<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Panel - Final Border Fix</title>
    <style>
        /* --- Reset & Base --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            color: #333; 
            overflow: hidden; 
        }

        /* --- LAYOUT WRAPPER --- */
        .layout-wrapper { display: flex; flex-direction: column; height: 100vh; width: 100vw; }
        .global-top-nav { height: 50px; background-color: #3F4757; flex-shrink: 0; }
        .main-row-wrapper { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Side Nav Styling */
        .global-side-nav { 
            width: 60px; 
            background-color: #3F4757; 
            flex-shrink: 0;
            display: flex; flex-direction: column; align-items: center; padding-top: 15px; 
            gap: 20px; 
            z-index: 30;
        }

        .nav-toggle-btn {
            width: 36px; height: 36px;
            border: none; border-radius: 8px; cursor: pointer;
            background-color: #6F7884; color: #FFFFFF; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; font-weight: 600; font-size: 13px; font-family: inherit;
        }
        .nav-toggle-btn:hover { filter: brightness(1.1); }
        
        #navAiToggle {
            background: linear-gradient(270deg, #ECFEFF 0%, #F5F3FF 74.52%, #EDE9FE 100%);
            color: #00BFA5; 
        }
        #navAiToggle.active {
            background: #00BFA5; color: #FFFFFF;
            box-shadow: 0 2px 5px rgba(0, 191, 165, 0.4);
        }
        .nav-toggle-btn svg { width: 20px; height: 20px; }

        .app-container { flex: 1; position: relative; background-color: #fff; overflow: hidden; display: flex; }

        /* --- CHAT SIDEBAR --- */
        .chat-sidebar {
            position: absolute; bottom: 0; left: 0; z-index: 20;
            width: 400px; height: 100%;
            background: linear-gradient(270deg, #ECFEFF 0%, #F5F3FF 74.52%, #EDE9FE 100%);
            border-right: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column; overflow: hidden;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chat-sidebar.state-docked { width: 400px; height: 100%; border-radius: 0; transform: translateX(0); opacity: 1; }
        .chat-sidebar.state-minimized {
            height: 48px; width: 280px; left: 20px; bottom: 0; transform: translateX(0);
            background: linear-gradient(270deg, #ECFEFF 0%, #F5F3FF 74.52%, #EDE9FE 100%);
            border: 1px solid rgba(0,0,0,0.1); border-bottom: none; border-radius: 12px 12px 0 0;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.08); opacity: 1;
        }
        .chat-sidebar.state-fullscreen { width: 100%; height: 100%; border-radius: 0; z-index: 100; transform: translateX(0); opacity: 1; }
        .chat-sidebar.state-closed { width: 400px; height: 100%; transform: translateX(-100%); pointer-events: none; opacity: 1; }

        /* --- WRAPPERS --- */
        .main-view-wrapper {
            display: flex; flex-direction: column; height: 100%; 
            min-width: 400px; width: 400px; padding: 0; 
            opacity: 1; transition: opacity 0.2s ease;
        }
        .chat-sidebar.state-minimized .main-view-wrapper { opacity: 0; pointer-events: none; transition-duration: 0.1s; }

        .minimized-view-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
            opacity: 0; pointer-events: none; min-width: 280px;
            transition: opacity 0.2s ease;
        }
        .chat-sidebar.state-minimized .minimized-view-wrapper { opacity: 1; pointer-events: auto; transition-delay: 0.2s; }

        /* --- TOP BAR --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; height: 44px; flex-shrink: 0; padding: 0 8px 0 16px; margin-bottom: 0; }
        .brand-text { font-size: 0.95rem; color: #444; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .window-controls { display: flex; gap: 6px; align-items: center; }
        .win-btn { background: transparent; border: none; cursor: pointer; padding: 6px; border-radius: 6px; color: #555; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .win-btn:hover { background-color: rgba(0,0,0,0.05); color: #000; }
        .win-btn svg { width: 16px; height: 16px; stroke-width: 2px; }

        /* --- CARD CONTAINER --- */
        .chat-card-container {
            flex: 1; background-color: #fff; 
            /* REQ 1: Fixed Border Radius */
            border-radius: 16px 16px 0 0;
            
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.03); 
            border: none;
            position: relative; 
        }
        .chat-sidebar.state-fullscreen .main-view-wrapper { width: 100%; min-width: 100%; padding: 0; }
        
        /* REQ 1: Ensure full screen maintains border radius on top */
        .chat-sidebar.state-fullscreen .chat-card-container { border-radius: 16px 16px 0 0; }

        .nav-header { padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; background-color: #fff; border-bottom: 1px solid #f5f5f5; flex-shrink: 0; }
        .action-btn { background: transparent; border: none; cursor: pointer; padding: 8px; border-radius: 8px; color: #555; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .action-btn:hover { background-color: #f5f5f5; color: #000; }
        .action-btn svg { width: 18px; height: 18px; stroke-width: 2px; }
        .chat-title { font-size: 0.95rem; font-weight: 600; color: #222; text-align: center; flex: 1; }

        .min-brand { display: flex; align-items: center; gap: 8px; font-weight: 600; color: #333; font-size: 0.95rem; pointer-events: none; }
        .min-controls { display: flex; gap: 4px; margin-left: auto; }
        .min-btn { background: none; border: none; cursor: pointer; color: #555; display: flex; align-items: center; padding: 6px; border-radius: 4px; }
        .min-btn:hover { color: #000; background-color: rgba(255,255,255,0.5); }

        .drag-handle {
            cursor: grab; color: #94A3B8; display: flex; align-items: center; padding: 4px; margin-right: 4px;
        }
        .drag-handle:active { cursor: grabbing; color: #475569; }
        .drag-handle svg { width: 14px; height: 14px; stroke-width: 2px; }

        /* --- CONTENT AREAS --- */
        .chat-scroll-area { 
            flex: 1; 
            padding: 16px; 
            overflow-y: auto; 
            background-color: #fff; 
            display: flex; 
            flex-direction: column; 
            scroll-behavior: smooth;
        }
        
        .empty-state-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .empty-state-content { text-align: left; width: 100%; padding: 0 10px; max-width: 400px; transition: width 0.3s; }
        .chat-sidebar.state-fullscreen .empty-state-content { width: 75%; max-width: 1000px; margin: 0 auto; }

        .empty-icon { width: 48px; height: 48px; margin-bottom: 16px; color: #00BFA5; background: rgba(0, 191, 165, 0.1); border-radius: 12px; padding: 10px; display: inline-block; }
        .greeting-title { font-size: 1.75rem; color: #2D3748; margin-bottom: 8px; font-weight: 600; }
        .greeting-subtitle { font-size: 1.1rem; color: #718096; margin: 0; display: flex; align-items: center; }

        /* Active Chat State */
        .active-chat-wrapper {
            display: none; 
            flex-direction: column;
            gap: 16px;
            padding-bottom: 20px;
            width: 100%;
        }
        .chat-sidebar.state-fullscreen .active-chat-wrapper { width: 75%; max-width: 1000px; align-self: center; }
        
        .message-bubble {
            max-width: 85%;
            padding: 10px 14px; 
            font-size: 0.9rem;
            line-height: 1.45;
            position: relative;
        }
        
        .message-bubble.user {
            align-self: flex-end;
            background-color: #EEF2F6;
            color: #161616;
            border-radius: 12px 12px 0 12px;
        }
        
        .message-bubble.ai {
            align-self: flex-start;
            background-color: transparent;
            color: #444F5C;
            padding-left: 0;
            padding-bottom: 4px;
        }

        .message-bubble.ai ul { margin: 8px 0 0 0; padding-left: 20px; list-style-type: disc; }
        .message-bubble.ai li { margin-bottom: 2px; }

        .ai-actions-row { display: flex; align-self: flex-start; gap: 12px; margin-top: -8px; margin-bottom: 12px; padding-left: 0; }
        .ai-action-btn { background: transparent; border: none; cursor: pointer; color: #64748B; padding: 4px; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: color 0.2s, background 0.2s; }
        .ai-action-btn:hover { color: #1E293B; background-color: #F1F5F9; }
        .ai-action-btn svg { width: 16px; height: 16px; stroke-width: 2px; }


        /* --- INPUT AREA --- */
        .input-wrapper { 
            padding: 16px 16px 8px 16px; 
            background-color: #fff; width: 100%; flex-shrink: 0; position: relative; 
        }
        .chat-sidebar.state-fullscreen .input-wrapper { display: flex; flex-direction: column; align-items: center; }
        .chat-sidebar.state-fullscreen .input-group-container { width: 75%; max-width: 1000px; }
        .input-group-container { width: 100%; transition: width 0.3s; position: relative; }

        .suggestions-list { display: flex; flex-direction: column; margin-bottom: 12px; border: none; background-color: transparent; }
        .suggestion-item { background-color: transparent; border: none; border-bottom: 1px solid #E2E8F0; padding: 10px 10px; font-size: 0.9rem; color: #64748B; cursor: pointer; text-align: left; transition: background-color 0.2s, color 0.2s; line-height: 1.4; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #EEF2F6; color: #1E293B; border-radius: 6px; border-bottom-color: transparent; }

        .input-border-wrapper { background-color: #EEF2F6; border: 1px solid #E2E8F0; padding: 4px; border-radius: 16px; width: 100%; }
        
        .enhanced-input-box { 
            border: 1px solid #E2E8F0; border-radius: 12px; padding: 12px 14px; background-color: #fff; 
            display: flex; flex-direction: column; gap: 8px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.02); 
            transition: border-color 0.2s; 
            position: relative;
        }
        .enhanced-input-box:focus-within { border-color: #CBD5E0; }
        
        .skills-menu {
            position: absolute; bottom: 60px; left: 10px; width: 280px;
            background-color: #fff; border: 1px solid #E2E8F0; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12); padding: 8px 0;
            display: none; z-index: 100; animation: slideUp 0.15s ease-out;
        }
        .skills-menu.visible { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .skills-header { padding: 8px 16px 6px 16px; font-size: 0.75rem; font-weight: 700; color: #161616; text-transform: uppercase; letter-spacing: 0.05em; }
        .skill-item { padding: 8px 16px; cursor: pointer; transition: background 0.2s; }
        .skill-item:hover { background-color: #F7FAFC; }
        .skill-name { font-size: 0.9rem; color: #161616; font-weight: 500; margin-bottom: 2px; }
        .skill-desc { font-size: 0.8rem; color: #94A3B8; }

        .context-row { display: flex; }
        .context-pill { display: inline-flex; align-items: center; gap: 6px; background-color: #EDF2F7; color: #4A5568; font-size: 0.75rem; font-weight: 600; padding: 4px 10px; border-radius: 12px; user-select: none; }
        .context-close { cursor: pointer; color: #718096; font-size: 14px; line-height: 1; }
        .context-close:hover { color: #cf3a3a; }
        
        .main-input { border: none; outline: none; width: 100%; font-size: 0.95rem; color: #2D3748; font-family: inherit; resize: none; padding: 4px 0 8px 0; background: transparent; }
        .main-input::placeholder { color: #A0AEC0; }
        
        .input-toolbar { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid transparent; }
        .toolbar-left, .toolbar-right { display: flex; gap: 8px; align-items: center; }
        .tool-icon-btn { background: transparent; border: none; cursor: pointer; padding: 6px; border-radius: 6px; color: #718096; display: flex; align-items: center; justify-content: center; transition: color 0.2s, background 0.2s; }
        .tool-icon-btn:hover { background-color: #F7FAFC; color: #4A5568; }
        .tool-icon-btn svg { width: 18px; height: 18px; stroke-width: 2px; }
        .send-btn-square { width: 32px; height: 32px; background-color: #F1F5F9; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #64748B; transition: all 0.2s; }
        .send-btn-square:hover { background-color: #E2E8F0; color: #334155; }
        .send-btn-square svg { width: 16px; height: 16px; stroke-width: 2px; }

        .disclaimer-text { 
            text-align: center; font-size: 0.7rem; color: #94A3B8; 
            padding-bottom: 2px; margin-top: 6px; 
        }

        /* --- HISTORY SIDE SHEET --- */
        .history-sheet {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #fff; z-index: 50; display: flex; flex-direction: column; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-right: 1px solid #f0f0f0;
        }
        .chat-sidebar.state-fullscreen .history-sheet { width: 320px; border-right: 1px solid #E2E8F0; }
        .history-sheet.open { transform: translateX(0); }

        .history-header {
            padding: 14px 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f5f5f5; flex-shrink: 0;
        }
        .history-title { font-weight: 600; color: #333; font-size: 0.95rem; flex: 1; }
        .history-back-btn, .history-new-chat-btn {
            background: transparent; border: none; cursor: pointer; padding: 6px; border-radius: 6px; color: #555; display: flex; align-items: center; justify-content: center;
        }
        .history-back-btn:hover, .history-new-chat-btn:hover { background-color: #f5f5f5; }
        .history-back-btn svg, .history-new-chat-btn svg { width: 20px; height: 20px; }

        .history-search-wrapper { padding: 12px 16px 4px 16px; }
        .history-search-box {
            display: flex; align-items: center; gap: 8px; background-color: #F7FAFC; border: 1px solid #E2E8F0; border-radius: 8px; padding: 8px 12px;
        }
        .history-search-box:focus-within { border-color: #CBD5E0; }
        .history-search-box input { border: none; background: transparent; outline: none; width: 100%; font-size: 0.85rem; color: #333; }
        .history-search-box svg { width: 16px; height: 16px; color: #A0AEC0; }

        .history-content { flex: 1; overflow-y: auto; padding: 16px; }
        .history-section-title { font-size: 0.75rem; font-weight: 600; color: #94A3B8; margin: 16px 0 8px 0; text-transform: uppercase; letter-spacing: 0.05em; }
        .history-section-title:first-child { margin-top: 0; }

        .history-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; color: #4A5568; font-size: 0.9rem; }
        .history-item:hover { background-color: #F7FAFC; color: #1E293B; }
        .history-icon { color: #A0AEC0; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .history-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }

        /* --- MAIN CONTENT & SKELETON --- */
        .main-content { 
            flex: 1; height: 100%; background-color: #fff; 
            padding: 30px;
            text-align: center; transition: padding-left 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; flex-direction: column; cursor: pointer; 
            overflow: hidden;
        }
        .main-content.pushed-by-dock { padding-left: 430px; }
        .main-content.full-hidden { opacity: 0; pointer-events: none; }

        .table-skeleton-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            background: #fff;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            overflow: hidden;
        }

        .skeleton-row {
            display: grid;
            grid-template-columns: 2fr 3fr 2fr 2fr 2fr 1fr;
            gap: 24px;
            padding: 0 24px; 
            border-bottom: 1px solid #F1F5F9;
            align-items: center;
            height: 50px; 
        }
        .skeleton-row:last-child { border-bottom: none; }
        
        .skeleton-row.header { 
            background-color: #F8FAFC; 
            border-bottom: 1px solid #E2E8F0;
        }

        .skeleton-cell {
            display: flex;
            align-items: center;
            width: 100%;
        }
        
        .skeleton-bar { height: 12px; background: #F1F5F9; border-radius: 6px; width: 100%; }
        .header .skeleton-bar { background: #E2E8F0; }

    </style>
</head>
<body>

    <div class="layout-wrapper">
        <nav class="global-top-nav"></nav>
        <div class="main-row-wrapper">
            
            <nav class="global-side-nav">
                <button class="nav-toggle-btn active" id="navAiToggle" title="Toggle AI Assistant">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg>
                </button>
                <button class="nav-toggle-btn">C</button>
                <button class="nav-toggle-btn">L</button>
                <button class="nav-toggle-btn">T</button>
                <button class="nav-toggle-btn">CH</button>
                <button class="nav-toggle-btn">D</button>
            </nav>

            <div class="app-container">
                
                <aside class="chat-sidebar state-docked" id="chatPanel">
                    
                    <div class="minimized-view-wrapper">
                        <div class="drag-handle" id="dragHandle">
                            <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="9" cy="5" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="9" cy="19" r="1.5"/><circle cx="15" cy="5" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="15" cy="19" r="1.5"/></svg>
                        </div>
                        <div class="min-brand">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="color: #00BFA5;"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg>
                            <span>AI Assistant</span>
                        </div>
                        <div class="min-controls">
                            <button class="min-btn" id="btnRestoreMin" title="Restore"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
                            <button class="min-btn" id="btnCloseMin" title="Close"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                        </div>
                    </div>

                    <div class="main-view-wrapper">
                        <div class="top-bar">
                            <div class="brand-text">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="color: #00BFA5;"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg>
                                AI Assistant
                            </div>
                            <div class="window-controls">
                                <button class="win-btn" id="btnMinimize" title="Minimize"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                                <button class="win-btn" id="btnFull" title="Full Screen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg></button>
                                <button class="win-btn" id="btnDock" title="Dock" style="display:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg></button>
                                <button class="win-btn" id="btnClose" title="Close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                            </div>
                        </div>

                        <div class="chat-card-container">
                            
                            <div class="history-sheet" id="historySheet">
                                <div class="history-header">
                                    <button class="history-back-btn" id="btnCloseHistory" title="Back"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button>
                                    <div class="history-title">My Conversations</div>
                                    <button class="history-new-chat-btn" id="btnHistoryNewChat" title="New Chat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/><path d="M8 12h8"/><path d="M12 8v8"/></svg></button>
                                </div>
                                <div class="history-search-wrapper">
                                    <div class="history-search-box">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                        <input type="text" placeholder="Search leads & deals...">
                                    </div>
                                </div>
                                <div class="history-content">
                                    <div class="history-section-title" id="historyTodaySection">Today</div>
                                    <div class="history-item" onclick="loadHistoryChat('Tesla Fleet Inquiry')">
                                        <div class="history-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
                                        <span class="history-text">Tesla Fleet Inquiry</span>
                                    </div>
                                    <div class="history-item" onclick="loadHistoryChat('Q3 SUV Sales Report')">
                                        <div class="history-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
                                        <span class="history-text">Q3 SUV Sales Report</span>
                                    </div>
                                    <div class="history-section-title">Earlier</div>
                                    <div class="history-item" onclick="loadHistoryChat('Ford F-150 Negotiation')">
                                        <div class="history-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
                                        <span class="history-text">Ford F-150 Negotiation</span>
                                    </div>
                                </div>
                            </div>

                            <div class="nav-header">
                                <button class="action-btn" id="btnShowHistory" title="History"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg></button>
                                <div class="chat-title">New Conversation</div>
                                <button class="action-btn" id="btnNewChat" title="New Chat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/><path d="M8 12h8"/><path d="M12 8v8"/></svg></button>
                            </div>

                            <div class="chat-scroll-area">
                                
                                <div class="empty-state-wrapper" id="emptyState">
                                    <div class="empty-state-content">
                                        <div class="empty-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg></div>
                                        <h2 class="greeting-title">Hi John,</h2>
                                        <p class="greeting-subtitle">How can I help with your leads today?</p>
                                    </div>
                                </div>

                                <div class="active-chat-wrapper" id="activeChat">
                                    </div>

                            </div>

                            <div class="input-wrapper">
                                <div class="input-group-container">
                                    
                                    <div class="suggestions-list" id="suggestionsList">
                                        <div class="suggestion-item" onclick="startChat('Summarize recent car leads')">Summarize recent car leads</div>
                                        <div class="suggestion-item" onclick="startChat('Draft quote for Model X')">Draft quote for Model X</div>
                                        <div class="suggestion-item" onclick="startChat('List high-priority test drives')">List high-priority test drives</div>
                                    </div>

                                    <div class="input-border-wrapper">
                                        <div class="enhanced-input-box">
                                            
                                            <div class="skills-menu" id="skillsMenu">
                                                <div class="skills-header">Skills</div>
                                                <div class="skill-item" onclick="startChat('/inventory-check')">
                                                    <div class="skill-name">/inventory-check</div>
                                                    <div class="skill-desc">Check stock availability across lots</div>
                                                </div>
                                                <div class="skill-item" onclick="startChat('/deal-probability')">
                                                    <div class="skill-name">/deal-probability</div>
                                                    <div class="skill-desc">Likelihood of closing current lead</div>
                                                </div>
                                                <div class="skill-item" onclick="startChat('/credit-prequal')">
                                                    <div class="skill-name">/credit-prequal</div>
                                                    <div class="skill-desc">Quick credit estimation for buyer</div>
                                                </div>
                                                <div class="skill-item" onclick="startChat('/trade-in-val')">
                                                    <div class="skill-name">/trade-in-val</div>
                                                    <div class="skill-desc">Estimate trade-in value by VIN</div>
                                                </div>
                                                <div class="skill-item" onclick="startChat('/schedule-drive')">
                                                    <div class="skill-name">/schedule-drive</div>
                                                    <div class="skill-desc">Book test drive slots</div>
                                                </div>
                                            </div>

                                            <div class="context-row" id="contextRow">
                                                <div class="context-pill">
                                                    Page 1 
                                                    <span class="context-close" id="btnCloseContext">Ã—</span>
                                                </div>
                                            </div>
                                            <input type="text" class="main-input" placeholder="Ask or assign task...">
                                            <div class="input-toolbar">
                                                <div class="toolbar-left">
                                                    <button class="tool-icon-btn" id="btnSlashMenu" title="Slash Commands">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                                            <rect x="3" y="3" width="18" height="18" rx="4" ry="4"></rect>
                                                            <line x1="10" y1="16" x2="14" y2="8"></line>
                                                        </svg>
                                                    </button>
                                                    <button class="tool-icon-btn" title="Attach">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                                                    </button>
                                                </div>
                                                <div class="toolbar-right">
                                                    <button class="tool-icon-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></button>
                                                    <button class="send-btn-square"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="disclaimer-text">AI Assistant can make mistakes. Please check for accuracy.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>

                <main class="main-content pushed-by-dock" id="mainContent">
                    <div class="table-skeleton-container">
                        <div class="skeleton-row header">
                            <div class="skeleton-cell"><div class="skeleton-bar"></div></div>
                            <div class="skeleton-cell"><div class="skeleton-bar"></div></div>
                            <div class="skeleton-cell"><div class="skeleton-bar"></div></div>
                            <div class="skeleton-cell"><div class="skeleton-bar"></div></div>
                            <div class="skeleton-cell"><div class="skeleton-bar"></div></div>
                            <div class="skeleton-cell"><div class="skeleton-bar"></div></div>
                        </div>
                        
                        <script>
                            for(let i = 0; i < 20; i++) {
                                let cellsHtml = '';
                                for(let j=0; j<6; j++) {
                                     const width = 50 + Math.random() * 50;
                                     cellsHtml += `<div class="skeleton-cell"><div class="skeleton-bar" style="width: ${width}%"></div></div>`;
                                }
                                document.write(`<div class="skeleton-row">${cellsHtml}</div>`);
                            }
                        </script>
                    </div>
                </main>

            </div>
        </div>
    </div>

    <script>
        const panel = document.getElementById('chatPanel');
        const mainContent = document.getElementById('mainContent');
        const btnMinimize = document.getElementById('btnMinimize');
        const btnRestoreMin = document.getElementById('btnRestoreMin');
        const btnCloseMin = document.getElementById('btnCloseMin');
        const btnFull = document.getElementById('btnFull');
        const btnDock = document.getElementById('btnDock');
        const btnClose = document.getElementById('btnClose');
        const navAiToggle = document.getElementById('navAiToggle');
        
        const btnCloseContext = document.getElementById('btnCloseContext');
        const contextRow = document.getElementById('contextRow');
        const suggestionsList = document.getElementById('suggestionsList');
        
        const historySheet = document.getElementById('historySheet');
        const btnShowHistory = document.getElementById('btnShowHistory');
        const btnCloseHistory = document.getElementById('btnCloseHistory');
        const btnNewChat = document.getElementById('btnNewChat');
        const btnHistoryNewChat = document.getElementById('btnHistoryNewChat');
        
        const emptyState = document.getElementById('emptyState');
        const activeChat = document.getElementById('activeChat');
        const chatScrollArea = document.querySelector('.chat-scroll-area');
        const chatTitle = document.querySelector('.chat-title');
        const historyTodaySection = document.getElementById('historyTodaySection');

        const btnSlashMenu = document.getElementById('btnSlashMenu');
        const skillsMenu = document.getElementById('skillsMenu');
        const dragHandle = document.getElementById('dragHandle');

        let historyAdded = false;

        let isDragging = false;
        let startX, startLeft;

        // DRAG HANDLER
        dragHandle.onmousedown = function(e) {
            if(!panel.classList.contains('state-minimized')) return;
            isDragging = true;
            startX = e.clientX;
            const style = window.getComputedStyle(panel);
            startLeft = parseInt(style.left);
            panel.style.transition = 'none';
            document.body.style.cursor = 'grabbing';
            e.preventDefault(); 
        };

        document.onmousemove = function(e) {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            let newLeft = startLeft + dx;
            const maxLeft = window.innerWidth - panel.offsetWidth - 20;
            if (newLeft < 20) newLeft = 20;
            if (newLeft > maxLeft) newLeft = maxLeft;
            panel.style.left = newLeft + 'px';
        };

        document.onmouseup = function() {
            if (isDragging) {
                isDragging = false;
                panel.style.transition = ''; 
                document.body.style.cursor = '';
            }
        };

        function scrollToBottom() {
            chatScrollArea.scrollTop = chatScrollArea.scrollHeight;
        }

        btnSlashMenu.onclick = (e) => {
            e.stopPropagation();
            skillsMenu.classList.toggle('visible');
        }

        document.addEventListener('click', (e) => {
            if (!skillsMenu.contains(e.target) && e.target !== btnSlashMenu) {
                skillsMenu.classList.remove('visible');
            }
        });

        const skillDisplayNames = {
            '/inventory-check': 'Inventory check',
            '/deal-probability': 'Deal probability',
            '/credit-prequal': 'Credit pre-qual',
            '/trade-in-val': 'Trade-in value',
            '/schedule-drive': 'Schedule test drive'
        };

        window.loadHistoryChat = function(title) {
            emptyState.style.display = 'none';
            suggestionsList.style.display = 'none';
            activeChat.style.display = 'flex';
            skillsMenu.classList.remove('visible');
            
            chatTitle.innerText = title;
            activeChat.innerHTML = '';

            const userBubble = document.createElement('div');
            userBubble.className = 'message-bubble user';
            userBubble.innerText = title;
            activeChat.appendChild(userBubble);

            const aiBubble = document.createElement('div');
            aiBubble.className = 'message-bubble ai';
            aiBubble.innerHTML = `<p>Loading deal details for <strong>${title}</strong>...</p>`;
            activeChat.appendChild(aiBubble);

            historySheet.classList.remove('open');
            scrollToBottom();
        }

        window.startChat = function(userText) {
            emptyState.style.display = 'none';
            suggestionsList.style.display = 'none';
            activeChat.style.display = 'flex';
            skillsMenu.classList.remove('visible'); 
            
            let displayText = userText;
            if (skillDisplayNames[userText]) {
                displayText = skillDisplayNames[userText];
            }

            if (!historyAdded) {
                if (userText.includes("Summarize")) {
                    chatTitle.innerText = "Lead Summary - Page 1";
                } else {
                    chatTitle.innerText = displayText;
                }

                const newItem = document.createElement('div');
                newItem.className = 'history-item';
                const historyTitle = chatTitle.innerText; 
                newItem.onclick = () => window.loadHistoryChat(historyTitle); 
                
                newItem.innerHTML = `<div class="history-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div><span class="history-text">${historyTitle}</span>`;
                historyTodaySection.insertAdjacentElement('afterend', newItem);
                
                historyAdded = true;
            }

            const userBubble = document.createElement('div');
            userBubble.className = 'message-bubble user';
            userBubble.innerText = displayText;
            activeChat.appendChild(userBubble);
            scrollToBottom();

            setTimeout(() => {
                const aiBubble = document.createElement('div');
                aiBubble.className = 'message-bubble ai';
                
                let responseHTML = "";
                
                switch(userText) {
                    case 'Summarize recent car leads':
                        responseHTML = `
                            <p style="margin-bottom: 8px;">Here is a summary of the active car leads from the current page view:</p>
                            <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                                <li><strong>John Doe:</strong> Interested in 2024 Honda CR-V. Financing pending.</li>
                                <li><strong>Sarah Smith:</strong> Requesting test drive for Ford Explorer. Trade-in valuation needed.</li>
                                <li><strong>Mike Johnson:</strong> Lease expiring soon. Looking at Toyota Camry options.</li>
                                <li><strong>Corporate Fleet:</strong> Inquiry for 5 Chevy Silverados. Quote sent.</li>
                                <li><strong>Pending Action:</strong> 3 unread messages from internet leads.</li>
                            </ul>
                        `;
                        break;
                    case 'Draft quote for Model X':
                        responseHTML = `
                            <p><strong>Subject: Your Tesla Model X Quote</strong></p>
                            <p>Hi [Customer Name],</p>
                            <p>Great choice on the Model X. Based on your configuration (Long Range, Black Interior), here is the preliminary quote attached. This includes the federal tax incentive deduction.</p>
                            <p>Let me know if you want to proceed with the credit application.</p>
                            <p>Best,<br>[Your Name]</p>
                        `;
                        break;
                    case 'List high-priority test drives':
                        responseHTML = `
                            <p><strong>Today's High Priority Test Drives:</strong></p>
                            <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                                <li>10:00 AM - BMW X5 (Client: A. Miller)</li>
                                <li>1:30 PM - Audi Q7 (Client: B. Davis) - <em>Confirm trade-in arrival</em></li>
                                <li>3:00 PM - Mercedes C-Class (Client: C. Wilson)</li>
                                <li>4:30 PM - Porsche Macan (Client: D. Brown)</li>
                            </ul>
                        `;
                        break;
                    case '/inventory-check':
                        responseHTML = `<strong>Stock Status:</strong><br>We have 3 units matching that description at the Main Lot, and 1 in transit (ETA: 5 days).`;
                        break;
                    case '/deal-probability':
                        responseHTML = `<strong>Deal Probability: 75%</strong><br>Customer has high intent. Credit score is solid (720+). Pending spouse approval on color.`;
                        break;
                    case '/credit-prequal':
                        responseHTML = `<strong>Soft Pull Result:</strong><br>Tier 1 Credit Qualified. Rate eligibility: 3.9% APR for 60 months.`;
                        break;
                    case '/trade-in-val':
                        responseHTML = `<strong>Estimated Value:</strong> $18,500 - $20,000<br>Based on 2018 model year with 45k miles and 'Good' condition.`;
                        break;
                    case '/schedule-drive':
                        responseHTML = `<strong>Slot Confirmed:</strong><br>Test drive scheduled for Saturday, Oct 24th at 11:00 AM. Confirmation SMS sent.`;
                        break;
                    default:
                        responseHTML = "Analyzing CRM data...";
                }

                aiBubble.innerHTML = responseHTML;
                activeChat.appendChild(aiBubble);

                const actionRow = document.createElement('div');
                actionRow.className = 'ai-actions-row';
                const icons = [
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>',
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path></svg>',
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>',
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>'
                ];
                icons.forEach(svg => {
                    const btn = document.createElement('button');
                    btn.className = 'ai-action-btn';
                    btn.innerHTML = svg;
                    actionRow.appendChild(btn);
                });
                activeChat.appendChild(actionRow);
                scrollToBottom();

            }, 400);

            historySheet.classList.remove('open');
        }

        function resetChat() {
            activeChat.innerHTML = '';
            activeChat.style.display = 'none';
            emptyState.style.display = 'flex';
            suggestionsList.style.display = 'flex';
            contextRow.style.display = 'flex';
            historySheet.classList.remove('open');
            chatTitle.innerText = "New Conversation"; 
            historyAdded = false; 
        }

        btnNewChat.onclick = resetChat;
        btnHistoryNewChat.onclick = resetChat;

        btnCloseContext.onclick = (e) => {
            e.stopPropagation();
            contextRow.style.display = 'none';
            suggestionsList.style.display = 'none';
        };

        mainContent.onclick = () => {
            if(emptyState.style.display !== 'none') {
                contextRow.style.display = 'flex';
                suggestionsList.style.display = 'flex';
            }
        };

        btnShowHistory.onclick = () => historySheet.classList.add('open');
        btnCloseHistory.onclick = () => historySheet.classList.remove('open');

        // SHORTCUT LOGIC - SIMPLE
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
            const key = e.key.toLowerCase();
            
            if (key === 't') {
                // Shift + T (Windows preference, usually)
                if (e.shiftKey) {
                    e.preventDefault();
                    navAiToggle.click();
                }
                // Alt/Option + T (Mac preference)
                if (e.altKey) {
                    e.preventDefault();
                    navAiToggle.click();
                }
            }
        });

        function setState(state) {
            panel.classList.remove('state-docked', 'state-minimized', 'state-fullscreen', 'state-closed');
            mainContent.classList.remove('pushed-by-dock', 'full-hidden');
            btnFull.style.display = 'flex';
            btnDock.style.display = 'none';

            if (state === 'closed') navAiToggle.classList.remove('active');
            else navAiToggle.classList.add('active');

            if (state === 'docked') {
                panel.classList.add('state-docked');
                mainContent.classList.add('pushed-by-dock');
                panel.style.left = ''; 
            } else if (state === 'minimized') {
                panel.classList.add('state-minimized');
                if(!panel.style.left) panel.style.left = '20px';
            } else if (state === 'fullscreen') {
                panel.classList.add('state-fullscreen');
                mainContent.classList.add('full-hidden');
                btnFull.style.display = 'none';
                btnDock.style.display = 'flex';
                panel.style.left = '';
            } else if (state === 'closed') {
                panel.classList.add('state-closed');
                panel.style.left = '';
            }
        }

        navAiToggle.onclick = () => {
            if (panel.classList.contains('state-closed')) setState('docked');
            else setState('closed');
        };

        btnMinimize.onclick = () => setState('minimized');
        btnRestoreMin.onclick = () => setState('docked');
        btnCloseMin.onclick = () => setState('closed');
        btnFull.onclick = () => setState('fullscreen');
        btnDock.onclick = () => setState('docked');
        btnClose.onclick = () => setState('closed');
    </script>
</body>
</html>
