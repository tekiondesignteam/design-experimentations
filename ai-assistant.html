<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Assistant</title>
    <style>
        :root {
            /* --- TOKENS --- */
            /* Colors */
            --color-primary: #00BFA5;
            --color-text-on-primary: #FFFFFF;
            --color-danger: #EF4444;

            --color-text-main: #444F5C;
            --color-text-heading: #161616;
            --color-text-muted: #969AA3;
            --color-text-subtle: #64748B;

            --color-bg-main: #FFFFFF;
            --color-bg-dark: #3F4757;
            --color-bg-surface: #F1F5F9;
            --color-bg-hover: #F8FAFC;
            --color-bg-message: #EEF2F6;

            --color-border: #E2E8F0;
            --color-border-hover: #CBD5E0;

            --gradient-primary: linear-gradient(270deg, #ECFEFF 0%, #F5F3FF 74.52%, #EDE9FE 100%);

            /* Dimensions */
            --header-height: 48px;
            --sidebar-width: 400px;
            --sidebar-min-width: 280px;
            --sidebar-collapsed-width: 60px;
            --icon-sm: 14px;
            --icon-md: 16px;
            --icon-lg: 20px;
            --icon-xl: 24px;
            --radius-xs: 4px;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;

            /* Component Dimensions */
            --nav-height: 50px;
            --btn-size: 36px;
            --sidebar-min-height: 48px;
            --panel-width: 320px;
            --spacer-height: 160px;
            --popup-max-height: 380px;
            --full-content-max-width: 900px;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-card: 0 -2px 10px rgba(0, 0, 0, 0.03);
            --shadow-sidebar: 0 -4px 12px rgba(0, 0, 0, 0.08);

            /* Spacing */
            --space-2xs: 2px;
            --space-xs: 4px;
            --space-s: 6px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 20px;
            --space-2xl: 24px;
            --space-3xl: 32px;
            --space-4xl: 40px;

            /* Motions */
            --transition-speed-fast: 0.1s;
            --transition-speed-normal: 0.2s;
            --transition-speed-slow: 0.3s;
            --transition-speed-slower: 0.4s;

            /* Z-Index */
            --z-base: 0;
            --z-raised: 1;
            --z-overlay: 10;
            --z-nav: 20;
            --z-sidebar: 30;
            --z-modal: 50;
            --z-top: 100;
            --z-max: 9999;
            --z-maximum: 10000;

            /* Stroke Width */
            --stroke-normal: 2px;
            --stroke-thick: 2.5px;

            /* Layout */
            --w-full: 100%;
            --bubble-max-width: 85%;

            /* Extra Colors & Spacing */
            --color-disabled: #D4D5D6;
            --color-stop-btn: #94A3B8;
            --color-stop-btn-hover: #64748B;
            --color-danger-bg: #FFF5F5;
            --color-btn-secondary: #EDF2F7;
            --space-10: 10px;

            /* Typography */
            --font-xs: 0.75rem;
            --font-sm: 0.85rem;
            --font-base: 0.95rem;
            /* Slightly larger base */
            --font-md: 1rem;
            --font-lg: 1.1rem;
            --font-xl: 1.6rem;
        }

        /* --- Reset & Base --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--color-text-main);
            overflow: hidden;
        }

        /* --- LAYOUT WRAPPER --- */
        .layout-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        .global-top-nav {
            height: var(--nav-height);
            background-color: var(--color-bg-dark);
            flex-shrink: 0;
        }

        .main-row-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* Side Nav Styling */
        .global-side-nav {
            width: var(--sidebar-collapsed-width);
            background-color: var(--color-bg-dark);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: var(--space-lg);
            gap: var(--space-xl);
            z-index: var(--z-sidebar);
        }

        .nav-toggle-btn {
            width: var(--btn-size);
            height: var(--btn-size);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            background-color: var(--color-text-muted);
            color: var(--color-text-on-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed-normal);
            font-weight: 600;
            font-size: var(--font-xs);
            font-family: inherit;
        }

        .nav-toggle-btn:hover {
            filter: brightness(1.1);
        }

        #navAiToggle {
            background: var(--gradient-primary);
            color: var(--color-primary);
        }

        #navAiToggle.active {
            background: var(--color-primary);
            color: var(--color-text-on-primary);
            box-shadow: 0 2px 5px rgba(0, 191, 165, 0.4);
        }

        .nav-toggle-btn svg {
            width: var(--icon-lg);
            height: var(--icon-lg);
        }

        .app-container {
            flex: 1;
            position: relative;
            background-color: #fff;
            overflow: hidden;
            display: flex;
        }

        /* --- CHAT SIDEBAR --- */
        .chat-sidebar {
            position: absolute;
            bottom: 0;
            left: 0;
            z-index: var(--z-nav);
            width: var(--sidebar-width);
            height: 100%;
            background: var(--gradient-primary);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform var(--transition-speed-slower) cubic-bezier(0.4, 0, 0.2, 1), width var(--transition-speed-slow) ease;
        }

        .chat-sidebar.state-docked {
            width: var(--sidebar-width);
            height: 100%;
            border-radius: 0;
            transform: translateX(0);
            opacity: 1;
        }

        .chat-sidebar.state-minimized {
            height: var(--sidebar-min-height);
            width: var(--sidebar-min-width);
            left: var(--space-xl);
            bottom: 0;
            transform: translateX(0);
            background: var(--gradient-primary);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-bottom: none;
            border-radius: var(--radius-xs) var(--radius-xs) 0 0;
            box-shadow: var(--shadow-sidebar);
            opacity: 1;
        }

        .chat-sidebar.state-fullscreen {
            width: 100%;
            height: 100%;
            border-radius: 0;
            z-index: var(--z-top);
            transform: translateX(0);
            opacity: 1;
        }

        .chat-sidebar.state-closed {
            width: var(--sidebar-width);
            height: 100%;
            transform: translateX(-100%);
            pointer-events: none;
            opacity: 1;
        }

        /* --- RESPONSIVE DOCKED MODE (< 1600px) --- */
        @media (max-width: 1599px) {
            .chat-sidebar.state-docked {
                position: fixed;
                width: var(--sidebar-width);
                height: 85%;
                left: 96px;
                bottom: 0;
                top: auto;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
                border: 1px solid rgba(0, 0, 0, 0.1);
                border-bottom: none;
                z-index: var(--z-top);
            }

            .main-content.pushed-by-dock {
                padding-left: 24px !important;
            }

            /* Ensure app-container doesn't reserve space for floating sidebar */
            .app-container {
                padding-left: 0 !important;
            }

            /* Remove rounded corners from chat card in floating mode */
            .chat-card-container {
                border-radius: 0 !important;
            }
        }

        /* --- LISTENING OVERLAY CSS --- */
        .enhanced-input-box {
            position: relative;
            /* Ensure absolute child aligns */
        }

        .listening-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #F8FAFC;
            border-radius: var(--radius-lg);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            padding: 0 var(--space-lg);
            gap: var(--space-lg);
        }

        .listening-overlay.active {
            display: flex;
        }

        .listen-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-muted);
            padding: var(--space-xs);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color var(--transition-speed-normal);
        }

        .listen-close-btn:hover {
            color: var(--color-text-subtle);
        }

        .listen-visualizer {
            flex: 1;
            height: var(--space-3xl);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2xs);
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            overflow: hidden;
        }

        .v-bar {
            width: var(--space-2xs);
            background-color: var(--color-text-heading);
            border-radius: var(--space-2xs);
            height: var(--space-xs);
            animation: soundWave 0.5s infinite ease-in-out;
        }

        /* Randomize animations for wave effect */
        .v-bar:nth-child(odd) {
            animation-duration: 0.4s;
        }

        .v-bar:nth-child(2n) {
            animation-duration: 0.5s;
        }

        .v-bar:nth-child(3n) {
            animation-duration: 0.6s;
        }

        .v-bar:nth-child(4n) {
            animation-duration: 0.7s;
        }

        .v-bar:nth-child(5n) {
            animation-duration: 0.3s;
        }

        .listen-right-group {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .listen-timer {
            font-family: monospace;
            font-size: var(--font-base);
            color: var(--color-text-subtle);
            min-width: 48px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .listen-stop-btn {
            width: var(--space-3xl);
            height: var(--space-3xl);
            border-radius: 50%;
            background: var(--color-stop-btn);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #fff;
            transition: background var(--transition-speed-normal);
        }

        .listen-stop-btn:hover {
            background: var(--color-stop-btn-hover);
        }

        @keyframes soundWave {

            0%,
            100% {
                height: var(--space-xs);
            }

            50% {
                height: var(--space-xl);
            }
        }

        /* --- WRAPPERS --- */
        .main-view-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            flex-direction: column;
            height: 100%;
            min-width: var(--sidebar-width);
            width: var(--sidebar-width);
            padding: 0;
            opacity: 1;
            visibility: visible;
            transition: opacity var(--transition-speed-normal) ease, visibility var(--transition-speed-normal);
            position: relative;
            z-index: 2;
        }

        .chat-sidebar.state-minimized .main-view-wrapper {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            z-index: var(--z-base);
        }

        .minimized-view-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: var(--w-full);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-lg);
            opacity: 0;
            visibility: hidden;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            min-width: var(--sidebar-min-width);
            transition: opacity var(--transition-speed-normal) ease, visibility var(--transition-speed-normal);
            z-index: var(--z-raised);
        }

        .chat-sidebar.state-minimized .minimized-view-wrapper {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            z-index: var(--z-overlay);
            transition-delay: 0.1s;
        }

        .min-left-group {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .drag-handle {
            cursor: grab;
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            padding: var(--space-xs);
            margin-left: -4px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle svg {
            width: var(--icon-md);
            height: var(--icon-md);
        }

        .min-brand {
            font-weight: 600;
            color: var(--color-text-heading);
            font-size: var(--font-md);
            display: flex;
            align-items: center;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            user-select: none;
        }

        .min-controls {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .min-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--color-text-main);
            padding: var(--space-s);
            display: flex;
            align-items: center;
            justify-content: center;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: background var(--transition-speed-normal), color var(--transition-speed-normal);
        }

        .min-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--color-text-heading);
        }

        .min-btn svg {
            width: var(--icon-lg);
            height: var(--icon-lg);
            stroke-width: var(--stroke-thick);
        }

        /* --- TOP BAR --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 44px;
            flex-shrink: 0;
            padding: 0 var(--space-sm) 0 var(--space-lg);
            margin-bottom: 0;
        }

        .brand-text {
            font-size: var(--font-base);
            color: var(--color-text-main);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .window-controls {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
            z-index: var(--z-nav);
            position: relative;
        }

        .win-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: var(--space-s);
            border-radius: var(--radius-sm);
            color: var(--color-text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background var(--transition-speed-normal);
            pointer-events: auto;
        }

        .win-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--color-text-heading);
        }

        .win-btn svg {
            width: var(--icon-md);
            height: var(--icon-md);
            stroke-width: var(--stroke-normal);
        }

        /* --- CARD CONTAINER --- */
        .chat-card-container {
            flex: 1;
            background-color: #fff;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow-card);
            border: none;
            position: relative;
        }

        .chat-sidebar.state-fullscreen .main-view-wrapper {
            width: var(--w-full);
            min-width: 100%;
            padding: 0;
        }

        .chat-sidebar.state-fullscreen .chat-card-container {
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        /* --- NAV HEADER --- */
        .nav-header {
            padding: 8px var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-bg-main);
            border-bottom: 1px solid var(--color-bg-surface);
            flex-shrink: 0;
            position: relative;
            z-index: var(--z-nav);
            min-height: var(--header-height);
        }

        .action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            color: #444F5C;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background var(--transition-speed-normal);
            width: var(--btn-size);
            height: var(--btn-size);
        }

        .action-btn:hover {
            background-color: var(--color-bg-surface);
            color: var(--color-text-heading);
        }

        .action-btn svg {
            width: var(--icon-lg);
            height: var(--icon-lg);
            stroke-width: var(--stroke-normal);
        }

        .action-btn:disabled {
            opacity: 0.3;
            cursor: default;
        }

        .action-btn:disabled:hover {
            background: transparent;
            color: var(--color-disabled);
        }

        .chat-title {
            font-size: var(--font-md);
            font-weight: 600;
            color: var(--color-text-heading);
            text-align: center;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
            margin: 0 var(--space-md);
        }

        #chatMenuContainer {
            display: block;
            position: relative;
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            display: none;
            flex-direction: column;
            min-width: 130px;
            z-index: var(--z-top);
            margin-top: 4px;
        }

        .menu-dropdown.visible {
            display: flex;
        }

        .menu-item {
            padding: var(--space-10) var(--space-lg);
            font-size: var(--font-sm);
            cursor: pointer;
            color: #444F5C;
            text-align: left;
            background: none;
            border: none;
            transition: background var(--transition-speed-normal);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .menu-item:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-heading);
        }

        .menu-item:first-child {
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .menu-item:last-child {
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        .menu-item.danger {
            color: var(--color-danger);
        }

        .menu-item.danger:hover {
            background: var(--color-danger-bg);
        }

        .menu-item svg {
            width: var(--icon-sm);
            height: var(--icon-sm);
            stroke-width: var(--stroke-normal);
        }

        /* --- HISTORY SIDE SHEET --- */
        .history-sheet {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg-main);
            z-index: var(--z-modal);
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform var(--transition-speed-slow) cubic-bezier(0.4, 0, 0.2, 1);
            border-right: 1px solid var(--color-border);
        }

        .chat-sidebar.state-fullscreen .history-sheet {
            width: var(--panel-width);
            border-right: 1px solid var(--color-border);
        }

        .history-sheet.open {
            transform: translateX(0);
        }

        .chat-sidebar.state-fullscreen .history-sheet {
            transform: translateX(0) !important;
            z-index: var(--z-sidebar);
        }

        .chat-sidebar.state-fullscreen .history-back-btn {
            display: none;
        }

        .chat-sidebar.state-fullscreen .nav-header,
        .chat-sidebar.state-fullscreen .chat-scroll-area,
        .chat-sidebar.state-fullscreen .footer-container {
            margin-left: var(--panel-width);
            width: calc(100% - var(--panel-width));
            border-left: 1px solid var(--color-border);
        }

        .chat-sidebar.state-fullscreen #btnShowHistory {
            display: none;
        }

        .history-header {
            padding: 8px var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            border-bottom: 1px solid var(--color-bg-surface);
            flex-shrink: 0;
            position: relative;
            min-height: var(--header-height);
        }

        .history-title {
            font-weight: 600;
            color: var(--color-text-heading);
            font-size: var(--font-base);
            flex: 1;
            margin-left: 4px;
        }

        .history-back-btn,
        .history-new-chat-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            color: #444F5C;
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--btn-size);
            height: var(--btn-size);
        }

        .history-back-btn:hover,
        .history-new-chat-btn:hover {
            background-color: var(--color-bg-surface);
            color: var(--color-text-heading);
        }

        .history-back-btn svg,
        .history-new-chat-btn svg {
            width: var(--icon-lg);
            height: var(--icon-lg);
        }

        .history-search-wrapper {
            padding: var(--space-md) var(--space-lg) 4px var(--space-lg);
        }

        .history-search-box {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background-color: var(--color-bg-hover);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-md);
            position: relative;
        }

        .history-search-box:focus-within {
            border-color: var(--color-border-hover);
        }

        .history-search-box input {
            border: none;
            background: transparent;
            outline: none;
            width: var(--w-full);
            font-size: var(--font-sm);
            color: var(--color-text-heading);
            padding-right: var(--space-xl);
        }

        .history-search-box svg {
            width: var(--icon-md);
            height: var(--icon-md);
            color: var(--color-text-muted);
            flex-shrink: 0;
        }

        .history-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
            padding-right: var(--space-sm);
        }

        .history-section-title {
            font-size: var(--font-xs);
            font-weight: 600;
            color: var(--color-text-muted);
            margin: var(--space-lg) 0 var(--space-sm) 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .history-section-title:first-child {
            margin-top: 0;
        }

        .history-placeholder {
            padding: var(--space-xl);
            text-align: center;
            color: var(--color-text-muted);
            font-size: var(--font-sm);
            display: none;
        }

        .history-placeholder.visible {
            display: block;
        }

        .history-footer {
            padding: var(--space-lg) var(--space-xl);
            border-top: 1px solid var(--color-bg-surface);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            color: var(--color-text-main);
            font-size: 0.9rem;
            font-weight: 500;
            transition: color var(--transition-speed-normal);
        }

        .history-footer:hover {
            color: #161616;
        }

        .history-footer:hover svg {
            color: var(--color-primary);
        }

        .history-footer svg {
            width: 18px;
            height: 18px;
            stroke-width: var(--stroke-normal);
            transition: color var(--transition-speed-normal);
        }

        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-sm) var(--space-sm) var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background var(--transition-speed-normal);
            color: var(--color-text-main);
            font-size: 0.9rem;
            position: relative;
            margin-bottom: var(--space-2xs);
        }

        .history-item:hover {
            background-color: var(--color-bg-hover);
            color: var(--color-text-heading);
        }

        .history-item-left {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            overflow: hidden;
            flex: 1;
        }

        .history-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .history-item-menu-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--color-text-muted);
            padding: var(--space-xs);
            border-radius: var(--radius-xs);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: background var(--transition-speed-normal);
        }

        .history-item-menu-btn:hover {
            background-color: var(--color-border);
            color: var(--color-text-heading);
        }

        .history-item-menu-btn svg {
            width: var(--icon-md);
            height: var(--icon-md);
        }

        /* GLOBAL CONTEXT MENU & MODALS */
        #globalContextMenu {
            position: fixed;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            display: none;
            flex-direction: column;
            min-width: 140px;
            z-index: var(--z-max);
        }

        #globalContextMenu.visible {
            display: flex;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            z-index: var(--z-maximum);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-box {
            background: white;
            width: var(--panel-width);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-lg);
            animation: fadeIn 0.2s ease-out;
        }

        .modal-title {
            font-size: var(--font-lg);
            font-weight: 600;
            margin-bottom: var(--space-md);
            color: var(--color-text-heading);
        }

        .modal-input {
            width: var(--w-full);
            padding: var(--space-10);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--font-base);
            margin-bottom: var(--space-lg);
            outline: none;
            color: var(--color-text-heading);
        }

        .modal-input:focus {
            border-color: var(--color-primary);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
        }

        .modal-btn {
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-sm);
            font-size: var(--font-base);
            font-weight: 500;
            cursor: pointer;
            border: none;
        }

        .modal-btn.secondary {
            background: var(--color-btn-secondary);
            color: var(--color-text-main);
        }

        .modal-btn.primary {
            background: var(--color-primary);
            color: white;
        }

        .modal-btn.danger {
            background: var(--color-danger);
            color: white;
        }

        /* CHAT CONTENT AREA */
        .chat-scroll-area {
            flex: 1;
            padding: 0;
            /* Padding handled by content-aligner */
            overflow-y: auto;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }

        .scroll-spacer {
            height: var(--spacer-height);
            width: var(--w-full);
            flex-shrink: 0;
        }

        /* --- UNIVERSAL CONTENT ALIGNMENT --- */
        /* This class ensures consistent width and horizontal padding across all responsive modes */
        .content-aligner {
            width: var(--w-full);
            margin: 0 auto;
            box-sizing: border-box;
            padding: 0 var(--space-2xl);
            /* Default for Docked */
            transition: max-width var(--transition-speed-slow) ease, padding var(--transition-speed-slow) ease;
        }

        /* Fullscreen Mode: Centered, limited width */
        .chat-sidebar.state-fullscreen .content-aligner {
            max-width: var(--full-content-max-width);
            padding: 0 var(--space-4xl);
        }

        /* Suggestions List */
        .suggestions-list {
            display: flex;
            flex-direction: column;
            margin-top: auto;
            margin-bottom: 0px;
            /* Reduced to sit on top of input */
            border: none;
            background-color: transparent;
        }

        .suggestion-item {
            background-color: transparent;
            border: none;
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-10) var(--space-10);
            font-size: 0.9rem;
            color: var(--color-text-main);
            cursor: pointer;
            text-align: left;
            transition: background-color var(--transition-speed-normal), color var(--transition-speed-normal);
            line-height: 1.4;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: var(--color-bg-message);
            color: var(--color-text-heading);
            border-radius: var(--radius-sm);
            border-bottom-color: transparent;
        }

        .empty-state-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: var(--w-full);
        }

        .empty-state-content {
            text-align: left;
            /* Width controlled by content-aligner */
        }

        .empty-icon {
            width: 48px;
            height: 48px;
            margin-bottom: var(--space-lg);
            color: var(--color-primary);
            background: rgba(0, 191, 165, 0.1);
            border-radius: var(--radius-lg);
            padding: var(--space-10);
            display: inline-block;
        }

        .greeting-title {
            font-size: var(--font-xl);
            color: var(--color-text-heading);
            margin-bottom: var(--space-sm);
            font-weight: 500;
        }

        .greeting-subtitle {
            font-size: var(--font-lg);
            color: var(--color-text-muted);
            margin: 0;
            display: flex;
            align-items: center;
        }

        .active-chat-wrapper {
            display: none;
            flex-direction: column;
            gap: var(--space-lg);
            padding-bottom: var(--space-xl);
            padding-top: var(--space-xl);
        }

        /* Message Bubble Line Height */
        .message-bubble {
            max-width: var(--w-full);
            font-size: 0.875rem;
            line-height: 1.5;
            position: relative;
        }

        .message-bubble.user {
            margin-top: var(--space-md);
            align-self: flex-end;
            max-width: var(--bubble-max-width);
            padding: var(--space-sm) var(--space-md);
            background-color: var(--color-bg-message);
            color: var(--color-text-heading);
            border-radius: var(--radius-lg) var(--radius-lg) 0 var(--radius-lg);
        }

        /* UPDATED: AI Message Row Padding Top 0px */
        .ai-message-row {
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            width: 100%;
            padding-top: 0px;
            animation: fadeIn var(--transition-speed-slow) ease-out;
        }

        .ai-avatar {
            width: 28px;
            height: 28px;
            background-color: rgba(0, 191, 165, 0.1);
            color: var(--color-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .ai-avatar svg {
            width: 16px;
            height: 16px;
        }

        .ai-avatar.thinking svg {
            animation: spinPulse 3s ease-in-out infinite;
        }

        /* WRAPPER FOR VERTICAL ALIGNMENT */
        .ai-text-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* AI Content Font and Line Height */
        .ai-content {
            color: var(--color-text-heading);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .ai-content p {
            margin-bottom: var(--space-md);
            margin-top: 0;
        }

        .ai-content p:last-child {
            margin-bottom: 4px;
        }

        .ai-content strong,
        .ai-content b {
            font-weight: 500 !important;
            color: var(--color-text-heading);
        }

        /* Thoughts Header */
        .ai-thought-line {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* Was space-between */
            gap: var(--space-sm);
            /* Brings chevron closer */
            color: var(--color-text-muted);
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: var(--space-sm);
            padding-top: var(--space-sm);
            cursor: pointer;
            user-select: none;
            transition: color var(--transition-speed-fast);
        }

        .ai-thought-line:hover {
            color: var(--color-text-main);
        }

        .ai-thought-line span {
            display: flex;
            align-items: center;
        }

        /* Chevron Animation */
        .ai-thought-line .chevron {
            width: var(--icon-sm);
            height: var(--icon-sm);
            color: var(--color-text-muted);
            transition: transform 0.2s ease;
        }

        .ai-thought-line.expanded .chevron {
            transform: rotate(180deg);
        }

        /* Reasoning Details */
        .ai-thought-details {
            background-color: var(--color-bg-hover);
            border: 1px solid var(--color-bg-surface);
            border-radius: var(--radius-md);
            padding: var(--space-10) var(--space-md);
            margin-bottom: var(--space-md);
            display: none;
            font-size: 0.8rem;
            color: var(--color-text-main);
            animation: fadeIn 0.2s ease;
        }

        .thought-step {
            margin-bottom: 4px;
            padding-left: var(--space-sm);
            border-left: 2px solid var(--color-border);
        }

        .thought-step:last-child {
            margin-bottom: 0;
        }

        /* AI List Item Spacing and Line Height */
        .ai-list-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-s);
            margin-bottom: var(--space-sm);
            line-height: 1.5;
        }

        .ai-list-item:last-child {
            margin-bottom: 0;
        }

        .ai-list-number {
            color: var(--color-text-main);
            font-size: var(--font-base);
            margin-top: 0;
            min-width: var(--space-2xl);
            font-weight: 600;
            flex-shrink: 0;
        }

        .thinking-text {
            font-size: var(--font-sm);
            color: var(--color-text-muted);
            font-weight: 500;
            margin-top: 4px;
            animation: fadeText 2s ease-in-out infinite alternate;
        }

        /* AI Actions Row Padding */
        .ai-actions-row {
            display: flex;
            align-self: flex-start;
            gap: var(--space-md);
            margin-top: 0px;
            margin-bottom: 4px;
            margin-left: 0px;
            padding-top: var(--space-sm);
            opacity: 0;
            animation: fadeIn var(--transition-speed-slow) ease-in forwards;
        }

        .ai-action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: #969AA3;
            padding: var(--space-xs);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s, background 0.2s;
        }

        .ai-action-btn:hover {
            color: var(--color-text-heading);
            background-color: var(--color-bg-surface);
        }

        .ai-action-btn svg {
            width: var(--icon-md);
            height: var(--icon-md);
            stroke-width: var(--stroke-normal);
        }

        /* --- FOOTER CONTAINER (New wrapper for input + disclaimer) --- */
        .footer-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: var(--w-full);
            background-color: var(--color-bg-main);
            z-index: var(--z-nav);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-md) 0px;
            /* Aligned with content-aligner horizontal padding */
        }

        /* INPUT WRAPPER HIERARCHY */
        .input-wrapper {
            padding: 0 var(--space-lg);
            /* Width controlled by content-aligner */
        }

        .input-border-wrapper {
            background-color: var(--color-bg-message);
            border: 1px solid var(--color-border);
            padding: 4px;
            border-radius: var(--radius-xl);
            width: var(--w-full);
            position: relative;
        }

        /* ENHANCED INPUT BOX */
        .enhanced-input-box {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-md) 14px;
            background-color: var(--color-bg-main);
            display: block;
            box-shadow: var(--shadow-sm);
            transition: border-color var(--transition-speed-normal);
            position: relative;
        }

        .enhanced-input-box:focus-within {
            border-color: var(--color-border-hover);
        }

        /* POPUP MENU & PROMPT SHEET */
        .popup-menu,
        .prompt-sheet-inline {
            position: static;
            width: var(--w-full);
            display: flex;
            flex-direction: column;
            background: var(--color-bg-main);
            border-bottom: 0 solid var(--color-bg-surface);
            z-index: var(--z-overlay);
            overflow: hidden;

            /* Start Closed State */
            max-height: 0;
            opacity: 0;
            visibility: hidden;
            margin-bottom: 0;

            /* FIX: Removed padding in closed state to match open state */
            padding: 0;

            /* FIX: Targeted transition instead of 'all' to avoid padding animation artifacts */
            transition: max-height var(--transition-speed-slow) ease-in-out, opacity var(--transition-speed-slow) ease-in-out, margin var(--transition-speed-slow) ease-in-out, visibility var(--transition-speed-slow);
        }

        /* Visible State */
        .popup-menu.visible,
        .prompt-sheet-inline.visible {
            max-height: var(--popup-max-height);
            opacity: 1;
            visibility: visible;
            margin-bottom: 8px;
            border-bottom-width: 1px;
            padding: 0px;
        }

        .popup-header {
            padding: var(--space-xs) var(--space-md) var(--space-md) var(--space-xs);
            font-size: var(--font-md);
            font-weight: 600;
            color: var(--color-text-heading);
            letter-spacing: 0.01em;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: none;
        }

        .popup-header button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-main);
            display: flex;
            align-items: center;
            margin-right: 0;
        }

        .popup-header button:hover {
            color: var(--color-text-heading);
        }

        .popup-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .popup-list {
            flex: 1;
            overflow-y: auto;
            padding: 0px;
        }


        .popup-item {
            padding: var(--space-10) var(--space-md);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--color-text-main);
            transition: background var(--transition-speed-fast);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* Corrected from space-between */
            gap: var(--space-10);
            border-radius: var(--radius-sm);
        }

        .popup-item:hover {
            background-color: var(--color-bg-hover);
            color: var(--color-text-heading);
        }

        .popup-item svg {
            width: var(--icon-md);
            height: var(--icon-md);
            min-width: var(--icon-md);
            min-height: var(--icon-md);
            color: var(--color-text-muted);
            flex-shrink: 0;
        }

        /* --- ATTACHMENT AREA --- */
        .attachment-area {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            width: var(--w-full);
            padding-bottom: 4px;
            /* Space between attachments and text */
        }

        .attachment-area:empty {
            display: none;
            padding-bottom: 0;
        }

        /* --- ATTACHMENT PILL --- */
        /* --- ATTACHMENT PILL --- */
        .attachment-pill {
            display: inline-flex;
            align-items: center;
            background-color: var(--color-bg-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 2px 8px 2px var(--space-s);
            margin-right: var(--space-s);
            font-size: 0.85rem;
            color: var(--color-text-heading);
            user-select: none;
            cursor: default;
            vertical-align: middle;
            gap: var(--space-s);
            max-width: var(--w-full);
            /* Prevent overflow */
        }

        .attachment-pill>span:first-of-type {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        .attachment-pill svg {
            width: var(--icon-sm);
            height: var(--icon-sm);
            color: var(--color-text-subtle);
            flex-shrink: 0;
        }

        .attachment-remove {
            cursor: pointer;
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            margin-left: 2px;
            flex-shrink: 0;
        }

        .attachment-remove:hover {
            color: var(--color-danger);
        }

        /* Context Menu Item Specifics (using .popup-item but with inner structure) */
        .popup-item.context-row-item {
            justify-content: space-between;
            /* Allow spread for muted tag */
        }

        .popup-item-left-group {
            display: flex;
            align-items: center;
            gap: var(--space-10);
            flex: 1;
        }

        /* Right side container for muted text */
        .popup-item-right {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-left: auto;
        }

        .muted-tag {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            font-weight: 500;
            background: var(--color-bg-surface);
            padding: 2px var(--space-s);
            border-radius: var(--radius-xs);
        }

        /* Multi-select checkmark styling */
        .context-checkbox {
            color: #D1D5DB;
            /* Default grey */
            transition: color var(--transition-speed-normal);
        }

        .popup-item.selected .context-checkbox {
            color: var(--color-primary);
            /* Green when selected */
        }

        /* No background change on selection as requested */

        /* NEW: Section Title in Popup */
        .popup-section-title {
            padding: var(--space-md) var(--space-md) 4px var(--space-md);
            font-size: 0.75rem;
            color: var(--color-text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* NEW: Menu Divider */
        .menu-divider {
            height: 1px;
            background-color: var(--color-bg-surface);
            margin: var(--space-s) 0;
            flex-shrink: 0;
        }

        .prompt-item {
            padding: var(--space-sm);
            cursor: pointer;
            transition: background var(--transition-speed-normal);
            display: flex;
            flex-direction: column;
            gap: 2px;
            border-radius: 6px;
        }

        .prompt-item:hover {
            background-color: var(--color-bg-hover);
        }

        .prompt-item-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-heading);
        }

        .prompt-item-desc {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            line-height: 1.4;
        }

        .prompt-filters {
            display: flex;
            gap: var(--space-sm);
            padding: 4px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            flex-shrink: 0;
        }

        .prompt-filters::-webkit-scrollbar {
            display: none;
        }

        .filter-pill {
            padding: var(--space-xs) var(--space-10);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid #E2E8F0;
            background: #fff;
            color: #969AA3;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .filter-pill:hover {
            background-color: #F8FAFC;
            color: #444F5C;
        }

        .filter-pill.active {
            background-color: #EEF2F6;
            color: #161616;
            border-color: #CBD5E0;
        }

        .vin-item {
            padding: var(--space-sm) var(--space-md);
            cursor: pointer;
            transition: background 0.1s;
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            border-radius: 6px;
        }

        .vin-item:hover {
            background-color: #F8FAFC;
        }

        .vin-icon {
            margin-top: 2px;
            color: #969AA3;
        }

        .vin-icon svg {
            width: var(--icon-md);
            height: var(--icon-md);
        }

        .vin-details {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .vin-text {
            font-weight: 500;
            color: #444F5C;
            font-size: 0.9rem;
        }

        .vin-desc {
            color: #969AA3;
            font-size: 0.8rem;
        }

        .popup-search-container {
            padding: var(--space-md);
            border-top: 1px solid #F1F5F9;
            background: #fff;
            flex-shrink: 0;
        }

        /* UPDATED: Search Input Wrapper with Clear Button */
        .popup-search-input-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: #fff;
            border: 1px solid #CBD5E0;
            border-radius: 6px;
            padding: var(--space-sm) var(--space-10);
            transition: border-color 0.2s, box-shadow 0.2s;
            position: relative;
            /* For clear btn */
        }

        .popup-search-input-wrapper:focus-within {
            border-color: #00BFA5;
            box-shadow: 0 0 0 3px rgba(0, 191, 165, 0.1);
        }

        .popup-search-input-wrapper svg {
            width: var(--icon-md);
            height: var(--icon-md);
            min-width: var(--icon-md);
            min-height: var(--icon-md);
            color: #969AA3;
        }

        .popup-search-input-wrapper input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.9rem;
            color: #161616;
            background: transparent;
            padding-right: 20px;
        }

        .search-clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #969AA3;
            cursor: pointer;
            display: none;
            padding: 4px;
            z-index: 5;
        }

        .search-clear-btn:hover {
            color: #444F5C;
        }

        .search-clear-btn.visible {
            display: block;
        }

        /* Content Editable Div Input */
        .input-container {
            width: 100%;
            border: none;
            background: transparent;
            padding: 0;
            margin-bottom: 8px;
        }

        /* Changed min-height to 40px per user request */
        .main-input {
            width: 100%;
            min-height: 40px;
            max-height: 120px;
            overflow-y: auto;
            outline: none;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #161616;
            font-family: inherit;
        }

        .main-input:empty::before {
            content: attr(data-placeholder);
            color: #969AA3;
            pointer-events: none;
            display: block;
        }

        .prompt-var {
            color: #7C3AED;
            background: #F3E8FF;
            padding: 0 4px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
        }

        .filled-var {
            color: #2563EB;
            font-weight: 500;
        }

        /* New CSS for Microphone Listening Placeholder and Waveform */
        .listening-ui {
            display: flex;
            align-items: center;
            gap: 12px;
            height: 100%;
            padding: 4px 0;
        }

        .wave-container {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 16px;
        }

        /* Updated Wave Bar with Gradient */
        .wave-bar {
            width: 3px;
            /* Updated to Purple Gradient */
            background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
            border-radius: 4px;
            animation: quiet 1s ease-in-out infinite;
        }

        .wave-bar:nth-child(1) {
            height: 8px;
            animation-duration: 0.8s;
        }

        .wave-bar:nth-child(2) {
            height: 12px;
            animation-duration: 1.1s;
        }

        .wave-bar:nth-child(3) {
            height: 16px;
            animation-duration: 1.3s;
        }

        .wave-bar:nth-child(4) {
            height: 10px;
            animation-duration: 0.9s;
        }

        .wave-bar:nth-child(5) {
            height: 6px;
            animation-duration: 1.2s;
        }

        .listening-ui.active .wave-bar {
            animation-name: loud;
        }

        @keyframes loud {
            0% {
                transform: scaleY(0.4);
            }

            50% {
                transform: scaleY(1.2);
            }

            100% {
                transform: scaleY(0.4);
            }
        }

        .listening-label {
            color: #7C3AED;
            /* Purple */
            font-weight: 500;
            font-size: 0.95rem;
        }

        /* Mic Button Active State */
        .tool-icon-btn.mic-active {
            color: #7C3AED;
            /* Purple */
            background-color: #F3E8FF;
            /* Light Purple BG */
        }

        .tool-icon-btn.mic-active svg {
            animation: micPulse 1.5s infinite;
        }

        @keyframes micPulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
            }

            100% {
                transform: scale(1);
            }
        }

        .input-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid transparent;
        }

        .toolbar-left,
        .toolbar-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tool-icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: var(--space-s);
            border-radius: 6px;
            color: #969AA3;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s, background 0.2s;
        }

        .tool-icon-btn:hover {
            background-color: #F7FAFC;
            color: #444F5C;
        }

        .tool-icon-btn:disabled {
            opacity: 0.3;
            cursor: default;
        }

        .tool-icon-btn:disabled:hover {
            background: transparent;
            color: #D4D5D6;
        }

        .tool-icon-btn svg {
            width: 18px;
            height: 18px;
            stroke-width: var(--stroke-normal);
        }

        /* New Disclaimer Style */
        .disclaimer-text {
            font-size: 11px;
            color: #969AA3;
            text-align: center;
            margin-top: 8px;
        }

        .send-btn-square {
            width: 32px;
            height: 32px;
            background-color: #F1F5F9;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #969AA3;
            transition: all 0.2s;
        }

        .send-btn-square:hover {
            background-color: #E2E8F0;
            color: #444F5C;
        }

        .send-btn-square.active {
            background-color: rgba(0, 191, 165, 0.1);
            color: #00BFA5;
        }

        /* Disabled State */
        .send-btn-square:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            background-color: #F1F5F9;
            color: #D4D5D6;
        }

        .send-btn-square svg {
            width: var(--icon-md);
            height: var(--icon-md);
            stroke-width: 2px;
        }

        @keyframes spinPulse {
            0% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }

            50% {
                transform: rotate(180deg) scale(0.8);
                opacity: 0.7;
            }

            100% {
                transform: rotate(360deg) scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeText {
            0% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- UNIFIED CONTEXT PILL --- */
        .context-row {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
            margin-bottom: 0;
            min-height: auto;
        }

        /* Context row at top of input */
        .context-row-top {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-border);
        }


        .unified-pill {
            display: inline-flex;
            align-items: center;
            background-color: #EFF6FF;
            border: 1px solid #DBEAFE;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #161616;
            overflow: hidden;
            transition: all 0.2s;
            user-select: none;
        }

        /* Updated Empty State Style: Grey & Solid Border */
        .unified-pill.empty {
            background-color: #F7FAFC;
            /* Grey background */
            border: 1px solid #E2E8F0;
            /* Normal solid border */
            color: #444F5C;
            cursor: pointer;
        }

        .unified-pill.empty:hover {
            background-color: #EDF2F7;
            border-color: #CBD5E0;
        }

        .pill-part {
            padding: var(--space-s) var(--space-10);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            cursor: pointer;
            transition: background 0.2s;
            height: 100%;
        }

        .pill-part:hover {
            background-color: rgba(37, 99, 235, 0.08);
        }

        /* Compact version for toolbar */
        .unified-pill-compact {
            font-size: 0.75rem;
            border-radius: 16px;
        }

        .unified-pill-compact .pill-part {
            padding: var(--space-xs) var(--space-sm);
            gap: 3px;
        }


        .pill-part svg {
            width: 14px;
            height: 14px;
            stroke-width: 2.5px;
        }

        /* Add part specific - Icon Color Changed to #161616 */
        .pill-part.main {
            padding: var(--space-s) var(--space-md);
            font-weight: 500;
        }

        .pill-part.add-trigger {
            color: #161616;
            font-weight: 500;
            padding-right: 8px;
        }

        /* Content part specific */
        .pill-part.content {
            font-weight: 500;
            padding-left: 8px;
            padding-right: 8px;
        }

        /* Close part specific */
        .pill-part.close {
            padding: var(--space-s) var(--space-sm);
            color: #969AA3;
        }

        .pill-part.close:hover {
            background-color: rgba(229, 62, 62, 0.1);
            color: #E53E3E;
        }

        .pill-divider {
            width: 1px;
            height: 14px;
            background-color: #BFDBFE;
        }

        /* --- SKELETON --- */
        .table-skeleton-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #fff;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            overflow: hidden;
        }

        .skeleton-row {
            display: grid;
            grid-template-columns: 2fr 3fr 2fr 2fr 2fr 1fr;
            gap: 24px;
            padding: 0 24px;
            border-bottom: 1px solid #F1F5F9;
            align-items: center;
            height: 50px;
        }

        .skeleton-row:last-child {
            border-bottom: none;
        }

        .skeleton-row.header {
            background-color: #F8FAFC;
            border-bottom: 1px solid #E2E8F0;
        }

        .skeleton-cell {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .skeleton-bar {
            height: 12px;
            background: #F1F5F9;
            border-radius: 6px;
            width: 100%;
        }

        .header .skeleton-bar {
            background: #E2E8F0;
        }

        /* --- MOBILE FAB (New) --- */
        .mobile-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00BFA5 0%, #00a690 100%);
            color: white;
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 16px rgba(0, 191, 165, 0.4);
            z-index: 10001;
            border: none;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s;
        }

        .mobile-fab:active {
            transform: scale(0.92);
        }

        .mobile-fab svg {
            width: 28px;
            height: 28px;
        }

        /* --- MEDIA QUERIES (MOBILE) --- */
        @media (max-width: 768px) {

            /* HIDE TOP & LEFT NAV */
            .global-top-nav,
            .global-side-nav,
            .main-content {
                display: none !important;
            }

            /* FORCE CHAT SIDEBAR FULLSCREEN */
            .chat-sidebar {
                width: 100% !important;
                height: 85% !important;
                /* Bottom Sheet Height */
                position: fixed !important;
                left: 0 !important;
                top: auto !important;
                /* Move to bottom */
                bottom: 0 !important;
                border-radius: 24px 24px 0 0 !important;
                /* Rounded Top Corners */
                border: none !important;
                z-index: 9999;
                display: flex !important;
                flex-direction: column;

                /* ANIMATION PROPS */
                transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease, border-radius 0.3s ease !important;
                transform-origin: bottom right !important;
                transform: scale(1) translate(0, 0) !important;
                opacity: 1 !important;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15) !important;
            }

            /* Closed State for Mobile - Animate out to FAB */
            .chat-sidebar.state-closed {
                display: flex !important;
                transform: scale(0) translate(20px, 20px) !important;
                opacity: 0 !important;
                pointer-events: none !important;
                border-radius: 100% !important;
            }

            /* Show FAB when visible class is added */
            .mobile-fab.visible {
                display: flex;
                animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }


            .footer-container {
                padding: 12px 0px !important;
                position: relative;
                bottom: auto;
                left: auto;
            }


            .suggestions-list {
                margin-bottom: 2px !important;
                padding-bottom: 0 !important;
            }


            .scroll-spacer {
                height: 60px !important;
            }



            /* HISTORY SHEET OVERRIDES FOR MOBILE */
            /* Force history sheet to behave like a drawer on mobile, even if parent says fullscreen */
            .chat-sidebar.state-fullscreen .history-sheet {
                transform: translateX(-100%) !important;
                /* Start closed */
                width: 100% !important;
                border-right: none !important;
                z-index: 50 !important;
                border-radius: 24px 24px 0 0 !important;
                /* Match Parent */
            }

            .chat-sidebar.state-fullscreen .history-sheet.open {
                transform: translateX(0) !important;
                /* Open when class added */
            }

            /* Ensure Back Button is Visible on Mobile */
            .chat-sidebar.state-fullscreen .history-back-btn {
                display: flex !important;
            }

            .chat-sidebar.state-fullscreen #btnShowHistory {
                display: flex !important;
            }

            /* Reset Fullscreen Layout shifts */
            .chat-sidebar.state-fullscreen .nav-header,
            .chat-sidebar.state-fullscreen .chat-scroll-area,
            .chat-sidebar.state-fullscreen .footer-container {
                margin-left: 0 !important;
                width: 100% !important;
                border-left: none !important;
            }

            .main-view-wrapper {
                min-width: 100% !important;
                width: 100% !important;
                padding: 0 !important;
                opacity: 1 !important;
                visibility: visible !important;
                pointer-events: auto !important;
            }

            .input-wrapper {
                padding: 0 !important;
            }

            .chat-card-container {
                border-radius: 0px !important;
                /* CHANGED per request */
                box-shadow: none !important;
                height: 100% !important;
            }

            /* HIDE DRAG HANDLE ONLY */
            .drag-handle {
                display: none !important;
            }

            /* ADJUST WINDOW CONTROLS: Hide all except Close */
            .window-controls {
                display: flex !important;
            }

            #btnMinimize,
            #btnFull,
            #btnDock {
                display: none !important;
            }

            #btnClose {
                display: flex !important;
            }

            /* Fix Widths */
            .content-aligner {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 16px !important;
            }

            .active-chat-wrapper {
                width: 100% !important;
                max-width: 100% !important;
            }

            /* Hide Minimized Wrapper elements */
            .minimized-view-wrapper {
                display: none !important;
            }

            /* Use Flex column for mobile layout to fix overlapping */
            .chat-card-container {
                display: flex;
                flex-direction: column;
            }

            .chat-scroll-area {
                flex: 1;
            }

            .footer-container {
                position: relative;
                /* Stack normally */
                bottom: auto;
                left: auto;
            }

            .scroll-spacer {
                display: none;
            }

            /* No spacer needed if stacked */
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            height: 100%;
            background-color: #fff;
            padding: 30px;
            text-align: center;
            transition: padding-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            overflow: hidden;
        }

        .main-content.pushed-by-dock {
            padding-left: 430px;
        }

        .main-content.full-hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <button id="mobileFab" class="mobile-fab" onclick="toggleMobileChat()">
        <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path>
        </svg>
    </button>

    <div class="modal-overlay" id="renameModal">
        <div class="modal-box">
            <div class="modal-title">Rename Chat</div>
            <input type="text" class="modal-input" id="renameInput" placeholder="Enter new name...">
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModals()">Cancel</button>
                <button class="modal-btn primary" onclick="saveRename()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-title">Delete Chat?</div>
            <p style="margin-bottom:20px; color:#444F5C; font-size:0.9rem;">Are you sure you want to delete this
                conversation? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModals()">Cancel</button>
                <button class="modal-btn danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div id="globalContextMenu">
        <button class="menu-item" id="btnPinItem" onclick="togglePin()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="12" y1="17" x2="12" y2="22"></line>
                <path
                    d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z">
                </path>
            </svg>
            <span id="pinText">Pin Chat</span>
        </button>
        <button class="menu-item" onclick="openRenameModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </svg>
            Rename
        </button>
        <button class="menu-item danger" onclick="openDeleteModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Delete
        </button>
    </div>

    <div class="layout-wrapper">
        <nav class="global-top-nav"></nav>
        <div class="main-row-wrapper">

            <nav class="global-side-nav">
                <button class="nav-toggle-btn active" id="navAiToggle" title="Toggle AI Assistant">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path>
                    </svg>
                </button>
                <button class="nav-toggle-btn">C</button>
                <button class="nav-toggle-btn">L</button>
                <button class="nav-toggle-btn">T</button>
                <button class="nav-toggle-btn">CH</button>
                <button class="nav-toggle-btn">D</button>
            </nav>

            <div class="app-container">

                <aside class="chat-sidebar state-docked" id="chatPanel">

                    <div class="minimized-view-wrapper">
                        <div class="min-left-group">
                            <div class="drag-handle" id="dragHandle">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <circle cx="9" cy="5" r="1.5" />
                                    <circle cx="9" cy="12" r="1.5" />
                                    <circle cx="9" cy="19" r="1.5" />
                                    <circle cx="15" cy="5" r="1.5" />
                                    <circle cx="15" cy="12" r="1.5" />
                                    <circle cx="15" cy="19" r="1.5" />
                                </svg>
                            </div>
                            <div class="min-brand">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"
                                    style="color: #00BFA5;">
                                    <path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path>
                                </svg>
                                <span>AI Assistant</span>
                            </div>
                        </div>
                        <div class="min-controls">
                            <button class="min-btn" id="btnRestoreMin"><svg width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2.5">
                                    <polyline points="18 15 12 9 6 15"></polyline>
                                </svg></button>
                            <button class="min-btn" id="btnCloseMin"><svg width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2.5">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg></button>
                        </div>
                    </div>

                    <div class="main-view-wrapper">

                        <div class="top-bar">
                            <div class="brand-text">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"
                                    style="color: #00BFA5;">
                                    <path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path>
                                </svg>
                                AI Assistant
                            </div>
                            <div class="window-controls">
                                <button class="win-btn" id="btnMinimize"><svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg></button>
                                <button class="win-btn" id="btnFull"><svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <polyline points="9 21 3 21 3 15"></polyline>
                                        <line x1="21" y1="3" x2="14" y2="10"></line>
                                        <line x1="3" y1="21" x2="10" y2="14"></line>
                                    </svg></button>
                                <button class="win-btn" id="btnDock" style="display:none;"><svg viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="9" y1="3" x2="9" y2="21"></line>
                                    </svg></button>
                                <button class="win-btn" id="btnClose"><svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg></button>
                            </div>
                        </div>

                        <div class="chat-card-container">

                            <div class="nav-header">
                                <button class="action-btn" id="btnShowHistory" title="History">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round" stroke-width="2">
                                        <line x1="3" y1="12" x2="21" y2="12"></line>
                                        <line x1="3" y1="6" x2="21" y2="6"></line>
                                        <line x1="3" y1="18" x2="21" y2="18"></line>
                                    </svg>
                                </button>
                                <div class="chat-title">New Chat</div>

                                <button class="action-btn" id="btnHeaderNewChat" title="New Chat" disabled
                                    style="margin-right: 4px;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z" />
                                        <path d="M8 12h8" />
                                        <path d="M12 8v8" />
                                    </svg>
                                </button>

                                <div id="chatMenuContainer">
                                    <button class="action-btn" id="btnChatMenu" title="Menu" disabled>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="1"></circle>
                                            <circle cx="12" cy="5" r="1"></circle>
                                            <circle cx="12" cy="19" r="1"></circle>
                                        </svg>
                                    </button>
                                    <div class="menu-dropdown" id="chatDropdown">
                                        <button class="menu-item" onclick="togglePinFromHeader()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <line x1="12" y1="17" x2="12" y2="22"></line>
                                                <path
                                                    d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z">
                                                </path>
                                            </svg>
                                            <span id="headerPinText">Pin Chat</span>
                                        </button>
                                        <button class="menu-item" onclick="openRenameModalFromHeader()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z">
                                                </path>
                                            </svg>
                                            Rename
                                        </button>
                                        <button class="menu-item danger" onclick="openDeleteModalFromHeader()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path
                                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                                </path>
                                            </svg>
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="history-sheet" id="historySheet">
                                <div class="history-header">
                                    <button class="history-back-btn" id="btnCloseHistory"><svg width="20" height="20"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="19" y1="12" x2="5" y2="12"></line>
                                            <polyline points="12 19 5 12 12 5"></polyline>
                                        </svg></button>
                                    <div class="history-title">My Chats</div>
                                    <button class="history-new-chat-btn" id="btnHistoryNewChat"><svg viewBox="0 0 24 24"
                                            fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z" />
                                            <path d="M8 12h8" />
                                            <path d="M12 8v8" />
                                        </svg></button>
                                </div>
                                <div class="history-search-wrapper">
                                    <div class="history-search-box" id="historySearchWrapper">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        </svg>
                                        <input type="text" placeholder="Search chats..." id="historySearchInput">
                                    </div>
                                </div>
                                <div class="history-content">
                                    <div class="history-section-title">Pinned</div>
                                    <div id="pinnedList">
                                        <div class="history-item" onclick="loadHistoryChat('Monthly Sales Review')">
                                            <div class="history-item-left">
                                                <span class="history-text">Monthly Sales Review</span>
                                            </div>
                                            <button class="history-item-menu-btn" onclick="showItemMenu(event)">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2">
                                                    <circle cx="12" cy="12" r="1"></circle>
                                                    <circle cx="12" cy="5" r="1"></circle>
                                                    <circle cx="12" cy="19" r="1"></circle>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="history-section-title" id="historyTodaySection">Today</div>
                                    <div id="historyPlaceholder" class="history-placeholder">No active chats</div>
                                    <div id="todayList">
                                        <div class="history-item" onclick="loadHistoryChat('Tesla Fleet Inquiry')">
                                            <div class="history-item-left"><span class="history-text">Tesla Fleet
                                                    Inquiry</span></div>
                                            <button class="history-item-menu-btn" onclick="showItemMenu(event)"><svg
                                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2">
                                                    <circle cx="12" cy="12" r="1"></circle>
                                                    <circle cx="12" cy="5" r="1"></circle>
                                                    <circle cx="12" cy="19" r="1"></circle>
                                                </svg></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="history-footer">
                                    <span>Prompt Templates</span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </div>
                            </div>

                            <div class="chat-scroll-area">
                                <div class="empty-state-wrapper" id="emptyState">
                                    <div class="empty-state-content content-aligner">
                                        <div class="empty-icon"><svg width="28" height="28" viewBox="0 0 24 24"
                                                fill="currentColor">
                                                <path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path>
                                            </svg></div>
                                        <h2 class="greeting-title">Hi John,</h2>
                                        <p class="greeting-subtitle">How can I help you today?</p>
                                    </div>
                                </div>
                                <div class="active-chat-wrapper content-aligner" id="activeChat"></div>

                                <div class="suggestions-list content-aligner" id="suggestionsList">
                                    <div class="suggestion-item" onclick="startChat('Summarize recent hot leads')">
                                        Summarize recent hot leads</div>
                                    <div class="suggestion-item" onclick="startChat('Draft quote for Model X')">Draft
                                        quote for Model X</div>
                                    <div class="suggestion-item" onclick="startChat('List high-priority test drives')">
                                        List high-priority test drives for today</div>
                                </div>
                                <div class="scroll-spacer"></div>
                            </div>

                            <div class="footer-container">
                                <div class="input-wrapper content-aligner">
                                    <div class="input-border-wrapper">
                                        <div class="enhanced-input-box" id="enhancedInputBox">

                                            <div id="promptSheet" class="prompt-sheet-inline">
                                                <div class="popup-header">
                                                    <span>Prompt Templates</span>
                                                    <button style="border:none; background:transparent; cursor:pointer;"
                                                        onclick="closePromptSheet()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="#969AA3" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>

                                                <div class="prompt-filters">
                                                    <button class="filter-pill active"
                                                        onclick="filterPrompts(this, 'CRM')">CRM</button>
                                                    <button class="filter-pill"
                                                        onclick="filterPrompts(this, 'Sales')">Sales</button>
                                                    <button class="filter-pill"
                                                        onclick="filterPrompts(this, 'Service')">Service</button>
                                                    <button class="filter-pill"
                                                        onclick="filterPrompts(this, 'Parts')">Parts</button>
                                                    <button class="filter-pill"
                                                        onclick="filterPrompts(this, 'Accounting')">Accounting</button>
                                                </div>

                                                <div class="popup-list" id="promptList"></div>

                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper" id="promptSearchWrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                        </svg>
                                                        <input type="text" placeholder="Search prompts..."
                                                            id="promptSearchInput">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="contextMenu" class="popup-menu">
                                                <div class="popup-header">
                                                    <div class="popup-header-left">
                                                        <button id="btnContextBack" style="display:none;"
                                                            onclick="goBackContext()">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2">
                                                                <line x1="19" y1="12" x2="5" y2="12"></line>
                                                                <polyline points="12 19 5 12 12 5"></polyline>
                                                            </svg>
                                                        </button>
                                                        <span id="contextTitle">Add Context</span>
                                                    </div>
                                                    <button onclick="closeAllMenus()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="#969AA3" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>

                                                <div class="popup-list" id="contextList"></div>

                                                <div class="popup-search-container" id="contextSearchContainer"
                                                    style="display:none;">
                                                    <div class="popup-search-input-wrapper" id="contextSearchWrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                        </svg>
                                                        <input type="text" id="contextSearchInput"
                                                            placeholder="Search... or Paste a link">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="customerMenu" class="popup-menu">
                                                <div class="popup-header">
                                                    <span>Customers</span>
                                                    <button onclick="closeAllMenus()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="#969AA3" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="popup-list" id="customerList"></div>
                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper" id="customerSearchWrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                        </svg>
                                                        <input type="text" id="customerSearchInput"
                                                            placeholder="Search Customers...">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="vehicleMenu" class="popup-menu">
                                                <div class="popup-header">
                                                    <span>Vehicles</span>
                                                    <button onclick="closeAllMenus()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="#969AA3" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="popup-list" id="vehicleList"></div>
                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper" id="vehicleSearchWrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                        </svg>
                                                        <input type="text" id="vehicleSearchInput"
                                                            placeholder="Search Vehicles">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="vinMenu" class="popup-menu">
                                                <div class="popup-header">
                                                    <span>VIN</span>
                                                    <button onclick="closeAllMenus()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="#969AA3" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="popup-list" id="vinList"></div>
                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper" id="vinSearchWrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                        </svg>
                                                        <input type="text" id="vinSearchInput"
                                                            placeholder="Search VIN...">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="datetimeMenu" class="popup-menu">
                                                <div class="popup-header">
                                                    <span>Available Slots</span>
                                                    <button onclick="closeAllMenus()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="#969AA3" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="popup-list" id="datetimeList"></div>
                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper" id="datetimeSearchWrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                        </svg>
                                                        <input type="text" id="datetimeSearchInput"
                                                            placeholder="Search Date & Time...">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- LISTENING OVERLAY -->
                                            <div class="listening-overlay" id="listeningOverlay">
                                                <button class="listen-close-btn" id="btnListenClose">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                        stroke-linejoin="round">
                                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                                    </svg>
                                                </button>
                                                <div class="listen-visualizer">
                                                    <!-- Dynamic bars will be handled via CSS/JS or static repetitive HTML -->
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                </div>
                                                <div class="listen-right-group">
                                                    <div class="listen-timer" id="listenTimer">00:00</div>
                                                    <button class="listen-stop-btn" id="btnListenStop">
                                                        <svg width="12" height="12" viewBox="0 0 24 24"
                                                            fill="currentColor">
                                                            <rect x="2" y="2" width="20" height="20" rx="4"></rect>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>



                                            <!-- Input Container (Middle Line) -->
                                            <div class="input-container">
                                                <div id="attachmentArea" class="attachment-area"></div>
                                                <div id="mainInput" class="main-input" contenteditable="true"
                                                    data-placeholder="Ask  Find  Summarize"></div>
                                            </div>

                                            <!-- Toolbar (Bottom Line) -->
                                            <div class="input-toolbar">
                                                <div class="toolbar-left">
                                                    <button class="tool-icon-btn" id="btnSlashMenu"
                                                        title="Open Templates">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                            stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2">
                                                            <rect x="3" y="3" width="18" height="18" rx="4" ry="4">
                                                            </rect>
                                                            <line x1="10" y1="16" x2="14" y2="8"></line>
                                                        </svg>
                                                    </button>
                                                    <button class="tool-icon-btn" title="Attach" id="btnAttach">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                            stroke-linecap="round" stroke-linejoin="round">
                                                            <path
                                                                d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                                                            </path>
                                                        </svg>
                                                    </button>
                                                    <input type="file" id="fileInput" style="display: none;" />
                                                </div>
                                                <div class="toolbar-right">
                                                    <!-- Context Pill (Compact) -->
                                                    <div class="unified-pill empty unified-pill-compact"
                                                        id="unifiedContextPill" onclick="showContextMenu(event)">
                                                        <div class="pill-part main">
                                                            <span>Context</span>
                                                        </div>
                                                    </div>
                                                    <button class="tool-icon-btn" id="btnMic"><svg viewBox="0 0 24 24"
                                                            fill="none" stroke="currentColor" stroke-linecap="round"
                                                            stroke-linejoin="round">
                                                            <path
                                                                d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z">
                                                            </path>
                                                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                                            <line x1="12" y1="19" x2="12" y2="23"></line>
                                                            <line x1="8" y1="23" x2="16" y2="23"></line>
                                                        </svg></button>
                                                    <button class="send-btn-square" id="btnSend" disabled><svg
                                                            viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                            stroke-linecap="round" stroke-linejoin="round">
                                                            <line x1="12" y1="19" x2="12" y2="5"></line>
                                                            <polyline points="5 12 12 5 19 12"></polyline>
                                                        </svg></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="disclaimer-text content-aligner">AI Assistant can make mistakes, so
                                        please verify responses.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>

                <main class="main-content pushed-by-dock" id="mainContent">
                    <div class="table-skeleton-container">
                        <div class="skeleton-row header">
                            <div class="skeleton-cell">
                                <div class="skeleton-bar"></div>
                            </div>
                            <div class="skeleton-cell">
                                <div class="skeleton-bar"></div>
                            </div>
                            <div class="skeleton-cell">
                                <div class="skeleton-bar"></div>
                            </div>
                            <div class="skeleton-cell">
                                <div class="skeleton-bar"></div>
                            </div>
                            <div class="skeleton-cell">
                                <div class="skeleton-bar"></div>
                            </div>
                            <div class="skeleton-cell">
                                <div class="skeleton-bar"></div>
                            </div>
                        </div>
                        <div class="top-bar" style="border:none; padding: 0 16px;">
                            <div class="window-controls">
                                <button class="win-btn" id="btnDock" style="display:none;"><svg viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="9" y1="3" x2="9" y2="21"></line>
                                    </svg></button>
                                <button class="win-btn" id="btnFull" style="display:none;"><svg viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <polyline points="9 21 3 21 3 15"></polyline>
                                        <line x1="21" y1="3" x2="14" y2="10"></line>
                                        <line x1="3" y1="21" x2="10" y2="14"></line>
                                    </svg></button>
                                <button class="win-btn" id="btnClose" style="display:none;"><svg viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg></button>
                            </div>
                        </div>
                        <script>
                            for (let i = 0; i < 20; i++) {
                                let cellsHtml = '';
                                for (let j = 0; j < 6; j++) {
                                    const width = 50 + Math.random() * 50;
                                    cellsHtml += `<div class="skeleton-cell"><div class="skeleton-bar" style="width: ${width}%"></div></div>`;
                                }
                                document.write(`<div class="skeleton-row">${cellsHtml}</div>`);
                            }
                        </script>
                    </div>
                </main>

            </div>
        </div>
    </div>

    <script>
        const panel = document.getElementById('chatPanel');
        const mainContent = document.getElementById('mainContent');
        const btnMinimize = document.getElementById('btnMinimize');
        const btnRestoreMin = document.getElementById('btnRestoreMin');
        const btnCloseMin = document.getElementById('btnCloseMin');
        const btnFull = document.getElementById('btnFull');
        const btnDock = document.getElementById('btnDock');
        const btnClose = document.getElementById('btnClose');
        const navAiToggle = document.getElementById('navAiToggle');

        // Mobile FAB
        const mobileFab = document.getElementById('mobileFab');

        // Context Elements
        const contextRow = document.getElementById('contextRow');
        const unifiedContextPill = document.getElementById('unifiedContextPill');

        // Context Menu Popups
        const contextMenu = document.getElementById('contextMenu');
        const contextList = document.getElementById('contextList');
        const btnContextBack = document.getElementById('btnContextBack');
        const contextTitle = document.getElementById('contextTitle');
        const contextSearchContainer = document.getElementById('contextSearchContainer');
        const contextSearchInput = document.getElementById('contextSearchInput');

        const historySheet = document.getElementById('historySheet');
        const btnShowHistory = document.getElementById('btnShowHistory');
        const btnCloseHistory = document.getElementById('btnCloseHistory');
        const btnHistoryNewChat = document.getElementById('btnHistoryNewChat');
        const historyPlaceholder = document.getElementById('historyPlaceholder');

        const emptyState = document.getElementById('emptyState');
        const activeChat = document.getElementById('activeChat');
        const chatScrollArea = document.querySelector('.chat-scroll-area');
        const chatTitle = document.querySelector('.chat-title');

        // Lists
        const pinnedList = document.getElementById('pinnedList');
        const todayList = document.getElementById('todayList');
        const suggestionsList = document.getElementById('suggestionsList');

        const btnSlashMenu = document.getElementById('btnSlashMenu');
        const promptSheet = document.getElementById('promptSheet');
        const promptList = document.getElementById('promptList');
        const dragHandle = document.getElementById('dragHandle');

        // Input
        const mainInput = document.getElementById('mainInput');
        const btnSend = document.getElementById('btnSend');
        const btnMic = document.getElementById('btnMic');
        const btnAttach = document.getElementById('btnAttach');
        const fileInput = document.getElementById('fileInput');
        const attachmentArea = document.getElementById('attachmentArea');
        const listeningOverlay = document.getElementById('listeningOverlay');
        const btnListenClose = document.getElementById('btnListenClose');
        const btnListenStop = document.getElementById('btnListenStop');
        const listenTimer = document.getElementById('listenTimer');
        const enhancedInputBox = document.getElementById('enhancedInputBox');

        // Menu Elements
        const globalContextMenu = document.getElementById('globalContextMenu');
        const pinText = document.getElementById('pinText');

        const btnChatMenu = document.getElementById('btnChatMenu');
        const chatDropdown = document.getElementById('chatDropdown');
        const chatMenuContainer = document.getElementById('chatMenuContainer');
        const headerPinText = document.getElementById('headerPinText');

        // Header New Chat Btn
        const btnHeaderNewChat = document.getElementById('btnHeaderNewChat');

        // Modals
        const renameModal = document.getElementById('renameModal');
        const renameInput = document.getElementById('renameInput');
        const deleteModal = document.getElementById('deleteModal');

        // Menu Elements
        const customerMenu = document.getElementById('customerMenu');
        const customerList = document.getElementById('customerList');
        const customerSearchInput = document.getElementById('customerSearchInput');

        const vehicleMenu = document.getElementById('vehicleMenu');
        const vehicleList = document.getElementById('vehicleList');
        const vehicleSearchInput = document.getElementById('vehicleSearchInput');

        const vinMenu = document.getElementById('vinMenu');
        const vinList = document.getElementById('vinList');
        const vinSearchInput = document.getElementById('vinSearchInput');

        const datetimeMenu = document.getElementById('datetimeMenu');
        const datetimeList = document.getElementById('datetimeList');
        const datetimeSearchInput = document.getElementById('datetimeSearchInput');

        const promptSearchInput = document.getElementById('promptSearchInput');

        let historyAdded = false;
        let currentItem = null;

        let isDragging = false;
        let startX, startLeft;

        let activePromptVar = null; // Track the span triggering the menu
        let currentActiveMenu = null;

        // Typing Controller
        let typingController = null;
        const btnSendIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>';
        const btnStopIcon = '<svg viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="6" width="12" height="12" rx="2" ry="2"></rect></svg>';

        // Data Placeholders
        const customers = ["James T. Kirk", "Sarah Connor", "Marty McFly", "Ellen Ripley", "Tony Stark"];
        const vehicles = ["2024 Toyota Camry SE", "2023 Ford F-150 XLT", "2024 Honda CR-V EX-L", "2023 Tesla Model Y Long Range", "2024 Chevrolet Silverado 1500 RST"];

        // Full VIN strings
        const vins = [
            { vin: "1G1RC6E45LU125678", desc: "2020 Chevy Malibu LT" },
            { vin: "5XYKTCA23MG112345", desc: "2021 Kia Telluride SX" },
            { vin: "JTEZU5JR8K3098765", desc: "2019 Toyota RAV4 LE" },
            { vin: "1FM5K8GC4LGB43210", desc: "2022 Ford Explorer ST" },
            { vin: "1N4AL3AP0NC155555", desc: "2023 Nissan Altima SR" }
        ];
        const datetimes = [
            "Oct 24, 2025 at 10:00 AM",
            "Oct 24, 2025 at 2:00 PM",
            "Oct 25, 2025 at 9:30 AM",
            "Oct 25, 2025 at 11:00 AM",
            "Oct 26, 2025 at 4:00 PM"
        ];

        // Prompts Data
        const promptsData = [
            { name: "/book-test-drive", desc: "Book a test drive appointment for [Vehicle] on [Date & Time].", text: "Book a test drive appointment for [Vehicle] on [Date & Time]" },
            { name: "/credit-pre-qual", desc: "Run a soft credit qualification check for [Customer] to determine eligibility.", text: "Run a soft credit qualification check for [Customer] to determine eligibility" },
            { name: "/inventory-check", desc: "Check stock availability for [Vehicle] across all lots available in the region.", text: "Check stock availability for [Vehicle] across all lots" },
            { name: "/trade-in-value", desc: "Estimate trade-in value for [VIN] assuming good condition.", text: "Estimate trade-in value for [VIN] assuming good condition" }
        ];

        // --- UPDATED DMS CONTEXT DATA (TRIMMED TO 5 RELEVANT ITEMS) ---
        // NOTE: "Leads" replaced "Current Page (Lead name 1)" with same ID for simplicity
        const dmsContextItems = [
            { id: 'deal1', label: "Deal #4492: 2024 Ford F-150", type: 'deal' },
            { id: 'ro1', label: "RO #10234: Brake Squeal Diag", type: 'service' },
            { id: 'inv1', label: "Stock #F22-001: 2022 Mustang GT", type: 'car' },
            { id: 'rpt1', label: "Report: EOM Sales Oct", type: 'report' },
            { id: 'lead1', label: "Lead #1023: John Doe (Model Y)", type: 'lead' }
        ];

        // "Leads" Item (Renamed from Current Page)
        // We will treat this as a special item in the list
        const leadsItem = { id: 'curr1', label: "Leads", type: 'page', isCurrent: true };

        // --- MULTI-SELECT STATE ---
        let selectedContexts = new Set(); // Stores IDs of selected items

        // --- GLOBAL SEND DISABLE STATE ---
        let isListening = false;

        // --- CLEAR INPUT HELPER ---
        function setupClearableInput(wrapperId) {
            const wrapper = document.getElementById(wrapperId);
            const input = wrapper.querySelector('input');

            // Create button
            const btn = document.createElement('button');
            btn.className = 'search-clear-btn';
            btn.innerHTML = '&times;'; // X char
            wrapper.appendChild(btn);

            // Logic
            const toggleBtn = () => {
                if (input.value.length > 0) btn.classList.add('visible');
                else btn.classList.remove('visible');
            };

            input.addEventListener('input', toggleBtn);

            btn.onclick = (e) => {
                e.stopPropagation();
                input.value = '';
                toggleBtn();
                input.focus();
                // Trigger input event to refresh list
                input.dispatchEvent(new Event('input'));
            };
        }

        // Initialize Clear Buttons
        setupClearableInput('historySearchWrapper');
        setupClearableInput('promptSearchWrapper');
        setupClearableInput('customerSearchWrapper');
        setupClearableInput('vehicleSearchWrapper');
        setupClearableInput('vinSearchWrapper');
        setupClearableInput('datetimeSearchWrapper');
        setupClearableInput('contextSearchWrapper');


        // --- FILTER LOGIC ---
        window.filterPrompts = function (btn, filterName) {
            const pills = document.querySelectorAll('.filter-pill');
            pills.forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- RENDER PROMPTS ---
        function renderPromptList(filter = "") {
            promptList.innerHTML = '';
            promptsData.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()) || p.desc.toLowerCase().includes(filter.toLowerCase())).forEach(p => {
                const div = document.createElement('div');
                div.className = 'prompt-item';
                div.onclick = () => fillInput(p.text);
                div.innerHTML = `
                    <div class="prompt-item-name">${p.name}</div>
                    <div class="prompt-item-desc">${p.desc}</div>
                `;
                promptList.appendChild(div);
            });
        }
        // Initial Render
        renderPromptList();


        // --- MENU LOGIC ---
        function renderCustomerList(filter = "") {
            customerList.innerHTML = '';
            customers.filter(c => c.toLowerCase().includes(filter.toLowerCase())).forEach(c => {
                const div = document.createElement('div');
                div.className = 'popup-item';
                div.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg> ${c}`;
                div.onclick = () => selectItem(c);
                customerList.appendChild(div);
            });
        }

        function renderVehicleList(filter = "") {
            vehicleList.innerHTML = '';
            vehicles.filter(v => v.toLowerCase().includes(filter.toLowerCase())).forEach(v => {
                const div = document.createElement('div');
                div.className = 'popup-item';
                div.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg> ${v}`;
                div.onclick = () => selectItem(v);
                vehicleList.appendChild(div);
            });
        }

        function renderVinList(filter = "") {
            vinList.innerHTML = '';
            vins.filter(item => item.vin.toLowerCase().includes(filter.toLowerCase()) || item.desc.toLowerCase().includes(filter.toLowerCase())).forEach(item => {
                const div = document.createElement('div');
                div.className = 'vin-item';
                div.innerHTML = `
                    <div class="vin-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 19H5v-5h14v5z"/></svg></div>
                    <div class="vin-details">
                        <div class="vin-text">${item.vin}</div>
                        <div class="vin-desc">${item.desc}</div>
                    </div>
                `;
                div.onclick = () => selectItem(item.vin);
                vinList.appendChild(div);
            });
        }

        function renderDateTimeList(filter = "") {
            datetimeList.innerHTML = '';
            datetimes.filter(d => d.toLowerCase().includes(filter.toLowerCase())).forEach(d => {
                const div = document.createElement('div');
                div.className = 'popup-item';
                div.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> ${d}`;
                div.onclick = () => selectItem(d);
                datetimeList.appendChild(div);
            });
        }

        function showMenu(menu, input, renderFn, targetElement) {
            closeAllMenus();

            if (input) {
                input.value = '';
                // Ensure clear button is hidden on reset
                const clearBtn = input.parentNode.querySelector('.search-clear-btn');
                if (clearBtn) clearBtn.classList.remove('visible');
            }
            if (renderFn) renderFn();

            // Just reveal it (positioned via CSS)
            menu.classList.add('visible');
            enhancedInputBox.classList.add('menu-open');

            if (input) setTimeout(() => input.focus(), 50);

            currentActiveMenu = menu;
        }

        function selectItem(text) {
            if (activePromptVar) {
                activePromptVar.innerText = text;
                activePromptVar.classList.remove('prompt-var');
                activePromptVar.classList.add('filled-var');
                closeAllMenus();
                activePromptVar = null;
                updateSendButton();

                // Auto-trigger next menu if available (Chaining)
                setTimeout(() => {
                    const nextVar = mainInput.querySelector('.prompt-var');
                    if (nextVar) {
                        const txt = nextVar.innerText.toLowerCase();
                        activePromptVar = nextVar;

                        setTimeout(() => {
                            if (txt === '[customer]') showMenu(customerMenu, customerSearchInput, () => renderCustomerList(), nextVar);
                            else if (txt === '[vehicle]') showMenu(vehicleMenu, vehicleSearchInput, () => renderVehicleList(), nextVar);
                            else if (txt === '[vin]') showMenu(vinMenu, vinSearchInput, () => renderVinList(), nextVar);
                            else if (txt === '[date & time]') showMenu(datetimeMenu, datetimeSearchInput, () => renderDateTimeList(), nextVar);
                        }, 600); // 600ms
                    }
                }, 150); // 150ms
            }
        }

        function closeAllMenus() {
            customerMenu.classList.remove('visible');
            vehicleMenu.classList.remove('visible');
            vinMenu.classList.remove('visible');
            datetimeMenu.classList.remove('visible');
            promptSheet.classList.remove('visible');
            contextMenu.classList.remove('visible');
            enhancedInputBox.classList.remove('menu-open');
            currentActiveMenu = null;
        }

        // Search Listeners
        customerSearchInput.addEventListener('input', (e) => renderCustomerList(e.target.value));
        vehicleSearchInput.addEventListener('input', (e) => renderVehicleList(e.target.value));
        vinSearchInput.addEventListener('input', (e) => renderVinList(e.target.value));
        datetimeSearchInput.addEventListener('input', (e) => renderDateTimeList(e.target.value));
        promptSearchInput.addEventListener('input', (e) => renderPromptList(e.target.value));
        contextSearchInput.addEventListener('input', (e) => renderContextList(e.target.value));

        // --- HELPER: Find History Item by Title ---
        function getActiveHistoryItem() {
            const title = chatTitle.innerText;
            const items = document.querySelectorAll('.history-text');
            for (let span of items) {
                if (span.innerText === title) {
                    return span.closest('.history-item');
                }
            }
            return null;
        }

        // --- HELPER: Check Empty List ---
        function checkEmptyHistory() {
            if (todayList.children.length === 0) {
                historyPlaceholder.classList.add('visible');
                document.getElementById('historyTodaySection').style.display = 'none';
            } else {
                historyPlaceholder.classList.remove('visible');
                document.getElementById('historyTodaySection').style.display = 'block';
            }
        }

        // --- MENU LOGIC ---
        window.showItemMenu = function (e) {
            e.stopPropagation();
            currentItem = e.currentTarget.closest('.history-item');

            const isPinned = currentItem.parentElement.id === 'pinnedList';
            pinText.innerText = isPinned ? 'Unpin Chat' : 'Pin Chat';

            const rect = e.currentTarget.getBoundingClientRect();
            globalContextMenu.style.top = (rect.bottom + 5) + 'px';
            globalContextMenu.style.left = (rect.left - 120) + 'px';
            globalContextMenu.classList.add('visible');

            chatDropdown.classList.remove('visible');
        };

        window.openRenameModalFromHeader = function () {
            currentItem = getActiveHistoryItem();
            openRenameModal();
        }

        window.openDeleteModalFromHeader = function () {
            currentItem = getActiveHistoryItem();
            openDeleteModal();
        }

        window.togglePinFromHeader = function () {
            currentItem = getActiveHistoryItem();
            if (currentItem) togglePin();
            chatDropdown.classList.remove('visible');
        };

        window.togglePin = function () {
            if (!currentItem) return;
            const isPinned = currentItem.parentElement.id === 'pinnedList';

            if (isPinned) {
                todayList.prepend(currentItem);
            } else {
                pinnedList.appendChild(currentItem);
            }
            globalContextMenu.classList.remove('visible');
            checkEmptyHistory();
        };

        // --- CONTEXT LOGIC (MULTI-SELECT) ---

        // Clicking Add button -> Open Context Menu
        // Now handled by onclick on the Unified Pill Container in JS

        window.showContextMenu = function (e) {
            if (e) e.stopPropagation();

            // Toggle behavior: if already open, close it
            if (contextMenu.classList.contains('visible')) {
                closeAllMenus();
            } else {
                closeAllMenus();
                renderContextList();
                contextMenu.classList.add('visible');
                enhancedInputBox.classList.add('menu-open');
            }
        };

        // Helper to get SVG for item type
        function getIconForType(type) {
            return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;
        }

        // Helper: Checkbox Icons
        const iconSquare = `<svg class="context-checkbox" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`;
        const iconChecked = `<svg class="context-checkbox" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>`;

        // Renders the Multi-Select List
        function renderContextList(filter = "") {
            contextList.innerHTML = '';
            contextTitle.innerText = "Add Context";
            btnContextBack.style.display = 'none';
            contextSearchContainer.style.display = 'block';

            const filterText = filter.toLowerCase();

            // Combined List: Recent Items + Leads Item (which was "Current Page")
            const allItems = [...dmsContextItems, leadsItem];

            const filteredItems = allItems.filter(item => item.label.toLowerCase().includes(filterText));

            filteredItems.forEach(item => {
                const isSelected = selectedContexts.has(item.id);

                const div = document.createElement('div');
                div.className = `popup-item context-row-item ${isSelected ? 'selected' : ''}`;

                let rightContent = '';
                // Special "Current Page" tag for Leads item
                if (item.isCurrent) {
                    rightContent = `<span class="muted-tag">Current Page</span>`;
                }

                // New Structure: [Checkbox] [Page Icon] [Name] ...... [Current Page Tag]
                div.innerHTML = `
                    <div class="popup-item-left-group">
                        ${isSelected ? iconChecked : iconSquare}
                        ${getIconForType(item.type)}
                        <span>${item.label}</span>
                    </div>
                    <div class="popup-item-right">
                        ${rightContent}
                    </div>
                `;

                // Toggle Logic
                div.onclick = (e) => {
                    e.stopPropagation();
                    toggleContextItem(item);
                };
                contextList.appendChild(div);
            });

            if (filter === "" && document.activeElement !== contextSearchInput) {
                setTimeout(() => contextSearchInput.focus(), 50);
            }
        }

        window.goBackContext = function () { }

        // Toggle Selection
        function toggleContextItem(item) {
            if (selectedContexts.has(item.id)) {
                selectedContexts.delete(item.id);
            } else {
                selectedContexts.add(item.id);
            }
            // Re-render list to show checked state immediately
            renderContextList(contextSearchInput.value);
            // Update the pill in the main view
            renderContextPills();
        }

        window.clearContext = function (e) {
            if (e) e.stopPropagation();
            selectedContexts.clear();
            renderContextPills();
            if (contextMenu.classList.contains('visible')) {
                renderContextList(contextSearchInput.value);
            }
        }

        // Render Unified Context Pill
        function renderContextPills() {
            const count = selectedContexts.size;

            // Reset Classes
            unifiedContextPill.className = 'unified-pill unified-pill-compact';
            unifiedContextPill.onclick = null; // Clear old listeners

            if (count === 0) {
                // State: None Selected -> [+ Add Context]
                unifiedContextPill.classList.add('empty');
                unifiedContextPill.innerHTML = `
                    <div class="pill-part main">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> 
                        <span>Context</span>
                    </div>
                `;
                unifiedContextPill.onclick = (e) => { e.stopPropagation(); showContextMenu(); };
            } else {
                // State: Selected (Single or Multi) -> [+ | Content | X]
                const allItems = [...dmsContextItems, leadsItem];
                let contentHTML = '';

                if (count === 1) {
                    const id = [...selectedContexts][0];
                    const item = allItems.find(i => i.id === id);
                    const label = item ? item.label : 'Unknown';
                    // Truncate based on sidebar state
                    const isFullscreen = document.getElementById('chatPanel').classList.contains('state-fullscreen');
                    const maxChars = isFullscreen ? 25 : 8;
                    const truncateAt = isFullscreen ? 23 : 8;
                    const displayLabel = label.length > maxChars ? label.substring(0, truncateAt) + '...' : label;
                    contentHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <span>${displayLabel}</span>
                    `;
                } else {
                    contentHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <span>${count} Pages</span>
                    `;
                }

                unifiedContextPill.innerHTML = `
                    <div class="pill-part content" onclick="showContextMenu(event)">
                        ${contentHTML}
                    </div>
                    <div class="pill-divider"></div>
                    <div class="pill-part close" onclick="clearContext(event)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </div>
                `;
            }
        }

        // Initial Render of Pill (Start with Leads Item Selected)
        selectedContexts.add(leadsItem.id);
        renderContextPills();

        // --- ATTACHMENT LOGIC ---
        btnAttach.onclick = () => {
            fileInput.click();
        };

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                // Show area
                attachmentArea.style.display = 'flex';

                // Create Pill
                const pill = document.createElement('span');
                pill.className = 'attachment-pill';
                // pill.contentEditable is not needed since it's outside mainInput
                pill.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <span>${file.name}</span>
                    <span class="attachment-remove" onclick="this.parentElement.remove(); if(attachmentArea.children.length === 0) attachmentArea.style.display='none'; updateSendButton(); event.stopPropagation();">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" style="width:14px; height:14px;">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </span>
                `;

                // Append to Attachment Area
                attachmentArea.appendChild(pill);

                // Focus Input and Update Button
                mainInput.focus();
                updateSendButton();
            }
            // Reset input
            fileInput.value = '';
        };

        // --- MIC LOGIC ---
        let listeningInterval;
        let listeningTime = 0;

        btnMic.onclick = function () {
            if (isListening) return;

            // Show Overlay
            listeningOverlay.classList.add('active');
            isListening = true;
            updateSendButton();

            // Reset & Start Timer
            listeningTime = 0;
            listenTimer.innerText = "00:00";
            listeningInterval = setInterval(() => {
                listeningTime++;
                const mins = Math.floor(listeningTime / 60).toString().padStart(2, '0');
                const secs = (listeningTime % 60).toString().padStart(2, '0');
                listenTimer.innerText = `${mins}:${secs}`;
            }, 1000);

            // Auto-finish after 4 seconds (Simulator)
            this.autoStopTimeout = setTimeout(() => {
                finishListening("List high-priority test drives for today");
            }, 4000);
        }

        // Close = Cancel
        btnListenClose.onclick = () => {
            stopListeningState();
            if (btnMic.autoStopTimeout) clearTimeout(btnMic.autoStopTimeout);
        }

        // Stop = Finish immediately
        btnListenStop.onclick = () => {
            if (btnMic.autoStopTimeout) clearTimeout(btnMic.autoStopTimeout);
            finishListening("List high-priority test drives for today");
        }

        function stopListeningState() {
            isListening = false;
            clearInterval(listeningInterval);
            listeningOverlay.classList.remove('active');
            updateSendButton();
        }

        function finishListening(text) {
            stopListeningState();
            mainInput.innerHTML = text;

            // Ensure focus and cursor placement
            mainInput.focus();
            setTimeout(() => {
                const range = document.createRange();
                const sel = window.getSelection();
                range.selectNodeContents(mainInput);
                range.collapse(false);
                sel.removeAllRanges();
                sel.addRange(range);
                updateSendButton();
            }, 10);
        }

        // --- BUTTON DISABLE LOGIC ---
        function updateSendButton() {
            // STOP MODE: Always enabled
            if (typingController) {
                btnSend.disabled = false;
                btnSend.classList.add('active');
                return;
            }

            // INPUT/LISTENING MODE
            const hasText = mainInput.innerText.trim().length > 0;
            const canSend = hasText && !isListening;

            btnSend.disabled = !canSend;
            if (canSend) {
                btnSend.classList.add('active');
            } else {
                btnSend.classList.remove('active');
            }
        }


        // --- MODAL LOGIC ---
        window.openRenameModal = function () {
            let initialName = "";
            if (currentItem) {
                initialName = currentItem.querySelector('.history-text').innerText;
            } else {
                initialName = chatTitle.innerText;
            }
            renameInput.value = initialName;
            renameModal.classList.add('visible');
            globalContextMenu.classList.remove('visible');
            chatDropdown.classList.remove('visible');
            renameInput.focus();
        };

        window.saveRename = function () {
            if (renameInput.value.trim() !== "") {
                const newName = renameInput.value;
                if (currentItem) {
                    const textSpan = currentItem.querySelector('.history-text');
                    textSpan.innerText = newName;
                    if (chatTitle.innerText === textSpan.innerText || getActiveHistoryItem() === currentItem) {
                        chatTitle.innerText = newName;
                    }
                } else {
                    chatTitle.innerText = newName;
                }
            }
            closeModals();
        };

        window.openDeleteModal = function () {
            deleteModal.classList.add('visible');
            globalContextMenu.classList.remove('visible');
            chatDropdown.classList.remove('visible');
        };

        window.confirmDelete = function () {
            if (currentItem) {
                const textSpan = currentItem.querySelector('.history-text');
                if (chatTitle.innerText === textSpan.innerText) {
                    resetChat();
                }
                currentItem.remove();
                checkEmptyHistory();
            } else {
                resetChat();
            }
            closeModals();
        };

        window.closeModals = function () {
            renameModal.classList.remove('visible');
            deleteModal.classList.remove('visible');
        };

        // --- DRAG HANDLER ---
        dragHandle.onmousedown = function (e) {
            if (!panel.classList.contains('state-minimized')) return;
            isDragging = true;
            startX = e.clientX;
            const style = window.getComputedStyle(panel);
            startLeft = parseInt(style.left);
            panel.style.transition = 'none';
            document.body.style.cursor = 'grabbing';
            e.preventDefault();
        };

        document.onmousemove = function (e) {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            let newLeft = startLeft + dx;
            const maxLeft = window.innerWidth - panel.offsetWidth - 20;
            if (newLeft < 20) newLeft = 20;
            if (newLeft > maxLeft) newLeft = maxLeft;
            panel.style.left = newLeft + 'px';
        };

        document.onmouseup = function () {
            if (isDragging) {
                isDragging = false;
                panel.style.transition = '';
                document.body.style.cursor = '';
            }
        };

        function scrollToBottom() {
            chatScrollArea.scrollTop = chatScrollArea.scrollHeight;
        }

        // --- PROMPT SHEET LOGIC (UPDATED TOGGLE) ---
        btnSlashMenu.onclick = (e) => {
            e.stopPropagation();
            if (promptSheet.classList.contains('visible')) {
                // If already visible, close it (toggle OFF)
                closePromptSheet();
            } else {
                // If not visible, open it (toggle ON)
                showMenu(promptSheet, promptSearchInput, () => renderPromptList());
            }
        }

        window.closePromptSheet = function () {
            promptSheet.classList.remove('visible');
            enhancedInputBox.classList.remove('menu-open');
        }

        // Fill Input with Variable Styling
        window.fillInput = function (text) {
            // Regex to replace [text] with styled span
            const formattedHTML = text.replace(/\[(.*?)\]/g, '<span class="prompt-var">[$1]</span>');
            mainInput.innerHTML = formattedHTML;

            promptSheet.classList.remove('visible');
            enhancedInputBox.classList.remove('menu-open');
            mainInput.focus();

            // Move cursor to end (contenteditable quirk)
            const range = document.createRange();
            const sel = window.getSelection();
            range.selectNodeContents(mainInput);
            range.collapse(false);
            sel.removeAllRanges();
            sel.addRange(range);

            updateSendButton();

            // Menu Triggers Logic (Sequential)
            setTimeout(() => {
                const vars = mainInput.querySelectorAll('.prompt-var');
                // Only trigger the FIRST one found to start the sequence
                for (const span of vars) {
                    const txt = span.innerText.toLowerCase();
                    activePromptVar = span;

                    if (txt === '[customer]') {
                        showMenu(customerMenu, customerSearchInput, () => renderCustomerList(), span);
                        break;
                    } else if (txt === '[vehicle]') {
                        showMenu(vehicleMenu, vehicleSearchInput, () => renderVehicleList(), span);
                        break;
                    } else if (txt === '[vin]') {
                        showMenu(vinMenu, vinSearchInput, () => renderVinList(), span);
                        break;
                    } else if (txt === '[date & time]') {
                        showMenu(datetimeMenu, datetimeSearchInput, () => renderDateTimeList(), span);
                        break;
                    }
                }
            }, 750);
        };



        // --- INPUT EVENT HANDLING (DIV) ---
        mainInput.addEventListener('input', function (e) {
            if (this.innerText === '/') {
                showMenu(promptSheet, promptSearchInput, () => renderPromptList());
            }


            if (this.textContent.trim() === '') {
                this.innerHTML = '';
            }

            updateSendButton();
        });

        mainInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (this.innerText.trim() !== '') {
                    const text = this.innerText;
                    this.innerHTML = ''; // Clear
                    updateSendButton();
                    handleSend(text);
                }
            }
        });

        // --- RENDER ACTION ICONS HELPER ---
        function renderActionIcons(textWrapper) {
            const actionRow = document.createElement('div');
            actionRow.className = 'ai-actions-row';
            const icons = [
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>',
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path></svg>',
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>',
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>'
            ];
            icons.forEach(svg => {
                const btn = document.createElement('button');
                btn.className = 'ai-action-btn';
                btn.innerHTML = svg;
                actionRow.appendChild(btn);
            });
            textWrapper.appendChild(actionRow);
            scrollToBottom();
        }

        // Combined Send/Stop Click Handler
        btnSend.onclick = () => {
            if (typingController) {
                // STOP LOGIC
                typingController.stopped = true;

                // 1. Clear "Thinking..." Timer if active
                if (typingController.timerId) {
                    clearTimeout(typingController.timerId);

                    // Remove "Thinking..." row immediately
                    const thinkingRow = activeChat.querySelector('.ai-message-row:last-child');
                    if (thinkingRow && thinkingRow.querySelector('.thinking')) {
                        activeChat.removeChild(thinkingRow);
                    }

                    // Render Stopped Row Immediately
                    const stoppedRow = document.createElement('div');
                    stoppedRow.className = 'ai-message-row';
                    stoppedRow.innerHTML = `
                        <div class="ai-avatar"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg></div>
                        <div class="ai-text-wrapper"><div class="ai-content"><em style="color:#969AA3">Response stopped by you</em></div></div>
                    `;
                    activeChat.appendChild(stoppedRow);

                    // Add Action Icons
                    renderActionIcons(stoppedRow.querySelector('.ai-text-wrapper'));

                    // Reset UI
                    typingController = null;
                }

                // Immediate Feedback
                btnSend.innerHTML = btnSendIcon;
                updateSendButton();
                return;
            }

            if (mainInput.innerText.trim() !== '') {
                const text = mainInput.innerText;
                mainInput.innerHTML = '';
                updateSendButton();
                handleSend(text);
            }
        };

        // --- THOUGHT TOGGLE ---
        window.toggleThoughts = function (element) {
            element.classList.toggle('expanded');
            const details = element.nextElementSibling;
            if (details.style.display === 'none' || details.style.display === '') {
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
        }

        function handleSend(text) {
            // Clear Attachments
            attachmentArea.innerHTML = '';
            attachmentArea.style.display = 'none';

            let logicKey = text;
            const lower = text.toLowerCase();

            if (lower.includes('stock availability') || lower.includes('inventory')) logicKey = '/inventory-check';
            else if (lower.includes('soft credit') || lower.includes('credit')) logicKey = '/credit-prequal';
            else if (lower.includes('trade-in') || lower.includes('estimate value')) logicKey = '/trade-in-val';
            else if (lower.includes('list') || lower.includes('high-priority')) logicKey = 'List high-priority test drives';
            else if (lower.includes('test drive') || lower.includes('book')) logicKey = '/schedule-drive';
            else if (text.includes('Summarize')) logicKey = 'Summarize recent hot leads';

            startChat(text, logicKey);
        }

        // NEW CHAT BTN HANDLER
        btnHeaderNewChat.onclick = () => {
            resetChat();
        };

        btnChatMenu.onclick = (e) => {
            e.stopPropagation();
            const item = getActiveHistoryItem();
            if (item) {
                const isPinned = item.parentElement.id === 'pinnedList';
                headerPinText.innerText = isPinned ? 'Unpin Chat' : 'Pin Chat';
            } else {
                headerPinText.innerText = 'Pin Chat';
            }
            chatDropdown.classList.toggle('visible');
            globalContextMenu.classList.remove('visible');
        };

        document.addEventListener('click', (e) => {
            if (!enhancedInputBox.contains(e.target) && e.target !== btnSlashMenu) {
                closeAllMenus();
            }
            if (!globalContextMenu.contains(e.target)) {
                globalContextMenu.classList.remove('visible');
            }
            if (!chatDropdown.contains(e.target) && e.target !== btnChatMenu) {
                chatDropdown.classList.remove('visible');
            }
            if (e.target === renameModal) closeModals();
            if (e.target === deleteModal) closeModals();
        });

        async function typeWriter(container, htmlString, controller) {
            // Check stop before starting typing
            if (controller.stopped) {
                container.innerHTML = '<br><em style="color:#969AA3">Response stopped by you</em>';
                // Add icons
                renderActionIcons(container.parentElement);

                typingController = null;
                btnSend.innerHTML = btnSendIcon;
                updateSendButton();
                return;
            }

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const nodes = Array.from(doc.body.childNodes);
            container.innerHTML = '';

            async function typeNode(node, parent) {
                // Check stop inside recursion
                if (controller.stopped) return;

                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    const textNode = document.createTextNode('');
                    parent.appendChild(textNode);
                    for (let char of text) {
                        if (controller.stopped) return; // Immediate break
                        textNode.textContent += char;
                        await new Promise(r => setTimeout(r, 5));
                        scrollToBottom();
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const newElement = document.createElement(node.tagName);
                    Array.from(node.attributes).forEach(attr => newElement.setAttribute(attr.name, attr.value));
                    parent.appendChild(newElement);
                    const children = Array.from(node.childNodes);
                    for (const child of children) {
                        await typeNode(child, newElement);
                    }
                }
            }

            for (const node of nodes) {
                if (controller.stopped) break;
                await typeNode(node, container);
            }

            // Cleanup if stopped or finished
            if (controller.stopped) {
                container.innerHTML += '<br><br><em style="color:#969AA3">Response stopped by you</em>';
                renderActionIcons(container.parentElement);
            } else {
                // Normal Finish
                renderActionIcons(container.parentElement);
            }

            // Reset UI state
            typingController = null;
            btnSend.innerHTML = btnSendIcon;
            updateSendButton();
            scrollToBottom();
        }

        window.loadHistoryChat = function (title) {
            emptyState.style.display = 'none';
            suggestionsList.style.display = 'none';
            activeChat.style.display = 'flex';
            closeAllMenus();

            chatTitle.innerText = title;
            activeChat.innerHTML = '';

            btnHeaderNewChat.disabled = false;
            btnChatMenu.disabled = false;

            const userBubble = document.createElement('div');
            userBubble.className = 'message-bubble user';
            userBubble.innerText = title;
            activeChat.appendChild(userBubble);

            const aiRow = document.createElement('div');
            aiRow.className = 'ai-message-row';
            const avatar = document.createElement('div');
            avatar.className = 'ai-avatar';
            avatar.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg>';
            aiRow.appendChild(avatar);

            const textWrapper = document.createElement('div');
            textWrapper.className = 'ai-text-wrapper';

            const aiContent = document.createElement('div');
            aiContent.className = 'ai-content';

            // Mock load logic (history doesn't re-animate)
            const thoughtSeconds = (Math.random() * 2 + 1).toFixed(1);
            const thoughtHeader = `
                <div class="ai-thought-line" onclick="toggleThoughts(this)">
                    <span>Thought for ${thoughtSeconds} seconds</span>
                    <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>
                <div class="ai-thought-details">
                    <div class="thought-step">1. Analyzed request intent</div>
                    <div class="thought-step">2. Retrieved conversation history</div>
                    <div class="thought-step">3. Formatted final response</div>
                </div>
            `;

            const responseBody = document.createElement('div');
            responseBody.innerHTML = `<p>Loading deal details for <strong>${title}</strong>...</p>`;

            aiContent.innerHTML = thoughtHeader;
            aiContent.appendChild(responseBody);

            textWrapper.appendChild(aiContent);
            aiRow.appendChild(textWrapper);
            activeChat.appendChild(aiRow);

            if (!panel.classList.contains('state-fullscreen') || window.innerWidth <= 768) {
                historySheet.classList.remove('open');
            }

            scrollToBottom();
            mainInput.focus();
        }

        window.startChat = function (userText, logicKey) {
            if (!logicKey) logicKey = userText;

            emptyState.style.display = 'none';
            suggestionsList.style.display = 'none';
            activeChat.style.display = 'flex';
            closeAllMenus();

            btnHeaderNewChat.disabled = false;
            btnChatMenu.disabled = false;

            if (!historyAdded) {
                let historyTitle = userText;
                if (historyTitle.length > 25) historyTitle = historyTitle.substring(0, 25) + "...";

                chatTitle.innerText = historyTitle;

                const newItem = document.createElement('div');
                newItem.className = 'history-item';
                newItem.onclick = () => loadHistoryChat(historyTitle);

                newItem.innerHTML = `
                    <div class="history-item-left">
                        <span class="history-text">${historyTitle}</span>
                    </div>
                    <button class="history-item-menu-btn" onclick="showItemMenu(event)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                    </button>
                `;
                todayList.insertAdjacentElement('afterbegin', newItem);
                historyAdded = true;
                checkEmptyHistory();
            }

            const userBubble = document.createElement('div');
            userBubble.className = 'message-bubble user';
            if (userText.includes('<span')) userBubble.innerHTML = userText;
            else userBubble.innerText = userText;

            activeChat.appendChild(userBubble);
            scrollToBottom();

            // --- START STREAMING STATE ---
            typingController = { stopped: false };
            btnSend.innerHTML = btnStopIcon; // Change to Stop Icon
            btnSend.disabled = false; // Force Enable
            btnSend.classList.add('active'); // Keep it colored

            const delay = Math.floor(Math.random() * (8000 - 4000 + 1) + 4000);
            const delaySeconds = (delay / 1000).toFixed(1);

            const thinkingRow = document.createElement('div');
            thinkingRow.className = 'ai-message-row';
            const thinkingAvatar = document.createElement('div');
            thinkingAvatar.className = 'ai-avatar thinking';
            thinkingAvatar.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg>';
            thinkingRow.appendChild(thinkingAvatar);

            const textWrapper = document.createElement('div');
            textWrapper.className = 'ai-text-wrapper';

            const aiContent = document.createElement('div');
            aiContent.className = 'ai-content';
            aiContent.innerHTML = `<div class="thinking-text">Thinking...</div>`;
            textWrapper.appendChild(aiContent);
            thinkingRow.appendChild(textWrapper);

            activeChat.appendChild(thinkingRow);
            scrollToBottom();

            // Store timerId to allow immediate cancellation
            typingController.timerId = setTimeout(async () => {
                // If stopped during thinking phase
                if (typingController.stopped) {
                    activeChat.removeChild(thinkingRow);

                    const stoppedRow = document.createElement('div');
                    stoppedRow.className = 'ai-message-row';
                    stoppedRow.innerHTML = `
                        <div class="ai-avatar"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg></div>
                        <div class="ai-text-wrapper"><div class="ai-content"><em style="color:#969AA3">Response stopped by you</em></div></div>
                    `;
                    activeChat.appendChild(stoppedRow);

                    // Add Icons
                    renderActionIcons(stoppedRow.querySelector('.ai-text-wrapper'));

                    // Reset UI
                    typingController = null;
                    btnSend.innerHTML = btnSendIcon;
                    updateSendButton();
                    return;
                }

                activeChat.removeChild(thinkingRow);
                const aiRow = document.createElement('div');
                aiRow.className = 'ai-message-row';

                const aiAvatar = document.createElement('div');
                aiAvatar.className = 'ai-avatar';
                aiAvatar.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg>';
                aiRow.appendChild(aiAvatar);

                const textWrapper = document.createElement('div');
                textWrapper.className = 'ai-text-wrapper';

                const aiContent = document.createElement('div');
                aiContent.className = 'ai-content';

                // --- THOUGHT DROPDOWN STRUCTURE ---
                const thoughtHeader = document.createElement('div');
                thoughtHeader.className = 'ai-thought-line';
                thoughtHeader.onclick = function () { toggleThoughts(this); };
                thoughtHeader.innerHTML = `
                    <span>Thought for ${delaySeconds} seconds</span>
                    <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                `;
                aiContent.appendChild(thoughtHeader);

                const thoughtDetails = document.createElement('div');
                thoughtDetails.className = 'ai-thought-details';
                // Placeholder Steps
                thoughtDetails.innerHTML = `
                    <div class="thought-step">1. Analyzing user input: "${userText}"</div>
                    <div class="thought-step">2. Identifying context variables</div>
                    <div class="thought-step">3. Retrieving CRM records</div>
                    <div class="thought-step">4. Formatting response output</div>
                `;
                aiContent.appendChild(thoughtDetails);

                // Content Body for Typewriter
                const contentBody = document.createElement('div');
                aiContent.appendChild(contentBody);

                textWrapper.appendChild(aiContent);
                aiRow.appendChild(textWrapper);

                activeChat.appendChild(aiRow);

                let responseHTML = "";
                switch (logicKey) {
                    case 'Summarize recent hot leads':
                        responseHTML = `<p>Here is a summary of the active car leads from the current page view:</p><div class="ai-list-item"><span class="ai-list-number">1.</span><span><strong>John Doe:</strong> Interested in 2024 Honda CR-V. Financing pending.</span></div><div class="ai-list-item"><span class="ai-list-number">2.</span><span><strong>Sarah Smith:</strong> Requesting test drive for Ford Explorer. Trade-in valuation needed.</span></div><div class="ai-list-item"><span class="ai-list-number">3.</span><span><strong>Mike Johnson:</strong> Lease expiring soon. Looking at Toyota Camry options.</span></div>`;
                        break;
                    case 'Draft quote for Model X':
                        responseHTML = `<p><strong>Subject: Your Tesla Model X Quote</strong></p><p>Hi <strong>[Customer Name]</strong>,</p><p>Great choice on the <strong>Model X</strong>. Based on your configuration (Long Range, Black Interior), here is the preliminary quote attached. This includes the federal tax incentive deduction.</p>`;
                        break;
                    case 'List high-priority test drives':
                        responseHTML = `<p><strong>Today's High Priority Test Drives:</strong></p><div class="ai-list-item"><span class="ai-list-number">1.</span><span><strong>10:00 AM - BMW X5</strong> (Client: A. Miller)</span></div><div class="ai-list-item"><span class="ai-list-number">2.</span><span><strong>1:30 PM - Audi Q7</strong> (Client: B. Davis) - <em>Confirm trade-in arrival</em></span></div>`;
                        break;
                    case '/inventory-check':
                        responseHTML = `<strong>Stock Status:</strong><br>We have 3 units matching that description at the Main Lot, and 1 in transit (ETA: 5 days).`;
                        break;
                    case '/deal-probability':
                        responseHTML = `<strong>Deal Probability: 75%</strong><br>Customer has high intent. Credit score is solid (720+). Pending spouse approval on color.`;
                        break;
                    case '/credit-prequal':
                        responseHTML = `<strong>Soft Pull Result:</strong><br>Tier 1 Credit Qualified. Rate eligibility: 3.9% APR for 60 months.`;
                        break;
                    case '/trade-in-val':
                        responseHTML = `<strong>Estimated Value:</strong> $18,500 - $20,000<br>Based on 2018 model year with 45k miles and 'Good' condition.`;
                        break;
                    case '/schedule-drive':
                        responseHTML = `<strong>Slot Confirmed:</strong><br>Test drive scheduled for Saturday, Oct 24th at 11:00 AM. Confirmation SMS sent.`;
                        break;
                    case 'Summarize recent car leads':
                        responseHTML = `<p>Here is a summary of the active car leads from the current page view:</p><div class="ai-list-item"><span class="ai-list-number">1.</span><span><strong>John Doe:</strong> Interested in 2024 Honda CR-V. Financing pending.</span></div><div class="ai-list-item"><span class="ai-list-number">2.</span><span><strong>Sarah Smith:</strong> Requesting test drive for Ford Explorer. Trade-in valuation needed.</span></div><div class="ai-list-item"><span class="ai-list-number">3.</span><span><strong>Mike Johnson:</strong> Lease expiring soon. Looking at Toyota Camry options.</span></div>`;
                        break;
                    default:
                        responseHTML = "Analyzing CRM data...";
                }

                // Pass controller to typewriter
                await typeWriter(contentBody, responseHTML, typingController);

            }, delay);
        }

        function resetChat() {
            activeChat.innerHTML = '';
            activeChat.style.display = 'none';
            emptyState.style.display = 'flex';
            suggestionsList.style.display = 'flex';
            contextRow.style.display = 'flex';
            chatTitle.innerText = "New Chat";

            btnHeaderNewChat.disabled = true;
            btnChatMenu.disabled = true;

            historyAdded = false;
            mainInput.innerHTML = '';
            updateSendButton();
            mainInput.focus();
        }

        // btnNewChat.onclick = resetChat;
        // Close history sheet on New Chat click from Side Sheet
        btnHistoryNewChat.onclick = () => {
            resetChat();
            if (!panel.classList.contains('state-fullscreen') || window.innerWidth <= 768) {
                historySheet.classList.remove('open');
            }
        };

        mainContent.onclick = () => {
            if (emptyState.style.display !== 'none') {
                contextRow.style.display = 'flex';
                suggestionsList.style.display = 'flex';
            }
        };

        // Window Controls
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btnMinimize').onclick = () => setState('minimized');
            document.getElementById('btnRestoreMin').onclick = () => setState('docked');
            document.getElementById('btnCloseMin').onclick = () => setState('closed');
            document.getElementById('btnFull').onclick = () => setState('fullscreen');
            document.getElementById('btnDock').onclick = () => setState('docked');
            document.getElementById('btnClose').onclick = () => setState('closed');
        });

        // Global State Logic
        function setState(state) {
            panel.classList.remove('state-docked', 'state-minimized', 'state-fullscreen', 'state-closed');
            mainContent.classList.remove('pushed-by-dock', 'full-hidden');
            btnFull.style.display = 'flex';
            btnDock.style.display = 'none';

            if (state === 'closed') {
                navAiToggle.classList.remove('active');
                panel.classList.add('state-closed');
                panel.style.left = '';

                // Show FAB if on mobile
                if (window.innerWidth <= 768) {
                    mobileFab.classList.add('visible');
                }
            } else {
                navAiToggle.classList.add('active');
                mobileFab.classList.remove('visible'); // Hide FAB when chat opens
            }

            if (state === 'docked') {
                panel.classList.add('state-docked');
                mainContent.classList.add('pushed-by-dock');
                panel.style.left = '';
                mainInput.focus();
            } else if (state === 'minimized') {
                panel.classList.add('state-minimized');
                if (!panel.style.left) panel.style.left = '20px';
            } else if (state === 'fullscreen') {
                panel.classList.add('state-fullscreen');
                mainContent.classList.add('full-hidden');
                btnFull.style.display = 'none';
                btnDock.style.display = 'flex';
                panel.style.left = '';
                mainInput.focus();
            }
        }

        navAiToggle.onclick = () => {
            if (panel.classList.contains('state-closed')) setState('docked');
            else setState('closed');
        };

        // Mobile FAB Toggle Function
        window.toggleMobileChat = function () {
            setState('fullscreen'); // Open as full screen on mobile
        };

        btnShowHistory.onclick = () => historySheet.classList.add('open');
        btnCloseHistory.onclick = () => historySheet.classList.remove('open');

        // Load directly into a new conversation
        window.onload = function () {
            resetChat();
        };

    </script>
</body>

</html>
