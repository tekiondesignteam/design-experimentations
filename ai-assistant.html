<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Assistant</title>
    <style>
        /* --- Reset & Base --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { 
            height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            color: #333; 
            overflow: hidden; 
        }

        /* --- LAYOUT WRAPPER --- */
        .layout-wrapper { display: flex; flex-direction: column; height: 100vh; width: 100vw; }
        .global-top-nav { height: 50px; background-color: #3F4757; flex-shrink: 0; }
        .main-row-wrapper { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Side Nav Styling */
        .global-side-nav { 
            width: 60px; 
            background-color: #3F4757; 
            flex-shrink: 0;
            display: flex; flex-direction: column; align-items: center; padding-top: 15px; 
            gap: 20px; 
            z-index: 30;
        }

        .nav-toggle-btn {
            width: 36px; height: 36px;
            border: none; border-radius: 8px; cursor: pointer;
            background-color: #6F7884; color: #FFFFFF; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; font-weight: 600; font-size: 13px; font-family: inherit;
        }
        .nav-toggle-btn:hover { filter: brightness(1.1); }
        
        #navAiToggle {
            background: linear-gradient(270deg, #ECFEFF 0%, #F5F3FF 74.52%, #EDE9FE 100%);
            color: #00BFA5; 
        }
        #navAiToggle.active {
            background: #00BFA5; color: #FFFFFF;
            box-shadow: 0 2px 5px rgba(0, 191, 165, 0.4);
        }
        .nav-toggle-btn svg { width: 20px; height: 20px; }

        .app-container { flex: 1; position: relative; background-color: #fff; overflow: hidden; display: flex; }

        /* --- CHAT SIDEBAR --- */
        .chat-sidebar {
            position: absolute; bottom: 0; left: 0; z-index: 20;
            width: 400px; height: 100%;
            background: linear-gradient(270deg, #ECFEFF 0%, #F5F3FF 74.52%, #EDE9FE 100%);
            border-right: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column; overflow: hidden;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s ease;
        }

        .chat-sidebar.state-docked { width: 400px; height: 100%; border-radius: 0; transform: translateX(0); opacity: 1; }
        
        .chat-sidebar.state-minimized {
            height: 48px; width: 280px; 
            left: 20px; 
            bottom: 0; 
            transform: translateX(0);
            background: linear-gradient(270deg, #ECFEFF 0%, #F5F3FF 74.52%, #EDE9FE 100%);
            border: 1px solid rgba(0,0,0,0.1); 
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.08); 
            opacity: 1;
        }
        
        .chat-sidebar.state-fullscreen { width: 100%; height: 100%; border-radius: 0; z-index: 100; transform: translateX(0); opacity: 1; }
        .chat-sidebar.state-closed { width: 400px; height: 100%; transform: translateX(-100%); pointer-events: none; opacity: 1; }

        /* --- WRAPPERS --- */
        .main-view-wrapper {
            display: flex; flex-direction: column; height: 100%; 
            min-width: 400px; width: 400px; padding: 0; 
            opacity: 1; visibility: visible; 
            transition: opacity 0.2s ease, visibility 0.2s;
            position: relative; z-index: 2;
        }
        .chat-sidebar.state-minimized .main-view-wrapper { opacity: 0; visibility: hidden; pointer-events: none; z-index: 0; }

        .minimized-view-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
            opacity: 0; visibility: hidden; pointer-events: none; min-width: 280px;
            transition: opacity 0.2s ease, visibility 0.2s;
            z-index: 1;
        }
        .chat-sidebar.state-minimized .minimized-view-wrapper { opacity: 1; visibility: visible; pointer-events: auto; z-index: 10; transition-delay: 0.1s; }

        .min-left-group { display: flex; align-items: center; gap: 12px; }
        
        .drag-handle { 
            cursor: grab; color: #94A3B8; display: flex; align-items: center; 
            padding: 4px; margin-left: -4px;
        }
        .drag-handle:active { cursor: grabbing; }
        .drag-handle svg { width: 16px; height: 16px; }

        .min-brand { 
            font-weight: 600; color: #1E293B; font-size: 1rem;
            display: flex; align-items: center; gap: 8px; 
            user-select: none;
        }
        
        .min-controls { display: flex; align-items: center; gap: 4px; }
        .min-btn { 
            background: transparent; border: none; cursor: pointer; 
            color: #475569; padding: 6px; 
            display: flex; align-items: center; justify-content: center;
            border-radius: 6px;
            transition: background 0.2s, color 0.2s;
        }
        .min-btn:hover { background-color: rgba(0,0,0,0.05); color: #1E293B; }
        .min-btn svg { width: 20px; height: 20px; stroke-width: 2.5px; }

        /* --- TOP BAR --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; height: 44px; flex-shrink: 0; padding: 0 8px 0 16px; margin-bottom: 0; }
        .brand-text { font-size: 0.95rem; color: #444; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .window-controls { display: flex; gap: 6px; align-items: center; z-index: 20; position: relative;}
        .win-btn { background: transparent; border: none; cursor: pointer; padding: 6px; border-radius: 6px; color: #555; display: flex; align-items: center; justify-content: center; transition: background 0.2s; pointer-events: auto; }
        .win-btn:hover { background-color: rgba(0,0,0,0.05); color: #000; }
        .win-btn svg { width: 16px; height: 16px; stroke-width: 2px; }

        /* --- CARD CONTAINER --- */
        .chat-card-container {
            flex: 1; background-color: #fff; 
            border-radius: 16px 16px 0 0;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.03); 
            border: none;
            position: relative; 
        }
        .chat-sidebar.state-fullscreen .main-view-wrapper { width: 100%; min-width: 100%; padding: 0; }
        .chat-sidebar.state-fullscreen .chat-card-container { border-radius: 16px 16px 0 0; }

        /* --- HISTORY SIDE SHEET --- */
        .history-sheet {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: #fff; z-index: 50; 
            display: flex; flex-direction: column; 
            transform: translateX(-100%); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border-right: 1px solid #f0f0f0;
        }
        .chat-sidebar.state-fullscreen .history-sheet { width: 320px; border-right: 1px solid #E2E8F0; }
        .history-sheet.open { transform: translateX(0); }

        .chat-sidebar.state-fullscreen .history-sheet { transform: translateX(0) !important; z-index: 30; }
        .chat-sidebar.state-fullscreen .history-back-btn { display: none; }
        .chat-sidebar.state-fullscreen .nav-header,
        .chat-sidebar.state-fullscreen .chat-scroll-area,
        .chat-sidebar.state-fullscreen .input-wrapper,
        .chat-sidebar.state-fullscreen .prompt-sheet {
            margin-left: 320px; 
            width: calc(100% - 320px);
            border-left: 1px solid #E2E8F0;
        }
        .chat-sidebar.state-fullscreen #btnShowHistory { display: none; }

        .history-header { padding: 14px 16px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #f5f5f5; flex-shrink: 0; position: relative; }
        .history-title { font-weight: 600; color: #333; font-size: 0.95rem; flex: 1; margin-left: 4px; }
        .history-back-btn, .history-new-chat-btn { background: transparent; border: none; cursor: pointer; padding: 6px; border-radius: 6px; color: #555; display: flex; align-items: center; justify-content: center; }
        .history-back-btn:hover, .history-new-chat-btn:hover { background-color: #f5f5f5; }
        .history-back-btn svg, .history-new-chat-btn svg { width: 20px; height: 20px; }

        .history-search-wrapper { padding: 12px 16px 4px 16px; }
        .history-search-box { display: flex; align-items: center; gap: 8px; background-color: #F7FAFC; border: 1px solid #E2E8F0; border-radius: 8px; padding: 8px 12px; }
        .history-search-box:focus-within { border-color: #CBD5E0; }
        .history-search-box input { border: none; background: transparent; outline: none; width: 100%; font-size: 0.85rem; color: #333; }
        .history-search-box svg { width: 16px; height: 16px; color: #A0AEC0; }

        .history-content { flex: 1; overflow-y: auto; padding: 16px; padding-right: 8px; }
        .history-section-title { font-size: 0.75rem; font-weight: 600; color: #94A3B8; margin: 16px 0 8px 0; text-transform: uppercase; letter-spacing: 0.05em; }
        .history-section-title:first-child { margin-top: 0; }
        .history-placeholder { padding: 20px; text-align: center; color: #94A3B8; font-size: 0.85rem; display: none; }
        .history-placeholder.visible { display: block; }
        .history-footer { padding: 16px 20px; border-top: 1px solid #f5f5f5; display: flex; align-items: center; justify-content: space-between; cursor: pointer; color: #4A5568; font-size: 0.9rem; font-weight: 500; transition: color 0.2s; }
        .history-footer:hover { color: #4A5568; }
        .history-footer:hover svg { color: #00BFA5; }
        .history-footer svg { width: 18px; height: 18px; stroke-width: 2px; transition: color 0.2s; }

        .history-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 8px 8px 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; color: #4A5568; font-size: 0.9rem; position: relative; margin-bottom: 2px; }
        .history-item:hover { background-color: #F7FAFC; color: #1E293B; }
        .history-item-left { display: flex; align-items: center; gap: 8px; overflow: hidden; flex: 1; }
        .history-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .history-item-menu-btn { background: transparent; border: none; cursor: pointer; color: #A0AEC0; padding: 4px; border-radius: 4px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s, background 0.2s; }
        .history-item:hover .history-item-menu-btn { opacity: 1; }
        .history-item-menu-btn:hover { background-color: #E2E8F0; color: #333; }
        .history-item-menu-btn svg { width: 16px; height: 16px; }

        /* GLOBAL CONTEXT MENU & MODALS */
        #globalContextMenu { position: fixed; background: white; border: 1px solid #E2E8F0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; flex-direction: column; min-width: 140px; z-index: 9999; }
        #globalContextMenu.visible { display: flex; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.visible { display: flex; }
        .modal-box { background: white; width: 320px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); animation: fadeIn 0.2s ease-out; }
        .modal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 12px; color: #1E293B; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 0.95rem; margin-bottom: 16px; outline: none; }
        .modal-input:focus { border-color: #00BFA5; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 8px; }
        .modal-btn { padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; cursor: pointer; border: none; }
        .modal-btn.secondary { background: #EDF2F7; color: #4A5568; }
        .modal-btn.primary { background: #00BFA5; color: white; }
        .modal-btn.danger { background: #E53E3E; color: white; }

        /* --- INPUT WRAPPER --- */
        .input-wrapper { padding: 16px 16px 8px 16px; background-color: #fff; width: 100%; flex-shrink: 0; position: relative; }
        .chat-sidebar.state-fullscreen .input-wrapper { display: flex; flex-direction: column; align-items: center; }
        .chat-sidebar.state-fullscreen .input-group-container { width: 75%; max-width: 1000px; }
        .input-group-container { width: 100%; transition: width 0.3s; position: relative; }
        
        .input-border-wrapper { background-color: #EEF2F6; border: 1px solid #E2E8F0; padding: 4px; border-radius: 16px; width: 100%; position: relative;}
        
        /* ENHANCED INPUT BOX & POPUP MENU STYLES */
        .enhanced-input-box { 
            border: 1px solid #E2E8F0; 
            border-radius: 12px; 
            padding: 12px 14px; 
            background-color: #fff; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.02); 
            transition: border-color 0.2s, border-radius 0.2s; 
            position: relative; 
        }
        .enhanced-input-box:focus-within { border-color: #CBD5E0; }
        .enhanced-input-box.menu-open { border-top-left-radius: 0; border-top-right-radius: 0; border-top-color: transparent; }

        /* POPUP MENU - INTERNAL EXTENSION */
        .popup-menu {
            position: absolute;
            bottom: 100%; 
            left: -1px;   
            width: calc(100% + 2px); 
            display: none;
            flex-direction: column;
            background: white;
            border: 1px solid #E2E8F0;
            border-bottom: 1px solid #f0f0f0;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.08);
            z-index: 10;
            overflow: hidden;
            max-height: 350px;
            animation: slideUpFade 0.15s ease-out;
        }
        .popup-menu.visible { display: flex; }

        .popup-header {
            padding: 12px 16px 8px 16px;
            font-size: 0.9rem;
            font-weight: 700;
            color: #1E293B;
            border-bottom: none;
            flex-shrink: 0;
        }

        .popup-list { flex: 1; overflow-y: auto; padding: 0; }
        
        .popup-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 0.95rem;
            color: #334155;
            transition: background 0.1s;
            display: flex; align-items: center; gap: 10px;
            border-left: 3px solid transparent;
        }
        .popup-item:hover { background-color: #F1F5F9; border-left-color: #00BFA5; color: #0F172A; }
        
        /* FIX: Explicitly size SVGs to prevent giant icon bug */
        .popup-item svg { width: 16px; height: 16px; min-width: 16px; min-height: 16px; color: #94A3B8; flex-shrink: 0; }

        .vin-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.1s;
            display: flex; align-items: flex-start; gap: 12px;
            border-left: 3px solid transparent;
        }
        .vin-item:hover { background-color: #F1F5F9; border-left-color: #00BFA5; }
        .vin-icon { margin-top: 2px; color: #94A3B8; }
        .vin-icon svg { width: 16px; height: 16px; }
        .vin-details { display: flex; flex-direction: column; gap: 2px; }
        .vin-text { font-weight: 600; color: #1E293B; font-size: 0.95rem; }
        .vin-desc { color: #64748B; font-size: 0.85rem; }

        .popup-search-container {
            padding: 10px 16px 14px 16px;
            background: #fff;
            border-top: 1px solid #F1F5F9;
            flex-shrink: 0;
        }
        
        .popup-search-input-wrapper {
            display: flex; align-items: center; gap: 8px;
            background: #fff;
            border: 1px solid #CBD5E0;
            border-radius: 6px;
            padding: 8px 10px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .popup-search-input-wrapper:focus-within {
            border-color: #00BFA5;
            box-shadow: 0 0 0 3px rgba(0, 191, 165, 0.1);
        }
        
        /* FIX: Explicitly size SVGs to prevent giant icon bug */
        .popup-search-input-wrapper svg { width: 16px; height: 16px; min-width: 16px; min-height: 16px; color: #64748B; }
        .popup-search-input-wrapper input {
            border: none; outline: none; width: 100%; font-size: 0.9rem;
            color: #333; background: transparent;
        }

        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- CHAT HEADER --- */
        .nav-header { padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; background-color: #fff; border-bottom: 1px solid #f5f5f5; flex-shrink: 0; position: relative; }
        .action-btn { background: transparent; border: none; cursor: pointer; padding: 8px; border-radius: 8px; color: #555; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .action-btn:hover { background-color: #f5f5f5; color: #000; }
        .action-btn svg { width: 18px; height: 18px; stroke-width: 2px; }
        .action-btn:disabled { opacity: 0.3; cursor: default; }
        .action-btn:disabled:hover { background: transparent; color: #555; }
        
        .chat-title { font-size: 0.95rem; font-weight: 600; color: #222; text-align: center; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; margin: 0 10px; }

        #chatMenuContainer { display: none; position: relative; } 
        .menu-dropdown { position: absolute; top: 100%; right: 0; background: white; border: 1px solid #E2E8F0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; flex-direction: column; min-width: 130px; z-index: 100; margin-top: 4px; }
        .menu-dropdown.visible { display: flex; }
        .menu-item { padding: 10px 16px; font-size: 0.85rem; cursor: pointer; color: #333; text-align: left; background: none; border: none; transition: background 0.2s; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover { background: #F7FAFC; }
        .menu-item:first-child { border-radius: 8px 8px 0 0; }
        .menu-item:last-child { border-radius: 0 0 8px 8px; }
        .menu-item.danger { color: #E53E3E; }
        .menu-item.danger:hover { background: #FFF5F5; }
        .menu-item svg { width: 14px; height: 14px; stroke-width: 2px; }

        /* --- REUSED CONTENT STYLES --- */
        .chat-scroll-area { flex: 1; padding: 16px; overflow-y: auto; background-color: #fff; display: flex; flex-direction: column; scroll-behavior: smooth; }
        .empty-state-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .empty-state-content { text-align: left; width: 100%; padding: 0 10px; max-width: 400px; transition: width 0.3s; }
        .chat-sidebar.state-fullscreen .empty-state-content { width: 75%; max-width: 1000px; margin: 0 auto; }
        .empty-icon { width: 48px; height: 48px; margin-bottom: 16px; color: #00BFA5; background: rgba(0, 191, 165, 0.1); border-radius: 12px; padding: 10px; display: inline-block; }
        .greeting-title { font-size: 1.75rem; color: #2D3748; margin-bottom: 8px; font-weight: 600; }
        .greeting-subtitle { font-size: 1.1rem; color: #718096; margin: 0; display: flex; align-items: center; }
        .active-chat-wrapper { display: none; flex-direction: column; gap: 20px; padding-bottom: 20px; width: 100%; }
        .chat-sidebar.state-fullscreen .active-chat-wrapper { width: 75%; max-width: 1000px; align-self: center; }
        
        .message-bubble { max-width: 100%; font-size: 0.95rem; line-height: 1.6; position: relative; }
        .message-bubble.user { align-self: flex-end; max-width: 85%; padding: 10px 14px; background-color: #EEF2F6; color: #161616; border-radius: 12px 12px 0 12px; }
        .ai-message-row { display: flex; align-items: flex-start; gap: 12px; width: 100%; animation: fadeIn 0.3s ease-out; }
        .ai-avatar { width: 28px; height: 28px; background-color: rgba(0, 191, 165, 0.1); color: #00BFA5; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
        .ai-avatar svg { width: 16px; height: 16px; }
        .ai-avatar.thinking svg { animation: spinPulse 3s ease-in-out infinite; }
        .ai-content { flex: 1; color: #334155; font-size: 0.95rem; line-height: 1.6; }
        .ai-content p { margin-bottom: 12px; margin-top: 0; }
        .ai-content strong, .ai-content b { font-weight: 500 !important; color: #1E293B; }
        .ai-list-item { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 16px; line-height: 1.6; }
        .ai-list-item:last-child { margin-bottom: 0; }
        .ai-list-number { color: #64748B; font-size: 0.9rem; margin-top: 1px; min-width: 16px; font-weight: 600; }
        .thinking-text { font-size: 0.85rem; color: #64748B; font-weight: 500; margin-top: 4px; animation: fadeText 2s ease-in-out infinite alternate; }
        
        .ai-actions-row { display: flex; align-self: flex-start; gap: 12px; margin-top: 8px; margin-bottom: 4px; margin-left: 40px; opacity: 0; animation: fadeIn 0.3s ease-in forwards; }
        .ai-action-btn { background: transparent; border: none; cursor: pointer; color: #64748B; padding: 4px; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: color 0.2s, background 0.2s; }
        .ai-action-btn:hover { color: #1E293B; background-color: #F1F5F9; }
        .ai-action-btn svg { width: 16px; height: 16px; stroke-width: 2px; }

        /* Content Editable Div Input */
        .input-container {
            width: 100%; border: none; background: transparent; padding: 0;
        }
        .main-input { 
            width: 100%; min-height: 24px; max-height: 120px; overflow-y: auto;
            outline: none; font-size: 0.95rem; line-height: 1.5; color: #2D3748;
            font-family: inherit;
        }
        .main-input:empty::before { content: attr(data-placeholder); color: #A0AEC0; pointer-events: none; display: block; }
        .prompt-var { color: #7C3AED; background: #F3E8FF; padding: 0 4px; border-radius: 4px; font-weight: 500; cursor: pointer; }
        .filled-var { color: #2563EB; font-weight: 500; }
        
        .input-toolbar { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid transparent; }
        .toolbar-left, .toolbar-right { display: flex; gap: 8px; align-items: center; }
        .tool-icon-btn { background: transparent; border: none; cursor: pointer; padding: 6px; border-radius: 6px; color: #718096; display: flex; align-items: center; justify-content: center; transition: color 0.2s, background 0.2s; }
        .tool-icon-btn:hover { background-color: #F7FAFC; color: #4A5568; }
        .tool-icon-btn svg { width: 18px; height: 18px; stroke-width: 2px; }
        .send-btn-square { width: 32px; height: 32px; background-color: #F1F5F9; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #64748B; transition: all 0.2s; }
        .send-btn-square:hover { background-color: #E2E8F0; color: #334155; }
        .send-btn-square.active { background-color: rgba(0, 191, 165, 0.1); color: #00BFA5; }
        .send-btn-square svg { width: 16px; height: 16px; stroke-width: 2px; }

        .prompt-sheet { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 75%; 
            background-color: #fff; border-radius: 20px 20px 0 0; 
            box-shadow: 0 -4px 30px rgba(0,0,0,0.15); 
            padding: 0; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }
        .prompt-sheet.visible { transform: translateY(0); }
        
        .prompt-header { padding: 20px; display: flex; align-items: center; justify-content: space-between; }
        .prompt-title { font-weight: 600; font-size: 1rem; color: #111; letter-spacing: -0.02em; }
        
        .prompt-search-wrapper { 
            padding: 12px 20px 20px 20px; 
            border-top: 1px solid #f0f0f0; 
            margin-top: auto; 
            background: #fff;
        }
        .prompt-search-box { 
            display: flex; align-items: center; gap: 10px; 
            background-color: #fff; border: 1px solid #E2E8F0; 
            border-radius: 8px; padding: 10px 12px; 
            transition: border 0.2s;
        }
        .prompt-search-box:focus-within { border-color: #000; }
        .prompt-search-box input { border: none; background: transparent; outline: none; width: 100%; font-size: 0.95rem; color: #333; }
        /* FIX: Explicit size for search icon in sheet */
        .prompt-search-box svg { width: 18px; height: 18px; color: #94A3B8; }
        
        .prompt-list { flex: 1; overflow-y: auto; padding: 0 0 0 0; }
        
        .prompt-item { 
            padding: 16px 20px; 
            border-bottom: 1px solid #f0f0f0; 
            cursor: pointer; transition: background 0.2s;
            display: flex; flex-direction: column; gap: 4px;
        }
        .prompt-item:last-child { border-bottom: none; }
        .prompt-item:hover { background-color: #F7FAFC; }
        .prompt-item-name { font-size: 0.95rem; font-weight: 600; color: #0F172A; margin-bottom: 2px; }
        .prompt-item-desc { font-size: 0.9rem; color: #64748B; line-height: 1.5; display: block; }

        @keyframes spinPulse { 0% { transform: rotate(0deg) scale(1); opacity: 1; } 50% { transform: rotate(180deg) scale(0.8); opacity: 0.7; } 100% { transform: rotate(360deg) scale(1); opacity: 1; } }
        @keyframes fadeText { 0% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Context styling helpers */
        .context-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .context-pill { 
            display: inline-flex; align-items: center; gap: 6px; 
            background-color: #EFF6FF; 
            color: #1E293B; font-size: 0.85rem; font-weight: 500; 
            padding: 6px 12px; border-radius: 20px; user-select: none; 
            border: 1px solid #DBEAFE;
            transition: all 0.2s;
        }
        .context-close { cursor: pointer; color: #94A3B8; font-size: 18px; line-height: 1; display: flex; align-items: center; }
        .context-close:hover { color: #cf3a3a; }
        .context-pill.add-context { 
            background: #EFF6FF; color: #2563EB; border: 1px dashed #BFDBFE; cursor: pointer; 
        }
        .context-pill.add-context:hover { background: #DBEAFE; }

    </style>
</head>
<body>

    <div class="modal-overlay" id="renameModal">
        <div class="modal-box">
            <div class="modal-title">Rename Chat</div>
            <input type="text" class="modal-input" id="renameInput" placeholder="Enter new name...">
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModals()">Cancel</button>
                <button class="modal-btn primary" onclick="saveRename()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-title">Delete Chat?</div>
            <p style="margin-bottom:20px; color:#4A5568; font-size:0.9rem;">Are you sure you want to delete this conversation? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModals()">Cancel</button>
                <button class="modal-btn danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div id="globalContextMenu">
        <button class="menu-item" id="btnPinItem" onclick="togglePin()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg>
            <span id="pinText">Pin Chat</span>
        </button>
        <button class="menu-item" onclick="openRenameModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
            Rename
        </button>
        <button class="menu-item danger" onclick="openDeleteModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            Delete
        </button>
    </div>

    <div class="layout-wrapper">
        <nav class="global-top-nav"></nav>
        <div class="main-row-wrapper">
            
            <nav class="global-side-nav">
                <button class="nav-toggle-btn active" id="navAiToggle" title="Toggle AI Assistant">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg>
                </button>
                <button class="nav-toggle-btn">C</button>
                <button class="nav-toggle-btn">L</button>
                <button class="nav-toggle-btn">T</button>
                <button class="nav-toggle-btn">CH</button>
                <button class="nav-toggle-btn">D</button>
            </nav>

            <div class="app-container">
                
                <aside class="chat-sidebar state-docked" id="chatPanel">
                    
                    <div class="minimized-view-wrapper">
                        <div class="min-left-group">
                            <div class="drag-handle" id="dragHandle">
                                <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="9" cy="5" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="9" cy="19" r="1.5"/><circle cx="15" cy="5" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="15" cy="19" r="1.5"/></svg>
                            </div>
                            <div class="min-brand">
                                 <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="color: #00BFA5;"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg>
                                <span>AI Assistant</span>
                            </div>
                        </div>
                        <div class="min-controls">
                            <button class="min-btn" id="btnRestoreMin"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
                            <button class="min-btn" id="btnCloseMin"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                        </div>
                    </div>

                    <div class="main-view-wrapper">
                        
                        <div class="top-bar">
                            <div class="brand-text">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="color: #00BFA5;"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg>
                                AI Assistant
                            </div>
                            <div class="window-controls">
                                <button class="win-btn" id="btnMinimize"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                                <button class="win-btn" id="btnFull"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg></button>
                                <button class="win-btn" id="btnDock" style="display:none;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg></button>
                                <button class="win-btn" id="btnClose"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                            </div>
                        </div>

                        <div class="chat-card-container">
                            
                            <div class="history-sheet" id="historySheet">
                                <div class="history-header">
                                    <button class="history-back-btn" id="btnCloseHistory"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button>
                                    <div class="history-title">My Chats</div>
                                    <button class="history-new-chat-btn" id="btnHistoryNewChat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/><path d="M8 12h8"/><path d="M12 8v8"/></svg></button>
                                </div>
                                <div class="history-search-wrapper">
                                    <div class="history-search-box">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                        <input type="text" placeholder="Search chats...">
                                    </div>
                                </div>
                                <div class="history-content">
                                    <div class="history-section-title">Pinned</div>
                                    <div id="pinnedList">
                                        <div class="history-item" onclick="loadHistoryChat('Monthly Sales Review')">
                                            <div class="history-item-left">
                                                <span class="history-text">Monthly Sales Review</span>
                                            </div>
                                            <button class="history-item-menu-btn" onclick="showItemMenu(event)">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="history-section-title" id="historyTodaySection">Today</div>
                                    <div id="historyPlaceholder" class="history-placeholder">No active chats</div>
                                    <div id="todayList">
                                        <div class="history-item" onclick="loadHistoryChat('Tesla Fleet Inquiry')">
                                            <div class="history-item-left"><span class="history-text">Tesla Fleet Inquiry</span></div>
                                            <button class="history-item-menu-btn" onclick="showItemMenu(event)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="history-footer">
                                    <span>Prompt Presets</span>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                                </div>
                            </div>

                            <div class="nav-header">
                                <button class="action-btn" id="btnShowHistory"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
                                <div class="chat-title">New Chat</div>
                                <div style="display:flex; gap:4px; align-items:center;">
                                    <button class="action-btn" id="btnNewChat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/><path d="M8 12h8"/><path d="M12 8v8"/></svg></button>
                                    <div id="chatMenuContainer" style="display:none;">
                                        <button class="action-btn" id="btnChatMenu"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button>
                                        <div class="menu-dropdown" id="chatDropdown">
                                            <button class="menu-item" onclick="togglePinFromHeader()"><span id="headerPinText">Pin Chat</span></button>
                                            <button class="menu-item" onclick="openRenameModalFromHeader()">Rename</button>
                                            <button class="menu-item danger" onclick="openDeleteModalFromHeader()">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="prompt-sheet" id="promptSheet">
                                <div class="prompt-header">
                                    <div class="prompt-title">Prompt Presets</div>
                                    <button style="border:none; background:transparent; cursor:pointer; padding:4px;" onclick="closePromptSheet()">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                    </button>
                                </div>

                                <div class="prompt-list">
                                    <div class="prompt-item" onclick="startChat('Summarize recent car leads')">
                                        <div class="prompt-item-name">Summarize Leads</div>
                                        <div class="prompt-item-desc">Summarize recent car leads from the current page view.</div>
                                    </div>
                                    <div class="prompt-item" onclick="startChat('Draft quote for Model X')">
                                        <div class="prompt-item-name">Draft Quote</div>
                                        <div class="prompt-item-desc">Draft quote for Model X based on current configuration.</div>
                                    </div>
                                    <div class="prompt-item" onclick="startChat('List high-priority test drives')">
                                        <div class="prompt-item-name">Priority Drives</div>
                                        <div class="prompt-item-desc">List high-priority test drives scheduled for today.</div>
                                    </div>
                                    
                                    <div class="prompt-item" onclick="fillInput('Check stock availability for [Vehicle] across all lots')">
                                        <div class="prompt-item-name">Inventory Check</div>
                                        <div class="prompt-item-desc">Check stock availability for [Vehicle] across all lots available in the region.</div>
                                    </div>
                                    <div class="prompt-item" onclick="fillInput('Analyze the closing probability for the current lead based on recent activity')">
                                        <div class="prompt-item-name">Deal Probability</div>
                                        <div class="prompt-item-desc">Analyze the closing probability for the current lead based on recent activity.</div>
                                    </div>
                                    <div class="prompt-item" onclick="fillInput('Run a soft credit qualification check for [Customer] to determine eligibility')">
                                        <div class="prompt-item-name">Credit Pre-qual</div>
                                        <div class="prompt-item-desc">Run a soft credit qualification check for [Customer] to determine eligibility.</div>
                                    </div>
                                    <div class="prompt-item" onclick="fillInput('Book a test drive appointment for [Vehicle] on [Date & Time]')">
                                        <div class="prompt-item-name">Schedule Drive</div>
                                        <div class="prompt-item-desc">Book a test drive appointment for [Vehicle] on [Date & Time].</div>
                                    </div>
                                </div>
                                
                                <div class="prompt-search-wrapper">
                                    <div class="prompt-search-box">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                        <input type="text" placeholder="Search prompts..." id="promptSearchInput">
                                    </div>
                                </div>
                            </div>

                            <div class="chat-scroll-area">
                                <div class="empty-state-wrapper" id="emptyState">
                                    <div class="empty-state-content">
                                        <div class="empty-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg></div>
                                        <h2 class="greeting-title">Hi John,</h2>
                                        <p class="greeting-subtitle">How can I help with your leads today?</p>
                                    </div>
                                </div>
                                <div class="active-chat-wrapper" id="activeChat"></div>
                            </div>

                            <div class="input-wrapper">
                                <div class="input-group-container">
                                    <div class="input-border-wrapper">
                                        <div class="enhanced-input-box" id="enhancedInputBox">
                                            
                                            <div id="customerMenu" class="popup-menu">
                                                <div class="popup-header">Customers</div>
                                                <div class="popup-list" id="customerList"></div>
                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                                        <input type="text" id="customerSearchInput" placeholder="Search Customers...">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="vehicleMenu" class="popup-menu">
                                                <div class="popup-header">Vehicles</div>
                                                <div class="popup-list" id="vehicleList"></div>
                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                                        <input type="text" id="vehicleSearchInput" placeholder="Search Vehicles">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="vinMenu" class="popup-menu">
                                                <div class="popup-header">VIN Database</div>
                                                <div class="popup-list" id="vinList"></div>
                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                                        <input type="text" id="vinSearchInput" placeholder="Search VIN...">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="datetimeMenu" class="popup-menu">
                                                <div class="popup-header">Available Slots</div>
                                                <div class="popup-list" id="datetimeList"></div>
                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                                        <input type="text" id="datetimeSearchInput" placeholder="Search Date & Time...">
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="context-row" id="contextRow">
                                                <div class="context-pill" id="activeContext">
                                                    Page 1 
                                                    <span class="context-close" id="btnCloseContext">Ã—</span>
                                                </div>
                                                <div class="context-pill add-context" id="btnAddContext" style="display:none;">
                                                    + Add current page as context
                                                </div>
                                            </div>
                                            
                                            <div class="input-container">
                                                <div id="mainInput" class="main-input" contenteditable="true" data-placeholder="Ask or assign task..."></div>
                                            </div>
                                            
                                            <div class="input-toolbar">
                                                <div class="toolbar-left">
                                                    <button class="tool-icon-btn" id="btnSlashMenu" title="Open Presets">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                                                            <rect x="3" y="3" width="18" height="18" rx="4" ry="4"></rect>
                                                            <line x1="10" y1="16" x2="14" y2="8"></line>
                                                        </svg>
                                                    </button>
                                                    <button class="tool-icon-btn" title="Attach">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                                                    </button>
                                                </div>
                                                <div class="toolbar-right">
                                                    <button class="tool-icon-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></button>
                                                    <button class="send-btn-square" id="btnSend"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>

                <main class="main-content pushed-by-dock" id="mainContent">
                    <div class="table-skeleton-container">
                        <div class="skeleton-row header">
                            <div class="skeleton-cell"><div class="skeleton-bar"></div></div>
                            <div class="skeleton-cell"><div class="skeleton-bar"></div></div>
                            <div class="skeleton-cell"><div class="skeleton-bar"></div></div>
                            <div class="skeleton-cell"><div class="skeleton-bar"></div></div>
                            <div class="skeleton-cell"><div class="skeleton-bar"></div></div>
                            <div class="skeleton-cell"><div class="skeleton-bar"></div></div>
                        </div>
                        
                        <script>
                            for(let i = 0; i < 20; i++) {
                                let cellsHtml = '';
                                for(let j=0; j<6; j++) {
                                     const width = 50 + Math.random() * 50;
                                     cellsHtml += `<div class="skeleton-cell"><div class="skeleton-bar" style="width: ${width}%"></div></div>`;
                                }
                                document.write(`<div class="skeleton-row">${cellsHtml}</div>`);
                            }
                        </script>
                    </div>
                </main>

            </div>
        </div>
    </div>

    <script>
        const panel = document.getElementById('chatPanel');
        const mainContent = document.getElementById('mainContent');
        const btnMinimize = document.getElementById('btnMinimize');
        const btnRestoreMin = document.getElementById('btnRestoreMin');
        const btnCloseMin = document.getElementById('btnCloseMin');
        const btnFull = document.getElementById('btnFull');
        const btnDock = document.getElementById('btnDock');
        const btnClose = document.getElementById('btnClose');
        const navAiToggle = document.getElementById('navAiToggle');
        
        // Context Elements
        const btnCloseContext = document.getElementById('btnCloseContext');
        const contextRow = document.getElementById('contextRow');
        const activeContext = document.getElementById('activeContext');
        const btnAddContext = document.getElementById('btnAddContext');

        const historySheet = document.getElementById('historySheet');
        const btnShowHistory = document.getElementById('btnShowHistory');
        const btnCloseHistory = document.getElementById('btnCloseHistory');
        const btnNewChat = document.getElementById('btnNewChat');
        const btnHistoryNewChat = document.getElementById('btnHistoryNewChat');
        const historyPlaceholder = document.getElementById('historyPlaceholder');
        
        const emptyState = document.getElementById('emptyState');
        const activeChat = document.getElementById('activeChat');
        const chatScrollArea = document.querySelector('.chat-scroll-area');
        const chatTitle = document.querySelector('.chat-title');
        
        // Lists
        const pinnedList = document.getElementById('pinnedList');
        const todayList = document.getElementById('todayList');

        const btnSlashMenu = document.getElementById('btnSlashMenu');
        const promptSheet = document.getElementById('promptSheet');
        const dragHandle = document.getElementById('dragHandle');

        // Input
        const mainInput = document.getElementById('mainInput');
        const btnSend = document.getElementById('btnSend');
        const enhancedInputBox = document.getElementById('enhancedInputBox');

        // Menu Elements
        const globalContextMenu = document.getElementById('globalContextMenu');
        const pinText = document.getElementById('pinText');
        
        const btnChatMenu = document.getElementById('btnChatMenu');
        const chatDropdown = document.getElementById('chatDropdown');
        const chatMenuContainer = document.getElementById('chatMenuContainer');
        const headerPinText = document.getElementById('headerPinText');

        // Modals
        const renameModal = document.getElementById('renameModal');
        const renameInput = document.getElementById('renameInput');
        const deleteModal = document.getElementById('deleteModal');

        // Menu Elements
        const customerMenu = document.getElementById('customerMenu');
        const customerList = document.getElementById('customerList');
        const customerSearchInput = document.getElementById('customerSearchInput');

        const vehicleMenu = document.getElementById('vehicleMenu');
        const vehicleList = document.getElementById('vehicleList');
        const vehicleSearchInput = document.getElementById('vehicleSearchInput');

        const vinMenu = document.getElementById('vinMenu');
        const vinList = document.getElementById('vinList');
        const vinSearchInput = document.getElementById('vinSearchInput');

        const datetimeMenu = document.getElementById('datetimeMenu');
        const datetimeList = document.getElementById('datetimeList');
        const datetimeSearchInput = document.getElementById('datetimeSearchInput');

        let historyAdded = false;
        let currentItem = null; 

        let isDragging = false;
        let startX, startLeft;

        let activePromptVar = null; // Track the span triggering the menu
        let currentActiveMenu = null;

        // Data Placeholders
        const customers = ["James T. Kirk", "Sarah Connor", "Marty McFly", "Ellen Ripley", "Tony Stark"];
        const vehicles = ["2024 Toyota Camry SE", "2023 Ford F-150 XLT", "2024 Honda CR-V EX-L", "2023 Tesla Model Y Long Range", "2024 Chevrolet Silverado 1500 RST"];
        const vins = [
            { vin: "1G1...5678", desc: "2020 Chevy Malibu LT" },
            { vin: "5XY...1234", desc: "2021 Kia Telluride SX" },
            { vin: "JTE...9876", desc: "2019 Toyota RAV4 LE" },
            { vin: "1FT...4321", desc: "2022 Ford Explorer ST" },
            { vin: "JN1...5555", desc: "2023 Nissan Altima SR" }
        ];
        const datetimes = [
            "Oct 24, 2025 at 10:00 AM",
            "Oct 24, 2025 at 2:00 PM",
            "Oct 25, 2025 at 9:30 AM",
            "Oct 25, 2025 at 11:00 AM",
            "Oct 26, 2025 at 4:00 PM"
        ];

        // --- MENU LOGIC ---
        function renderCustomerList(filter = "") {
            customerList.innerHTML = '';
            customers.filter(c => c.toLowerCase().includes(filter.toLowerCase())).forEach(c => {
                const div = document.createElement('div');
                div.className = 'popup-item';
                div.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg> ${c}`;
                div.onclick = () => selectItem(c);
                customerList.appendChild(div);
            });
        }

        function renderVehicleList(filter = "") {
            vehicleList.innerHTML = '';
            vehicles.filter(v => v.toLowerCase().includes(filter.toLowerCase())).forEach(v => {
                const div = document.createElement('div');
                div.className = 'popup-item';
                div.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg> ${v}`;
                div.onclick = () => selectItem(v);
                vehicleList.appendChild(div);
            });
        }

        function renderVinList(filter = "") {
            vinList.innerHTML = '';
            vins.filter(item => item.vin.toLowerCase().includes(filter.toLowerCase()) || item.desc.toLowerCase().includes(filter.toLowerCase())).forEach(item => {
                const div = document.createElement('div');
                div.className = 'vin-item';
                div.innerHTML = `
                    <div class="vin-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 19H5v-5h14v5z"/></svg></div>
                    <div class="vin-details">
                        <div class="vin-text">${item.vin}</div>
                        <div class="vin-desc">${item.desc}</div>
                    </div>
                `;
                div.onclick = () => selectItem(item.vin);
                vinList.appendChild(div);
            });
        }

        function renderDateTimeList(filter = "") {
            datetimeList.innerHTML = '';
            datetimes.filter(d => d.toLowerCase().includes(filter.toLowerCase())).forEach(d => {
                const div = document.createElement('div');
                div.className = 'popup-item';
                div.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> ${d}`;
                div.onclick = () => selectItem(d);
                datetimeList.appendChild(div);
            });
        }

        function showMenu(menu, input, renderFn, targetElement) {
            closeAllMenus();
            
            input.value = '';
            renderFn();
            
            // Just reveal it (positioned via CSS)
            menu.classList.add('visible'); 
            enhancedInputBox.classList.add('menu-open');
            
            setTimeout(() => input.focus(), 50);
            
            currentActiveMenu = menu;
        }

        function selectItem(text) {
            if(activePromptVar) {
                activePromptVar.innerText = text;
                activePromptVar.classList.remove('prompt-var');
                activePromptVar.classList.add('filled-var');
                closeAllMenus();
                activePromptVar = null;
                updateSendButton();

                // Auto-trigger next menu if available (Chaining)
                setTimeout(() => {
                     const nextVar = mainInput.querySelector('.prompt-var');
                     if(nextVar) {
                         const txt = nextVar.innerText.toLowerCase();
                         activePromptVar = nextVar;
                         if(txt === '[customer]') showMenu(customerMenu, customerSearchInput, () => renderCustomerList(), nextVar);
                         else if(txt === '[vehicle]') showMenu(vehicleMenu, vehicleSearchInput, () => renderVehicleList(), nextVar);
                         else if(txt === '[vin]') showMenu(vinMenu, vinSearchInput, () => renderVinList(), nextVar);
                         else if(txt === '[date & time]') showMenu(datetimeMenu, datetimeSearchInput, () => renderDateTimeList(), nextVar);
                     }
                }, 150);
            }
        }

        function closeAllMenus() {
            customerMenu.classList.remove('visible');
            vehicleMenu.classList.remove('visible');
            vinMenu.classList.remove('visible');
            datetimeMenu.classList.remove('visible');
            enhancedInputBox.classList.remove('menu-open');
            currentActiveMenu = null;
        }

        // Search Listeners
        customerSearchInput.addEventListener('input', (e) => renderCustomerList(e.target.value));
        vehicleSearchInput.addEventListener('input', (e) => renderVehicleList(e.target.value));
        vinSearchInput.addEventListener('input', (e) => renderVinList(e.target.value));
        datetimeSearchInput.addEventListener('input', (e) => renderDateTimeList(e.target.value));

        // --- HELPER: Find History Item by Title ---
        function getActiveHistoryItem() {
            const title = chatTitle.innerText;
            const items = document.querySelectorAll('.history-text');
            for(let span of items) {
                if(span.innerText === title) {
                    return span.closest('.history-item');
                }
            }
            return null;
        }

        // --- HELPER: Check Empty List ---
        function checkEmptyHistory() {
            if(todayList.children.length === 0) {
                historyPlaceholder.classList.add('visible');
                document.getElementById('historyTodaySection').style.display = 'none';
            } else {
                historyPlaceholder.classList.remove('visible');
                document.getElementById('historyTodaySection').style.display = 'block';
            }
        }

        // --- MENU LOGIC ---
        window.showItemMenu = function(e) {
            e.stopPropagation();
            currentItem = e.currentTarget.closest('.history-item');
            
            const isPinned = currentItem.parentElement.id === 'pinnedList';
            pinText.innerText = isPinned ? 'Unpin Chat' : 'Pin Chat';

            const rect = e.currentTarget.getBoundingClientRect();
            globalContextMenu.style.top = (rect.bottom + 5) + 'px';
            globalContextMenu.style.left = (rect.left - 120) + 'px';
            globalContextMenu.classList.add('visible');
            
            chatDropdown.classList.remove('visible');
        };

        window.openRenameModalFromHeader = function() {
            currentItem = getActiveHistoryItem();
            openRenameModal(); 
        }

        window.openDeleteModalFromHeader = function() {
            currentItem = getActiveHistoryItem();
            openDeleteModal();
        }

        window.togglePinFromHeader = function() {
            currentItem = getActiveHistoryItem();
            if(currentItem) togglePin();
            chatDropdown.classList.remove('visible');
        };

        window.togglePin = function() {
            if(!currentItem) return;
            const isPinned = currentItem.parentElement.id === 'pinnedList';
            
            if(isPinned) {
                todayList.prepend(currentItem); 
            } else {
                pinnedList.appendChild(currentItem); 
            }
            globalContextMenu.classList.remove('visible');
            checkEmptyHistory(); 
        };

        // --- CONTEXT TOGGLE LOGIC ---
        // Clicking 'x' hides active, shows Add button
        btnCloseContext.onclick = (e) => {
            e.stopPropagation();
            activeContext.style.display = 'none';
            btnAddContext.style.display = 'inline-flex';
        };

        // Clicking Add button hides itself, shows active
        btnAddContext.onclick = (e) => {
             e.stopPropagation(); // Explicitly handle click on div
             btnAddContext.style.display = 'none';
             activeContext.style.display = 'inline-flex';
        };

        // --- MODAL LOGIC ---
        window.openRenameModal = function() {
            let initialName = "";
            if(currentItem) {
                initialName = currentItem.querySelector('.history-text').innerText;
            } else {
                initialName = chatTitle.innerText; 
            }
            renameInput.value = initialName;
            renameModal.classList.add('visible');
            globalContextMenu.classList.remove('visible');
            chatDropdown.classList.remove('visible');
            renameInput.focus();
        };

        window.saveRename = function() {
            if(renameInput.value.trim() !== "") {
                const newName = renameInput.value;
                if(currentItem) {
                    const textSpan = currentItem.querySelector('.history-text');
                    textSpan.innerText = newName;
                    if(chatTitle.innerText === textSpan.innerText || getActiveHistoryItem() === currentItem) {
                        chatTitle.innerText = newName;
                    }
                } else {
                    chatTitle.innerText = newName;
                }
            }
            closeModals();
        };

        window.openDeleteModal = function() {
            deleteModal.classList.add('visible');
            globalContextMenu.classList.remove('visible');
            chatDropdown.classList.remove('visible');
        };

        window.confirmDelete = function() {
            if(currentItem) {
                const textSpan = currentItem.querySelector('.history-text');
                if(chatTitle.innerText === textSpan.innerText) {
                    resetChat();
                }
                currentItem.remove();
                checkEmptyHistory();
            } else {
                resetChat();
            }
            closeModals();
        };

        window.closeModals = function() {
            renameModal.classList.remove('visible');
            deleteModal.classList.remove('visible');
        };

        // --- DRAG HANDLER ---
        dragHandle.onmousedown = function(e) {
            if(!panel.classList.contains('state-minimized')) return;
            isDragging = true;
            startX = e.clientX;
            const style = window.getComputedStyle(panel);
            startLeft = parseInt(style.left);
            panel.style.transition = 'none';
            document.body.style.cursor = 'grabbing';
            e.preventDefault(); 
        };

        document.onmousemove = function(e) {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            let newLeft = startLeft + dx;
            const maxLeft = window.innerWidth - panel.offsetWidth - 20;
            if (newLeft < 20) newLeft = 20;
            if (newLeft > maxLeft) newLeft = maxLeft;
            panel.style.left = newLeft + 'px';
        };

        document.onmouseup = function() {
            if (isDragging) {
                isDragging = false;
                panel.style.transition = ''; 
                document.body.style.cursor = '';
            }
        };

        function scrollToBottom() {
            chatScrollArea.scrollTop = chatScrollArea.scrollHeight;
        }

        // --- PROMPT SHEET LOGIC ---
        btnSlashMenu.onclick = (e) => {
            e.stopPropagation();
            promptSheet.classList.add('visible');
        }
        
        window.closePromptSheet = function() {
            promptSheet.classList.remove('visible');
        }

        // Fill Input with Variable Styling
        window.fillInput = function(text) {
            // Regex to replace [text] with styled span
            const formattedHTML = text.replace(/\[(.*?)\]/g, '<span class="prompt-var">[$1]</span>');
            mainInput.innerHTML = formattedHTML;
            
            promptSheet.classList.remove('visible');
            mainInput.focus();
            
            // Move cursor to end (contenteditable quirk)
            const range = document.createRange();
            const sel = window.getSelection();
            range.selectNodeContents(mainInput);
            range.collapse(false);
            sel.removeAllRanges();
            sel.addRange(range);
            
            updateSendButton(); 
            
            // Menu Triggers Logic (Sequential)
            setTimeout(() => {
                const vars = mainInput.querySelectorAll('.prompt-var');
                // Only trigger the FIRST one found to start the sequence
                for(const span of vars) {
                    const txt = span.innerText.toLowerCase();
                    activePromptVar = span;
                    
                    if(txt === '[customer]') {
                        showMenu(customerMenu, customerSearchInput, () => renderCustomerList(), span);
                        break; 
                    } else if(txt === '[vehicle]') {
                        showMenu(vehicleMenu, vehicleSearchInput, () => renderVehicleList(), span);
                        break;
                    } else if(txt === '[vin]') {
                        showMenu(vinMenu, vinSearchInput, () => renderVinList(), span);
                        break;
                    } else if(txt === '[date & time]') {
                        showMenu(datetimeMenu, datetimeSearchInput, () => renderDateTimeList(), span);
                        break;
                    }
                }
            }, 50); 
        };

        function updateSendButton() {
            if (mainInput.innerText.trim().length > 0) {
                btnSend.classList.add('active');
            } else {
                btnSend.classList.remove('active');
            }
        }

        // --- INPUT EVENT HANDLING (DIV) ---
        mainInput.addEventListener('input', function(e) {
            if (this.innerText === '/') {
                promptSheet.classList.add('visible');
            }
            updateSendButton();
        });

        mainInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                if (this.innerText.trim() !== '') {
                    const text = this.innerText;
                    this.innerHTML = ''; // Clear
                    updateSendButton();
                    handleSend(text);
                }
            }
        });

        btnSend.onclick = () => {
            if (mainInput.innerText.trim() !== '') {
                const text = mainInput.innerText;
                mainInput.innerHTML = '';
                updateSendButton();
                handleSend(text);
            }
        };

        function handleSend(text) {
            let logicKey = text;
            const lower = text.toLowerCase();
            
            if(lower.includes('stock availability') || lower.includes('inventory')) logicKey = '/inventory-check';
            else if(lower.includes('closing probability') || lower.includes('deal')) logicKey = '/deal-probability';
            else if(lower.includes('soft credit') || lower.includes('credit')) logicKey = '/credit-prequal';
            else if(lower.includes('trade-in') || lower.includes('estimate value')) logicKey = '/trade-in-val';
            else if(lower.includes('test drive') || lower.includes('book')) logicKey = '/schedule-drive';
            else if(text.includes('Summarize')) logicKey = 'Summarize recent car leads';

            startChat(text, logicKey);
        }

        btnChatMenu.onclick = (e) => {
            e.stopPropagation();
            const item = getActiveHistoryItem();
            if (item) {
                const isPinned = item.parentElement.id === 'pinnedList';
                headerPinText.innerText = isPinned ? 'Unpin Chat' : 'Pin Chat';
            } else {
                headerPinText.innerText = 'Pin Chat';
            }
            chatDropdown.classList.toggle('visible');
            globalContextMenu.classList.remove('visible');
        };

        document.addEventListener('click', (e) => {
            if (!promptSheet.contains(e.target) && e.target !== btnSlashMenu && e.target !== mainInput) {
                promptSheet.classList.remove('visible');
            }
            if(!globalContextMenu.contains(e.target)) {
                globalContextMenu.classList.remove('visible');
            }
            if(!chatDropdown.contains(e.target) && e.target !== btnChatMenu) {
                chatDropdown.classList.remove('visible');
            }
            // Close active menu if clicking outside
            if(currentActiveMenu && !currentActiveMenu.contains(e.target) && !e.target.classList.contains('prompt-var')) {
                closeAllMenus();
            }
            if(e.target === renameModal) closeModals();
            if(e.target === deleteModal) closeModals();
        });

        async function typeWriter(container, htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const nodes = Array.from(doc.body.childNodes);
            container.innerHTML = '';
            async function typeNode(node, parent) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    const textNode = document.createTextNode('');
                    parent.appendChild(textNode);
                    for (let char of text) {
                        textNode.textContent += char;
                        await new Promise(r => setTimeout(r, 5)); 
                        scrollToBottom();
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const newElement = document.createElement(node.tagName);
                    Array.from(node.attributes).forEach(attr => newElement.setAttribute(attr.name, attr.value));
                    parent.appendChild(newElement);
                    const children = Array.from(node.childNodes);
                    for (const child of children) {
                        await typeNode(child, newElement);
                    }
                }
            }
            for (const node of nodes) await typeNode(node, container);
        }

        window.loadHistoryChat = function(title) {
            emptyState.style.display = 'none';
            activeChat.style.display = 'flex';
            promptSheet.classList.remove('visible');
            
            chatTitle.innerText = title;
            activeChat.innerHTML = '';
            
            btnNewChat.disabled = false;
            chatMenuContainer.style.display = 'block';

            const userBubble = document.createElement('div');
            userBubble.className = 'message-bubble user';
            userBubble.innerText = title;
            activeChat.appendChild(userBubble);

            const aiRow = document.createElement('div');
            aiRow.className = 'ai-message-row';
            const avatar = document.createElement('div');
            avatar.className = 'ai-avatar';
            avatar.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg>';
            aiRow.appendChild(avatar);
            const aiContent = document.createElement('div');
            aiContent.className = 'ai-content';
            aiContent.innerHTML = `<p>Loading deal details for <strong>${title}</strong>...</p>`;
            aiRow.appendChild(aiContent);
            activeChat.appendChild(aiRow);

            if(!panel.classList.contains('state-fullscreen')) {
                historySheet.classList.remove('open');
            }
            
            scrollToBottom();
            mainInput.focus();
        }

        window.startChat = function(userText, logicKey) {
            if(!logicKey) logicKey = userText;

            emptyState.style.display = 'none';
            activeChat.style.display = 'flex';
            promptSheet.classList.remove('visible'); 
            
            if (!historyAdded) {
                let historyTitle = userText;
                if (historyTitle.length > 25) historyTitle = historyTitle.substring(0, 25) + "...";
                
                chatTitle.innerText = historyTitle;
                
                btnNewChat.disabled = false;
                chatMenuContainer.style.display = 'block';

                const newItem = document.createElement('div');
                newItem.className = 'history-item';
                newItem.onclick = () => loadHistoryChat(historyTitle); 
                
                newItem.innerHTML = `
                    <div class="history-item-left">
                        <span class="history-text">${historyTitle}</span>
                    </div>
                    <button class="history-item-menu-btn" onclick="showItemMenu(event)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                    </button>
                `;
                todayList.insertAdjacentElement('afterbegin', newItem);
                historyAdded = true;
                checkEmptyHistory();
            }

            const userBubble = document.createElement('div');
            userBubble.className = 'message-bubble user';
            // Render HTML if variables present, otherwise text
            if(userText.includes('<span')) userBubble.innerHTML = userText;
            else userBubble.innerText = userText;

            activeChat.appendChild(userBubble);
            scrollToBottom();

            // REQ 1: Randomize Thinking Time (4-8s)
            const delay = Math.floor(Math.random() * (8000 - 4000 + 1) + 4000); 

            const thinkingRow = document.createElement('div');
            thinkingRow.className = 'ai-message-row';
            const thinkingAvatar = document.createElement('div');
            thinkingAvatar.className = 'ai-avatar thinking';
            thinkingAvatar.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg>';
            thinkingRow.appendChild(thinkingAvatar);
            const thinkingContent = document.createElement('div');
            thinkingContent.className = 'ai-content';
            thinkingContent.innerHTML = `<div class="thinking-text">Thinking...</div>`;
            thinkingRow.appendChild(thinkingContent);
            activeChat.appendChild(thinkingRow);
            scrollToBottom();

            setTimeout(async () => {
                activeChat.removeChild(thinkingRow);
                const aiRow = document.createElement('div');
                aiRow.className = 'ai-message-row';
                const aiAvatar = document.createElement('div');
                aiAvatar.className = 'ai-avatar';
                aiAvatar.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path></svg>';
                aiRow.appendChild(aiAvatar);
                const aiContent = document.createElement('div');
                aiContent.className = 'ai-content';
                aiRow.appendChild(aiContent);
                activeChat.appendChild(aiRow);
                
                let responseHTML = "";
                switch(logicKey) {
                    case 'Summarize recent car leads':
                        responseHTML = `<p>Here is a summary of the active car leads from the current page view:</p><div class="ai-list-item"><span class="ai-list-number">1.</span><span><strong>John Doe:</strong> Interested in 2024 Honda CR-V. Financing pending.</span></div><div class="ai-list-item"><span class="ai-list-number">2.</span><span><strong>Sarah Smith:</strong> Requesting test drive for Ford Explorer. Trade-in valuation needed.</span></div><div class="ai-list-item"><span class="ai-list-number">3.</span><span><strong>Mike Johnson:</strong> Lease expiring soon. Looking at Toyota Camry options.</span></div>`;
                        break;
                    case 'Draft quote for Model X':
                        responseHTML = `<p><strong>Subject: Your Tesla Model X Quote</strong></p><p>Hi <strong>[Customer Name]</strong>,</p><p>Great choice on the <strong>Model X</strong>. Based on your configuration (Long Range, Black Interior), here is the preliminary quote attached. This includes the federal tax incentive deduction.</p>`;
                        break;
                    case 'List high-priority test drives':
                        responseHTML = `<p><strong>Today's High Priority Test Drives:</strong></p><div class="ai-list-item"><span class="ai-list-number">1.</span><span><strong>10:00 AM - BMW X5</strong> (Client: A. Miller)</span></div><div class="ai-list-item"><span class="ai-list-number">2.</span><span><strong>1:30 PM - Audi Q7</strong> (Client: B. Davis) - <em>Confirm trade-in arrival</em></span></div>`;
                        break;
                    case '/inventory-check':
                        responseHTML = `<strong>Stock Status:</strong><br>We have 3 units matching that description at the Main Lot, and 1 in transit (ETA: 5 days).`;
                        break;
                    case '/deal-probability':
                        responseHTML = `<strong>Deal Probability: 75%</strong><br>Customer has high intent. Credit score is solid (720+). Pending spouse approval on color.`;
                        break;
                    case '/credit-prequal':
                        responseHTML = `<strong>Soft Pull Result:</strong><br>Tier 1 Credit Qualified. Rate eligibility: 3.9% APR for 60 months.`;
                        break;
                    case '/trade-in-val':
                        responseHTML = `<strong>Estimated Value:</strong> $18,500 - $20,000<br>Based on 2018 model year with 45k miles and 'Good' condition.`;
                        break;
                    case '/schedule-drive':
                        responseHTML = `<strong>Slot Confirmed:</strong><br>Test drive scheduled for Saturday, Oct 24th at 11:00 AM. Confirmation SMS sent.`;
                        break;
                    default:
                        responseHTML = "Analyzing CRM data...";
                }
                await typeWriter(aiContent, responseHTML);
                const actionRow = document.createElement('div');
                actionRow.className = 'ai-actions-row';
                const icons = [
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>',
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path></svg>',
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>',
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>'
                ];
                icons.forEach(svg => {
                    const btn = document.createElement('button');
                    btn.className = 'ai-action-btn';
                    btn.innerHTML = svg;
                    actionRow.appendChild(btn);
                });
                activeChat.appendChild(actionRow);
                scrollToBottom();
            }, delay);
        }

        function resetChat() {
            activeChat.innerHTML = '';
            activeChat.style.display = 'none';
            emptyState.style.display = 'flex';
            contextRow.style.display = 'flex';
            chatTitle.innerText = "New Chat"; 
            chatMenuContainer.style.display = 'none';
            btnNewChat.disabled = true;

            historyAdded = false; 
            mainInput.innerHTML = '';
            updateSendButton();
            mainInput.focus();
        }

        btnNewChat.onclick = resetChat;
        // Close history sheet on New Chat click from Side Sheet
        btnHistoryNewChat.onclick = () => {
            resetChat();
            if(!panel.classList.contains('state-fullscreen')) {
                historySheet.classList.remove('open');
            }
        };

        mainContent.onclick = () => {
            if(emptyState.style.display !== 'none') {
                contextRow.style.display = 'flex';
            }
        };

        // Window Controls
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btnMinimize').onclick = () => setState('minimized');
            document.getElementById('btnRestoreMin').onclick = () => setState('docked');
            document.getElementById('btnCloseMin').onclick = () => setState('closed');
            document.getElementById('btnFull').onclick = () => setState('fullscreen');
            document.getElementById('btnDock').onclick = () => setState('docked');
            document.getElementById('btnClose').onclick = () => setState('closed');
        });

        // Global State Logic
        function setState(state) {
            panel.classList.remove('state-docked', 'state-minimized', 'state-fullscreen', 'state-closed');
            mainContent.classList.remove('pushed-by-dock', 'full-hidden');
            btnFull.style.display = 'flex';
            btnDock.style.display = 'none';

            if (state === 'closed') navAiToggle.classList.remove('active');
            else navAiToggle.classList.add('active');

            if (state === 'docked') {
                panel.classList.add('state-docked');
                mainContent.classList.add('pushed-by-dock');
                panel.style.left = ''; 
            } else if (state === 'minimized') {
                panel.classList.add('state-minimized');
                if(!panel.style.left) panel.style.left = '20px';
            } else if (state === 'fullscreen') {
                panel.classList.add('state-fullscreen');
                mainContent.classList.add('full-hidden');
                btnFull.style.display = 'none';
                btnDock.style.display = 'flex';
                panel.style.left = '';
            } else if (state === 'closed') {
                panel.classList.add('state-closed');
                panel.style.left = '';
            }
        }

        navAiToggle.onclick = () => {
            if (panel.classList.contains('state-closed')) setState('docked');
            else setState('closed');
        };

        btnShowHistory.onclick = () => historySheet.classList.add('open');
        btnCloseHistory.onclick = () => historySheet.classList.remove('open');

        // Load directly into a new conversation
        window.onload = function() {
            resetChat();
        };

    </script>
</body>
</html>
