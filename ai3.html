<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Assistant</title>
    <style>
        :root {
            /* --- TOKENS --- */
            /* Colors */
            --color-primary: #4285F4;
            --gradient-brand: linear-gradient(38deg, #2157F5 0%, #3C6DFF 50%, #47FF97 100%);
            --color-text-on-primary: #FFFFFF;
            --color-danger: #EF4444;

            --color-text-main: #444F5C;
            --color-text-heading: #161616;
            --color-text-muted: #969AA3;
            --color-text-subtle: #64748B;

            --color-bg-main: #FFFFFF;
            --color-bg-dark: #3F4757;
            --color-bg-surface: #F4F5F6;
            --color-bg-hover: #F8FAFC;
            --color-bg-message: #EEF2F6;

            --color-border: #D4D5D6;
            --color-border-muted: #E8E9EB;
            --color-border-hover: #969AA3;

            --gradient-primary: linear-gradient(94deg, rgba(147, 124, 249, 0.2) 1.61%, rgba(123, 235, 236, 0.2) 107.91%), #FFFFFF;
            --gradient-surface: linear-gradient(94deg, rgba(123, 235, 236, 0.40) 0%, rgba(147, 124, 249, 0.40) 98.94%), #FFFFFF;
            --gradient-ai: linear-gradient(320deg, #2157F5 8.61%, #258DFF 39.1%, #86FFBB 92.21%), #FFFFFF;

            /* Dimensions */
            --header-height: 48px;
            --sidebar-width: 400px;
            --sidebar-min-width: 280px;
            --sidebar-collapsed-width: 60px;
            --icon-sm: 14px;
            --icon-md: 16px;
            --icon-lg: 20px;
            --icon-xl: 24px;
            --radius-xs: 4px;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;

            /* Component Dimensions */
            --nav-height: 50px;
            --btn-size: 40px;
            --sidebar-min-height: 48px;
            --panel-width: 320px;
            --spacer-height: 160px;
            --popup-max-height: 380px;
            --full-content-max-width: 900px;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-card: 0 -2px 10px rgba(0, 0, 0, 0.03);
            --shadow-sidebar: 0 -4px 12px rgba(0, 0, 0, 0.08);

            /* Spacing */
            --space-2xs: 2px;
            --space-xs: 4px;
            --space-s: 6px;
            --space-sm: 8px;
            --space-m: 10px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 20px;
            --space-2xl: 24px;
            --space-3xl: 32px;
            --space-4xl: 40px;

            /* Motions */
            --transition-speed-fast: 0.1s;
            --transition-speed-normal: 0.2s;
            --transition-speed-slow: 0.3s;
            --transition-speed-slower: 0.4s;

            /* Z-Index */
            --z-base: 0;
            --z-raised: 1;
            --z-overlay: 10;
            --z-nav: 20;
            --z-sidebar: 30;
            --z-modal: 50;
            --z-top: 100;
            --z-max: 9999;
            --z-maximum: 10000;

            /* Stroke Width */
            --stroke-normal: 2px;
            --stroke-thick: 2.5px;

            /* Layout */
            --w-full: 100%;
            --bubble-max-width: 85%;

            /* Extra Colors & Spacing */
            --color-disabled: #D4D5D6;
            --color-stop-btn: #94A3B8;
            --color-stop-btn-hover: #64748B;
            --color-danger-bg: #FFF5F5;
            --color-btn-secondary: #EDF2F7;
            --space-10: 10px;

            /* Typography */
            --font-xs: 0.75rem;
            --font-sm: 0.85rem;
            --font-base: 0.95rem;
            /* Slightly larger base */
            --font-md: 1rem;
            --font-lg: 1.1rem;
            --font-xl: 1.6rem;

            /* Aurora Glow Colors */
            --aurora-color-1: rgba(134, 255, 187, 0.5);
            --aurora-color-2: rgba(37, 141, 255, 0.5);
            --aurora-color-3: rgba(33, 87, 245, 0.5);
            --aurora-color-4: rgba(37, 141, 255, 0.25);
        }

        /* --- Reset & Base --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--color-text-main);
            overflow: hidden;
        }

        /* --- LAYOUT WRAPPER --- */
        .layout-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        .global-top-nav {
            height: var(--nav-height);
            background-color: var(--color-bg-dark);
            flex-shrink: 0;
        }

        .main-row-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* Side Nav Styling */
        .global-side-nav {
            width: var(--sidebar-collapsed-width);
            background-color: var(--color-bg-dark);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: var(--space-lg);
            gap: var(--space-xl);
            z-index: var(--z-sidebar);
        }

        .nav-toggle-btn {
            width: var(--btn-size);
            height: var(--btn-size);
            border: none;
            border-radius: var(--radius-xs);
            cursor: pointer;
            background-color: var(--color-text-muted);
            color: var(--color-text-on-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed-normal);
            font-weight: 600;
            font-size: var(--font-xs);
            font-family: inherit;
        }

        .nav-toggle-btn:hover {
            filter: brightness(1.1);
        }

        #navAiToggle {
            background: var(--gradient-brand);
            color: var(--color-bg-main);
        }

        #navAiToggle.active {
            background: var(--gradient-primary);
            color: var(--color-primary);
        }

        .nav-toggle-btn svg {
            width: var(--icon-lg);
            height: var(--icon-lg);
        }

        .app-container {
            flex: 1;
            position: relative;
            background-color: #fff;
            overflow: hidden;
            display: flex;
        }

        /* --- CHAT SIDEBAR --- */
        .chat-sidebar {
            position: absolute;
            bottom: 0;
            left: 0;
            z-index: var(--z-nav);
            width: var(--sidebar-width);
            height: 100%;
            background: var(--gradient-primary);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform var(--transition-speed-slower) cubic-bezier(0.4, 0, 0.2, 1), width var(--transition-speed-slow) ease;
        }

        .chat-sidebar.state-docked {
            width: var(--sidebar-width);
            height: 100%;
            border-radius: 0;
            transform: translateX(0);
            opacity: 1;
        }

        .chat-sidebar.state-minimized {
            height: var(--sidebar-min-height);
            width: var(--sidebar-min-width);
            left: var(--space-xl);
            bottom: 0;
            transform: translateX(0);
            background: var(--gradient-primary);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-bottom: none;
            border-radius: var(--radius-xs) var(--radius-xs) 0 0;
            box-shadow: var(--shadow-sidebar);
            opacity: 1;
        }

        .chat-sidebar.state-fullscreen {
            width: 100%;
            height: 100%;
            border-radius: 0;
            z-index: var(--z-top);
            transform: translateX(0);
            opacity: 1;
        }

        .chat-sidebar.state-closed {
            width: var(--sidebar-width);
            height: 100%;
            transform: translateX(-100%);
            pointer-events: none;
            opacity: 1;
        }

        /* --- RESPONSIVE DOCKED MODE (< 1600px) --- */
        @media (max-width: 1599px) {
            .chat-sidebar.state-docked {
                position: fixed;
                width: var(--sidebar-width);
                height: 85% !important;
                left: 96px;
                bottom: 0 !important;
                top: auto !important;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
                border: 1px solid rgba(0, 0, 0, 0.1);
                border-bottom: none;
                z-index: var(--z-top);
                transform: translateY(0);
                transform-origin: bottom center;
            }

            .chat-sidebar.state-minimized {
                position: fixed !important;
                width: var(--sidebar-min-width) !important;
                height: var(--sidebar-min-height) !important;
                left: 96px;
                bottom: 0 !important;
                top: auto !important;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15) !important;
                border: 1px solid rgba(0, 0, 0, 0.1) !important;
                border-bottom: none !important;
                z-index: var(--z-top) !important;
                transform: translateY(0) !important;
            }

            .chat-sidebar.state-closed {
                position: fixed !important;
                width: var(--sidebar-width) !important;
                height: 85% !important;
                left: 96px !important;
                bottom: 0 !important;
                top: auto !important;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important;
                z-index: var(--z-top) !important;
                transform: translateY(100%) !important;
            }

            .main-content.pushed-by-dock {
                padding-left: 30px !important;
                padding-right: 30px !important;
                padding-top: 30px !important;
                padding-bottom: 30px !important;
            }

            /* Ensure app-container doesn't reserve space for floating sidebar */
            .app-container {
                padding-left: 0 !important;
            }

            /* Remove rounded corners from chat card in floating mode */
            .chat-card-container {
                border-radius: 0 !important;
            }

            /* Responsive Adjustment for Response Header */
            .response-action-row {
                flex-direction: column;
                align-items: flex-start !important;
                gap: var(--space-sm);
            }

            .response-action-row p {
                width: 100%;
            }

            .filter-applied-badge {
                align-self: flex-start;
            }
        }

        /* --- LISTENING OVERLAY CSS --- */
        .enhanced-input-box {
            position: relative;
            /* Ensure absolute child aligns */
        }

        .listening-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--color-bg-surface);
            border-radius: var(--radius-lg);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            padding: 0 var(--space-lg);
            gap: var(--space-lg);
        }

        .listening-overlay.active {
            display: flex;
        }

        .listen-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-muted);
            padding: var(--space-xs);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color var(--transition-speed-normal);
        }

        .listen-close-btn:hover {
            color: var(--color-text-subtle);
        }

        .listen-visualizer {
            flex: 1;
            height: var(--space-3xl);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2xs);
            mask-image: var(--gradient-surface);
            -webkit-mask-image: var(--gradient-surface);
            overflow: hidden;
        }

        .v-bar {
            width: var(--space-2xs);
            background: var(--gradient-surface);
            border-radius: var(--space-2xs);
            height: var(--space-xs);
            animation: soundWave 0.5s infinite ease-in-out;
        }

        /* Randomize animations for wave effect */
        .v-bar:nth-child(odd) {
            animation-duration: 0.4s;
        }

        .v-bar:nth-child(2n) {
            animation-duration: 0.5s;
        }

        .v-bar:nth-child(3n) {
            animation-duration: 0.6s;
        }

        .v-bar:nth-child(4n) {
            animation-duration: 0.7s;
        }

        .v-bar:nth-child(5n) {
            animation-duration: 0.3s;
        }

        .listen-right-group {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .listen-timer {
            font-family: monospace;
            font-size: var(--font-base);
            color: var(--color-text-subtle);
            min-width: 48px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .listen-stop-btn {
            width: var(--space-3xl);
            height: var(--space-3xl);
            border-radius: 50%;
            background: var(--color-stop-btn);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #fff;
            transition: background var(--transition-speed-normal);
        }

        .listen-stop-btn:hover {
            background: var(--color-stop-btn-hover);
        }

        @keyframes soundWave {

            0%,
            100% {
                height: var(--space-xs);
            }

            50% {
                height: var(--space-xl);
            }
        }

        /* --- WRAPPERS --- */
        .main-view-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            border-radius: inherit;
            min-width: var(--sidebar-width);
            width: var(--sidebar-width);
            padding: 0;
            opacity: 1;
            visibility: visible;
            transition: opacity var(--transition-speed-normal) ease, visibility var(--transition-speed-normal);
            position: relative;
            z-index: 2;
        }

        .chat-sidebar.state-minimized .main-view-wrapper {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            z-index: var(--z-base);
        }

        .minimized-view-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: var(--w-full);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-lg);
            opacity: 0;
            visibility: hidden;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            min-width: var(--sidebar-min-width);
            transition: opacity var(--transition-speed-normal) ease, visibility var(--transition-speed-normal);
            z-index: var(--z-raised);
        }

        .chat-sidebar.state-minimized .minimized-view-wrapper {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            z-index: var(--z-overlay);
            transition-delay: 0.1s;
        }

        .min-left-group {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .drag-handle {
            cursor: grab;
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            padding: var(--space-xs);
            margin-left: -4px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle svg {
            width: var(--icon-md);
            height: var(--icon-md);
        }

        .min-brand {
            font-weight: 600;
            color: var(--color-text-heading);
            font-size: var(--font-md);
            display: flex;
            align-items: center;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            user-select: none;
        }

        .min-controls {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .min-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--color-text-main);
            padding: var(--space-s);
            display: flex;
            align-items: center;
            justify-content: center;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: background var(--transition-speed-normal), color var(--transition-speed-normal);
        }

        .min-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--color-text-heading);
        }

        .min-btn svg {
            width: var(--icon-lg);
            height: var(--icon-lg);
            stroke-width: var(--stroke-thick);
        }

        /* --- TOP BAR --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 44px;
            flex-shrink: 0;
            padding: 0 var(--space-sm) 0 var(--space-lg);
            margin-bottom: 0;
        }

        .brand-text {
            font-size: var(--font-base);
            color: var(--color-text-main);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .window-controls {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
            z-index: var(--z-nav);
            position: relative;
        }

        .win-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: var(--space-s);
            border-radius: var(--radius-sm);
            color: var(--color-text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background var(--transition-speed-normal);
            pointer-events: auto;
        }

        .win-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--color-text-heading);
        }

        .win-btn svg {
            width: var(--icon-md);
            height: var(--icon-md);
            stroke-width: var(--stroke-normal);
        }

        /* --- CARD CONTAINER --- */
        .chat-card-container {
            flex: 1;
            background-color: #fff;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow-card);
            border: none;
            position: relative;
        }

        .chat-sidebar.state-fullscreen .main-view-wrapper {
            width: var(--w-full);
            min-width: 100%;
            padding: 0;
        }

        .chat-sidebar.state-fullscreen .chat-card-container {
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        /* --- NAV HEADER --- */
        .nav-header {
            padding: var(--space-m) var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-bg-main);
            border-bottom: 1px solid var(--color-border);
            flex-shrink: 0;
            position: relative;
            z-index: var(--z-nav);
            min-height: var(--header-height);
        }

        .action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            color: #444F5C;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background var(--transition-speed-normal);
            width: var(--btn-size);
            height: var(--btn-size);
        }

        .action-btn:hover {
            background-color: var(--color-bg-surface);
            color: var(--color-text-heading);
        }

        .action-btn svg {
            width: var(--icon-lg);
            height: var(--icon-lg);
            stroke-width: var(--stroke-normal);
        }

        .action-btn:disabled {
            opacity: 0.3;
            cursor: default;
        }

        .action-btn:disabled:hover {
            background: transparent;
            color: var(--color-disabled);
        }

        .chat-title {
            font-size: var(--font-md);
            font-weight: 600;
            color: var(--color-text-heading);
            text-align: center;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
            margin: 0 var(--space-md);
        }

        #chatMenuContainer {
            display: block;
            position: relative;
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            display: none;
            flex-direction: column;
            min-width: 130px;
            z-index: var(--z-top);
            margin-top: 4px;
        }

        .menu-dropdown.visible {
            display: flex;
        }

        .menu-item {
            padding: var(--space-10) var(--space-lg);
            font-size: var(--font-sm);
            cursor: pointer;
            color: #444F5C;
            text-align: left;
            background: none;
            border: none;
            transition: background var(--transition-speed-normal);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .menu-item:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-heading);
        }

        .menu-item:first-child {
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .menu-item:last-child {
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        .menu-item.danger {
            color: var(--color-danger);
        }

        .menu-item.danger:hover {
            background: var(--color-danger-bg);
        }

        .menu-item svg {
            width: var(--icon-sm);
            height: var(--icon-sm);
            stroke-width: var(--stroke-normal);
        }

        /* EMPTY STATE FOR SEARCHES */
        .search-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-3xl) var(--space-xl);
            text-align: center;
            color: var(--color-text-muted);
            min-height: 200px;
        }

        .search-empty-state svg {
            width: 48px;
            height: 48px;
            color: var(--color-border-hover);
            margin-bottom: var(--space-lg);
            opacity: 0.5;
        }

        .search-empty-state-title {
            font-size: var(--font-base);
            font-weight: 600;
            color: var(--color-text-main);
            margin-bottom: var(--space-xs);
        }

        .search-empty-state-desc {
            font-size: var(--font-sm);
            color: var(--color-text-muted);
            max-width: 280px;
        }

        /* --- HISTORY FULL PAGE --- */
        .history-sheet {
            position: absolute;
            top: 0;
            left: 0;
            width: 85%;
            height: 100%;
            background-color: var(--color-bg-main);
            z-index: var(--z-modal);
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform var(--transition-speed-slow) cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-lg);
            border-right: 1px solid var(--color-border);
            overflow: hidden;
        }

        /* Full width mode should cover 100% */
        .state-fullscreen .history-sheet {
            width: 100%;
            border-right: none;
            box-shadow: none;
        }

        .history-sheet.open {
            transform: translateX(0);
        }

        /* Overlay */
        .history-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: calc(var(--z-modal) - 1);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-speed-normal);
            backdrop-filter: blur(2px);
        }

        .history-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .history-header {
            padding: var(--space-md) var(--space-lg);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            gap: var(--space-sm);
            flex-shrink: 0;
            position: relative;
            min-height: auto;
            border-bottom: 1px solid var(--color-border);
        }

        .history-new-chat-btn {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-border);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--radius-xs);
            color: var(--color-text-heading);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: filter var(--transition-speed-normal);
            width: 100%;
            margin-right: 0;
        }

        .history-new-chat-btn:hover {
            background: var(--color-bg-hover);
            border: 1px solid var(--color-border-hover);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--radius-xs);
            color: var(--color-text-heading);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: filter var(--transition-speed-normal);
            width: 100%;
            margin-right: 0;
        }

        .history-new-chat-btn svg {
            width: 18px;
            height: 18px;
            stroke-width: 2.5px;
        }

        .history-new-chat-btn:disabled {
            opacity: 0.6;
            cursor: default;
            filter: grayscale(0.5);
        }

        .history-header-icon-btn {
            /* Kept for Search/Close icons inside wrappers if needed, but main button is now the above class */
            background: transparent;
            border: none;
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            color: var(--color-text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--btn-size);
            height: var(--btn-size);
            transition: background var(--transition-speed-normal);
            flex-shrink: 0;
        }

        .history-header-icon-btn:hover {
            background-color: var(--color-bg-hover);
            color: var(--color-text-heading);
        }

        .history-header-icon-btn svg {
            width: var(--icon-lg);
            height: var(--icon-lg);
            flex-shrink: 0;
        }

        .history-back-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            color: var(--color-text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--btn-size);
            height: var(--btn-size);
            flex-shrink: 0;
        }

        .history-back-btn:hover {
            background-color: var(--color-bg-surface);
            color: var(--color-text-heading);
        }

        .history-back-btn svg {
            width: var(--icon-lg);
            height: var(--icon-lg);
        }

        .history-search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            height: 36px;
            background: var(--color-bg-main);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xs);
            padding: 0 10px;
            transition: all var(--transition-speed-normal);
        }

        .history-search-wrapper:hover,
        .history-search-wrapper:focus-within {
            border-color: var(--color-border-hover);
            background: var(--color-bg-hover);
        }

        .history-search-wrapper .search-icon {
            width: 16px;
            height: 16px;
            color: var(--color-text-subtle);
            margin-right: 8px;
            flex-shrink: 0;
        }

        .history-search-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: var(--font-base);
            color: var(--color-text-heading);
            outline: none;
            padding: 0;
            width: 100%;
        }

        .history-search-input::placeholder {
            color: var(--color-text-muted);
        }

        .history-search-wrapper.active .history-search-input {
            width: 100%;
            opacity: 1;
            padding-right: var(--space-sm);
        }

        /* Hide title when searching */
        /* Title covered by search overlay */

        .history-search-box .icon-close {
            display: none;
        }

        .history-search-wrapper.active .history-search-box .icon-search {
            display: none;
        }

        .history-search-wrapper.active .history-search-box .icon-close {
            display: block;
        }

        .history-search-box {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            color: var(--color-text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--btn-size);
            height: var(--btn-size);
            transition: background var(--transition-speed-normal);
            flex-shrink: 0;
        }

        .history-search-box:hover {
            background-color: var(--color-bg-hover);
            color: var(--color-text-heading);
        }

        .history-search-box svg {
            width: var(--icon-lg);
            height: var(--icon-lg);
            flex-shrink: 0;
        }

        /* Tab Content Container */
        .history-tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 0px var(--space-sm);
            padding-bottom: var(--space-sm);
        }

        @media (max-width: 768px) {
            .history-tab-content {
                padding-bottom: 80px;
            }
        }

        .history-section-title {
            font-size: var(--font-xs);
            font-weight: 600;
            color: var(--color-text-muted);
            margin: var(--space-lg) 0 var(--space-sm) 0;
            letter-spacing: 0.02em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .history-section-title svg {
            width: 12px;
            height: 12px;
            stroke-width: 2.5px;
        }

        .history-section-title:first-child {
            margin-top: 0;
        }

        .history-placeholder {
            padding: var(--space-xl);
            text-align: center;
            color: var(--color-text-muted);
            font-size: var(--font-sm);
            display: none;
        }

        .history-placeholder.visible {
            display: block;
        }

        /* Bottom Tabs Navigation */
        /* Tabs Navigation */
        .bottom-tabs {
            position: relative;
            height: 48px;
            background-color: var(--color-bg-main);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: stretch;
            justify-content: space-around;
            z-index: var(--z-nav);
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .bottom-tabs {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 64px;
                border-top: 1px solid var(--color-border);
                border-bottom: none;
            }
        }

        .tab-item {
            position: relative;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            color: var(--color-text-subtle);
            transition: all var(--transition-speed-normal);
            flex: 1;
            font-weight: 500;
        }

        /* Active Indicator (Desktop - Bottom Line) */
        .tab-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: transparent;
            transition: background 0.2s ease;
            border-radius: 3px 3px 0 0;
        }

        .tab-item:hover {
            color: var(--color-text-heading);
            background-color: rgba(0, 0, 0, 0.02);
        }

        .tab-item.active {
            color: var(--color-text-heading);
            font-weight: 600;
        }

        .tab-item.active::after {
            background: var(--color-primary);
        }

        .tab-item svg {
            width: 18px;
            height: 18px;
            stroke-width: 2px;
        }

        .tab-item span {
            font-size: 0.9rem;
            font-weight: inherit;
        }

        /* Mobile Adjustments (Revert to Stacked Bottom Bar) */
        @media (max-width: 768px) {
            .tab-item {
                flex-direction: column;
                gap: 4px;
                font-weight: 400;
            }

            .tab-item span {
                font-size: 11px;
            }

            /* Move indicator to top for bottom bar */
            .tab-item::after {
                top: 0;
                bottom: auto;
                border-radius: 0 0 3px 3px;
                width: 40px;
                left: 50%;
                transform: translateX(-50%);
            }
        }

        /* FAB Button for New Chat */
        .history-fab {
            position: absolute;
            bottom: 80px;
            right: var(--space-xl);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--gradient-brand);
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform var(--transition-speed-normal), box-shadow var(--transition-speed-normal);
            z-index: var(--z-overlay);
        }

        .history-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 28px rgba(0, 191, 165, 0.4);
        }

        .history-fab:active {
            transform: scale(0.95);
        }

        .history-fab svg {
            width: var(--icon-xl);
            height: var(--icon-xl);
            stroke-width: var(--stroke-thick);
        }

        /* Tab Content Sections - Hidden by default */
        .tab-content-section {
            display: none;
        }

        .tab-content-section {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .tab-content-section.active {
            display: flex;
        }

        .tab-empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: var(--color-text-muted);
            padding: var(--space-3xl);
            margin: auto;
        }

        /* Tab Content Container */
        .history-tab-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .history-nav-group {
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--color-border-muted);
        }

        .history-nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: 12px var(--space-sm);
            cursor: pointer;
            color: var(--color-text-main);
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .history-nav-item:hover,
        .history-nav-item.active {
            background-color: var(--color-bg-surface);
            color: var(--color-text-heading);
            border-radius: var(--space-xs);
        }

        .history-nav-item svg {
            width: 20px;
            height: 20px;
            color: var(--color-text-muted);
            stroke-width: 1.5px;
            transition: color 0.2s ease;
        }

        .history-nav-item:hover svg,
        .history-nav-item.active svg {
            color: var(--color-primary);
        }

        .history-section-header {
            padding: 24px var(--space-lg) 12px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text-muted);
            letter-spacing: 0.02em;
        }

        .history-footer {
            border-top: 1px solid var(--color-border-muted);
            padding: var(--space-xs) var(--space-md);
            background-color: var(--color-bg-main);
            flex-shrink: 0;
        }

        #recentList {
            padding: 0 var(--space-sm);
        }

        /* History Item Active */
        .history-item.active {
            background-color: var(--color-bg-surface);
        }

        .history-item.active .history-text {
            color: var(--color-text-heading);
            font-weight: 600;
        }

        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px var(--space-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: background var(--transition-speed-normal);
            color: var(--color-text-main);
            font-size: 0.9rem;
            position: relative;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .history-item:hover {
            background-color: var(--color-bg-hover);
            color: var(--color-text-heading);
        }

        .history-item-left {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            overflow: hidden;
            flex: 1;
        }

        .history-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .history-item-actions {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .history-item-pin-btn {
            color: var(--color-stop-btn-hover);
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-xs);
        }

        .history-item-pin-btn svg {
            width: 14px;
            height: 14px;
        }

        .history-item-menu-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--color-text-muted);
            padding: var(--space-xs);
            border-radius: var(--radius-xs);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: background var(--transition-speed-normal);
        }

        .history-item-menu-btn:hover {
            background-color: var(--color-border);
            color: var(--color-text-heading);
        }

        .history-item-menu-btn svg {
            width: var(--icon-md);
            height: var(--icon-md);
        }

        /* GLOBAL CONTEXT MENU & MODALS */
        #globalContextMenu {
            position: fixed;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            display: none;
            flex-direction: column;
            min-width: 140px;
            z-index: var(--z-max);
        }

        /* --- MAIN VIEW MODULES --- */
        .main-view-container {
            padding: var(--space-2xl) var(--space-3xl);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-header {
            margin-bottom: var(--space-3xl);
        }

        .view-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-text-heading);
            margin-bottom: var(--space-xs);
        }

        .view-subtitle {
            font-size: var(--font-base);
            color: var(--color-text-muted);
        }

        /* Insights Grid */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--space-lg);
        }

        .insight-card {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-border-muted);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .insight-card:hover {
            transform: translateY(-4px);
            border-color: var(--color-primary);
        }

        /* Tasks List */
        .tasks-container {
            background: var(--color-bg-surface);
            border-radius: var(--radius-xl);
            border: 1px solid var(--color-border-muted);
            overflow: hidden;
        }

        .task-row {
            padding: var(--space-lg) var(--space-xl);
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            border-bottom: 1px solid var(--color-border-muted);
        }

        .task-row:last-child {
            border-bottom: none;
        }

        .task-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-todo {
            background: var(--color-text-muted);
        }

        .status-progress {
            background: var(--color-primary);
        }

        .status-done {
            background: #10B981;
        }

        /* Templates Grid */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: var(--space-lg);
        }

        .template-card {
            padding: var(--space-lg);
            background: var(--color-bg-surface);
            border: 1px solid var(--color-border-muted);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-card:hover {
            background: var(--color-bg-main);
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            z-index: var(--z-maximum);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-box {
            background: white;
            width: var(--panel-width);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-lg);
            animation: fadeIn 0.2s ease-out;
        }

        .modal-title {
            font-size: var(--font-lg);
            font-weight: 600;
            margin-bottom: var(--space-md);
            color: var(--color-text-heading);
        }

        .modal-input {
            width: var(--w-full);
            padding: var(--space-10);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--font-base);
            margin-bottom: var(--space-lg);
            outline: none;
            color: var(--color-text-heading);
        }

        .modal-input:focus {
            border-color: var(--color-primary);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-sm);
        }

        .modal-btn {
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-sm);
            font-size: var(--font-base);
            font-weight: 500;
            cursor: pointer;
            border: none;
        }

        .modal-btn.secondary {
            background: var(--color-btn-secondary);
            color: var(--color-text-main);
        }

        .modal-btn.primary {
            background: var(--color-primary);
            color: white;
        }

        .modal-btn.danger {
            background: var(--color-danger);
            color: white;
        }

        /* Settings Page Styles */
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-xl);
            max-width: 800px;
        }

        .settings-group {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-border-muted);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
        }

        .settings-group-title {
            font-weight: 600;
            color: var(--color-text-heading);
            margin-bottom: var(--space-md);
            font-size: var(--font-md);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) 0;
            border-bottom: 1px solid var(--color-border-muted);
        }

        .setting-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .setting-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .setting-label {
            font-weight: 500;
            color: var(--color-text-main);
        }

        .setting-desc {
            font-size: var(--font-sm);
            color: var(--color-text-muted);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-border);
            transition: .3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: var(--color-primary);
        }

        input:checked+.toggle-slider:before {
            transform: translateX(20px);
        }

        /* MATCH_THIS_TEXT_NEXT_STEPA */
        /* CHAT CONTENT AREA */
        .chat-scroll-area {
            flex: 1;
            padding: 0;
            /* Padding handled by content-aligner */
            overflow-y: auto;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }

        .scroll-spacer {
            height: 0;
            display: none;
            width: var(--w-full);
            flex-shrink: 0;
        }

        /* --- UNIVERSAL CONTENT ALIGNMENT --- */
        /* This class ensures consistent width and horizontal padding across all responsive modes */
        .content-aligner {
            width: var(--w-full);
            margin: 0 auto;
            box-sizing: border-box;
            padding: 0 var(--space-2xl);
            /* Default for Docked */
            transition: max-width var(--transition-speed-slow) ease, padding var(--transition-speed-slow) ease;
        }

        /* Fullscreen Mode: Centered, limited width */
        .chat-sidebar.state-fullscreen .content-aligner {
            max-width: var(--full-content-max-width);
            padding: 0 var(--space-4xl);
        }

        /* Suggestions List */
        .suggestions-list {
            display: flex;
            flex-direction: column;
            width: 100%;
            margin-bottom: 8px;
            border: none;
            background-color: transparent;
        }

        .suggestion-item {
            background-color: transparent;
            border: none;
            border-bottom: 1px solid var(--color-border-muted);
            padding: var(--space-10) var(--space-10);
            font-size: 0.9rem;
            color: var(--color-text-main);
            cursor: pointer;
            text-align: left;
            transition: background-color var(--transition-speed-normal), color var(--transition-speed-normal);
            line-height: 1.4;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: var(--color-bg-message);
            color: var(--color-text-heading);
            border-radius: var(--radius-sm);
            border-bottom-color: transparent;
        }

        .empty-state-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: var(--w-full);
        }

        .empty-state-content {
            text-align: left;
            /* Width controlled by content-aligner */
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            margin-bottom: var(--space-2xl);
            display: inline-block;
        }

        .empty-icon img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        @keyframes emptyFloating {

            0%,
            100% {
                transform: translateY(0) scale(1);
            }

            50% {
                transform: translateY(-10px) scale(1.05);
            }
        }

        .greeting-title {
            font-size: var(--font-xl);
            color: var(--color-text-heading);
            margin-bottom: var(--space-sm);
            font-weight: 500;
        }

        .greeting-subtitle {
            font-size: var(--font-lg);
            color: var(--color-text-muted);
            margin: 0;
            display: flex;
            align-items: center;
        }

        .active-chat-wrapper {
            display: none;
            flex-direction: column;
            gap: var(--space-lg);
            padding-bottom: var(--space-xl);
            padding-top: var(--space-xl);
        }

        /* Message Bubble Line Height */
        .message-bubble {
            max-width: var(--w-full);
            font-size: 0.875rem;
            line-height: 1.5;
            position: relative;
        }

        .message-bubble.user {
            margin-top: var(--space-md);
            align-self: flex-end;
            max-width: var(--bubble-max-width);
            padding: var(--space-sm) var(--space-md);
            background-color: var(--color-border-muted);
            color: var(--color-text-heading);
            border-radius: var(--radius-lg) var(--radius-lg) 0 var(--radius-lg);
        }

        /* UPDATED: AI Message Row Padding Top 0px */
        .ai-message-row {
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            width: 100%;
            padding-top: 0px;
            animation: fadeIn var(--transition-speed-slow) ease-out;
        }

        .ai-avatar {
            width: 28px;
            height: 28px;
            color: var(--color-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .ai-avatar svg {
            width: 16px;
            height: 16px;
        }

        .ai-avatar svg path {
            fill: url(#aiLogoGradient);
        }

        .ai-avatar.thinking svg {
            animation: blink 1.5s ease-in-out infinite;
        }

        /* WRAPPER FOR VERTICAL ALIGNMENT */
        .ai-text-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* AI Content Font and Line Height */
        .ai-content {
            color: var(--color-text-heading);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .ai-content p {
            margin-bottom: var(--space-md);
            margin-top: 0;
        }

        .ai-content p:last-child {
            margin-bottom: 4px;
        }

        .ai-content strong,
        .ai-content b {
            font-weight: 500 !important;
            color: var(--color-text-heading);
        }

        /* --- REASONING COMPONENT (Bars Style) --- */
        .reasoning-container {
            width: 100%;
            margin-bottom: var(--space-md);
            font-size: 0.8rem;
        }

        .reasoning-header {
            padding-top: 4px !important;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            cursor: pointer;
            user-select: none;
            padding: var(--space-sm) 0px 0px 0px;
            color: var(--color-text-muted);
            transition: color var(--transition-speed-normal);
            width: fit-content;
        }

        .reasoning-header:hover {
            color: var(--color-text-main);
        }

        .reasoning-container.finished .reasoning-header .chevron {
            display: none;
        }

        .status-icon-wrapper {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid var(--color-primary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .check-icon {
            display: none;
            color: #10b981;
        }

        .reasoning-container.finished .status-icon-wrapper {
            display: none;
        }

        .status-text {
            font-weight: 500;
        }

        .reasoning-container:not(.finished) .status-text {
            background: var(--gradient-ai);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
            font-weight: 600;
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .timer {
            font-family: var(--font-mono, monospace);
            opacity: 0.7;
            font-size: 0.75rem;
        }

        .reasoning-container.finished .reasoning-summary-wrapper {
            max-height: 100px;
            opacity: 1;
            margin-top: 4px;
        }

        .reasoning-summary-wrapper {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            padding: 0;
            transition: max-height 0.5s ease, opacity 0.5s ease, margin 0.5s ease;
        }

        .reasoning-summary-wrapper:hover .reasoning-summary {
            color: var(--color-text-main);
        }

        .reasoning-summary-wrapper:hover .chevron {
            opacity: 0.8;
        }

        .reasoning-summary {
            flex: 1;
            font-size: 0.85rem;
            color: var(--color-text-muted);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            transition: color 0.2s;
        }

        .chevron {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0.5;
            margin-top: 2px;
        }

        .reasoning-header .chevron {
            transition: transform 0.3s ease;
            opacity: 0.5;
            width: 16px;
            height: 16px;
        }

        .reasoning-container.expanded .chevron {
            transform: rotate(180deg);
        }

        .reasoning-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: 2px;
            padding-left: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .reasoning-container.expanded .reasoning-content {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 8px;
            padding-bottom: 8px;
        }

        .step {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            color: var(--color-text-muted);
            font-size: 0.8rem;
            line-height: 1.5;
            transition: color 0.3s;
            margin-bottom: 6px;
        }

        .step::before {
            content: '';
            flex-shrink: 0;
            width: 3px;
            height: 14px;
            margin-top: 4px;
            border-radius: 4px;
            background-color: var(--color-border-muted);
            transition: all 0.3s ease;
        }

        .step.active {
            color: var(--color-text-main);
        }

        .step.active::before {
            background-color: var(--color-primary);
            height: 16px;
            margin-top: 3px;
            box-shadow: 0 0 8px rgba(66, 133, 244, 0.2);
        }

        .step.completed::before {
            background-color: var(--color-border-muted);
            opacity: 1;
        }

        .step-text {
            flex: 1;
            opacity: 0;
            animation: fadeIn 0.2s forwards;
            padding-top: 1px;
        }

        .cursor {
            display: inline-block;
            width: 4px;
            height: 12px;
            background-color: var(--color-text-main);
            animation: blink 1s step-end infinite;
            vertical-align: middle;
            margin-left: 4px;
        }

        /* --- INLINE FILTER BADGE & POPOVER --- */
        .inline-filter-badge {
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
            background-color: #E2E8F0;
            color: #444F5C;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
            position: relative;
            top: -1px;
        }

        .inline-filter-badge:hover {
            background-color: #CBD5E0;
            color: #161616;
        }

        .filter-popover {
            position: absolute;
            background: white;
            border: 1px solid var(--color-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            z-index: 100;
            display: none;
            min-width: 180px;
            animation: fadeIn 0.15s ease-out;
            margin-top: 4px;
        }

        .filter-popover.visible {
            display: block;
        }

        .popover-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 6px;
            color: var(--color-text-main);
        }

        .popover-item:last-child {
            margin-bottom: 0;
        }

        .popover-label {
            color: var(--color-text-subtle);
        }

        .popover-value {
            font-weight: 500;
            color: var(--color-text-heading);
            background: var(--color-bg-surface);
            padding: 1px 4px;
            border-radius: 4px;
        }

        .thought-step:last-child {
            margin-bottom: 0;
        }

        /* AI List Item Spacing and Line Height */
        .ai-list-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-s);
            margin-bottom: var(--space-sm);
            line-height: 1.5;
        }

        .ai-list-item:last-child {
            margin-bottom: 0;
        }

        .ai-list-number {
            color: var(--color-text-main);
            font-size: var(--font-base);
            margin-top: 0;
            min-width: var(--space-2xl);
            font-weight: 600;
            flex-shrink: 0;
        }

        .thinking-text {
            font-size: var(--font-sm);
            padding-top: var(--space-xs);
            font-weight: 500;
            animation: fadeText 2s ease-in-out infinite alternate;
            background: linear-gradient(135deg, #86FFBB 0%, #258DFF 15%, #2157F5 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* AI Actions Row Padding */
        .ai-actions-row {
            display: flex;
            align-self: flex-start;
            gap: var(--space-md);
            margin-top: 0px;
            margin-bottom: 4px;
            margin-left: 0px;
            padding-top: var(--space-sm);
            opacity: 0;
            animation: fadeIn var(--transition-speed-slow) ease-in forwards;
        }

        .ai-action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: #969AA3;
            padding: var(--space-xs);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s, background 0.2s;
        }

        .ai-action-btn:hover {
            color: var(--color-text-heading);
            background-color: var(--color-bg-surface);
        }

        .ai-action-btn svg {
            width: var(--icon-md);
            height: var(--icon-md);
            stroke-width: var(--stroke-normal);
        }

        /* --- FOOTER CONTAINER (New wrapper for input + disclaimer) --- */
        .footer-container {
            position: relative;
            bottom: auto;
            left: auto;
            width: var(--w-full);
            background-color: #f9f9f9;
            z-index: var(--z-nav);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-md) 0px;
        }

        /* INPUT WRAPPER HIERARCHY */
        .input-wrapper {
            padding: 0 var(--space-lg);
            /* Width controlled by content-aligner */
        }

        .input-border-wrapper {
            background-color: var(--color-bg-message);
            border: 1px solid var(--color-border);
            padding: 4px;
            border-radius: var(--radius-xl);
            width: var(--w-full);
            position: relative;
        }

        /* ENHANCED INPUT BOX */
        .enhanced-input-box {
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            padding: var(--space-md) 14px;
            background-color: var(--color-bg-main);
            display: block;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-speed-normal);
            position: relative;
        }

        .enhanced-input-box:focus-within {
            background-image: linear-gradient(var(--color-bg-main), var(--color-bg-main)),
                linear-gradient(94deg, rgba(123, 235, 236, 0.4) 0%, rgba(147, 124, 249, 0.4) 98.94%);
            background-origin: border-box;
            background-clip: padding-box, border-box;
            border-color: transparent;
        }

        /* POPUP MENU & PROMPT SHEET */
        .popup-menu,
        .prompt-sheet-inline {
            position: static;
            width: var(--w-full);
            display: flex;
            flex-direction: column;
            background: var(--color-bg-main);
            border-bottom: 0 solid var(--color-bg-surface);
            z-index: var(--z-overlay);
            overflow: hidden;

            /* Start Closed State */
            max-height: 0;
            opacity: 0;
            visibility: hidden;
            margin-bottom: 0;

            /* FIX: Removed padding in closed state to match open state */
            padding: 0;

            /* FIX: Targeted transition instead of 'all' to avoid padding animation artifacts */
            transition: max-height var(--transition-speed-slow) ease-in-out, opacity var(--transition-speed-slow) ease-in-out, margin var(--transition-speed-slow) ease-in-out, visibility var(--transition-speed-slow);
        }

        /* Visible State */
        .popup-menu.visible,
        .prompt-sheet-inline.visible {
            max-height: var(--popup-max-height);
            opacity: 1;
            visibility: visible;
            margin-bottom: 8px;
            border-bottom-width: 1px;
            padding: 0px;
        }

        .popup-header {
            padding: var(--space-xs) var(--space-md) var(--space-md) var(--space-xs);
            font-size: var(--font-md);
            font-weight: 600;
            color: var(--color-text-heading);
            letter-spacing: 0.01em;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: none;
        }

        .popup-header button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-main);
            display: flex;
            align-items: center;
            margin-right: 0;
        }

        .popup-header button:hover {
            color: var(--color-text-heading);
        }

        .popup-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .popup-list {
            flex: 1;
            overflow-y: auto;
            padding: 0px;
        }


        .popup-item {
            padding: var(--space-10) var(--space-md);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--color-text-main);
            transition: background var(--transition-speed-fast);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* Corrected from space-between */
            gap: var(--space-10);
            border-radius: var(--radius-sm);
        }

        .popup-item:hover {
            background-color: var(--color-bg-hover);
            color: var(--color-text-heading);
        }

        .popup-item svg {
            width: var(--icon-md);
            height: var(--icon-md);
            min-width: var(--icon-md);
            min-height: var(--icon-md);
            color: var(--color-text-muted);
            flex-shrink: 0;
        }

        /* --- ATTACHMENT AREA --- */
        /* --- ATTACHMENT AREA --- */
        .attachment-area {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-sm);
            /* Removed width 100% and bottom padding to fit in context row */
        }

        .attachment-area:empty {
            display: none;
            padding-bottom: 0;
        }

        /* --- ATTACHMENT PILL --- */
        .attachment-pill {
            display: inline-flex;
            align-items: center;
            background-color: #F7FAFC;
            /* Match unified-pill.empty */
            border: 1px solid #E2E8F0;
            /* Match unified-pill.empty */
            border-radius: var(--radius-xs);
            /* Match unified-pill-compact */
            padding: 2px 10px 2px 6px;
            /* Similar to compact pill */
            /* margin-right removed in favor of flex gap */
            font-size: 0.75rem;
            /* Match unified-pill-compact */
            color: #444F5C;
            user-select: none;
            cursor: default;
            vertical-align: middle;
            gap: var(--space-xs);
            max-width: var(--w-full);
            height: 24px;
            /* Fix height to align with context pill */
            /* Prevent overflow */
        }

        .attachment-pill>span:first-of-type {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        .attachment-pill svg {
            width: var(--icon-sm);
            height: var(--icon-sm);
            color: var(--color-text-subtle);
            flex-shrink: 0;
        }

        .attachment-remove {
            cursor: pointer;
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            margin-left: 2px;
            flex-shrink: 0;
        }

        .attachment-remove:hover {
            color: var(--color-danger);
        }

        /* Context Menu Item Specifics (using .popup-item but with inner structure) */
        .popup-item.context-row-item {
            justify-content: space-between;
            /* Allow spread for muted tag */
        }

        .popup-item-left-group {
            display: flex;
            align-items: center;
            gap: var(--space-10);
            flex: 1;
        }

        /* Right side container for muted text */
        .popup-item-right {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-left: auto;
        }

        .muted-tag {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            font-weight: 500;
            background: var(--color-bg-surface);
            padding: 2px var(--space-s);
            border-radius: var(--radius-xs);
        }

        /* Multi-select checkmark styling */
        .context-checkbox {
            color: #D1D5DB;
            /* Default grey */
            transition: color var(--transition-speed-normal);
        }

        .popup-item.selected .context-checkbox {
            color: var(--color-primary);
            /* Green when selected */
        }

        /* No background change on selection as requested */

        /* NEW: Section Title in Popup */
        .popup-section-title {
            padding: var(--space-md) var(--space-md) 4px var(--space-md);
            font-size: 0.75rem;
            color: var(--color-text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* NEW: Menu Divider */
        .menu-divider {
            height: 1px;
            background-color: var(--color-bg-surface);
            margin: var(--space-s) 0;
            flex-shrink: 0;
        }

        /* NEW: Context Row inside Input */
        .input-context-row {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: var(--space-s);
            width: 100%;
            gap: var(--space-sm);
            flex-wrap: wrap;
            /* Allow wrapping if many attachments */
        }

        .prompt-item {
            padding: var(--space-sm);
            cursor: pointer;
            transition: background var(--transition-speed-normal);
            display: flex;
            flex-direction: column;
            gap: 2px;
            border-radius: 6px;
        }

        .prompt-item:hover {
            background-color: var(--color-bg-hover);
        }

        .prompt-item-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-heading);
        }

        .prompt-item-desc {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            line-height: 1.4;
        }

        .prompt-filters {
            display: flex;
            gap: var(--space-sm);
            padding: 4px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            flex-shrink: 0;
        }

        .prompt-filters::-webkit-scrollbar {
            display: none;
        }

        .filter-pill {
            padding: var(--space-xs) var(--space-10);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid #E2E8F0;
            background: #fff;
            color: #969AA3;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .filter-pill:hover {
            background-color: #F8FAFC;
            color: #444F5C;
        }

        .filter-pill.active {
            background-color: #EEF2F6;
            color: #161616;
            border-color: #CBD5E0;
        }

        .vin-item {
            padding: var(--space-sm) var(--space-md);
            cursor: pointer;
            transition: background 0.1s;
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            border-radius: 6px;
        }

        .vin-item:hover {
            background-color: #F8FAFC;
        }

        .vin-icon {
            margin-top: 2px;
            color: #969AA3;
        }

        .vin-icon svg {
            width: var(--icon-md);
            height: var(--icon-md);
        }

        .vin-details {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .vin-text {
            font-weight: 500;
            color: #444F5C;
            font-size: 0.9rem;
        }

        .vin-desc {
            color: #969AA3;
            font-size: 0.8rem;
        }

        .popup-search-container {
            padding: var(--space-md);
            border-top: 1px solid #F1F5F9;
            background: #fff;
            flex-shrink: 0;
        }

        /* UPDATED: Search Input Wrapper with Clear Button */
        .popup-search-input-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: #fff;
            border: 1px solid var(--color-border-muted);
            border-radius: 6px;
            padding: var(--space-sm) var(--space-10);
            transition: border-color 0.2s;
            position: relative;
            /* For clear btn */
        }

        .popup-search-input-wrapper:focus-within {
            border-color: var(--color-border-hover);
        }

        .popup-search-input-wrapper svg {
            width: var(--icon-md);
            height: var(--icon-md);
            min-width: var(--icon-md);
            min-height: var(--icon-md);
            color: #969AA3;
        }

        .popup-search-input-wrapper input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.9rem;
            color: #161616;
            background: transparent;
            padding-right: 20px;
        }

        .search-clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #969AA3;
            cursor: pointer;
            display: none;
            padding: 4px;
            z-index: 5;
        }

        .search-clear-btn:hover {
            color: #444F5C;
        }

        .search-clear-btn.visible {
            display: block;
        }

        /* Content Editable Div Input */
        .input-container {
            width: 100%;
            border: none;
            background: transparent;
            padding: 0;
            margin-bottom: 8px;
        }

        /* Changed min-height to 40px per user request */
        .main-input {
            width: 100%;
            min-height: 40px;
            max-height: 120px;
            overflow-y: auto;
            outline: none;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #161616;
            font-family: inherit;
            padding: 0;
        }

        /* New Sliding Placeholder Styles */
        .input-container {
            position: relative;
        }

        .placeholder-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 22px;
            /* Matches one line height */
            pointer-events: none;
            overflow: hidden;
            display: none;
        }

        .main-input:empty+.placeholder-wrapper {
            display: block;
        }

        .placeholder-item {
            position: absolute;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: flex-start;
            color: #969AA3;
            font-size: 0.95rem;
            line-height: 1.5;
            transition: transform 600ms ease-in-out, opacity 600ms ease-in-out;
        }

        .placeholder-item.hidden-up {
            transform: translateY(-100%);
            opacity: 0;
        }

        .placeholder-item.hidden-down {
            transform: translateY(100%);
            opacity: 0;
        }

        .placeholder-item.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .placeholder-item.no-placeholder-transition {
            transition: none !important;
        }

        .prompt-var {
            color: #7C3AED;
            background: #F3E8FF;
            padding: 0 4px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
        }

        .filled-var {
            color: var(--color-primary);
            font-weight: 500;
            text-decoration: underline;
            text-decoration-style: dashed;
            text-underline-offset: 4px;
            cursor: pointer;
        }

        /* New CSS for Microphone Listening Placeholder and Waveform */
        .listening-ui {
            display: flex;
            align-items: center;
            gap: 12px;
            height: 100%;
            padding: 4px 0;
        }

        .wave-container {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 16px;
        }

        /* Updated Wave Bar with Gradient */
        .wave-bar {
            width: 3px;
            /* Updated to Purple Gradient */
            background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
            border-radius: 4px;
            animation: quiet 1s ease-in-out infinite;
        }

        .wave-bar:nth-child(1) {
            height: 8px;
            animation-duration: 0.8s;
        }

        .wave-bar:nth-child(2) {
            height: 12px;
            animation-duration: 1.1s;
        }

        .wave-bar:nth-child(3) {
            height: 16px;
            animation-duration: 1.3s;
        }

        .wave-bar:nth-child(4) {
            height: 10px;
            animation-duration: 0.9s;
        }

        .wave-bar:nth-child(5) {
            height: 6px;
            animation-duration: 1.2s;
        }

        .listening-ui.active .wave-bar {
            animation-name: loud;
        }

        @keyframes loud {
            0% {
                transform: scaleY(0.4);
            }

            50% {
                transform: scaleY(1.2);
            }

            100% {
                transform: scaleY(0.4);
            }
        }

        .listening-label {
            color: #7C3AED;
            /* Purple */
            font-weight: 500;
            font-size: 0.95rem;
        }

        /* Mic Button Active State */
        .tool-icon-btn.mic-active {
            color: #7C3AED;
            /* Purple */
            background-color: #F3E8FF;
            /* Light Purple BG */
        }

        .tool-icon-btn.mic-active svg {
            animation: micPulse 1.5s infinite;
        }

        @keyframes micPulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
            }

            100% {
                transform: scale(1);
            }
        }

        .input-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid transparent;
        }

        .toolbar-left,
        .toolbar-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tool-icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: var(--space-s);
            border-radius: 6px;
            color: #969AA3;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s, background 0.2s;
        }

        .tool-icon-btn:hover {
            background-color: #F7FAFC;
            color: #444F5C;
        }

        .tool-icon-btn:disabled {
            opacity: 0.3;
            cursor: default;
        }

        .tool-icon-btn:disabled:hover {
            background: transparent;
            color: #D4D5D6;
        }

        .tool-icon-btn svg {
            width: 18px;
            height: 18px;
            stroke-width: var(--stroke-normal);
        }

        /* New Disclaimer Style */
        .disclaimer-text {
            font-size: 11px;
            color: #969AA3;
            text-align: center;
            margin-top: 8px;
        }

        .send-btn-square {
            width: 32px;
            height: 32px;
            background-color: #F1F5F9;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #969AA3;
            transition: all 0.2s;
        }

        .send-btn-square:hover {
            background-color: var(--color-bg-surface);
            color: var(--color-border-hover);
        }

        .send-btn-square.active:hover {
            background: var(--gradient-ai);
            filter: brightness(0.9);
            color: #fff;
        }

        .send-btn-square.active {
            background: var(--gradient-ai);
            color: #fff;
        }


        .send-btn-square.stop {
            background: var(--gradient-surface);
        }

        .send-btn-square.stop:hover {
            background: var(--gradient-surface);
            filter: brightness(0.9);
        }

        /* Disabled State */
        .send-btn-square:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            background-color: #F1F5F9;
            color: #D4D5D6;
        }

        .send-btn-square svg {
            width: var(--icon-md);
            height: var(--icon-md);
            stroke-width: 2px;
        }

        @keyframes spinPulse {
            0% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }

            50% {
                transform: rotate(180deg) scale(0.8);
                opacity: 0.7;
            }

            100% {
                transform: rotate(360deg) scale(1);
                opacity: 1;
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        @keyframes fadeText {
            0% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- UNIFIED CONTEXT PILL --- */
        .context-row {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
            margin-bottom: 0;
            min-height: auto;
        }

        /* Context row at top of input */
        .context-row-top {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-border);
        }


        .unified-pill {
            display: inline-flex;
            align-items: center;
            background-color: #EFF6FF;
            border: 1px solid #DBEAFE;
            border-radius: var(--radius-xs);
            /* Updated to XS */
            font-size: 0.85rem;
            color: #161616;
            overflow: hidden;
            transition: all 0.2s;
            user-select: none;
        }

        /* Updated Empty State Style: Grey & Solid Border */
        .unified-pill.empty {
            background-color: #F7FAFC;
            /* Grey background */
            border: 1px solid #E2E8F0;
            /* Normal solid border */
            color: #444F5C;
            cursor: pointer;
        }

        .unified-pill.empty:hover {
            background-color: #EDF2F7;
            border-color: #CBD5E0;
        }

        .pill-part {
            padding: var(--space-s) var(--space-10);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            cursor: pointer;
            transition: background 0.2s;
            height: 100%;
        }

        .pill-part:hover {
            background-color: rgba(37, 99, 235, 0.08);
        }

        /* Compact version for toolbar */
        .unified-pill-compact {
            font-size: 0.75rem;
            border-radius: var(--radius-xs);
            /* Updated to XS */
        }

        .unified-pill-compact .pill-part {
            padding: 2px 10px;
            /* Explicit padding for alignment */
            gap: 4px;
        }

        .unified-pill-compact {
            height: 24px;
            /* Fix height */
        }


        .pill-part svg {
            width: 14px;
            height: 14px;
            stroke-width: 2.5px;
        }

        /* Add part specific - Icon Color Changed to #161616 */
        .pill-part.main {
            padding: var(--space-s) var(--space-md);
            font-weight: 500;
        }

        .pill-part.add-trigger {
            color: #161616;
            font-weight: 500;
            padding-right: 8px;
        }

        /* Content part specific */
        .pill-part.content {
            font-weight: 500;
            padding-left: 8px;
            padding-right: 8px;
        }

        /* Close part specific */
        .pill-part.close {
            padding: var(--space-s) var(--space-sm);
            color: #969AA3;
        }

        .pill-part.close:hover {
            background-color: rgba(229, 62, 62, 0.1);
            color: #E53E3E;
        }

        .pill-divider {
            width: 1px;
            height: 14px;
            background-color: #BFDBFE;
        }

        /* --- SKELETON --- */
        .table-skeleton-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #fff;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            overflow: hidden;
        }

        .skeleton-row {
            display: grid;
            grid-template-columns: 2fr 3fr 2fr 2fr 2fr 1fr;
            gap: 24px;
            padding: 0 24px;
            border-bottom: 1px solid #F1F5F9;
            align-items: center;
            height: 50px;
        }

        .skeleton-row:last-child {
            border-bottom: none;
        }

        .skeleton-row.header {
            background-color: #F8FAFC;
            border-bottom: 1px solid #E2E8F0;
        }

        .skeleton-cell {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .skeleton-bar {
            height: 12px;
            background: #F1F5F9;
            border-radius: 6px;
            width: 100%;
        }

        .header .skeleton-bar {
            background: #E2E8F0;
        }

        /* --- MOBILE FAB (New) --- */
        .mobile-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00BFA5 0%, #00a690 100%);
            color: white;
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 16px rgba(0, 191, 165, 0.4);
            z-index: 10001;
            border: none;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s;
        }

        .mobile-fab:active {
            transform: scale(0.92);
        }

        .mobile-fab svg {
            width: 28px;
            height: 28px;
        }

        /* --- MEDIA QUERIES (MOBILE) --- */
        @media (max-width: 768px) {

            /* HIDE TOP & LEFT NAV */
            .global-top-nav,
            .global-side-nav,
            .main-content {
                display: none !important;
            }

            /* FORCE CHAT SIDEBAR FULLSCREEN */
            .chat-sidebar {
                width: 100% !important;
                height: 70vh;
                /* Changed from 85vh to allow more room for growth, removed !important */
                min-height: 480px;
                /* Bottom Sheet Height */
                position: fixed !important;
                left: 0 !important;
                top: auto !important;
                /* Move to bottom */
                bottom: 0 !important;
                border-radius: 24px 24px 0 0 !important;
                /* Rounded Top Corners */
                border: none !important;
                z-index: 9999;
                display: flex !important;
                flex-direction: column;

                /* ANIMATION PROPS */
                transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease, border-radius 0.3s ease !important;
                transform-origin: bottom right !important;
                transform: scale(1) translate(0, 0) !important;
                opacity: 1 !important;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15) !important;
            }

            .mobile-sheet-handle {
                width: 100%;
                height: 8px;
                /* Slimmer handle area */
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: grab;
                flex-shrink: 0;
                touch-action: none;
                margin-top: 4px;
                border-radius: inherit;
                overflow: hidden;
            }

            .mobile-sheet-handle::after {
                content: '';
                width: 40px;
                height: 4px;
                background-color: var(--color-border);
                border-radius: 2px;
            }

            .chat-sidebar.resizing {
                transition: none !important;
            }

            /* Closed State for Mobile - Animate out to FAB */
            .chat-sidebar.state-closed {
                display: flex !important;
                transform: scale(0) translate(20px, 20px) !important;
                opacity: 0 !important;
                pointer-events: none !important;
                border-radius: 100% !important;
            }

            /* Show FAB when visible class is added */
            .mobile-fab.visible {
                display: flex;
                animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }


            .footer-container {
                padding: 12px 0px !important;
                position: relative;
                bottom: auto;
                left: auto;
            }


            .suggestions-list {
                margin-bottom: 2px !important;
                padding-bottom: 0 !important;
            }


            .scroll-spacer {
                height: 60px !important;
            }



            /* HISTORY SHEET OVERRIDES FOR MOBILE */
            /* Force history sheet to behave like a drawer on mobile, even if parent says fullscreen */
            .chat-sidebar.state-fullscreen .history-sheet {
                transform: translateX(-100%) !important;
                /* Start closed */
                width: 100% !important;
                border-right: none !important;
                z-index: 50 !important;
                border-radius: 24px 24px 0 0 !important;
                /* Match Parent */
            }

            .chat-sidebar.state-fullscreen .history-sheet.open {
                transform: translateX(0) !important;
                /* Open when class added */
            }

            /* Ensure Back Button is Visible on Mobile */
            .chat-sidebar.state-fullscreen .history-back-btn {
                display: flex !important;
            }

            .chat-sidebar.state-fullscreen #btnShowHistory {
                display: flex !important;
            }

            /* Reset Fullscreen Layout shifts */
            .chat-sidebar.state-fullscreen .nav-header,
            .chat-sidebar.state-fullscreen .chat-scroll-area,
            .chat-sidebar.state-fullscreen .footer-container {
                margin-left: 0 !important;
                width: 100% !important;
                border-left: none !important;
            }

            .main-view-wrapper {
                min-width: 100% !important;
                width: 100% !important;
                padding: 0 !important;
                opacity: 1 !important;
                visibility: visible !important;
                pointer-events: auto !important;
            }

            .input-wrapper {
                padding: 0 !important;
            }

            .chat-card-container {
                border-radius: 0px !important;
                /* CHANGED per request */
                box-shadow: none !important;
                height: 100% !important;
            }

            /* HIDE DRAG HANDLE ONLY */
            .drag-handle {
                display: none !important;
            }

            /* ADJUST WINDOW CONTROLS: Hide all except Close */
            .top-bar {
                height: 48px !important;
                /* Standard height for better touch/centering */
                padding: 0 16px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
            }

            .brand-text {
                font-size: 0.95rem !important;
                display: flex !important;
                align-items: center !important;
                height: 100% !important;
            }

            .window-controls {
                display: flex !important;
                align-items: center !important;
                height: 100% !important;
            }

            #btnMinimize,
            #btnFull,
            #btnDock {
                display: none !important;
            }

            #btnClose {
                display: flex !important;
            }

            /* Fix Widths */
            .content-aligner {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 16px !important;
            }

            .active-chat-wrapper {
                width: 100% !important;
                max-width: 100% !important;
            }

            /* Hide Minimized Wrapper elements */
            .minimized-view-wrapper {
                display: none !important;
            }

            /* Use Flex column for mobile layout to fix overlapping */
            .chat-card-container {
                display: flex;
                flex-direction: column;
            }

            .chat-scroll-area {
                flex: 1;
            }

            .footer-container {
                position: relative;
                /* Stack normally */
                bottom: auto;
                left: auto;
            }

            .scroll-spacer {
                display: none;
            }

            /* No spacer needed if stacked */
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            height: 100%;
            background-color: #fff;
            padding: 30px;
            text-align: center;
            transition: padding-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            overflow: hidden;
        }

        .main-content.pushed-by-dock {
            padding-left: 430px;
            padding-right: 30px;
            padding-top: 30px;
            padding-bottom: 30px;
        }

        .main-content.full-hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* --- AURORA GLOW EFFECT ON TOP BAR --- */
        .top-bar {
            position: relative;
            overflow: hidden;
            border-radius: inherit;
        }

        /* Ensure minimized wrapper clips the gradient */
        .minimized-view-wrapper {
            overflow: hidden;
            border-radius: inherit;
        }

        .top-bar::before,
        .minimized-view-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            right: -100%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent 0%,
                    var(--aurora-color-1) 30%,
                    var(--aurora-color-2) 50%,
                    var(--aurora-color-3) 70%,
                    var(--aurora-color-4) 85%,
                    transparent 100%);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s ease-in-out;
            z-index: 0;
            border-radius: inherit;
        }

        /* Active state - triggered when parent panel has .aurora-active */
        .aurora-active .top-bar::before,
        .aurora-active .minimized-view-wrapper::before {
            opacity: 0.6;
            animation: auroraSlide 6s ease-in-out infinite;
        }

        /* Use a pseudo-element for the aurora effect to match top-bar implementation */
        .mobile-sheet-handle.aurora-active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* Same gradient as top-bar */
            background: linear-gradient(90deg,
                    transparent 0%,
                    var(--aurora-color-1) 30%,
                    var(--aurora-color-2) 50%,
                    var(--aurora-color-3) 70%,
                    var(--aurora-color-4) 85%,
                    transparent 100%);
            background-size: 200% 100%;
            opacity: 0.6;
            z-index: 0;
            /* Behind the pill */
            /* We need to animate background-position if we aren't using the 'right' property trick, 
               OR we can use the same trick if we make this pseudo wider than container */
            width: 200%;
            right: -100%;
            left: auto;
            /* Override left */
            animation: auroraSlide 6s ease-in-out infinite;
            border-radius: inherit;
            /* If handle has radius */
        }

        .mobile-sheet-handle.aurora-active {
            /* Remove direct background */
            background: none;
            overflow: hidden;
            /* contain the wide pseudo */
            position: relative;
            /* Ensure it is a positioning context */
        }

        /* Ensure the pill (::after) is on top */
        .mobile-sheet-handle::after {
            z-index: 2;
            position: relative;
        }

        @keyframes auroraSlide {
            0% {
                right: -100%;
            }

            50% {
                right: -50%;
            }

            100% {
                right: -100%;
            }
        }

        /* Ensure content stays above aurora */
        .top-bar>*,
        .minimized-view-wrapper>* {
            position: relative;
            z-index: 1;
        }

        /* --- FULL SCREEN SIDE NAVIGATION LAYOUT --- */
        @media (min-width: 768px) {
            .chat-sidebar.state-fullscreen .chat-card-container {
                display: grid;
                grid-template-columns: 360px 1fr;
                grid-template-rows: auto 1fr auto;
                grid-template-areas:
                    "sidebar nav"
                    "sidebar content"
                    "sidebar footer";
                height: 100%;
            }

            .chat-sidebar.state-fullscreen .history-sheet {
                grid-area: sidebar;
                position: relative !important;
                width: 100% !important;
                height: 100% !important;
                transform: none !important;
                opacity: 1 !important;
                visibility: visible !important;
                border-right: 1px solid var(--color-border) !important;
                border-radius: 0 !important;
                background: var(--color-bg-main);
                display: flex !important;
                flex-direction: column;
                z-index: 10;
            }

            .chat-sidebar.state-fullscreen .nav-header {
                grid-area: nav;
                /* border-bottom: 1px solid var(--color-border); Optional separator */
            }

            /* Hide Back Button in side-nav mode */
            .chat-sidebar.state-fullscreen #btnShowHistory {
                display: none !important;
            }

            .chat-sidebar.state-fullscreen .chat-scroll-area {
                grid-area: content;
            }

            .chat-sidebar.state-fullscreen .footer-container {
                grid-area: footer;
                max-width: 100%;
                width: 100%;
                margin: 0 auto;
                /* Center input */
            }
        }

        /* AI Card Styles - Premium */
        .ai-card {
            background-color: var(--color-bg-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            margin-top: var(--space-sm);
            margin-bottom: var(--space-sm);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            max-width: 400px;
        }

        .ai-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: var(--color-primary);
        }

        .ai-card-header {
            font-size: var(--font-md);
            font-weight: 600;
            color: var(--color-text-heading);
            margin-bottom: var(--space-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-card-row {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-sm);
            color: var(--color-text-main);
            margin-bottom: 6px;
            border-bottom: 1px solid var(--color-border-subtle);
            padding-bottom: 4px;
        }

        .ai-card-row:last-child {
            border-bottom: none;
        }

        .ai-card-row label {
            color: var(--color-text-muted);
            font-weight: 500;
        }

        .ai-card-actions {
            margin-top: var(--space-md);
            display: flex;
            justify-content: flex-end;
        }

        .ai-card-btn {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--radius-md);
            font-size: var(--font-sm);
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .ai-card-btn:hover {
            background-color: var(--color-primary-dark);
        }

        /* Compact List Styles (Contact Disambiguation) */
        .compact-list-container {
            background-color: #ffffff;
            border: 1px solid #E0E0E0;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-top: var(--space-sm);
            display: flex;
            flex-direction: column;
        }

        .premium-deals-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: var(--space-sm);
        }

        .premium-deals-grid .premium-deal-card {
            margin: 0;
        }

        .chat-sidebar.state-fullscreen .premium-deals-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        @media (max-width: 768px) {
            .chat-sidebar.state-fullscreen .premium-deals-grid {
                grid-template-columns: 1fr;
            }
        }

        .compact-list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #F0F0F0;
            cursor: pointer;
            transition: background-color 0.1s;
            text-decoration: none;
            color: inherit;
        }

        .compact-list-item:last-child {
            border-bottom: none;
        }

        .compact-list-item:hover {
            background-color: #F8F9FA;
        }

        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 14px;
            flex-shrink: 0;
            text-transform: uppercase;
        }

        /* Avatar Colors */
        .avatar-blue {
            background-color: #E3F2FD;
            color: #1565C0;
        }

        .avatar-pink {
            background-color: #FFEBEE;
            color: #C62828;
        }

        .avatar-purple {
            background-color: #F3E5F5;
            color: #7B1FA2;
        }

        .avatar-green {
            background-color: #E8F5E9;
            color: #2E7D32;
        }

        .avatar-orange {
            background-color: #FFF3E0;
            color: #EF6C00;
        }

        .avatar-grey {
            background-color: #F5F5F5;
            color: #616161;
        }

        .item-main-info {
            flex: 1;
            min-width: 0;
            margin-right: 12px;
        }

        .item-name-row {
            display: flex;
            align-items: baseline;
            margin-bottom: 2px;
        }

        .item-name {
            font-weight: 600;
            color: #202124;
            font-size: 14px;
            margin-right: 6px;
        }

        .item-id {
            color: #9AA0A6;
            font-size: 12px;
        }

        .item-sub-row {
            color: #5F6368;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-meta-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 70px;
        }

        .meta-date {
            font-size: 11px;
            color: #9AA0A6;
            margin-bottom: 4px;
        }

        .deal-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 0;
            display: inline-block;
            background: none !important;
        }

        .badge-blue {
            color: #1976D2;
        }

        .badge-red {
            color: #D32F2F;
        }

        .badge-grey {
            color: #9E9E9E;
        }

        .compact-list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #F0F0F0;
            cursor: pointer;
            transition: background-color 0.1s;
            text-decoration: none;
            color: inherit;
        }

        .compact-list-item:last-child {
            border-bottom: none;
        }

        .compact-list-item:hover {
            background-color: #F8F9FA;
        }

        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 14px;
            flex-shrink: 0;
            text-transform: uppercase;
        }

        /* Avatar Colors */
        .avatar-blue {
            background-color: #E3F2FD;
            color: #1565C0;
        }

        .avatar-pink {
            background-color: #FFEBEE;
            color: #C62828;
        }

        .avatar-purple {
            background-color: #F3E5F5;
            color: #7B1FA2;
        }

        .avatar-green {
            background-color: #E8F5E9;
            color: #2E7D32;
        }

        .avatar-orange {
            background-color: #FFF3E0;
            color: #EF6C00;
        }

        .avatar-grey {
            background-color: #F5F5F5;
            color: #616161;
        }

        .item-main-info {
            flex: 1;
            min-width: 0;
            margin-right: 12px;
        }

        .item-name-row {
            display: flex;
            align-items: baseline;
            margin-bottom: 2px;
        }

        .item-name {
            font-weight: 600;
            color: #202124;
            font-size: 14px;
            margin-right: 6px;
        }

        .item-id {
            color: #9AA0A6;
            font-size: 12px;
        }

        .item-sub-row {
            color: #5F6368;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-meta-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 70px;
        }

        .meta-date {
            font-size: 11px;
            color: #9AA0A6;
            margin-bottom: 4px;
        }

        .deal-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 0;
            display: inline-block;
            background: none !important;
        }

        .open-btn-compact {
            margin-top: 6px;
            padding: 4px 10px;
            border: 1px solid var(--color-border-muted);
            border-radius: 2px;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-primary);
            background: #fff;
            cursor: pointer;
            transition: all var(--transition-speed-fast);
        }

        .open-btn-compact:hover {
            background: #f1f3f4;
            border-color: var(--color-primary);
            box-shadow: var(--shadow-sm);
        }

        .badge-blue {
            color: #1976D2;
        }

        .badge-red {
            color: #D32F2F;
        }

        .badge-grey {
            color: #9E9E9E;
        }

        /* --- PREMIUM DEAL CARD --- */
        .premium-deal-card {
            background: #fff;
            border: 1px solid var(--color-border-muted);
            border-radius: 12px;
            margin: 0;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        .premium-deal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
            border-color: var(--color-primary);
        }

        .deal-card-main {
            padding: 20px;
            flex: 1;
        }

        .deal-card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .vehicle-identity {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .vehicle-icon-box {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .deal-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-text-heading);
            letter-spacing: -0.01em;
        }

        .deal-vehicle-name {
            font-weight: 700;
            color: var(--color-text-heading);
            font-size: 1rem;
            line-height: 1.2;
            margin-bottom: 2px;
        }

        .deal-id-tag {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            background: var(--color-bg-surface);
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .deal-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--color-border-muted);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 0.7rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-weight: 700;
        }

        .detail-value {
            font-size: 0.85rem;
            color: var(--color-text-main);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Status Pills */
        .status-pill {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: capitalize;
        }

        .status-pill.quote {
            background: #FFF4E5;
            color: #B76E00;
        }

        .status-pill.booked {
            background: #E6F4EA;
            color: #1E7E34;
        }

        .deal-card-action {
            padding: 12px 20px;
            background: #FAFBFC;
            border-top: 1px solid var(--color-border-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .deal-action-link:hover {
            color: #1A56DB;
        }

        .open-btn-compact {
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .open-btn-compact:hover {
            background: #3367D6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <!-- Global SVG Gradient Definition -->
    <svg width="0" height="0" style="position: absolute;">
        <defs>
            <linearGradient id="aiLogoGradient" x1="13.2581" y1="16.0035" x2="1.09252" y2="1.37408"
                gradientUnits="userSpaceOnUse">
                <stop offset="0.01" stop-color="#2157F5" />
                <stop offset="0.371064" stop-color="#258DFF" />
                <stop offset="1" stop-color="#86FFBB" />
            </linearGradient>
        </defs>
    </svg>


    <button id="mobileFab" class="mobile-fab" onclick="toggleMobileChat()">
        <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path>
        </svg>
    </button>

    <div class="modal-overlay" id="renameModal">
        <div class="modal-box">
            <div class="modal-title">Rename Chat</div>
            <input type="text" class="modal-input" id="renameInput" placeholder="Enter new name...">
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModals()">Cancel</button>
                <button class="modal-btn primary" onclick="saveRename()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-title">Delete Chat?</div>
            <p style="margin-bottom:20px; color:#444F5C; font-size:0.9rem;">Are you sure you want to delete this
                conversation? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModals()">Cancel</button>
                <button class="modal-btn danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div id="globalContextMenu">
        <button class="menu-item" id="btnPinItem" onclick="togglePin()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="12" y1="17" x2="12" y2="22"></line>
                <path
                    d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z">
                </path>
            </svg>
            <span id="pinText">Pin Chat</span>
        </button>
        <button class="menu-item" onclick="openRenameModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </svg>
            Rename
        </button>
        <button class="menu-item danger" onclick="openDeleteModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Delete
        </button>
    </div>

    <div class="layout-wrapper">
        <nav class="global-top-nav"></nav>
        <div class="main-row-wrapper">

            <nav class="global-side-nav">
                <!-- AI Logo -->
                <div id="aiLogo1" style="margin-bottom:6px; cursor:pointer;" title="Toggle AI Assistant">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_2791_76828)">
                            <rect width="40" height="40" rx="4" fill="white" />
                            <rect width="40" height="40" rx="4" fill="white" />
                            <rect width="40" height="40" rx="4" fill="url(#paint0_linear_2791_76828)"
                                fill-opacity="0.08" />
                            <rect x="0.5" y="0.5" width="39" height="39" rx="3.5"
                                stroke="url(#paint1_linear_2791_76828)" stroke-opacity="0.4" />
                            <path
                                d="M18.8517 24.9975C18.4246 25.7242 17.4789 25.9732 16.7393 25.5536C15.9997 25.1341 15.7463 24.2049 16.1733 23.4782C16.6003 22.7515 17.5461 22.5025 18.2857 22.9221C19.0253 23.3416 19.2787 24.2708 18.8517 24.9975Z"
                                fill="url(#paint2_linear_2791_76828)" />
                            <path
                                d="M16.1733 16.4947C16.6003 17.2214 17.546 17.4704 18.2856 17.0508C19.0252 16.6313 19.2787 15.702 18.8516 14.9753C18.4246 14.2487 17.4789 13.9997 16.7393 14.4192C15.9997 14.8388 15.7463 15.768 16.1733 16.4947Z"
                                fill="url(#paint3_linear_2791_76828)" />
                            <path
                                d="M18.245 20.9805C18.8097 21.9415 20.0604 22.2708 21.0385 21.716C22.0166 21.1611 22.3517 19.9323 21.787 18.9713C21.2223 18.0103 19.9716 17.681 18.9935 18.2358C18.0154 18.7907 17.6803 20.0195 18.245 20.9805Z"
                                fill="url(#paint4_linear_2791_76828)" />
                            <path
                                d="M21.1696 24.9975C21.5967 25.7242 22.5424 25.9732 23.282 25.5536C24.0216 25.1341 24.275 24.2049 23.848 23.4782C23.421 22.7515 22.4753 22.5025 21.7356 22.9221C20.996 23.3416 20.7426 24.2708 21.1696 24.9975Z"
                                fill="url(#paint5_linear_2791_76828)" />
                            <path
                                d="M19.0475 28.2065C19.0475 28.7251 19.4754 29.1455 20.0032 29.1455C20.531 29.1455 20.9589 28.7251 20.9589 28.2065C20.9589 27.6879 20.531 27.2675 20.0032 27.2675C19.4754 27.2675 19.0475 27.6879 19.0475 28.2065Z"
                                fill="url(#paint6_linear_2791_76828)" />
                            <path
                                d="M14.3544 27.7372C14.0905 28.1863 14.2471 28.7605 14.7042 29.0198C15.1613 29.2791 15.7458 29.1253 16.0097 28.6761C16.2736 28.227 16.117 27.6528 15.6599 27.3935C15.2028 27.1342 14.6183 27.288 14.3544 27.7372Z"
                                fill="url(#paint7_linear_2791_76828)" />
                            <path
                                d="M29.6455 19.0508C29.1177 19.0508 28.6899 19.4712 28.6899 19.9898C28.6899 20.5084 29.1177 20.9288 29.6455 20.9288C30.1733 20.9288 30.6012 20.5084 30.6012 19.9898C30.6012 19.4712 30.1733 19.0508 29.6455 19.0508Z"
                                fill="url(#paint8_linear_2791_76828)" />
                            <path
                                d="M10.3608 19.0508C9.83304 19.0508 9.40517 19.4712 9.40517 19.9898C9.40517 20.5084 9.83304 20.9288 10.3608 20.9288C10.8886 20.9288 11.3165 20.5084 11.3165 19.9898C11.3165 19.4712 10.8886 19.0508 10.3608 19.0508Z"
                                fill="url(#paint9_linear_2791_76828)" />
                            <path
                                d="M27.755 23.3029C27.298 23.0436 26.7135 23.1975 26.4496 23.6466C26.1857 24.0957 26.3423 24.67 26.7994 24.9293C27.2565 25.1886 27.8409 25.0347 28.1048 24.5856C28.3688 24.1365 28.2121 23.5622 27.755 23.3029Z"
                                fill="url(#paint10_linear_2791_76828)" />
                            <path
                                d="M13.2256 15.0644C12.7685 14.8052 12.184 14.959 11.9201 15.4081C11.6562 15.8573 11.8128 16.4315 12.2699 16.6908C12.727 16.9501 13.3115 16.7962 13.5754 16.3471C13.8393 15.898 13.6827 15.3237 13.2256 15.0644Z"
                                fill="url(#paint11_linear_2791_76828)" />
                            <path
                                d="M25.652 27.7372C25.3881 27.288 24.8036 27.1342 24.3465 27.3935C23.8894 27.6528 23.7328 28.227 23.9967 28.6761C24.2606 29.1253 24.8451 29.2791 25.3022 29.0198C25.7593 28.7605 25.9159 28.1863 25.652 27.7372Z"
                                fill="url(#paint12_linear_2791_76828)" />
                            <path
                                d="M16.0097 11.3156C15.7458 10.8665 15.1613 10.7126 14.7042 10.9719C14.2471 11.2312 14.0905 11.8055 14.3544 12.2546C14.6183 12.7037 15.2028 12.8576 15.6599 12.5983C16.117 12.339 16.2736 11.7647 16.0097 11.3156Z"
                                fill="url(#paint13_linear_2791_76828)" />
                            <path
                                d="M29.7701 13.7876C29.4876 13.9479 29.3908 14.3028 29.5539 14.5804C29.717 14.858 30.0783 14.9531 30.3608 14.7928C30.6433 14.6325 30.7401 14.2776 30.577 14C30.4139 13.7224 30.0526 13.6273 29.7701 13.7876Z"
                                fill="url(#paint14_linear_2791_76828)" />
                            <path
                                d="M9.63919 25.2072C9.35667 25.3675 9.25988 25.7224 9.42299 26C9.5861 26.2776 9.94734 26.3727 10.2299 26.2124C10.5124 26.0522 10.6092 25.6972 10.4461 25.4196C10.2829 25.1421 9.9217 25.047 9.63919 25.2072Z"
                                fill="url(#paint15_linear_2791_76828)" />
                            <path
                                d="M30.3608 25.2072C30.0783 25.0469 29.717 25.142 29.5539 25.4196C29.3908 25.6972 29.4876 26.0521 29.7701 26.2124C30.0527 26.3727 30.4139 26.2776 30.577 26C30.7401 25.7224 30.6433 25.3675 30.3608 25.2072Z"
                                fill="url(#paint16_linear_2791_76828)" />
                            <path
                                d="M10.2299 13.7876C9.94736 13.6273 9.58611 13.7225 9.423 14C9.25989 14.2776 9.35669 14.6326 9.6392 14.7928C9.92171 14.9531 10.283 14.858 10.4461 14.5804C10.6092 14.3028 10.5124 13.9479 10.2299 13.7876Z"
                                fill="url(#paint17_linear_2791_76828)" />
                            <path
                                d="M20.5906 31.4196C20.5906 31.0991 20.3262 30.8393 20 30.8393C19.6737 30.8393 19.4093 31.0991 19.4093 31.4196C19.4093 31.7402 19.6737 32 20 32C20.3262 32 20.5906 31.7402 20.5906 31.4196Z"
                                fill="url(#paint18_linear_2791_76828)" />
                            <path
                                d="M20.5907 8.58036C20.5907 8.25983 20.3262 8 20 8C19.6738 8 19.4093 8.25983 19.4093 8.58036C19.4093 8.90088 19.6738 9.16071 20 9.16071C20.3262 9.16071 20.5907 8.90088 20.5907 8.58036Z"
                                fill="url(#paint19_linear_2791_76828)" />
                            <path
                                d="M17.0892 31.1195C17.1737 30.8099 16.9867 30.4917 16.6716 30.4087C16.3565 30.3258 16.0326 30.5095 15.9482 30.8191C15.8637 31.1287 16.0507 31.4469 16.3658 31.5299C16.6809 31.6129 17.0048 31.4291 17.0892 31.1195Z"
                                fill="url(#paint20_linear_2791_76828)" />
                            <path
                                d="M24.0518 9.18087C24.1362 8.87127 23.9492 8.55304 23.6341 8.47009C23.319 8.38713 22.9951 8.57086 22.9107 8.88046C22.8263 9.19006 23.0133 9.50829 23.3284 9.59125C23.6435 9.67421 23.9673 9.49048 24.0518 9.18087Z"
                                fill="url(#paint21_linear_2791_76828)" />
                            <path
                                d="M12.4897 28.8572C12.7204 28.6306 12.7204 28.2631 12.4897 28.0365C12.2591 27.8098 11.8851 27.8098 11.6544 28.0365C11.4237 28.2631 11.4237 28.6306 11.6544 28.8572C11.8851 29.0839 12.2591 29.0839 12.4897 28.8572Z"
                                fill="url(#paint22_linear_2791_76828)" />
                            <path
                                d="M28.3456 11.9635C28.5763 11.7369 28.5763 11.3694 28.3456 11.1427C28.1149 10.9161 27.7409 10.9161 27.5102 11.1427C27.2796 11.3694 27.2796 11.7369 27.5102 11.9635C27.7409 12.1901 28.1149 12.1901 28.3456 11.9635Z"
                                fill="url(#paint23_linear_2791_76828)" />
                            <path
                                d="M8.74369 23.0831C9.0588 23.0001 9.24579 22.6819 9.16136 22.3723C9.07693 22.0627 8.75304 21.8789 8.43794 21.9619C8.12284 22.0449 7.93584 22.3631 8.02027 22.6727C8.1047 22.9823 8.42859 23.166 8.74369 23.0831Z"
                                fill="url(#paint24_linear_2791_76828)" />
                            <path
                                d="M31.5621 18.0381C31.8772 17.9552 32.0642 17.6369 31.9797 17.3273C31.8953 17.0177 31.5714 16.834 31.2563 16.917C30.9412 16.9999 30.7542 17.3182 30.8386 17.6278C30.9231 17.9374 31.247 18.1211 31.5621 18.0381Z"
                                fill="url(#paint25_linear_2791_76828)" />
                            <path
                                d="M8.43794 18.0381C8.75305 18.1211 9.07693 17.9374 9.16136 17.6278C9.24579 17.3182 9.0588 16.9999 8.7437 16.917C8.42859 16.834 8.10471 17.0177 8.02028 17.3273C7.93584 17.6369 8.12284 17.9552 8.43794 18.0381Z"
                                fill="url(#paint26_linear_2791_76828)" />
                            <path
                                d="M31.2563 23.083C31.5714 23.166 31.8953 22.9823 31.9797 22.6727C32.0642 22.3631 31.8772 22.0448 31.5621 21.9619C31.247 21.8789 30.9231 22.0627 30.8386 22.3723C30.7542 22.6819 30.9412 23.0001 31.2563 23.083Z"
                                fill="url(#paint27_linear_2791_76828)" />
                            <path
                                d="M11.6544 11.9635C11.8851 12.1901 12.2591 12.1901 12.4898 11.9635C12.7204 11.7368 12.7204 11.3694 12.4898 11.1427C12.2591 10.9161 11.8851 10.9161 11.6544 11.1427C11.4237 11.3694 11.4237 11.7368 11.6544 11.9635Z"
                                fill="url(#paint28_linear_2791_76828)" />
                            <path
                                d="M27.5103 28.8572C27.7409 29.0839 28.1149 29.0839 28.3456 28.8572C28.5763 28.6306 28.5763 28.2631 28.3456 28.0365C28.1149 27.8098 27.7409 27.8098 27.5103 28.0365C27.2796 28.2631 27.2796 28.6306 27.5103 28.8572Z"
                                fill="url(#paint29_linear_2791_76828)" />
                            <path
                                d="M15.9482 9.18087C16.0326 9.49047 16.3565 9.6742 16.6716 9.59125C16.9867 9.50829 17.1737 9.19006 17.0893 8.88046C17.0049 8.57086 16.681 8.38713 16.3659 8.47008C16.0508 8.55304 15.8638 8.87127 15.9482 9.18087Z"
                                fill="url(#paint30_linear_2791_76828)" />
                            <path
                                d="M22.9107 31.1195C22.9952 31.4291 23.319 31.6129 23.6341 31.5299C23.9492 31.4469 24.1362 31.1287 24.0518 30.8191C23.9674 30.5095 23.6435 30.3258 23.3284 30.4087C23.0133 30.4917 22.8263 30.8099 22.9107 31.1195Z"
                                fill="url(#paint31_linear_2791_76828)" />
                            <path
                                d="M19.0449 11.773C19.0449 12.2916 19.4728 12.712 20.0006 12.712C20.5284 12.712 20.9562 12.2916 20.9562 11.773C20.9562 11.2544 20.5284 10.834 20.0006 10.834C19.4728 10.834 19.0449 11.2544 19.0449 11.773Z"
                                fill="url(#paint32_linear_2791_76828)" />
                            <path
                                d="M25.7742 21.2515C26.5138 20.832 26.7672 19.9028 26.3402 19.1761C26.1862 18.9139 25.9646 18.7139 25.7096 18.5851C25.159 18.3069 24.4959 18.0905 24.1863 17.5637C23.8768 17.0369 24.0176 16.3644 24.0477 15.7568C24.0616 15.4754 23.9961 15.1868 23.8421 14.9247C23.4151 14.198 22.4693 13.949 21.7297 14.3686C20.9901 14.7881 20.7367 15.7173 21.1637 16.444C21.3178 16.7062 21.5394 16.9062 21.7944 17.035C22.345 17.3132 23.0081 17.5296 23.3176 18.0564C23.6272 18.5832 23.4864 19.2557 23.4563 19.8633C23.4423 20.1447 23.5078 20.4333 23.6619 20.6954C24.0889 21.4221 25.0346 21.6711 25.7742 21.2515Z"
                                fill="url(#paint33_linear_2791_76828)" />
                            <path
                                d="M24.3535 10.9768C24.8106 10.7175 25.3951 10.8714 25.659 11.3205C26.0024 11.9049 25.8081 12.7533 26.1515 13.3377L26.5246 13.9727C26.8725 14.5648 27.7373 14.8219 28.0852 15.414C28.3491 15.8631 28.1925 16.4374 27.7354 16.6966C27.2783 16.9559 26.6939 16.8021 26.43 16.353C26.082 15.7609 26.2878 14.8965 25.9399 14.3044L25.593 13.7139C25.2406 13.1143 24.356 12.8591 24.0037 12.2595C23.7398 11.8104 23.8964 11.2361 24.3535 10.9768Z"
                                fill="url(#paint34_linear_2791_76828)" />
                            <path
                                d="M15.79 18.6607C15.0504 18.2411 14.1047 18.4901 13.6777 19.2168C13.575 19.3914 13.5117 19.5778 13.485 19.7659C13.3741 20.5474 13.5942 21.4541 13.1927 22.1374L13.1553 22.2012C12.8407 22.7366 12.1133 23.003 11.7987 23.5384C11.5348 23.9875 11.6915 24.5618 12.1485 24.8211C12.6056 25.0804 13.1901 24.9265 13.454 24.4774C13.7574 23.9611 13.6509 23.2443 13.9543 22.728L14.0023 22.6463C14.4169 21.9408 15.3634 21.6667 16.0024 21.1477C16.1406 21.0355 16.2611 20.8976 16.356 20.7361C16.783 20.0094 16.5296 19.0802 15.79 18.6607Z"
                                fill="url(#paint35_linear_2791_76828)" />
                        </g>
                        <defs>
                            <linearGradient id="paint0_linear_2791_76828" x1="0.502666" y1="2.7219" x2="45.6723"
                                y2="5.74959" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint1_linear_2791_76828" x1="0" y1="0" x2="42.2021" y2="3.03087"
                                gradientUnits="userSpaceOnUse">
                                <stop stop-color="#7BEBEC" />
                                <stop offset="1" stop-color="#937CF9" />
                            </linearGradient>
                            <linearGradient id="paint2_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint3_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint4_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint5_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint6_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint7_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint8_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint9_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint10_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint11_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint12_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint13_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint14_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint15_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint16_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint17_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint18_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint19_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint20_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint21_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint22_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint23_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint24_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint25_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint26_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint27_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint28_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint29_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint30_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint31_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint32_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint33_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint34_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint35_linear_2791_76828" x1="27.8872" y1="32.0052" x2="9.63878"
                                y2="10.0611" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <!-- AI Logo 2 -->
                <div id="aiLogo2" style="margin-bottom:6px; cursor:pointer;" title="Toggle AI Assistant">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_2791_77215)">
                            <rect width="40" height="40" rx="4" fill="white" />
                            <rect width="40" height="40" rx="4" fill="url(#paint0_linear_2791_77215)" />
                            <path
                                d="M18.8517 24.9975C18.4246 25.7242 17.4789 25.9732 16.7393 25.5536C15.9997 25.1341 15.7463 24.2049 16.1733 23.4782C16.6003 22.7515 17.5461 22.5025 18.2857 22.9221C19.0253 23.3416 19.2787 24.2708 18.8517 24.9975Z"
                                fill="white" />
                            <path
                                d="M18.8517 24.9975C18.4246 25.7242 17.4789 25.9732 16.7393 25.5536C15.9997 25.1341 15.7463 24.2049 16.1733 23.4782C16.6003 22.7515 17.5461 22.5025 18.2857 22.9221C19.0253 23.3416 19.2787 24.2708 18.8517 24.9975Z"
                                fill="url(#paint1_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M16.1733 16.4947C16.6003 17.2214 17.546 17.4704 18.2856 17.0508C19.0252 16.6313 19.2787 15.702 18.8516 14.9753C18.4246 14.2487 17.4789 13.9997 16.7393 14.4192C15.9997 14.8388 15.7463 15.768 16.1733 16.4947Z"
                                fill="white" />
                            <path
                                d="M16.1733 16.4947C16.6003 17.2214 17.546 17.4704 18.2856 17.0508C19.0252 16.6313 19.2787 15.702 18.8516 14.9753C18.4246 14.2487 17.4789 13.9997 16.7393 14.4192C15.9997 14.8388 15.7463 15.768 16.1733 16.4947Z"
                                fill="url(#paint2_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M18.245 20.9805C18.8097 21.9415 20.0604 22.2708 21.0385 21.716C22.0166 21.1611 22.3517 19.9323 21.787 18.9713C21.2223 18.0103 19.9716 17.681 18.9935 18.2358C18.0154 18.7907 17.6803 20.0195 18.245 20.9805Z"
                                fill="white" />
                            <path
                                d="M18.245 20.9805C18.8097 21.9415 20.0604 22.2708 21.0385 21.716C22.0166 21.1611 22.3517 19.9323 21.787 18.9713C21.2223 18.0103 19.9716 17.681 18.9935 18.2358C18.0154 18.7907 17.6803 20.0195 18.245 20.9805Z"
                                fill="url(#paint3_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M21.1696 24.9975C21.5967 25.7242 22.5424 25.9732 23.282 25.5536C24.0216 25.1341 24.275 24.2049 23.848 23.4782C23.421 22.7515 22.4753 22.5025 21.7356 22.9221C20.996 23.3416 20.7426 24.2708 21.1696 24.9975Z"
                                fill="white" />
                            <path
                                d="M21.1696 24.9975C21.5967 25.7242 22.5424 25.9732 23.282 25.5536C24.0216 25.1341 24.275 24.2049 23.848 23.4782C23.421 22.7515 22.4753 22.5025 21.7356 22.9221C20.996 23.3416 20.7426 24.2708 21.1696 24.9975Z"
                                fill="url(#paint4_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M19.0475 28.2065C19.0475 28.7251 19.4754 29.1455 20.0032 29.1455C20.531 29.1455 20.9589 28.7251 20.9589 28.2065C20.9589 27.6879 20.531 27.2675 20.0032 27.2675C19.4754 27.2675 19.0475 27.6879 19.0475 28.2065Z"
                                fill="white" />
                            <path
                                d="M19.0475 28.2065C19.0475 28.7251 19.4754 29.1455 20.0032 29.1455C20.531 29.1455 20.9589 28.7251 20.9589 28.2065C20.9589 27.6879 20.531 27.2675 20.0032 27.2675C19.4754 27.2675 19.0475 27.6879 19.0475 28.2065Z"
                                fill="url(#paint5_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M14.3544 27.7372C14.0905 28.1863 14.2471 28.7605 14.7042 29.0198C15.1613 29.2791 15.7458 29.1253 16.0097 28.6761C16.2736 28.227 16.117 27.6528 15.6599 27.3935C15.2028 27.1342 14.6183 27.288 14.3544 27.7372Z"
                                fill="white" />
                            <path
                                d="M14.3544 27.7372C14.0905 28.1863 14.2471 28.7605 14.7042 29.0198C15.1613 29.2791 15.7458 29.1253 16.0097 28.6761C16.2736 28.227 16.117 27.6528 15.6599 27.3935C15.2028 27.1342 14.6183 27.288 14.3544 27.7372Z"
                                fill="url(#paint6_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M29.6455 19.0508C29.1177 19.0508 28.6899 19.4712 28.6899 19.9898C28.6899 20.5084 29.1177 20.9288 29.6455 20.9288C30.1733 20.9288 30.6012 20.5084 30.6012 19.9898C30.6012 19.4712 30.1733 19.0508 29.6455 19.0508Z"
                                fill="white" />
                            <path
                                d="M29.6455 19.0508C29.1177 19.0508 28.6899 19.4712 28.6899 19.9898C28.6899 20.5084 29.1177 20.9288 29.6455 20.9288C30.1733 20.9288 30.6012 20.5084 30.6012 19.9898C30.6012 19.4712 30.1733 19.0508 29.6455 19.0508Z"
                                fill="url(#paint7_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M10.3608 19.0508C9.83304 19.0508 9.40517 19.4712 9.40517 19.9898C9.40517 20.5084 9.83304 20.9288 10.3608 20.9288C10.8886 20.9288 11.3165 20.5084 11.3165 19.9898C11.3165 19.4712 10.8886 19.0508 10.3608 19.0508Z"
                                fill="white" />
                            <path
                                d="M10.3608 19.0508C9.83304 19.0508 9.40517 19.4712 9.40517 19.9898C9.40517 20.5084 9.83304 20.9288 10.3608 20.9288C10.8886 20.9288 11.3165 20.5084 11.3165 19.9898C11.3165 19.4712 10.8886 19.0508 10.3608 19.0508Z"
                                fill="url(#paint8_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M27.755 23.3029C27.298 23.0436 26.7135 23.1975 26.4496 23.6466C26.1857 24.0957 26.3423 24.67 26.7994 24.9293C27.2565 25.1886 27.8409 25.0347 28.1048 24.5856C28.3688 24.1365 28.2121 23.5622 27.755 23.3029Z"
                                fill="white" />
                            <path
                                d="M27.755 23.3029C27.298 23.0436 26.7135 23.1975 26.4496 23.6466C26.1857 24.0957 26.3423 24.67 26.7994 24.9293C27.2565 25.1886 27.8409 25.0347 28.1048 24.5856C28.3688 24.1365 28.2121 23.5622 27.755 23.3029Z"
                                fill="url(#paint9_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M13.2256 15.0644C12.7685 14.8052 12.184 14.959 11.9201 15.4081C11.6562 15.8573 11.8128 16.4315 12.2699 16.6908C12.727 16.9501 13.3115 16.7962 13.5754 16.3471C13.8393 15.898 13.6827 15.3237 13.2256 15.0644Z"
                                fill="white" />
                            <path
                                d="M13.2256 15.0644C12.7685 14.8052 12.184 14.959 11.9201 15.4081C11.6562 15.8573 11.8128 16.4315 12.2699 16.6908C12.727 16.9501 13.3115 16.7962 13.5754 16.3471C13.8393 15.898 13.6827 15.3237 13.2256 15.0644Z"
                                fill="url(#paint10_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M25.652 27.7372C25.3881 27.288 24.8036 27.1342 24.3465 27.3935C23.8894 27.6528 23.7328 28.227 23.9967 28.6761C24.2606 29.1253 24.8451 29.2791 25.3022 29.0198C25.7593 28.7605 25.9159 28.1863 25.652 27.7372Z"
                                fill="white" />
                            <path
                                d="M25.652 27.7372C25.3881 27.288 24.8036 27.1342 24.3465 27.3935C23.8894 27.6528 23.7328 28.227 23.9967 28.6761C24.2606 29.1253 24.8451 29.2791 25.3022 29.0198C25.7593 28.7605 25.9159 28.1863 25.652 27.7372Z"
                                fill="url(#paint11_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M16.0097 11.3156C15.7458 10.8665 15.1613 10.7126 14.7042 10.9719C14.2471 11.2312 14.0905 11.8055 14.3544 12.2546C14.6183 12.7037 15.2028 12.8576 15.6599 12.5983C16.117 12.339 16.2736 11.7647 16.0097 11.3156Z"
                                fill="white" />
                            <path
                                d="M16.0097 11.3156C15.7458 10.8665 15.1613 10.7126 14.7042 10.9719C14.2471 11.2312 14.0905 11.8055 14.3544 12.2546C14.6183 12.7037 15.2028 12.8576 15.6599 12.5983C16.117 12.339 16.2736 11.7647 16.0097 11.3156Z"
                                fill="url(#paint12_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M29.7701 13.7876C29.4876 13.9479 29.3908 14.3028 29.5539 14.5804C29.717 14.858 30.0783 14.9531 30.3608 14.7928C30.6433 14.6325 30.7401 14.2776 30.577 14C30.4139 13.7224 30.0526 13.6273 29.7701 13.7876Z"
                                fill="white" />
                            <path
                                d="M29.7701 13.7876C29.4876 13.9479 29.3908 14.3028 29.5539 14.5804C29.717 14.858 30.0783 14.9531 30.3608 14.7928C30.6433 14.6325 30.7401 14.2776 30.577 14C30.4139 13.7224 30.0526 13.6273 29.7701 13.7876Z"
                                fill="url(#paint13_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M9.63919 25.2072C9.35667 25.3675 9.25988 25.7224 9.42299 26C9.5861 26.2776 9.94734 26.3727 10.2299 26.2124C10.5124 26.0522 10.6092 25.6972 10.4461 25.4196C10.2829 25.1421 9.9217 25.047 9.63919 25.2072Z"
                                fill="white" />
                            <path
                                d="M9.63919 25.2072C9.35667 25.3675 9.25988 25.7224 9.42299 26C9.5861 26.2776 9.94734 26.3727 10.2299 26.2124C10.5124 26.0522 10.6092 25.6972 10.4461 25.4196C10.2829 25.1421 9.9217 25.047 9.63919 25.2072Z"
                                fill="url(#paint14_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M30.3608 25.2072C30.0783 25.0469 29.717 25.142 29.5539 25.4196C29.3908 25.6972 29.4876 26.0521 29.7701 26.2124C30.0527 26.3727 30.4139 26.2776 30.577 26C30.7401 25.7224 30.6433 25.3675 30.3608 25.2072Z"
                                fill="white" />
                            <path
                                d="M30.3608 25.2072C30.0783 25.0469 29.717 25.142 29.5539 25.4196C29.3908 25.6972 29.4876 26.0521 29.7701 26.2124C30.0527 26.3727 30.4139 26.2776 30.577 26C30.7401 25.7224 30.6433 25.3675 30.3608 25.2072Z"
                                fill="url(#paint15_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M10.2299 13.7876C9.94736 13.6273 9.58611 13.7225 9.423 14C9.25989 14.2776 9.35669 14.6326 9.6392 14.7928C9.92171 14.9531 10.283 14.858 10.4461 14.5804C10.6092 14.3028 10.5124 13.9479 10.2299 13.7876Z"
                                fill="white" />
                            <path
                                d="M10.2299 13.7876C9.94736 13.6273 9.58611 13.7225 9.423 14C9.25989 14.2776 9.35669 14.6326 9.6392 14.7928C9.92171 14.9531 10.283 14.858 10.4461 14.5804C10.6092 14.3028 10.5124 13.9479 10.2299 13.7876Z"
                                fill="url(#paint16_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M20.5906 31.4196C20.5906 31.0991 20.3262 30.8393 20 30.8393C19.6737 30.8393 19.4093 31.0991 19.4093 31.4196C19.4093 31.7402 19.6737 32 20 32C20.3262 32 20.5906 31.7402 20.5906 31.4196Z"
                                fill="white" />
                            <path
                                d="M20.5906 31.4196C20.5906 31.0991 20.3262 30.8393 20 30.8393C19.6737 30.8393 19.4093 31.0991 19.4093 31.4196C19.4093 31.7402 19.6737 32 20 32C20.3262 32 20.5906 31.7402 20.5906 31.4196Z"
                                fill="url(#paint17_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M20.5907 8.58036C20.5907 8.25983 20.3262 8 20 8C19.6738 8 19.4093 8.25983 19.4093 8.58036C19.4093 8.90088 19.6738 9.16071 20 9.16071C20.3262 9.16071 20.5907 8.90088 20.5907 8.58036Z"
                                fill="white" />
                            <path
                                d="M20.5907 8.58036C20.5907 8.25983 20.3262 8 20 8C19.6738 8 19.4093 8.25983 19.4093 8.58036C19.4093 8.90088 19.6738 9.16071 20 9.16071C20.3262 9.16071 20.5907 8.90088 20.5907 8.58036Z"
                                fill="url(#paint18_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M17.0892 31.1195C17.1737 30.8099 16.9867 30.4917 16.6716 30.4087C16.3565 30.3258 16.0326 30.5095 15.9482 30.8191C15.8637 31.1287 16.0507 31.4469 16.3658 31.5299C16.6809 31.6129 17.0048 31.4291 17.0892 31.1195Z"
                                fill="white" />
                            <path
                                d="M17.0892 31.1195C17.1737 30.8099 16.9867 30.4917 16.6716 30.4087C16.3565 30.3258 16.0326 30.5095 15.9482 30.8191C15.8637 31.1287 16.0507 31.4469 16.3658 31.5299C16.6809 31.6129 17.0048 31.4291 17.0892 31.1195Z"
                                fill="url(#paint19_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M24.0518 9.18087C24.1362 8.87127 23.9492 8.55304 23.6341 8.47009C23.319 8.38713 22.9951 8.57086 22.9107 8.88046C22.8263 9.19006 23.0133 9.50829 23.3284 9.59125C23.6435 9.67421 23.9673 9.49048 24.0518 9.18087Z"
                                fill="white" />
                            <path
                                d="M24.0518 9.18087C24.1362 8.87127 23.9492 8.55304 23.6341 8.47009C23.319 8.38713 22.9951 8.57086 22.9107 8.88046C22.8263 9.19006 23.0133 9.50829 23.3284 9.59125C23.6435 9.67421 23.9673 9.49048 24.0518 9.18087Z"
                                fill="url(#paint20_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M12.4897 28.8572C12.7204 28.6306 12.7204 28.2631 12.4897 28.0365C12.2591 27.8098 11.8851 27.8098 11.6544 28.0365C11.4237 28.2631 11.4237 28.6306 11.6544 28.8572C11.8851 29.0839 12.2591 29.0839 12.4897 28.8572Z"
                                fill="white" />
                            <path
                                d="M12.4897 28.8572C12.7204 28.6306 12.7204 28.2631 12.4897 28.0365C12.2591 27.8098 11.8851 27.8098 11.6544 28.0365C11.4237 28.2631 11.4237 28.6306 11.6544 28.8572C11.8851 29.0839 12.2591 29.0839 12.4897 28.8572Z"
                                fill="url(#paint21_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M28.3456 11.9635C28.5763 11.7369 28.5763 11.3694 28.3456 11.1427C28.1149 10.9161 27.7409 10.9161 27.5102 11.1427C27.2796 11.3694 27.2796 11.7369 27.5102 11.9635C27.7409 12.1901 28.1149 12.1901 28.3456 11.9635Z"
                                fill="white" />
                            <path
                                d="M28.3456 11.9635C28.5763 11.7369 28.5763 11.3694 28.3456 11.1427C28.1149 10.9161 27.7409 10.9161 27.5102 11.1427C27.2796 11.3694 27.2796 11.7369 27.5102 11.9635C27.7409 12.1901 28.1149 12.1901 28.3456 11.9635Z"
                                fill="url(#paint22_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M8.74369 23.0831C9.0588 23.0001 9.24579 22.6819 9.16136 22.3723C9.07693 22.0627 8.75304 21.8789 8.43794 21.9619C8.12284 22.0449 7.93584 22.3631 8.02027 22.6727C8.1047 22.9823 8.42859 23.166 8.74369 23.0831Z"
                                fill="white" />
                            <path
                                d="M8.74369 23.0831C9.0588 23.0001 9.24579 22.6819 9.16136 22.3723C9.07693 22.0627 8.75304 21.8789 8.43794 21.9619C8.12284 22.0449 7.93584 22.3631 8.02027 22.6727C8.1047 22.9823 8.42859 23.166 8.74369 23.0831Z"
                                fill="url(#paint23_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M31.5621 18.0381C31.8772 17.9552 32.0642 17.6369 31.9797 17.3273C31.8953 17.0177 31.5714 16.834 31.2563 16.917C30.9412 16.9999 30.7542 17.3182 30.8386 17.6278C30.9231 17.9374 31.247 18.1211 31.5621 18.0381Z"
                                fill="white" />
                            <path
                                d="M31.5621 18.0381C31.8772 17.9552 32.0642 17.6369 31.9797 17.3273C31.8953 17.0177 31.5714 16.834 31.2563 16.917C30.9412 16.9999 30.7542 17.3182 30.8386 17.6278C30.9231 17.9374 31.247 18.1211 31.5621 18.0381Z"
                                fill="url(#paint24_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M8.43794 18.0381C8.75305 18.1211 9.07693 17.9374 9.16136 17.6278C9.24579 17.3182 9.0588 16.9999 8.7437 16.917C8.42859 16.834 8.10471 17.0177 8.02028 17.3273C7.93584 17.6369 8.12284 17.9552 8.43794 18.0381Z"
                                fill="white" />
                            <path
                                d="M8.43794 18.0381C8.75305 18.1211 9.07693 17.9374 9.16136 17.6278C9.24579 17.3182 9.0588 16.9999 8.7437 16.917C8.42859 16.834 8.10471 17.0177 8.02028 17.3273C7.93584 17.6369 8.12284 17.9552 8.43794 18.0381Z"
                                fill="url(#paint25_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M31.2563 23.083C31.5714 23.166 31.8953 22.9823 31.9797 22.6727C32.0642 22.3631 31.8772 22.0448 31.5621 21.9619C31.247 21.8789 30.9231 22.0627 30.8386 22.3723C30.7542 22.6819 30.9412 23.0001 31.2563 23.083Z"
                                fill="white" />
                            <path
                                d="M31.2563 23.083C31.5714 23.166 31.8953 22.9823 31.9797 22.6727C32.0642 22.3631 31.8772 22.0448 31.5621 21.9619C31.247 21.8789 30.9231 22.0627 30.8386 22.3723C30.7542 22.6819 30.9412 23.0001 31.2563 23.083Z"
                                fill="url(#paint26_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M11.6544 11.9635C11.8851 12.1901 12.2591 12.1901 12.4898 11.9635C12.7204 11.7368 12.7204 11.3694 12.4898 11.1427C12.2591 10.9161 11.8851 10.9161 11.6544 11.1427C11.4237 11.3694 11.4237 11.7368 11.6544 11.9635Z"
                                fill="white" />
                            <path
                                d="M11.6544 11.9635C11.8851 12.1901 12.2591 12.1901 12.4898 11.9635C12.7204 11.7368 12.7204 11.3694 12.4898 11.1427C12.2591 10.9161 11.8851 10.9161 11.6544 11.1427C11.4237 11.3694 11.4237 11.7368 11.6544 11.9635Z"
                                fill="url(#paint27_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M27.5103 28.8572C27.7409 29.0839 28.1149 29.0839 28.3456 28.8572C28.5763 28.6306 28.5763 28.2631 28.3456 28.0365C28.1149 27.8098 27.7409 27.8098 27.5103 28.0365C27.2796 28.2631 27.2796 28.6306 27.5103 28.8572Z"
                                fill="white" />
                            <path
                                d="M27.5103 28.8572C27.7409 29.0839 28.1149 29.0839 28.3456 28.8572C28.5763 28.6306 28.5763 28.2631 28.3456 28.0365C28.1149 27.8098 27.7409 27.8098 27.5103 28.0365C27.2796 28.2631 27.2796 28.6306 27.5103 28.8572Z"
                                fill="url(#paint28_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M15.9482 9.18087C16.0327 9.49047 16.3565 9.6742 16.6716 9.59125C16.9867 9.50829 17.1737 9.19006 17.0893 8.88046C17.0049 8.57086 16.681 8.38713 16.3659 8.47008C16.0508 8.55304 15.8638 8.87127 15.9482 9.18087Z"
                                fill="white" />
                            <path
                                d="M15.9482 9.18087C16.0327 9.49047 16.3565 9.6742 16.6716 9.59125C16.9867 9.50829 17.1737 9.19006 17.0893 8.88046C17.0049 8.57086 16.681 8.38713 16.3659 8.47008C16.0508 8.55304 15.8638 8.87127 15.9482 9.18087Z"
                                fill="url(#paint29_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M22.9107 31.1195C22.9952 31.4291 23.319 31.6129 23.6341 31.5299C23.9492 31.4469 24.1362 31.1287 24.0518 30.8191C23.9674 30.5095 23.6435 30.3258 23.3284 30.4087C23.0133 30.4917 22.8263 30.8099 22.9107 31.1195Z"
                                fill="white" />
                            <path
                                d="M22.9107 31.1195C22.9952 31.4291 23.319 31.6129 23.6341 31.5299C23.9492 31.4469 24.1362 31.1287 24.0518 30.8191C23.9674 30.5095 23.6435 30.3258 23.3284 30.4087C23.0133 30.4917 22.8263 30.8099 22.9107 31.1195Z"
                                fill="url(#paint30_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M19.0449 11.773C19.0449 12.2916 19.4728 12.712 20.0006 12.712C20.5284 12.712 20.9562 12.2916 20.9562 11.773C20.9562 11.2544 20.5284 10.834 20.0006 10.834C19.4728 10.834 19.0449 11.2544 19.0449 11.773Z"
                                fill="white" />
                            <path
                                d="M19.0449 11.773C19.0449 12.2916 19.4728 12.712 20.0006 12.712C20.5284 12.712 20.9562 12.2916 20.9562 11.773C20.9562 11.2544 20.5284 10.834 20.0006 10.834C19.4728 10.834 19.0449 11.2544 19.0449 11.773Z"
                                fill="url(#paint31_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M25.7742 21.2515C26.5138 20.832 26.7672 19.9028 26.3402 19.1761C26.1862 18.9139 25.9646 18.7139 25.7096 18.5851C25.159 18.3069 24.4959 18.0905 24.1863 17.5637C23.8768 17.0369 24.0176 16.3644 24.0477 15.7568C24.0616 15.4754 23.9961 15.1868 23.8421 14.9247C23.4151 14.198 22.4693 13.949 21.7297 14.3686C20.9901 14.7881 20.7367 15.7173 21.1637 16.444C21.3178 16.7062 21.5394 16.9062 21.7944 17.035C22.345 17.3132 23.0081 17.5296 23.3176 18.0564C23.6272 18.5832 23.4864 19.2557 23.4563 19.8633C23.4423 20.1447 23.5078 20.4333 23.6619 20.6954C24.0889 21.4221 25.0346 21.6711 25.7742 21.2515Z"
                                fill="white" />
                            <path
                                d="M25.7742 21.2515C26.5138 20.832 26.7672 19.9028 26.3402 19.1761C26.1862 18.9139 25.9646 18.7139 25.7096 18.5851C25.159 18.3069 24.4959 18.0905 24.1863 17.5637C23.8768 17.0369 24.0176 16.3644 24.0477 15.7568C24.0616 15.4754 23.9961 15.1868 23.8421 14.9247C23.4151 14.198 22.4693 13.949 21.7297 14.3686C20.9901 14.7881 20.7367 15.7173 21.1637 16.444C21.3178 16.7062 21.5394 16.9062 21.7944 17.035C22.345 17.3132 23.0081 17.5296 23.3176 18.0564C23.6272 18.5832 23.4864 19.2557 23.4563 19.8633C23.4423 20.1447 23.5078 20.4333 23.6619 20.6954C24.0889 21.4221 25.0346 21.6711 25.7742 21.2515Z"
                                fill="url(#paint32_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M24.3535 10.9768C24.8106 10.7175 25.3951 10.8714 25.659 11.3205C26.0024 11.9049 25.8081 12.7533 26.1515 13.3377L26.5246 13.9727C26.8725 14.5648 27.7373 14.8219 28.0852 15.414C28.3491 15.8631 28.1925 16.4374 27.7354 16.6966C27.2783 16.9559 26.6939 16.8021 26.43 16.353C26.082 15.7609 26.2878 14.8965 25.9399 14.3044L25.593 13.7139C25.2406 13.1143 24.356 12.8591 24.0037 12.2595C23.7398 11.8104 23.8964 11.2361 24.3535 10.9768Z"
                                fill="white" />
                            <path
                                d="M24.3535 10.9768C24.8106 10.7175 25.3951 10.8714 25.659 11.3205C26.0024 11.9049 25.8081 12.7533 26.1515 13.3377L26.5246 13.9727C26.8725 14.5648 27.7373 14.8219 28.0852 15.414C28.3491 15.8631 28.1925 16.4374 27.7354 16.6966C27.2783 16.9559 26.6939 16.8021 26.43 16.353C26.082 15.7609 26.2878 14.8965 25.9399 14.3044L25.593 13.7139C25.2406 13.1143 24.356 12.8591 24.0037 12.2595C23.7398 11.8104 23.8964 11.2361 24.3535 10.9768Z"
                                fill="url(#paint33_linear_2791_77215)" fill-opacity="0.08" />
                            <path
                                d="M15.79 18.6607C15.0504 18.2411 14.1047 18.4901 13.6777 19.2168C13.575 19.3914 13.5117 19.5778 13.485 19.7659C13.3741 20.5474 13.5942 21.4541 13.1928 22.1374L13.1553 22.2012C12.8407 22.7366 12.1133 23.003 11.7987 23.5384C11.5348 23.9875 11.6915 24.5618 12.1485 24.8211C12.6056 25.0804 13.1901 24.9265 13.454 24.4774C13.7574 23.9611 13.6509 23.2443 13.9543 22.728L14.0023 22.6463C14.4169 21.9408 15.3634 21.6667 16.0024 21.1477C16.1406 21.0355 16.2611 20.8976 16.356 20.7361C16.783 20.0094 16.5296 19.0802 15.79 18.6607Z"
                                fill="white" />
                            <path
                                d="M15.79 18.6607C15.0504 18.2411 14.1047 18.4901 13.6777 19.2168C13.575 19.3914 13.5117 19.5778 13.485 19.7659C13.3741 20.5474 13.5942 21.4541 13.1928 22.1374L13.1553 22.2012C12.8407 22.7366 12.1133 23.003 11.7987 23.5384C11.5348 23.9875 11.6915 24.5618 12.1485 24.8211C12.6056 25.0804 13.1901 24.9265 13.454 24.4774C13.7574 23.9611 13.6509 23.2443 13.9543 22.728L14.0023 22.6463C14.4169 21.9408 15.3634 21.6667 16.0024 21.1477C16.1406 21.0355 16.2611 20.8976 16.356 20.7361C16.783 20.0094 16.5296 19.0802 15.79 18.6607Z"
                                fill="url(#paint34_linear_2791_77215)" fill-opacity="0.08" />
                        </g>
                        <defs>
                            <linearGradient id="paint0_linear_2791_77215" x1="33.1454" y1="40.0086" x2="2.7313"
                                y2="3.43519" gradientUnits="userSpaceOnUse">
                                <stop offset="0.01" stop-color="#2157F5" />
                                <stop offset="0.371064" stop-color="#258DFF" />
                                <stop offset="1" stop-color="#86FFBB" />
                            </linearGradient>
                            <linearGradient id="paint1_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint2_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint3_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint4_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint5_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint6_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint7_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint8_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint9_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint10_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint11_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint12_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint13_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint14_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint15_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint16_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint17_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint18_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint19_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint20_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint21_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint22_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint23_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint24_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint25_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint26_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint27_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint28_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint29_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint30_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint31_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint32_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint33_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <linearGradient id="paint34_linear_2791_77215" x1="8.3016" y1="9.63314" x2="35.4034"
                                y2="11.4498" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#937CF9" />
                                <stop offset="1" stop-color="#7BEBEC" />
                            </linearGradient>
                            <clipPath id="clip0_2791_77215">
                                <rect width="40" height="40" fill="white" />
                            </clipPath>
                        </defs>
                    </svg>
                </div>

                <button class="nav-toggle-btn">C</button>
                <button class="nav-toggle-btn">L</button>
                <button class="nav-toggle-btn">T</button>
                <button class="nav-toggle-btn">CH</button>
                <button class="nav-toggle-btn">D</button>
            </nav>

            <div class="app-container">

                <aside class="chat-sidebar state-docked" id="chatPanel">
                    <div class="mobile-sheet-handle" id="mobileSheetHandle"></div>

                    <div class="minimized-view-wrapper">
                        <div class="min-left-group">
                            <div class="drag-handle" id="dragHandle">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <circle cx="9" cy="5" r="1.5" />
                                    <circle cx="9" cy="12" r="1.5" />
                                    <circle cx="9" cy="19" r="1.5" />
                                    <circle cx="15" cy="5" r="1.5" />
                                    <circle cx="15" cy="12" r="1.5" />
                                    <circle cx="15" cy="19" r="1.5" />
                                </svg>
                            </div>
                            <div class="min-brand">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"
                                    style="color: #00BFA5;">
                                    <path d="M12 2L15 9L22 12L15 15L12 22L9 15L2 12L9 9L12 2Z"></path>
                                </svg>
                                <span>AI Assistant</span>
                            </div>
                        </div>
                        <div class="min-controls">
                            <button class="min-btn" id="btnRestoreMin"><svg width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2.5">
                                    <polyline points="18 15 12 9 6 15"></polyline>
                                </svg></button>
                            <button class="min-btn" id="btnCloseMin"><svg width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2.5">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg></button>
                        </div>
                    </div>

                    <div class="main-view-wrapper">

                        <div class="top-bar" id="chatTopBar">
                            <div class="brand-text">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M7.94922 14.2996C8.41854 14.2998 8.79948 14.6805 8.79948 15.1498C8.79934 15.619 8.41845 15.9999 7.94922 16C7.47986 16 7.0991 15.6191 7.09896 15.1498C7.09896 14.6804 7.47978 14.2996 7.94922 14.2996Z"
                                        fill="url(#brand_paint0_linear)" />
                                    <path
                                        d="M12.1497 13.3973C12.5086 13.3973 12.7993 13.6882 12.7995 14.047C12.7995 14.406 12.5087 14.6967 12.1497 14.6967C11.7909 14.6966 11.5 14.4059 11.5 14.047C11.5001 13.6883 11.791 13.3975 12.1497 13.3973Z"
                                        fill="url(#brand_paint1_linear)" />
                                    <path
                                        d="M3.45052 12.7997C3.86473 12.7997 4.20052 13.1355 4.20052 13.5497C4.20052 13.9639 3.86473 14.2996 3.45052 14.2996C3.03631 14.2996 2.70052 13.9639 2.70052 13.5497C2.70052 13.1355 3.03631 12.7997 3.45052 12.7997Z"
                                        fill="url(#brand_paint2_linear)" />
                                    <path
                                        d="M6.25 10.3976C6.94036 10.3976 7.5 10.9572 7.5 11.6475C7.5 12.3378 6.94036 12.8974 6.25 12.8974C5.55964 12.8974 5 12.3378 5 11.6475C5 10.9572 5.55964 10.3976 6.25 10.3976Z"
                                        fill="url(#brand_paint3_linear)" />
                                    <path
                                        d="M10.3503 10.3976C10.9853 10.3976 11.4999 10.9123 11.5 11.5472C11.5 12.1823 10.9854 12.6969 10.3503 12.6969C9.71525 12.6967 9.20052 12.1822 9.20052 11.5472C9.20066 10.9124 9.71534 10.3977 10.3503 10.3976Z"
                                        fill="url(#brand_paint4_linear)" />
                                    <path
                                        d="M13.6497 10.1984C14.1191 10.1985 14.5 10.5793 14.5 11.0486C14.4999 11.5178 14.119 11.8986 13.6497 11.8988C13.1804 11.8988 12.7996 11.5179 12.7995 11.0486C12.7995 10.5792 13.1803 10.1984 13.6497 10.1984Z"
                                        fill="url(#brand_paint5_linear)" />
                                    <path
                                        d="M3.41667 6.86923C3.73903 6.32538 4.45228 6.13871 5.01042 6.4526C5.56871 6.7668 5.75983 7.46295 5.4375 8.00716C5.36588 8.12803 5.27483 8.23174 5.17057 8.31573C4.68818 8.70417 3.97429 8.90987 3.66146 9.43803L3.625 9.49923C3.39616 9.88587 3.47637 10.4224 3.2474 10.809C3.0482 11.1453 2.60674 11.2609 2.26172 11.0668C1.91679 10.8727 1.79845 10.4422 1.9974 10.1059C2.23484 9.70506 2.78461 9.50557 3.02214 9.10473L3.04948 9.05656C3.35255 8.54486 3.18708 7.86584 3.27083 7.28066C3.291 7.13974 3.3392 7.00003 3.41667 6.86923Z"
                                        fill="url(#brand_paint6_linear)" />
                                    <path
                                        d="M8.2487 6.60103C9.15988 6.60103 9.8983 7.33955 9.89844 8.25063C9.89844 9.16183 9.15997 9.90024 8.2487 9.90024C7.33755 9.9001 6.59896 9.16174 6.59896 8.25063C6.5991 7.33964 7.33763 6.60117 8.2487 6.60103Z"
                                        fill="url(#brand_paint7_linear)" />
                                    <path
                                        d="M9.68229 3.55049C10.2406 3.23631 10.955 3.42298 11.2773 3.96713C11.3936 4.16346 11.4428 4.38 11.4323 4.59077C11.4095 5.04569 11.3042 5.54911 11.5378 5.94353C11.7715 6.33786 12.272 6.50082 12.6875 6.70909C12.8796 6.8055 13.0466 6.95463 13.1628 7.15046C13.4851 7.69466 13.294 8.39082 12.7357 8.70502C12.1774 9.01922 11.4643 8.8326 11.1419 8.28839C11.0257 8.09219 10.9752 7.87667 10.9857 7.66604C11.0084 7.21104 11.1152 6.7065 10.8815 6.31199C10.6478 5.91782 10.1472 5.75593 9.73177 5.54773C9.53925 5.45123 9.3715 5.30139 9.25521 5.10505C8.93305 4.56095 9.12424 3.86473 9.68229 3.55049Z"
                                        fill="url(#brand_paint8_linear)" />
                                    <path
                                        d="M0.75 7.30019C1.16421 7.30019 1.5 7.63595 1.5 8.05013C1.5 8.46431 1.16421 8.80007 0.75 8.80007C0.335786 8.80007 0 8.46431 0 8.05013C0 7.63595 0.335786 7.30019 0.75 7.30019Z"
                                        fill="url(#brand_paint9_linear)" />
                                    <path
                                        d="M15.25 7.30019C15.6642 7.30019 16 7.63595 16 8.05013C16 8.46431 15.6642 8.80007 15.25 8.80007C14.8358 8.80007 14.5 8.46431 14.5 8.05013C14.5 7.63595 14.8358 7.30019 15.25 7.30019Z"
                                        fill="url(#brand_paint10_linear)" />
                                    <path
                                        d="M2.04948 3.49972C2.6292 3.49972 3.09998 3.9695 3.10026 4.54911C3.10026 5.12896 2.62938 5.5998 2.04948 5.5998C1.46982 5.59952 1 5.12879 1 4.54911C1.00028 3.96967 1.46999 3.5 2.04948 3.49972Z"
                                        fill="url(#brand_paint11_linear)" />
                                    <path
                                        d="M6.54948 2.8982C7.23984 2.8982 7.79948 3.4578 7.79948 4.1481C7.79948 4.8384 7.23984 5.398 6.54948 5.398C5.85912 5.398 5.29948 4.8384 5.29948 4.1481C5.29948 3.4578 5.85912 2.8982 6.54948 2.8982Z"
                                        fill="url(#brand_paint12_linear)" />
                                    <path
                                        d="M13.2005 2.4998C13.7528 2.4998 14.2005 2.94748 14.2005 3.49972C14.2005 4.05196 13.7528 4.49963 13.2005 4.49963C12.6482 4.49963 12.2005 4.05196 12.2005 3.49972C12.2005 2.94748 12.6482 2.4998 13.2005 2.4998Z"
                                        fill="url(#brand_paint13_linear)" />
                                    <path
                                        d="M4.55078 0.800716C4.90968 0.800716 5.20038 1.09157 5.20052 1.4504C5.20052 1.80936 4.90977 2.10009 4.55078 2.10009C4.19192 2.09995 3.90104 1.80927 3.90104 1.4504C3.90118 1.09165 4.192 0.800857 4.55078 0.800716Z"
                                        fill="url(#brand_paint14_linear)" />
                                    <path
                                        d="M8.75 0C9.16421 0 9.5 0.335759 9.5 0.749939C9.5 1.16412 9.16421 1.49988 8.75 1.49988C8.33579 1.49988 8 1.16412 8 0.749939C8 0.335759 8.33579 0 8.75 0Z"
                                        fill="url(#brand_paint15_linear)" />
                                    <defs>
                                        <linearGradient id="brand_paint0_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint1_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint2_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint3_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint4_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint5_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint6_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint7_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint8_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint9_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint10_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint11_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint12_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint13_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint14_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                        <linearGradient id="brand_paint15_linear" x1="13.2581" y1="16.0035" x2="1.09252"
                                            y2="1.37408" gradientUnits="userSpaceOnUse">
                                            <stop offset="0.01" stop-color="#2157F5" />
                                            <stop offset="0.371064" stop-color="#258DFF" />
                                            <stop offset="1" stop-color="#86FFBB" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                AI Assistant
                            </div>
                            <div class="window-controls">
                                <button class="win-btn" id="btnMinimize"><svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg></button>
                                <button class="win-btn" id="btnFull"><svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <polyline points="9 21 3 21 3 15"></polyline>
                                        <line x1="21" y1="3" x2="14" y2="10"></line>
                                        <line x1="3" y1="21" x2="10" y2="14"></line>
                                    </svg></button>
                                <button class="win-btn" id="btnDock" style="display:none;"><svg viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="9" y1="3" x2="9" y2="21"></line>
                                    </svg></button>
                                <button class="win-btn" id="btnClose"><svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg></button>
                            </div>
                        </div>

                        <div class="chat-card-container">

                            <div class="nav-header">
                                <button class="action-btn" id="btnShowHistory" title="Back to History">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round" stroke-width="2">
                                        <line x1="19" y1="12" x2="5" y2="12"></line>
                                        <polyline points="12 19 5 12 12 5"></polyline>
                                    </svg>
                                </button>
                                <div class="chat-title" id="chatHeaderTitle">New Chat</div>

                                <button class="action-btn" id="btnHeaderNewChat" title="New Chat" disabled
                                    style="margin-right: 4px;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z" />
                                        <path d="M8 12h8" />
                                        <path d="M12 8v8" />
                                    </svg>
                                </button>

                                <button class="action-btn" id="btnHeaderRefresh" title="Refresh" style="display: none;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round" stroke-width="2">
                                        <path d="M23 4v6h-6"></path>
                                        <path d="M1 20v-6h6"></path>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                                        <path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                </button>

                                <div id="chatMenuContainer">
                                    <button class="action-btn" id="btnChatMenu" title="Menu" disabled>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="1"></circle>
                                            <circle cx="12" cy="5" r="1"></circle>
                                            <circle cx="12" cy="19" r="1"></circle>
                                        </svg>
                                    </button>
                                    <div class="menu-dropdown" id="chatDropdown">
                                        <button class="menu-item" onclick="togglePinFromHeader()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <line x1="12" y1="17" x2="12" y2="22"></line>
                                                <path
                                                    d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z">
                                                </path>
                                            </svg>
                                            <span id="headerPinText">Pin Chat</span>
                                        </button>
                                        <button class="menu-item" onclick="openRenameModalFromHeader()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z">
                                                </path>
                                            </svg>
                                            Rename
                                        </button>
                                        <button class="menu-item danger" onclick="openDeleteModalFromHeader()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path
                                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                                </path>
                                            </svg>
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="history-overlay" id="historyOverlay"></div>

                            <div class="history-sheet" id="historySheet">
                                <!-- Search Header -->
                                <div class="history-header">
                                    <div class="history-search-wrapper">
                                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        </svg>
                                        <input type="text" class="history-search-input" id="historySearchInput"
                                            placeholder="Search chats..." oninput="filterHistoryList(this.value)">
                                    </div>
                                </div>

                                <div class="history-tab-content">
                                    <!-- Sidebar Fixed Nav -->
                                    <div class="history-nav-group">
                                        <div class="history-nav-item" onclick="resetChat(); toggleHistory(false);">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"></path>
                                                <path d="M8 12h8"></path>
                                                <path d="M12 8v8"></path>
                                            </svg>
                                            <span>New Chat</span>
                                        </div>
                                        <div class="history-nav-item" onclick="switchHistoryTab('agent-tasks')">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                <polyline points="9 11 12 14 16 9"></polyline>
                                            </svg>
                                            <span>Agent Tasks</span>
                                        </div>
                                        <div class="history-nav-item" onclick="switchHistoryTab('pulse')">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path
                                                    d="M12 3l1.65 4.35L18 9l-4.35 1.65L12 15l-1.65-4.35L6 9l4.35-1.65L12 3z">
                                                </path>
                                                <path
                                                    d="M19 14l1.1 2.9L23 18l-2.9 1.1L19 22l-1.1-2.9L15 18l2.9-1.1L19 14z">
                                                </path>
                                            </svg>
                                            <span>Insights</span>
                                        </div>
                                        <div class="history-nav-item" onclick="switchHistoryTab('prompt-templates')">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                <line x1="9" y1="17" x2="15" y2="7"></line>
                                            </svg>
                                            <span>Prompt Templates</span>
                                        </div>
                                    </div>


                                    <!-- PERSISTENT HISTORY SECTION -->
                                    <div class="history-persistent-chats" id="chatsTabContent">
                                        <div class="history-section-header">My Chats</div>
                                        <div id="recentList">
                                            <!-- Pinned items manually updated to match image order if possible -->
                                            <div class="history-item is-pinned active"
                                                onclick="loadHistoryChat('Monthly Sales Review')">
                                                <div class="history-item-left">
                                                    <span class="history-text">Monthly Sales Review</span>
                                                </div>
                                                <div class="history-item-actions">
                                                    <div class="history-item-pin-btn">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                            stroke-width="2">
                                                            <line x1="12" y1="17" x2="12" y2="22"></line>
                                                            <path
                                                                d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z">
                                                            </path>
                                                        </svg>
                                                    </div>
                                                    <button class="history-item-menu-btn" onclick="showItemMenu(event)">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                            stroke-width="2">
                                                            <circle cx="12" cy="12" r="1"></circle>
                                                            <circle cx="12" cy="5" r="1"></circle>
                                                            <circle cx="12" cy="19" r="1"></circle>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                            <!-- ... (truncating list for brevity, I'll copy the whole thing in the real call) -->
                                        </div>
                                        <div id="historyPlaceholder" style="display: none;"></div>
                                    </div>
                                </div>

                                <!-- Footer -->
                                <div class="history-footer">
                                    <div class="history-nav-item" onclick="openMainView('settingsView');">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="3"></circle>
                                            <path
                                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                                            </path>
                                        </svg>
                                        <span>Settings</span>
                                    </div>
                                </div>

                                <!-- (FAB Removed) -->


                            </div>

                            <div class="chat-scroll-area">
                                <div class="empty-state-wrapper" id="emptyState">
                                    <div class="empty-state-content content-aligner">
                                        <div class="empty-icon">
                                            <img src="ai-logo.gif" alt="AI Assistant Logo">
                                        </div>
                                        <h2 class="greeting-title">Hi John,</h2>
                                        <p class="greeting-subtitle">How can I help you today?</p>
                                    </div>
                                </div>
                                <div class="active-chat-wrapper content-aligner" id="activeChat"></div>

                                <!-- Main View Modules -->
                                <div class="main-view-container" id="tasksView">
                                    <div class="view-header">
                                        <h1 class="view-title">Agent Tasks</h1>
                                        <p class="view-subtitle">Review and manage your automated workflow tasks.</p>
                                    </div>
                                    <div class="tasks-container">
                                        <div class="task-row">
                                            <div class="task-status status-progress"></div>
                                            <div class="task-info">
                                                <div style="font-weight: 600;">Monthly Sales Data Reconciliation</div>
                                                <div style="font-size: var(--font-sm); color: var(--color-text-muted);">
                                                    In Progress  Due Today</div>
                                            </div>
                                        </div>
                                        <div class="task-row">
                                            <div class="task-status status-todo"></div>
                                            <div class="task-info">
                                                <div style="font-weight: 600;">Inventory Level Analysis (Tesla Model Y)
                                                </div>
                                                <div style="font-size: var(--font-sm); color: var(--color-text-muted);">
                                                    To Do  Next Up</div>
                                            </div>
                                        </div>
                                        <div class="task-row">
                                            <div class="task-status status-done"></div>
                                            <div class="task-info">
                                                <div style="font-weight: 600; text-decoration: line-through;">Q4 Service
                                                    Appointment Summary</div>
                                                <div style="font-size: var(--font-sm); color: var(--color-text-muted);">
                                                    Completed  Yesterday</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="main-view-container" id="insightsView">
                                    <div class="view-header">
                                        <h1 class="view-title">Insights</h1>
                                        <p class="view-subtitle">AI-powered analytics and business trends.</p>
                                    </div>
                                    <div class="insights-grid">
                                        <div class="insight-card">
                                            <div style="font-size: 2rem; margin-bottom: 12px;"></div>
                                            <div style="font-weight: 700; margin-bottom: 4px;">Conversion Rate Up 12%
                                            </div>
                                            <div style="font-size: var(--font-sm); color: var(--color-text-muted);">Your
                                                personalized follow-ups are significantly outperforming standard
                                                templates.</div>
                                        </div>
                                        <div class="insight-card">
                                            <div style="font-size: 2rem; margin-bottom: 12px;"></div>
                                            <div style="font-weight: 700; margin-bottom: 4px;">Model 3 Interest Spike
                                            </div>
                                            <div style="font-size: var(--font-sm); color: var(--color-text-muted);">
                                                Recent inquiries about Model 3 have increased by 40% in the last 48
                                                hours.</div>
                                        </div>
                                        <div class="insight-card">
                                            <div style="font-size: 2rem; margin-bottom: 12px;"></div>
                                            <div style="font-weight: 700; margin-bottom: 4px;">Top Active Times</div>
                                            <div style="font-size: var(--font-sm); color: var(--color-text-muted);">
                                                Clients are most responsive between 10am and 12pm on Tuesdays.</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="main-view-container" id="templatesView">
                                    <div class="view-header">
                                        <h1 class="view-title">Prompt Templates</h1>
                                        <p class="view-subtitle">Quick-start actions for common CRM and sales tasks.</p>
                                    </div>
                                    <div class="templates-grid">
                                        <div class="template-card" onclick="startChat('Summarize recent hot leads')">
                                            <div style="font-weight: 600; margin-bottom: 4px;">Hot Lead Summary</div>
                                            <div style="font-size: var(--font-sm); color: var(--color-text-muted);">Get
                                                a quick overview of all leads with high intent scores.</div>
                                        </div>
                                        <div class="template-card" onclick="startChat('Draft quote for Model X')">
                                            <div style="font-weight: 600; margin-bottom: 4px;">Draft Quote</div>
                                            <div style="font-size: var(--font-sm); color: var(--color-text-muted);">
                                                Automatically generate a pricing quote based on customer prefs.</div>
                                        </div>
                                        <div class="template-card" onclick="startChat('Service FAQ')">
                                            <div style="font-weight: 600; margin-bottom: 4px;">Service FAQ Assistant
                                            </div>
                                            <div style="font-size: var(--font-sm); color: var(--color-text-muted);">
                                                Answer technical service questions using the knowledge base.</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="main-view-container" id="settingsView">
                                    <div class="view-header">
                                        <h1 class="view-title">Settings</h1>
                                        <p class="view-subtitle">Manage your account preferences and system
                                            configuration.</p>
                                    </div>

                                    <div class="settings-list">
                                        <div class="settings-group">
                                            <div class="settings-group-title">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                                    stroke="currentColor" stroke-width="2">
                                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                    <circle cx="12" cy="7" r="4"></circle>
                                                </svg>
                                                Account
                                            </div>
                                            <div class="setting-row">
                                                <div class="setting-info">
                                                    <div class="setting-label">Profile Visibility</div>
                                                    <div class="setting-desc">Control who can see your activity.</div>
                                                </div>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            <div class="setting-row">
                                                <div class="setting-info">
                                                    <div class="setting-label">Email Notifications</div>
                                                    <div class="setting-desc">Receive updates about your leads.</div>
                                                </div>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="settings-group">
                                            <div class="settings-group-title">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                                    stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="5"></circle>
                                                    <line x1="12" y1="1" x2="12" y2="3"></line>
                                                    <line x1="12" y1="21" x2="12" y2="23"></line>
                                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                                    <line x1="1" y1="12" x2="3" y2="12"></line>
                                                    <line x1="21" y1="12" x2="23" y2="12"></line>
                                                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                                </svg>
                                                Appearance
                                            </div>
                                            <div class="setting-row">
                                                <div class="setting-info">
                                                    <div class="setting-label">Dark Mode</div>
                                                    <div class="setting-desc">Use the darker color palette.</div>
                                                </div>
                                                <label class="toggle-switch">
                                                    <input type="checkbox">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            <div class="setting-row">
                                                <div class="setting-info">
                                                    <div class="setting-label">Compact Mode</div>
                                                    <div class="setting-desc">Reduce padding in the chat history.</div>
                                                </div>
                                                <label class="toggle-switch">
                                                    <input type="checkbox">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="settings-group">
                                            <div class="settings-group-title">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                                    stroke="currentColor" stroke-width="2">
                                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                                </svg>
                                                Security
                                            </div>
                                            <div class="setting-row">
                                                <div class="setting-info">
                                                    <div class="setting-label">Two-Factor Auth</div>
                                                    <div class="setting-desc">Add an extra layer of security.</div>
                                                </div>
                                                <button class="action-btn"
                                                    style="width: auto; padding: 0 var(--space-md); font-size: var(--font-sm); font-weight: 500; height: 32px; background: var(--color-bg-surface); border: 1px solid var(--color-border);">Enable</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="footer-container">
                                <div class="suggestions-list content-aligner" id="suggestionsList">
                                    <div class="suggestion-item" onclick="startChat('Summarize recent hot leads')">
                                        Summarize recent hot leads</div>
                                    <div class="suggestion-item" onclick="startChat('Draft quote for Model X')">
                                        Draft
                                        quote for Model X</div>
                                    <div class="suggestion-item" onclick="startChat('List high-priority test drives')">
                                        List high-priority test drives for today</div>
                                </div>




                                <div class="input-wrapper content-aligner">
                                    <div class="input-border-wrapper">
                                        <div class="enhanced-input-box" id="enhancedInputBox">

                                            <div id="promptSheet" class="prompt-sheet-inline">
                                                <div class="popup-header">
                                                    <span>Prompt Templates</span>
                                                    <button style="border:none; background:transparent; cursor:pointer;"
                                                        onclick="closePromptSheet()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="#969AA3" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>

                                                <div class="prompt-filters">
                                                    <button class="filter-pill active"
                                                        onclick="filterPrompts(this, 'CRM')">CRM</button>
                                                    <button class="filter-pill"
                                                        onclick="filterPrompts(this, 'Sales')">Sales</button>
                                                    <button class="filter-pill"
                                                        onclick="filterPrompts(this, 'Service')">Service</button>
                                                    <button class="filter-pill"
                                                        onclick="filterPrompts(this, 'Parts')">Parts</button>
                                                    <button class="filter-pill"
                                                        onclick="filterPrompts(this, 'Accounting')">Accounting</button>
                                                </div>

                                                <div class="popup-list" id="promptList"></div>

                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper" id="promptSearchWrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                        </svg>
                                                        <input type="text" placeholder="Search prompts..."
                                                            id="promptSearchInput">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="contextMenu" class="popup-menu">
                                                <div class="popup-header">
                                                    <div class="popup-header-left">
                                                        <button id="btnContextBack" style="display:none;"
                                                            onclick="goBackContext()">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                                stroke="currentColor" stroke-width="2">
                                                                <line x1="19" y1="12" x2="5" y2="12"></line>
                                                                <polyline points="12 19 5 12 12 5"></polyline>
                                                            </svg>
                                                        </button>
                                                        <span id="contextTitle">Add Context</span>
                                                    </div>
                                                    <button onclick="closeAllMenus()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="#969AA3" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>

                                                <div class="popup-list" id="contextList"></div>

                                                <div class="popup-search-container" id="contextSearchContainer"
                                                    style="display:none;">
                                                    <div class="popup-search-input-wrapper" id="contextSearchWrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                        </svg>
                                                        <input type="text" id="contextSearchInput"
                                                            placeholder="Search... or Paste a link">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="customerMenu" class="popup-menu">
                                                <div class="popup-header">
                                                    <span>Customers</span>
                                                    <button onclick="closeAllMenus()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="#969AA3" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="popup-list" id="customerList"></div>
                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper" id="customerSearchWrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                        </svg>
                                                        <input type="text" id="customerSearchInput"
                                                            placeholder="Search Customers...">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="vehicleMenu" class="popup-menu">
                                                <div class="popup-header">
                                                    <span>Vehicles</span>
                                                    <button onclick="closeAllMenus()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="#969AA3" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="popup-list" id="vehicleList"></div>
                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper" id="vehicleSearchWrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                        </svg>
                                                        <input type="text" id="vehicleSearchInput"
                                                            placeholder="Search Vehicles">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="vinMenu" class="popup-menu">
                                                <div class="popup-header">
                                                    <span>VIN</span>
                                                    <button onclick="closeAllMenus()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="#969AA3" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="popup-list" id="vinList"></div>
                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper" id="vinSearchWrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                        </svg>
                                                        <input type="text" id="vinSearchInput"
                                                            placeholder="Search VIN...">
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="datetimeMenu" class="popup-menu">
                                                <div class="popup-header">
                                                    <span>Available Slots</span>
                                                    <button onclick="closeAllMenus()">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="#969AA3" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="popup-list" id="datetimeList"></div>
                                                <div class="popup-search-container">
                                                    <div class="popup-search-input-wrapper" id="datetimeSearchWrapper">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                            stroke="currentColor" stroke-width="2">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                        </svg>
                                                        <input type="text" id="datetimeSearchInput"
                                                            placeholder="Search Date & Time...">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- LISTENING OVERLAY -->
                                            <div class="listening-overlay" id="listeningOverlay">
                                                <button class="listen-close-btn" id="btnListenClose">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                        stroke-linejoin="round">
                                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                                    </svg>
                                                </button>
                                                <div class="listen-visualizer">
                                                    <!-- Dynamic bars will be handled via CSS/JS or static repetitive HTML -->
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                    <div class="v-bar"></div>
                                                </div>
                                                <div class="listen-right-group">
                                                    <div class="listen-timer" id="listenTimer">00:00</div>
                                                    <button class="listen-stop-btn" id="btnListenStop">
                                                        <svg width="12" height="12" viewBox="0 0 24 24"
                                                            fill="currentColor">
                                                            <rect x="2" y="2" width="20" height="20" rx="4"></rect>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>



                                            <!-- Input Container (Middle Line) -->
                                            <div class="input-container">

                                                <!-- Row 1: Attachments Area -->
                                                <div class="input-context-row" id="contextRow" style="display: none;">
                                                    <div id="attachmentArea" class="attachment-area"></div>
                                                </div>

                                                <!-- Row 2: Input & Placeholder -->
                                                <div style="position: relative; width: 100%;">
                                                    <div id="mainInput" class="main-input" contenteditable="true">
                                                    </div>
                                                    <div class="placeholder-wrapper" id="placeholderWrapper">
                                                        <div class="placeholder-item visible" id="phItem1">Ask 
                                                            Find 
                                                            Summarize</div>
                                                        <div class="placeholder-item hidden-down" id="phItem2">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Toolbar (Bottom Line) -->
                                            <div class="input-toolbar">
                                                <div class="toolbar-left">
                                                    <button class="tool-icon-btn" id="btnSlashMenu"
                                                        title="Open Templates">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                            stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2">
                                                            <rect x="3" y="3" width="18" height="18" rx="4" ry="4">
                                                            </rect>
                                                            <line x1="10" y1="16" x2="14" y2="8"></line>
                                                        </svg>
                                                    </button>
                                                    <button class="tool-icon-btn" title="Attach" id="btnAttach">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                            stroke-linecap="round" stroke-linejoin="round">
                                                            <path
                                                                d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                                                            </path>
                                                        </svg>
                                                    </button>
                                                    <input type="file" id="fileInput" style="display: none;" />
                                                </div>
                                                <div class="toolbar-right">
                                                    <!-- Context Pill Removed from here -->
                                                    <button class="tool-icon-btn" id="btnMic"><svg viewBox="0 0 24 24"
                                                            fill="none" stroke="currentColor" stroke-linecap="round"
                                                            stroke-linejoin="round">
                                                            <path
                                                                d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z">
                                                            </path>
                                                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                                            <line x1="12" y1="19" x2="12" y2="23"></line>
                                                            <line x1="8" y1="23" x2="16" y2="23"></line>
                                                        </svg></button>
                                                    <button class="send-btn-square" id="btnSend" disabled><svg
                                                            viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                            stroke-linecap="round" stroke-linejoin="round">
                                                            <line x1="12" y1="19" x2="12" y2="5"></line>
                                                            <polyline points="5 12 12 5 19 12"></polyline>
                                                        </svg></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="disclaimer-text content-aligner">AI Assistant can make mistakes, so
                                        please verify responses.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>

                <main class="main-content pushed-by-dock" id="mainContent">
                    <div class="table-skeleton-container">
                        <div class="skeleton-row header">
                            <div class="skeleton-cell">
                                <div class="skeleton-bar"></div>
                            </div>
                            <div class="skeleton-cell">
                                <div class="skeleton-bar"></div>
                            </div>
                            <div class="skeleton-cell">
                                <div class="skeleton-bar"></div>
                            </div>
                            <div class="skeleton-cell">
                                <div class="skeleton-bar"></div>
                            </div>
                            <div class="skeleton-cell">
                                <div class="skeleton-bar"></div>
                            </div>
                            <div class="skeleton-cell">
                                <div class="skeleton-bar"></div>
                            </div>
                        </div>
                        <script>
                            for (let i = 0; i < 20; i++) {
                                let cellsHtml = '';
                                for (let j = 0; j < 6; j++) {
                                    const width = 50 + Math.random() * 50;
                                    cellsHtml += `<div class="skeleton-cell"><div class="skeleton-bar" style="width: ${width}%"></div></div>`;
                                }
                                document.write(`<div class="skeleton-row">${cellsHtml}</div>`);
                            }
                        </script>
                    </div>
                </main>

            </div>
        </div>
    </div>

    <script>
        const panel = document.getElementById('chatPanel');
        const mainContent = document.getElementById('mainContent');
        const btnMinimize = document.getElementById('btnMinimize');
        const btnRestoreMin = document.getElementById('btnRestoreMin');
        const btnCloseMin = document.getElementById('btnCloseMin');
        const btnFull = document.getElementById('btnFull');
        const btnDock = document.getElementById('btnDock');
        const btnClose = document.getElementById('btnClose');
        const navAiToggle = document.getElementById('navAiToggle');

        // Mobile FAB
        const mobileFab = document.getElementById('mobileFab');

        // Context Elements
        const contextRow = document.getElementById('contextRow');

        // Context Menu Popups
        const contextMenu = document.getElementById('contextMenu');
        const contextList = document.getElementById('contextList');
        const btnContextBack = document.getElementById('btnContextBack');
        const contextTitle = document.getElementById('contextTitle');
        const contextSearchContainer = document.getElementById('contextSearchContainer');
        const contextSearchInput = document.getElementById('contextSearchInput');


        const historySheet = document.getElementById('historySheet');
        const btnShowHistory = document.getElementById('btnShowHistory');
        const historyPlaceholder = document.getElementById('historyPlaceholder');

        const emptyState = document.getElementById('emptyState');
        const activeChat = document.getElementById('activeChat');
        const chatScrollArea = document.querySelector('.chat-scroll-area');
        const chatHeaderTitle = document.getElementById('chatHeaderTitle');

        // Lists
        const recentList = document.getElementById('recentList');
        const suggestionsList = document.getElementById('suggestionsList');

        const btnSlashMenu = document.getElementById('btnSlashMenu');
        const promptSheet = document.getElementById('promptSheet');
        const promptList = document.getElementById('promptList');
        const dragHandle = document.getElementById('dragHandle');

        // Input
        const mainInput = document.getElementById('mainInput');
        const btnSend = document.getElementById('btnSend');
        const btnMic = document.getElementById('btnMic');
        const btnAttach = document.getElementById('btnAttach');
        const fileInput = document.getElementById('fileInput');
        const attachmentArea = document.getElementById('attachmentArea');
        const listeningOverlay = document.getElementById('listeningOverlay');
        const btnListenClose = document.getElementById('btnListenClose');
        const btnListenStop = document.getElementById('btnListenStop');
        const listenTimer = document.getElementById('listenTimer');
        const enhancedInputBox = document.getElementById('enhancedInputBox');

        // Menu Elements
        const globalContextMenu = document.getElementById('globalContextMenu');
        const pinText = document.getElementById('pinText');

        const btnChatMenu = document.getElementById('btnChatMenu');
        const chatDropdown = document.getElementById('chatDropdown');
        const chatMenuContainer = document.getElementById('chatMenuContainer');
        const headerPinText = document.getElementById('headerPinText');

        // Header New Chat Btn
        const btnHeaderNewChat = document.getElementById('btnHeaderNewChat');

        // Top Bar for Aurora Effect
        const chatTopBar = document.getElementById('chatTopBar');

        // Modals
        const renameModal = document.getElementById('renameModal');
        const renameInput = document.getElementById('renameInput');
        const deleteModal = document.getElementById('deleteModal');

        // Menu Elements
        const customerMenu = document.getElementById('customerMenu');
        const customerList = document.getElementById('customerList');
        const customerSearchInput = document.getElementById('customerSearchInput');

        const vehicleMenu = document.getElementById('vehicleMenu');
        const vehicleList = document.getElementById('vehicleList');
        const vehicleSearchInput = document.getElementById('vehicleSearchInput');

        const vinMenu = document.getElementById('vinMenu');
        const vinList = document.getElementById('vinList');
        const vinSearchInput = document.getElementById('vinSearchInput');

        const datetimeMenu = document.getElementById('datetimeMenu');
        const datetimeList = document.getElementById('datetimeList');
        const datetimeSearchInput = document.getElementById('datetimeSearchInput');

        const promptSearchInput = document.getElementById('promptSearchInput');

        let historyAdded = false;
        let currentItem = null;

        let isDragging = false;
        let startX, startLeft;

        let activePromptVar = null; // Track the span triggering the menu
        let currentActiveMenu = null;

        // Typing Controller
        let typingController = null;
        const btnSendIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>';
        const btnStopIcon = '<svg viewBox="0 0 24 24" fill="url(#aiLogoGradient)" stroke="none"><rect x="6" y="6" width="12" height="12" rx="2" ry="2"></rect></svg>';
        const HEADER_NEW_CHAT_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z" /><path d="M8 12h8" /><path d="M12 8v8" /></svg>';
        const HEADER_ADD_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
        const AI_LOGO_SVG = '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.94922 14.2996C8.41854 14.2998 8.79948 14.6805 8.79948 15.1498C8.79934 15.619 8.41845 15.9999 7.94922 16C7.47986 16 7.0991 15.6191 7.09896 15.1498C7.09896 14.6804 7.47978 14.2996 7.94922 14.2996Z" fill="url(#aiLogoGradient)"/><path d="M12.1497 13.3973C12.5086 13.3973 12.7993 13.6882 12.7995 14.047C12.7995 14.406 12.5087 14.6967 12.1497 14.6967C11.7909 14.6966 11.5 14.4059 11.5 14.047C11.5001 13.6883 11.791 13.3975 12.1497 13.3973Z" fill="url(#aiLogoGradient)"/><path d="M3.45052 12.7997C3.86473 12.7997 4.20052 13.1355 4.20052 13.5497C4.20052 13.9639 3.86473 14.2996 3.45052 14.2996C3.03631 14.2996 2.70052 13.9639 2.70052 13.5497C2.70052 13.1355 3.03631 12.7997 3.45052 12.7997Z" fill="url(#aiLogoGradient)"/><path d="M6.25 10.3976C6.94036 10.3976 7.5 10.9572 7.5 11.6475C7.5 12.3378 6.94036 12.8974 6.25 12.8974C5.55964 12.8974 5 12.3378 5 11.6475C5 10.9572 5.55964 10.3976 6.25 10.3976Z" fill="url(#aiLogoGradient)"/><path d="M10.3503 10.3976C10.9853 10.3976 11.4999 10.9123 11.5 11.5472C11.5 12.1823 10.9854 12.6969 10.3503 12.6969C9.71525 12.6967 9.20052 12.1822 9.20052 11.5472C9.20066 10.9124 9.71534 10.3977 10.3503 10.3976Z" fill="url(#aiLogoGradient)"/><path d="M13.6497 10.1984C14.1191 10.1985 14.5 10.5793 14.5 11.0486C14.4999 11.5178 14.119 11.8986 13.6497 11.8988C13.1804 11.8988 12.7996 11.5179 12.7995 11.0486C12.7995 10.5792 13.1803 10.1984 13.6497 10.1984Z" fill="url(#aiLogoGradient)"/><path d="M3.41667 6.86923C3.73903 6.32538 4.45228 6.13871 5.01042 6.4526C5.56871 6.7668 5.75983 7.46295 5.4375 8.00716C5.36588 8.12803 5.27483 8.23174 5.17057 8.31573C4.68818 8.70417 3.97429 8.90987 3.66146 9.43803L3.625 9.49923C3.39616 9.88587 3.47637 10.4224 3.2474 10.809C3.0482 11.1453 2.60674 11.2609 2.26172 11.0668C1.91679 10.8727 1.79845 10.4422 1.9974 10.1059C2.23484 9.70506 2.78461 9.50557 3.02214 9.10473L3.04948 9.05656C3.35255 8.54486 3.18708 7.86584 3.27083 7.28066C3.291 7.13974 3.3392 7.00003 3.41667 6.86923Z" fill="url(#aiLogoGradient)"/><path d="M8.2487 6.60103C9.15988 6.60103 9.8983 7.33955 9.89844 8.25063C9.89844 9.16183 9.15997 9.90024 8.2487 9.90024C7.33755 9.9001 6.59896 9.16174 6.59896 8.25063C6.5991 7.33964 7.33763 6.60117 8.2487 6.60103Z" fill="url(#aiLogoGradient)"/><path d="M9.68229 3.55049C10.2406 3.23631 10.955 3.42298 11.2773 3.96713C11.3936 4.16346 11.4428 4.38 11.4323 4.59077C11.4095 5.04569 11.3042 5.54911 11.5378 5.94353C11.7715 6.33786 12.272 6.50082 12.6875 6.70909C12.8796 6.8055 13.0466 6.95463 13.1628 7.15046C13.4851 7.69466 13.294 8.39082 12.7357 8.70502C12.1774 9.01922 11.4643 8.8326 11.1419 8.28839C11.0257 8.09219 10.9752 7.87667 10.9857 7.66604C11.0084 7.21104 11.1152 6.7065 10.8815 6.31199C10.6478 5.91782 10.1472 5.75593 9.73177 5.54773C9.53925 5.45123 9.3715 5.30139 9.25521 5.10505C8.93305 4.56095 9.12424 3.86473 9.68229 3.55049Z" fill="url(#aiLogoGradient)"/><path d="M0.75 7.30019C1.16421 7.30019 1.5 7.63595 1.5 8.05013C1.5 8.46431 1.16421 8.80007 0.75 8.80007C0.335786 8.80007 0 8.46431 0 8.05013C0 7.63595 0.335786 7.30019 0.75 7.30019Z" fill="url(#aiLogoGradient)"/><path d="M15.25 7.30019C15.6642 7.30019 16 7.63595 16 8.05013C16 8.46431 15.6642 8.80007 15.25 8.80007C14.8358 8.80007 14.5 8.46431 14.5 8.05013C14.5 7.63595 14.8358 7.30019 15.25 7.30019Z" fill="url(#aiLogoGradient)"/><path d="M2.04948 3.49972C2.6292 3.49972 3.09998 3.9695 3.10026 4.54911C3.10026 5.12896 2.62938 5.5998 2.04948 5.5998C1.46982 5.59952 1 5.12879 1 4.54911C1.00028 3.96967 1.46999 3.5 2.04948 3.49972Z" fill="url(#aiLogoGradient)"/><path d="M6.54948 2.8982C7.23984 2.8982 7.79948 3.4578 7.79948 4.1481C7.79948 4.8384 7.23984 5.398 6.54948 5.398C5.85912 5.398 5.29948 4.8384 5.29948 4.1481C5.29948 3.4578 5.85912 2.8982 6.54948 2.8982Z" fill="url(#aiLogoGradient)"/><path d="M13.2005 2.4998C13.7528 2.4998 14.2005 2.94748 14.2005 3.49972C14.2005 4.05196 13.7528 4.49963 13.2005 4.49963C12.6482 4.49963 12.2005 4.05196 12.2005 3.49972C12.2005 2.94748 12.6482 2.4998 13.2005 2.4998Z" fill="url(#aiLogoGradient)"/><path d="M4.55078 0.800716C4.90968 0.800716 5.20038 1.09157 5.20052 1.4504C5.20052 1.80936 4.90977 2.10009 4.55078 2.10009C4.19192 2.09995 3.90104 1.80927 3.90104 1.4504C3.90118 1.09165 4.192 0.800857 4.55078 0.800716Z" fill="url(#aiLogoGradient)"/><path d="M8.75 0C9.16421 0 9.5 0.335759 9.5 0.749939C9.5 1.16412 9.16421 1.49988 8.75 1.49988C8.33579 1.49988 8 1.16412 8 0.749939C8 0.335759 8.33579 0 8.75 0Z" fill="url(#aiLogoGradient)"/></svg>';

        // Data Placeholders
        const customers = ["James T. Kirk", "Sarah Connor", "Marty McFly", "Ellen Ripley", "Tony Stark"];
        const vehicles = ["2024 Toyota Camry SE", "2023 Ford F-150 XLT", "2024 Honda CR-V EX-L", "2023 Tesla Model Y Long Range", "2024 Chevrolet Silverado 1500 RST"];

        // Full VIN strings
        const vins = [
            { vin: "1G1RC6E45LU125678", desc: "2020 Chevy Malibu LT" },
            { vin: "5XYKTCA23MG112345", desc: "2021 Kia Telluride SX" },
            { vin: "JTEZU5JR8K3098765", desc: "2019 Toyota RAV4 LE" },
            { vin: "1FM5K8GC4LGB43210", desc: "2022 Ford Explorer ST" },
            { vin: "1N4AL3AP0NC155555", desc: "2023 Nissan Altima SR" }
        ];
        const datetimes = [
            "Oct 24, 2025 at 10:00 AM",
            "Oct 24, 2025 at 2:00 PM",
            "Oct 25, 2025 at 9:30 AM",
            "Oct 25, 2025 at 11:00 AM",
            "Oct 26, 2025 at 4:00 PM"
        ];

        // Prompts Data
        const promptsData = [
            { name: "/book-test-drive", desc: "Book a test drive appointment for [Vehicle] on [Date & Time].", text: "Book a test drive appointment for [Vehicle] on [Date & Time]" },
            { name: "/credit-pre-qual", desc: "Run a soft credit qualification check for [Customer] to determine eligibility.", text: "Run a soft credit qualification check for [Customer] to determine eligibility" },
            { name: "/inventory-check", desc: "Check stock availability for [Vehicle] across all lots available in the region.", text: "Check stock availability for [Vehicle] across all lots" },
            { name: "/trade-in-value", desc: "Estimate trade-in value for [VIN] assuming good condition.", text: "Estimate trade-in value for [VIN] assuming good condition" }
        ];


        // --- GLOBAL SEND DISABLE STATE ---
        let isListening = false;

        // --- CLEAR INPUT HELPER ---
        function setupClearableInput(wrapperId) {
            const wrapper = document.getElementById(wrapperId);
            const input = wrapper.querySelector('input');

            // Create button
            const btn = document.createElement('button');
            btn.className = 'search-clear-btn';
            btn.innerHTML = '&times;'; // X char
            wrapper.appendChild(btn);

            // Logic
            const toggleBtn = () => {
                if (input.value.length > 0) btn.classList.add('visible');
                else btn.classList.remove('visible');
            };

            input.addEventListener('input', toggleBtn);

            btn.onclick = (e) => {
                e.stopPropagation();
                input.value = '';
                toggleBtn();
                input.focus();
                // Trigger input event to refresh list
                input.dispatchEvent(new Event('input'));
            };
        }

        // Initialize Clear Buttons
        setupClearableInput('promptSearchWrapper');
        setupClearableInput('customerSearchWrapper');
        setupClearableInput('vehicleSearchWrapper');
        setupClearableInput('vinSearchWrapper');
        setupClearableInput('datetimeSearchWrapper');


        // --- FILTER LOGIC ---
        window.filterPrompts = function (btn, filterName) {
            const pills = document.querySelectorAll('.filter-pill');
            pills.forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- RENDER PROMPTS ---
        // Helper function to create empty state
        function createEmptyState(title, description) {
            return `
                <div class="search-empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <div class="search-empty-state-title">${title}</div>
                    <div class="search-empty-state-desc">${description}</div>
                </div>
            `;
        }

        function renderPromptList(filter = "") {
            promptList.innerHTML = '';
            const filtered = promptsData.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()) || p.desc.toLowerCase().includes(filter.toLowerCase()));

            if (filtered.length === 0) {
                promptList.innerHTML = createEmptyState(
                    'No templates found',
                    filter ? `No templates match "${filter}"` : 'No prompt templates available'
                );
                return;
            }

            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = 'prompt-item';
                div.onclick = () => fillInput(p.text);
                div.innerHTML = `
                    <div class="prompt-item-name">${p.name}</div>
                    <div class="prompt-item-desc">${p.desc}</div>
                `;
                promptList.appendChild(div);
            });
        }
        // Initial Render
        renderPromptList();


        // --- MENU LOGIC ---
        function renderCustomerList(filter = "") {
            customerList.innerHTML = '';
            const filtered = customers.filter(c => c.toLowerCase().includes(filter.toLowerCase()));

            if (filtered.length === 0) {
                customerList.innerHTML = createEmptyState(
                    'No customers found',
                    filter ? `No customers match "${filter}"` : 'No customers available'
                );
                return;
            }

            filtered.forEach(c => {
                const div = document.createElement('div');
                div.className = 'popup-item';
                div.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg> ${c}`;
                div.onclick = () => selectItem(c);
                customerList.appendChild(div);
            });
        }

        function renderVehicleList(filter = "") {
            vehicleList.innerHTML = '';
            const filtered = vehicles.filter(v => v.toLowerCase().includes(filter.toLowerCase()));

            if (filtered.length === 0) {
                vehicleList.innerHTML = createEmptyState(
                    'No vehicles found',
                    filter ? `No vehicles match "${filter}"` : 'No vehicles available'
                );
                return;
            }

            filtered.forEach(v => {
                const div = document.createElement('div');
                div.className = 'popup-item';
                div.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg> ${v}`;
                div.onclick = () => selectItem(v);
                vehicleList.appendChild(div);
            });
        }

        function renderVinList(filter = "") {
            vinList.innerHTML = '';
            const filtered = vins.filter(item => item.vin.toLowerCase().includes(filter.toLowerCase()) || item.desc.toLowerCase().includes(filter.toLowerCase()));

            if (filtered.length === 0) {
                vinList.innerHTML = createEmptyState(
                    'No VINs found',
                    filter ? `No VINs match "${filter}"` : 'No VINs available'
                );
                return;
            }

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'vin-item';
                div.innerHTML = `
                    <div class="vin-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 19H5v-5h14v5z"/></svg></div>
                    <div class="vin-details">
                        <div class="vin-text">${item.vin}</div>
                        <div class="vin-desc">${item.desc}</div>
                    </div>
                `;
                div.onclick = () => selectItem(item.vin);
                vinList.appendChild(div);
            });
        }

        function renderDateTimeList(filter = "") {
            datetimeList.innerHTML = '';
            const filtered = datetimes.filter(d => d.toLowerCase().includes(filter.toLowerCase()));

            if (filtered.length === 0) {
                datetimeList.innerHTML = createEmptyState(
                    'No dates found',
                    filter ? `No dates match "${filter}"` : 'No dates available'
                );
                return;
            }

            filtered.forEach(d => {
                const div = document.createElement('div');
                div.className = 'popup-item';
                div.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> ${d}`;
                div.onclick = () => selectItem(d);
                datetimeList.appendChild(div);
            });
        }

        function showMenu(menu, input, renderFn, targetElement) {
            closeAllMenus();

            if (input) {
                input.value = '';
                // Ensure clear button is hidden on reset
                const clearBtn = input.parentNode.querySelector('.search-clear-btn');
                if (clearBtn) clearBtn.classList.remove('visible');
            }
            if (renderFn) renderFn();

            // Just reveal it (positioned via CSS)
            menu.classList.add('visible');
            enhancedInputBox.classList.add('menu-open');

            if (input) setTimeout(() => input.focus(), 50);

            currentActiveMenu = menu;
        }

        function selectItem(text) {
            if (activePromptVar) {
                activePromptVar.innerText = text;
                activePromptVar.classList.remove('prompt-var');
                activePromptVar.classList.add('filled-var');
                closeAllMenus();
                activePromptVar = null;
                updateSendButton();

                // Auto-trigger next menu if available (Chaining)
                setTimeout(() => {
                    const nextVar = mainInput.querySelector('.prompt-var');
                    if (nextVar) {
                        const originalValue = nextVar.getAttribute('data-var') || nextVar.innerText;
                        const txt = originalValue.toLowerCase();
                        activePromptVar = nextVar;

                        setTimeout(() => {
                            if (txt === '[customer]') showMenu(customerMenu, customerSearchInput, () => renderCustomerList(), nextVar);
                            else if (txt === '[vehicle]') showMenu(vehicleMenu, vehicleSearchInput, () => renderVehicleList(), nextVar);
                            else if (txt === '[vin]') showMenu(vinMenu, vinSearchInput, () => renderVinList(), nextVar);
                            else if (txt === '[date & time]') showMenu(datetimeMenu, datetimeSearchInput, () => renderDateTimeList(), nextVar);
                        }, 600); // 600ms
                    }
                }, 150); // 150ms
            }
        }

        function closeAllMenus() {
            customerMenu.classList.remove('visible');
            vehicleMenu.classList.remove('visible');
            vinMenu.classList.remove('visible');
            datetimeMenu.classList.remove('visible');
            promptSheet.classList.remove('visible');
            if (contextMenu) contextMenu.classList.remove('visible');
            enhancedInputBox.classList.remove('menu-open');
            currentActiveMenu = null;
        }

        // Search Listeners
        customerSearchInput.addEventListener('input', (e) => renderCustomerList(e.target.value));
        vehicleSearchInput.addEventListener('input', (e) => renderVehicleList(e.target.value));
        vinSearchInput.addEventListener('input', (e) => renderVinList(e.target.value));
        datetimeSearchInput.addEventListener('input', (e) => renderDateTimeList(e.target.value));
        promptSearchInput.addEventListener('input', (e) => renderPromptList(e.target.value));
        if (contextSearchInput) contextSearchInput.addEventListener('input', (e) => renderContextList(e.target.value));

        function filterHistoryList(query) {
            const q = query.toLowerCase().trim();
            const items = document.querySelectorAll('.history-item');
            const navGroup = document.querySelector('.history-nav-group');
            let visibleCount = 0;

            items.forEach(item => {
                const text = item.querySelector('.history-text').innerText.toLowerCase();
                if (text.includes(q)) {
                    item.style.display = 'flex';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Handle section headers and placeholder
            const sectionHeaders = document.querySelectorAll('.history-section-header');
            const historyPlaceholder = document.getElementById('historyPlaceholder');

            if (q.length > 0) {
                if (navGroup) navGroup.style.display = 'none';
                sectionHeaders.forEach(t => t.style.display = 'none');

                if (visibleCount === 0) {
                    if (historyPlaceholder) {
                        historyPlaceholder.style.display = 'block';
                        historyPlaceholder.innerHTML = `
                            <div class="tab-empty-state" style="padding: 40px var(--space-lg); text-align: center;">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 12px; color: var(--color-text-muted); opacity: 0.5;">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                                <div style="font-weight: 600; color: var(--color-text-main);">No results found</div>
                                <div style="font-size: var(--font-sm); color: var(--color-text-muted); margin-top: 4px;">No chats match "${query}"</div>
                            </div>
                        `;
                    }
                } else {
                    if (historyPlaceholder) historyPlaceholder.style.display = 'none';
                }
            } else {
                if (navGroup) navGroup.style.display = 'block';
                sectionHeaders.forEach(t => t.style.display = 'block');
                if (historyPlaceholder) historyPlaceholder.style.display = 'none';
            }
        }

        // --- HELPER: Find History Item by Title ---
        function getActiveHistoryItem() {
            const title = chatTitle.innerText;
            const items = document.querySelectorAll('.history-text');
            for (let span of items) {
                if (span.innerText === title) {
                    return span.closest('.history-item');
                }
            }
            return null;
        }

        // --- HELPER: Check Empty List ---
        function checkEmptyHistory() {
            if (!historyPlaceholder) return;
            if (recentList.children.length === 0) {
                historyPlaceholder.classList.add('visible');
            } else {
                historyPlaceholder.classList.remove('visible');
            }
        }

        // --- MENU LOGIC ---
        window.showItemMenu = function (e) {
            e.stopPropagation();
            currentItem = e.currentTarget.closest('.history-item');

            const isPinned = currentItem.classList.contains('is-pinned');
            pinText.innerText = isPinned ? 'Unpin Chat' : 'Pin Chat';

            const rect = e.currentTarget.getBoundingClientRect();
            globalContextMenu.style.top = (rect.bottom + 5) + 'px';
            globalContextMenu.style.left = (rect.left - 120) + 'px';
            globalContextMenu.classList.add('visible');

            chatDropdown.classList.remove('visible');
        };

        window.openRenameModalFromHeader = function () {
            currentItem = getActiveHistoryItem();
            openRenameModal();
        }

        window.openDeleteModalFromHeader = function () {
            currentItem = getActiveHistoryItem();
            openDeleteModal();
        }

        window.togglePinFromHeader = function () {
            currentItem = getActiveHistoryItem();
            if (currentItem) togglePin();
            chatDropdown.classList.remove('visible');
        };

        // --- HELPER: Sort History List (Pinned First) ---
        function sortHistoryList() {
            const items = Array.from(recentList.querySelectorAll('.history-item'));
            const pinned = items.filter(item => item.classList.contains('is-pinned'));
            const unpinned = items.filter(item => !item.classList.contains('is-pinned'));

            // Clear the list
            recentList.innerHTML = '';

            // Add pinned items first, then unpinned
            pinned.forEach(item => recentList.appendChild(item));
            unpinned.forEach(item => recentList.appendChild(item));
        }

        window.togglePin = function () {
            if (!currentItem) return;
            const isPinned = currentItem.classList.contains('is-pinned');

            if (isPinned) {
                currentItem.classList.remove('is-pinned');
                const pinIcon = currentItem.querySelector('.history-item-pin-btn');
                if (pinIcon) pinIcon.remove();

                // Re-sort to move unpinned item below pinned items
                sortHistoryList();
            } else {
                currentItem.classList.add('is-pinned');
                // Ensure actions wrapper exists
                let actions = currentItem.querySelector('.history-item-actions');
                if (!actions) {
                    // Wrap existing menu btn if needed
                    const menuBtn = currentItem.querySelector('.history-item-menu-btn');
                    actions = document.createElement('div');
                    actions.className = 'history-item-actions';
                    menuBtn.parentNode.insertBefore(actions, menuBtn);
                    actions.appendChild(menuBtn);
                }

                // Add pin icon
                const pinBtn = document.createElement('div');
                // Sort to move pinned item to top
                sortHistoryList();
            }
            globalContextMenu.classList.remove('visible');
            checkEmptyHistory();
        };

        // --- CONTEXT LOGIC (MULTI-SELECT) ---


        // --- ATTACHMENT LOGIC ---
        btnAttach.onclick = () => {
            fileInput.click();
        };

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                // Show area
                if (contextRow) contextRow.style.display = 'flex';
                if (attachmentArea) attachmentArea.style.display = 'flex';

                // Create Pill
                const pill = document.createElement('span');
                pill.className = 'attachment-pill';
                // pill.contentEditable is not needed since it's outside mainInput
                pill.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <span>${file.name}</span>
                    <span class="attachment-remove" onclick="this.parentElement.remove(); if(attachmentArea && attachmentArea.children.length === 0) { attachmentArea.style.display='none'; if(contextRow) contextRow.style.display='none'; } updateSendButton(); event.stopPropagation();">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" style="width:14px; height:14px;">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </span>
                `;

                // Append to Attachment Area
                if (attachmentArea) attachmentArea.appendChild(pill);

                // Focus Input and Update Button
                mainInput.focus();
                updateSendButton();
            }
            // Reset input
            fileInput.value = '';
        };

        // --- MIC LOGIC ---
        let listeningInterval;
        let listeningTime = 0;

        btnMic.onclick = function () {
            if (isListening) return;

            // Show Overlay
            listeningOverlay.classList.add('active');
            isListening = true;
            updateSendButton();

            // Reset & Start Timer
            listeningTime = 0;
            listenTimer.innerText = "00:00";
            listeningInterval = setInterval(() => {
                listeningTime++;
                const mins = Math.floor(listeningTime / 60).toString().padStart(2, '0');
                const secs = (listeningTime % 60).toString().padStart(2, '0');
                listenTimer.innerText = `${mins}:${secs}`;
            }, 1000);

            // Auto-finish after 4 seconds (Simulator)
            this.autoStopTimeout = setTimeout(() => {
                finishListening("List high-priority test drives for today");
            }, 4000);
        }

        // Close = Cancel
        btnListenClose.onclick = () => {
            stopListeningState();
            if (btnMic.autoStopTimeout) clearTimeout(btnMic.autoStopTimeout);
        }

        // Stop = Finish immediately
        btnListenStop.onclick = () => {
            if (btnMic.autoStopTimeout) clearTimeout(btnMic.autoStopTimeout);
            finishListening("List high-priority test drives for today");
        }

        function stopListeningState() {
            isListening = false;
            clearInterval(listeningInterval);
            listeningOverlay.classList.remove('active');
            updateSendButton();
        }

        function finishListening(text) {
            stopListeningState();
            mainInput.innerHTML = text;

            // Ensure focus and cursor placement
            mainInput.focus();
            setTimeout(() => {
                const range = document.createRange();
                const sel = window.getSelection();
                range.selectNodeContents(mainInput);
                range.collapse(false);
                sel.removeAllRanges();
                sel.addRange(range);
                updateSendButton();
            }, 10);
        }

        // --- BUTTON DISABLE LOGIC ---
        function updateSendButton() {
            // STOP MODE: Always enabled with stop icon
            if (typingController) {
                btnSend.disabled = false;
                btnSend.classList.add('active');
                btnSend.innerHTML = btnStopIcon;
                return;
            }

            // INPUT/LISTENING MODE: Send icon
            btnSend.innerHTML = btnSendIcon;

            const hasText = mainInput.innerText.trim().length > 0;
            const canSend = hasText && !isListening;

            btnSend.disabled = !canSend;
            if (canSend) {
                btnSend.classList.add('active');
            } else {
                btnSend.classList.remove('active');
            }
        }



        // --- MODAL LOGIC ---
        window.openRenameModal = function () {
            let initialName = "";
            if (currentItem) {
                initialName = currentItem.querySelector('.history-text').innerText;
            } else {
                initialName = chatTitle.innerText;
            }
            renameInput.value = initialName;
            renameModal.classList.add('visible');
            globalContextMenu.classList.remove('visible');
            chatDropdown.classList.remove('visible');
            renameInput.focus();
        };

        window.saveRename = function () {
            if (renameInput.value.trim() !== "") {
                const newName = renameInput.value;
                if (currentItem) {
                    const textSpan = currentItem.querySelector('.history-text');
                    textSpan.innerText = newName;
                    if (chatTitle.innerText === textSpan.innerText || getActiveHistoryItem() === currentItem) {
                        chatTitle.innerText = newName;
                    }
                } else {
                    chatTitle.innerText = newName;
                }
            }
            closeModals();
        };

        window.openDeleteModal = function () {
            deleteModal.classList.add('visible');
            globalContextMenu.classList.remove('visible');
            chatDropdown.classList.remove('visible');
        };

        window.confirmDelete = function () {
            if (currentItem) {
                const textSpan = currentItem.querySelector('.history-text');
                if (chatTitle.innerText === textSpan.innerText) {
                    resetChat();
                }
                currentItem.remove();
                checkEmptyHistory();
            } else {
                resetChat();
            }
            closeModals();
        };

        window.closeModals = function () {
            renameModal.classList.remove('visible');
            deleteModal.classList.remove('visible');
        };

        // --- LAZY LOADING HISTORY ---
        // --- LAZY LOADING HISTORY ON SCROLL ---
        const historyTabContent = document.querySelector('.history-tab-content');
        if (historyTabContent) {
            historyTabContent.addEventListener('scroll', () => {
                // Check if near bottom
                if (historyTabContent.scrollTop + historyTabContent.clientHeight >= historyTabContent.scrollHeight - 50) {
                    const lazyItems = document.querySelectorAll('.lazy-item');
                    if (lazyItems.length > 0) {
                        lazyItems.forEach(item => {
                            item.style.display = 'flex';
                            item.classList.remove('lazy-item');
                        });
                    }
                }
            });
        }

        // --- DRAG HANDLER ---
        dragHandle.onmousedown = function (e) {
            if (!panel.classList.contains('state-minimized')) return;
            isDragging = true;
            startX = e.clientX;
            const style = window.getComputedStyle(panel);
            startLeft = parseInt(style.left);
            panel.style.transition = 'none';
            document.body.style.cursor = 'grabbing';
            e.preventDefault();
        };

        document.onmousemove = function (e) {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            let newLeft = startLeft + dx;
            const maxLeft = window.innerWidth - panel.offsetWidth - 20;
            if (newLeft < 20) newLeft = 20;
            if (newLeft > maxLeft) newLeft = maxLeft;
            panel.style.left = newLeft + 'px';
        };

        document.onmouseup = function () {
            if (isDragging) {
                isDragging = false;
                panel.style.transition = '';
                document.body.style.cursor = '';
            }
        };

        function scrollToBottom() {
            chatScrollArea.scrollTop = chatScrollArea.scrollHeight;
        }

        window.toggleThoughts = function (el) {
            const container = el.closest('.reasoning-container');
            if (container) {
                container.classList.toggle('expanded');
            }
        };

        // --- PROMPT SHEET LOGIC (UPDATED TOGGLE) ---
        btnSlashMenu.onclick = (e) => {
            e.stopPropagation();
            if (promptSheet.classList.contains('visible')) {
                // If already visible, close it (toggle OFF)
                closePromptSheet();
            } else {
                // If not visible, open it (toggle ON)
                showMenu(promptSheet, promptSearchInput, () => renderPromptList());
            }
        }

        window.closePromptSheet = function () {
            promptSheet.classList.remove('visible');
            enhancedInputBox.classList.remove('menu-open');
        }

        // Fill Input with Variable Styling
        window.fillInput = function (text) {
            // Regex to replace [text] with styled span
            const formattedHTML = text.replace(/\[(.*?)\]/g, '<span class="prompt-var" data-var="[$1]">[$1]</span>');
            mainInput.innerHTML = formattedHTML;

            promptSheet.classList.remove('visible');
            enhancedInputBox.classList.remove('menu-open');
            mainInput.focus();

            // Move cursor to end (contenteditable quirk)
            const range = document.createRange();
            const sel = window.getSelection();
            range.selectNodeContents(mainInput);
            range.collapse(false);
            sel.removeAllRanges();
            sel.addRange(range);

            updateSendButton();

            // Menu Triggers Logic (Sequential)
            setTimeout(() => {
                const vars = mainInput.querySelectorAll('.prompt-var');
                // Only trigger the FIRST one found to start the sequence
                for (const span of vars) {
                    const txt = span.innerText.toLowerCase();
                    activePromptVar = span;

                    if (txt === '[customer]') {
                        showMenu(customerMenu, customerSearchInput, () => renderCustomerList(), span);
                        break;
                    } else if (txt === '[vehicle]') {
                        showMenu(vehicleMenu, vehicleSearchInput, () => renderVehicleList(), span);
                        break;
                    } else if (txt === '[vin]') {
                        showMenu(vinMenu, vinSearchInput, () => renderVinList(), span);
                        break;
                    } else if (txt === '[date & time]') {
                        showMenu(datetimeMenu, datetimeSearchInput, () => renderDateTimeList(), span);
                        break;
                    }
                }
            }, 750);
        };



        // --- INPUT EVENT HANDLING (DIV) ---
        mainInput.addEventListener('input', function (e) {
            if (this.innerText === '/') {
                showMenu(promptSheet, promptSearchInput, () => renderPromptList());
            }

            if (this.textContent.trim() === '') {
                this.innerHTML = '';
            }

            updateSendButton();
        });

        // Delegate clicks for variables (both prompt-var and filled-var)
        mainInput.addEventListener('click', (e) => {
            const span = e.target.closest('.prompt-var, .filled-var');
            if (span) {
                e.stopPropagation();
                const originalValue = span.getAttribute('data-var') || span.innerText;
                const txt = originalValue.toLowerCase();
                activePromptVar = span;

                if (txt === '[customer]') showMenu(customerMenu, customerSearchInput, () => renderCustomerList(), span);
                else if (txt === '[vehicle]') showMenu(vehicleMenu, vehicleSearchInput, () => renderVehicleList(), span);
                else if (txt === '[vin]') showMenu(vinMenu, vinSearchInput, () => renderVinList(), span);
                else if (txt === '[date & time]') showMenu(datetimeMenu, datetimeSearchInput, () => renderDateTimeList(), span);
            }
        });

        mainInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (this.innerText.trim() !== '') {
                    const text = this.innerText;
                    this.innerHTML = ''; // Clear
                    updateSendButton();
                    handleSend(text);
                }
            }
        });

        // --- RENDER ACTION ICONS HELPER ---
        function renderActionIcons(textWrapper, sourcesData = { count: 0 }) {
            const actionRow = document.createElement('div');
            actionRow.className = 'ai-actions-row';
            const icons = [
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>',
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path></svg>',
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>',
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>'
            ];

            // Standard Icons
            icons.forEach(svg => {
                const btn = document.createElement('button');
                btn.className = 'ai-action-btn';
                btn.innerHTML = svg;
                actionRow.appendChild(btn);
            });

            // Sources Pill
            if (sourcesData && sourcesData.count > 0) {
                const sourcePill = document.createElement('button');
                sourcePill.className = 'ai-action-btn sources-pill';
                sourcePill.style.width = 'auto'; // allow text
                sourcePill.style.fontSize = '0.75rem';
                sourcePill.style.borderRadius = '16px';
                sourcePill.style.padding = '2px 8px';
                sourcePill.style.background = 'var(--color-bg-surface)';
                sourcePill.style.border = '1px solid var(--color-border)';
                sourcePill.style.color = 'var(--color-text-main)';
                sourcePill.style.gap = '4px';
                sourcePill.style.marginLeft = '8px'; // separate from icons

                sourcePill.innerHTML = `
                   <span>${sourcesData.count} Sources</span>
               `;
                sourcePill.onclick = (e) => toggleSourcesPopover(e, sourcePill, sourcesData);
                actionRow.appendChild(sourcePill);
            }

            textWrapper.appendChild(actionRow);
            scrollToBottom();
        }

        // Monitor input changes to update send button state
        mainInput.addEventListener('input', updateSendButton);

        // Combined Send/Stop Click Handler
        btnSend.onclick = () => {
            if (typingController) {
                // STOP LOGIC
                typingController.stopped = true;

                // 1. Clear "Thinking..." Timer if active
                if (typingController.timerId) {
                    clearTimeout(typingController.timerId);

                    // Remove "Thinking..." row immediately
                    const thinkingRow = activeChat.querySelector('.ai-message-row:last-child');
                    if (thinkingRow && thinkingRow.querySelector('.thinking')) {
                        activeChat.removeChild(thinkingRow);
                        // Remove aurora effect
                        if (panel) panel.classList.remove('aurora-active');
                        const mobileHandle = document.getElementById('mobileSheetHandle');
                        if (mobileHandle) mobileHandle.classList.remove('aurora-active');
                    }

                    // Render Stopped Row Immediately
                    const stoppedRow = document.createElement('div');
                    stoppedRow.className = 'ai-message-row';
                    stoppedRow.innerHTML = `
                        <div class="ai-avatar">${AI_LOGO_SVG}</div>
                        <div class="ai-text-wrapper"><div class="ai-content"><em style="color:#969AA3">Response stopped by you</em></div></div>
                    `;
                    activeChat.appendChild(stoppedRow);

                    // Add Action Icons
                    renderActionIcons(stoppedRow.querySelector('.ai-text-wrapper'));
                }

                // Reset UI for all stop scenarios
                typingController = null;
                btnSend.classList.remove('stop');
                updateSendButton();
                return;
            }

            if (!mainInput) return;
            const text = mainInput.innerText.trim();
            if (text !== '') {
                mainInput.innerHTML = '';
                updateSendButton();
                handleSend(text);
            }
        };

        function handleSend(text) {
            // Capture Attachments
            let attachmentHTML = '';
            if (attachmentArea && attachmentArea.children.length > 0) {
                const clones = Array.from(attachmentArea.children).map(child => {
                    const clone = child.cloneNode(true);
                    const removeBtn = clone.querySelector('.attachment-remove');
                    if (removeBtn) removeBtn.remove();
                    return clone.outerHTML;
                });
                attachmentHTML = clones.join('');
            }

            // Clear Attachments
            if (attachmentArea) {
                attachmentArea.innerHTML = '';
                attachmentArea.style.display = 'none';
            }

            let logicKey = text;
            const lower = text.toLowerCase();

            if (lower.includes('stock availability') || lower.includes('inventory')) logicKey = '/inventory-check';
            else if (lower.includes('soft credit') || lower.includes('credit')) logicKey = '/credit-prequal';
            else if (lower.includes('trade-in') || lower.includes('estimate value')) logicKey = '/trade-in-val';
            else if (lower.includes('list') || lower.includes('high-priority')) logicKey = 'List high-priority test drives';
            else if (lower.includes('test drive') || lower.includes('book')) logicKey = '/schedule-drive';
            else if (text.includes('Summarize')) logicKey = 'Summarize recent hot leads';
            else if (text.includes('Show open deals for Ryan')) logicKey = 'ryan_details';
            else if (lower.includes('ryan') && lower.includes('open deal')) logicKey = 'ryan_clarify';

            startChat(text, logicKey, attachmentHTML);
        }

        // NEW CHAT BTN HANDLER
        btnHeaderNewChat.onclick = () => {
            resetChat();
        };

        btnChatMenu.onclick = (e) => {
            e.stopPropagation();
            const item = getActiveHistoryItem();
            if (item) {
                const isPinned = item.classList.contains('is-pinned');
                headerPinText.innerText = isPinned ? 'Unpin Chat' : 'Pin Chat';
            } else {
                headerPinText.innerText = 'Pin Chat';
            }
            chatDropdown.classList.toggle('visible');
            globalContextMenu.classList.remove('visible');
        };

        document.addEventListener('click', (e) => {
            if (!enhancedInputBox.contains(e.target) && e.target !== btnSlashMenu) {
                closeAllMenus();
            }
            if (!globalContextMenu.contains(e.target)) {
                globalContextMenu.classList.remove('visible');
            }
            if (!chatDropdown.contains(e.target) && e.target !== btnChatMenu) {
                chatDropdown.classList.remove('visible');
            }
            if (e.target === renameModal) closeModals();
            if (e.target === deleteModal) closeModals();
        });

        async function typeWriter(container, htmlString, controller, sourcesData = { count: 0 }) {
            // Check stop before starting typing
            if (controller.stopped) {
                container.innerHTML = '<br><div style="color:var(--color-text-muted)">Response stopped by you</div>';
                // Add icons
                renderActionIcons(container.parentElement, sourcesData);

                typingController = null;
                btnSend.innerHTML = btnSendIcon;
                btnSend.classList.remove('stop');
                updateSendButton();
                return;
            }

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const nodes = Array.from(doc.body.childNodes);
            container.innerHTML = '';

            async function typeNode(node, parent) {
                // Check stop inside recursion
                if (controller.stopped) return;

                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    const textNode = document.createTextNode('');
                    parent.appendChild(textNode);
                    for (let char of text) {
                        if (controller.stopped) return; // Immediate break
                        textNode.textContent += char;
                        await new Promise(r => setTimeout(r, 1));
                        scrollToBottom();
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const newElement = document.createElement(node.tagName);
                    Array.from(node.attributes).forEach(attr => newElement.setAttribute(attr.name, attr.value));
                    parent.appendChild(newElement);

                    // Speed Up for Cards: If it's a complex card container, just inject full HTML
                    if (node.classList.contains('compact-list-container') ||
                        node.classList.contains('compact-list-item') ||
                        node.classList.contains('premium-deals-grid') ||
                        node.classList.contains('premium-deal-card')) {
                        await new Promise(r => setTimeout(r, 250)); // Artificial delay for better feel
                        newElement.innerHTML = node.innerHTML;
                        scrollToBottom();
                        return;
                    }

                    const children = Array.from(node.childNodes);
                    for (const child of children) {
                        await typeNode(child, newElement);
                    }
                }
            }

            for (const node of nodes) {
                if (controller.stopped) break;
                await typeNode(node, container);
            }

            // Cleanup if stopped or finished
            if (controller.stopped) {
                container.innerHTML += '<br><br><div style="color:var(--color-text-muted)">Response stopped by you</div>';
                renderActionIcons(container.parentElement, sourcesData);
            } else {
                // Normal Finish
                renderActionIcons(container.parentElement, sourcesData);
            }

            // Reset UI state
            typingController = null;
            btnSend.innerHTML = btnSendIcon;
            btnSend.classList.remove('stop');
            updateSendButton();
            scrollToBottom();
        }

        window.loadHistoryChat = function (title) {
            // Highlight Active History Item & Clear Nav Items
            document.querySelectorAll('.history-nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.history-item').forEach(el => {
                el.classList.remove('active');
                const textEl = el.querySelector('.history-text');
                if (textEl && textEl.textContent.trim() === title) {
                    el.classList.add('active');
                }
            });

            openMainView('activeChat');
            closeAllMenus();

            if (chatHeaderTitle) chatHeaderTitle.innerText = title;
            activeChat.innerHTML = '';

            if (btnHeaderNewChat) btnHeaderNewChat.disabled = false;
            if (btnChatMenu) btnChatMenu.disabled = false;

            const userBubble = document.createElement('div');
            userBubble.className = 'message-bubble user';
            userBubble.innerText = title;
            activeChat.appendChild(userBubble);

            const aiRow = document.createElement('div');
            aiRow.className = 'ai-message-row';
            const avatar = document.createElement('div');
            avatar.className = 'ai-avatar';
            avatar.innerHTML = AI_LOGO_SVG;
            aiRow.appendChild(avatar);

            const textWrapper = document.createElement('div');
            textWrapper.className = 'ai-text-wrapper';

            const aiContent = document.createElement('div');
            aiContent.className = 'ai-content';

            // Mock load logic (history doesn't re-animate)
            const thoughtSeconds = (Math.random() * 2 + 1).toFixed(1);
            const thoughtHeader = `
                <div class="reasoning-container finished">
                    <div class="reasoning-header" onclick="toggleThoughts(this)">
                        <span style="font-weight:500">Thought for</span>
                        <span class="timer">(${thoughtSeconds}s)</span>
                    </div>
                    <div class="reasoning-summary-wrapper" onclick="toggleThoughts(this)">
                        <div class="reasoning-summary">Accessed conversation history and internal records to prepare the summary for ${title} accurately.</div>
                        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>
                    <div class="reasoning-content">
                        <div class="step completed">Analyzed request intent</div>
                        <div class="step completed">Retrieved conversation history</div>
                        <div class="step completed">Formatted final response</div>
                    </div>
                </div>
            `;

            const responseBody = document.createElement('div');
            responseBody.innerHTML = `<p>Loading deal details for <strong>${title}</strong>...</p>`;

            aiContent.innerHTML = thoughtHeader;
            aiContent.appendChild(responseBody);

            textWrapper.appendChild(aiContent);
            aiRow.appendChild(textWrapper);
            activeChat.appendChild(aiRow);

            if (!panel.classList.contains('state-fullscreen') || window.innerWidth <= 768) {
                historySheet.classList.remove('open');
            }

            scrollToBottom();
            mainInput.focus();
        }

        window.startChat = function (userText, logicKey, attachmentHTML = '') {
            if (!logicKey) logicKey = userText;

            // Transition to active chat using central view manager
            openMainView('activeChat');

            const activeChatEl = document.getElementById('activeChat');
            const suggestionsListEl = document.getElementById('suggestionsList');
            const chatHeaderTitleEl = document.getElementById('chatHeaderTitle');
            const btnHeaderNewChatEl = document.getElementById('btnHeaderNewChat');
            const btnChatMenuEl = document.getElementById('btnChatMenu');
            const recentListEl = document.getElementById('recentList');
            const mainInputEl = document.getElementById('mainInput');
            const btnSendEl = document.getElementById('btnSend');

            if (btnHeaderNewChatEl) btnHeaderNewChatEl.disabled = false;
            if (btnChatMenuEl) btnChatMenuEl.disabled = false;

            if (!historyAdded) {
                let historyTitle = userText;
                if (historyTitle.length > 25) historyTitle = historyTitle.substring(0, 25) + "...";

                if (chatHeaderTitleEl) chatHeaderTitleEl.innerText = historyTitle;

                const newItem = document.createElement('div');
                newItem.className = 'history-item active'; // Set active highlight immediately
                newItem.onclick = () => loadHistoryChat(historyTitle);

                newItem.innerHTML = `
                    <div class="history-item-left">
                        <span class="history-text">${historyTitle}</span>
                    </div>
                    <button class="history-item-menu-btn" onclick="showItemMenu(event)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                    </button>
                `;

                // Insert new item after pinned items
                const pinnedItems = recentListEl.querySelectorAll('.history-item.is-pinned');
                if (pinnedItems.length > 0) {
                    // Insert after the last pinned item
                    const lastPinned = pinnedItems[pinnedItems.length - 1];
                    lastPinned.insertAdjacentElement('afterend', newItem);
                } else {
                    // No pinned items, add to the beginning
                    recentListEl.insertAdjacentElement('afterbegin', newItem);
                }

                historyAdded = true;
                checkEmptyHistory();
            }

            const userBubble = document.createElement('div');
            userBubble.className = 'message-bubble user';

            let bubbleContent = '';
            if (attachmentHTML) {
                bubbleContent += `<div class="bubble-attachments" style="display:flex; gap:4px; flex-wrap:wrap; margin-bottom:8px;">${attachmentHTML}</div>`;
            }
            // Add Text
            if (userText.includes('<span')) bubbleContent += `<div>${userText}</div>`;
            else bubbleContent += `<div>${userText}</div>`;

            userBubble.innerHTML = bubbleContent;

            if (activeChatEl) activeChatEl.appendChild(userBubble);
            scrollToBottom();

            // --- START STREAMING STATE ---
            typingController = { stopped: false };
            if (btnSendEl) {
                btnSendEl.innerHTML = btnStopIcon; // Change to Stop Icon
                btnSendEl.disabled = false; // Force Enable
                btnSendEl.classList.add('active'); // Keep it colored
                btnSendEl.classList.add('stop'); // Add Stop Style
            }

            const delay = 300; // Natural transition after thinking

            const thinkingRow = document.createElement('div');
            thinkingRow.className = 'ai-message-row';
            const thinkingAvatar = document.createElement('div');
            thinkingAvatar.className = 'ai-avatar thinking';
            thinkingAvatar.innerHTML = AI_LOGO_SVG;
            thinkingRow.appendChild(thinkingAvatar);

            const textWrapper = document.createElement('div');
            textWrapper.className = 'ai-text-wrapper';

            // --- REASONING COMPONENT ---
            const reasoningContainer = document.createElement('div');
            reasoningContainer.className = 'reasoning-container expanded';

            const reasoningHeader = document.createElement('div');
            reasoningHeader.className = 'reasoning-header';
            reasoningHeader.onclick = () => window.toggleThoughts(reasoningHeader);
            reasoningHeader.innerHTML = `
                <span class="status-text" style="font-weight:500">Thinking...</span>
                <span class="timer">0.0s</span>
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            `;

            const reasoningSummaryWrapper = document.createElement('div');
            reasoningSummaryWrapper.className = 'reasoning-summary-wrapper';
            reasoningSummaryWrapper.onclick = () => window.toggleThoughts(reasoningSummaryWrapper);
            reasoningSummaryWrapper.innerHTML = `
                <div class="reasoning-summary"></div>
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            `;
            const reasoningSummary = reasoningSummaryWrapper.querySelector('.reasoning-summary');

            const reasoningContent = document.createElement('div');
            reasoningContent.className = 'reasoning-content';

            reasoningContainer.appendChild(reasoningHeader);
            reasoningContainer.appendChild(reasoningSummaryWrapper);
            reasoningContainer.appendChild(reasoningContent);
            textWrapper.appendChild(reasoningContainer);
            thinkingRow.appendChild(textWrapper);

            if (activeChatEl) activeChatEl.appendChild(thinkingRow);
            scrollToBottom();

            // Timer Logic
            const timerEl = reasoningHeader.querySelector('.timer');
            const startTime = Date.now();
            const timerInterval = setInterval(() => {
                timerEl.textContent = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
            }, 100);

            let thinkingSteps = [
                "Analyzing user inquiry...",
                "Identifying CRM action items...",
                "Querying customer and vehicle records...",
                "Validating inventory and deal status...",
                "Synthesizing optimal response..."
            ];

            if (logicKey === 'ryan_clarify') {
                thinkingSteps = [
                    "Reading your request...",
                    "Searching contact list for 'Ryan'...",
                    "Found 5 people with that name.",
                    "Checking who has been active recently...",
                    "I need to check which Ryan you are referring to."
                ];
            } else if (logicKey === 'ryan_details') {
                thinkingSteps = [
                    "Looking up Ryan Carter's (customerID: 891) profile...",
                    "Checking the system for active deals...",
                    "Found 2 open deals for this contact.",
                    "Pulling deal details...",
                    "Formatting the deal summary for you."
                ];
            }

            const runSteps = async () => {
                for (let i = 0; i < thinkingSteps.length; i++) {
                    if (typingController.stopped) break;

                    const stepRow = document.createElement('div');
                    stepRow.className = 'step active';

                    const stepTextSpan = document.createElement('span');
                    stepTextSpan.className = 'step-text';

                    const cursor = document.createElement('span');
                    cursor.className = 'cursor';

                    stepRow.appendChild(stepTextSpan);
                    stepTextSpan.appendChild(cursor);
                    reasoningContent.appendChild(stepRow);

                    reasoningContent.scrollTop = reasoningContent.scrollHeight;
                    scrollToBottom();

                    const txt = thinkingSteps[i];
                    for (let j = 0; j < txt.length; j++) {
                        if (typingController.stopped) break;
                        stepTextSpan.insertBefore(document.createTextNode(txt[j]), cursor);
                        await new Promise(r => setTimeout(r, 20));
                    }
                    cursor.remove();
                    stepRow.classList.remove('active');
                    stepRow.classList.add('completed');

                    if (i < thinkingSteps.length - 1) {
                        await new Promise(r => setTimeout(r, 600));
                    }
                }
            };

            // --- AURORA GLOW EFFECT ---
            // Activate aurora effect when AI starts thinking
            if (panel) panel.classList.add('aurora-active');
            const mobileHandle = document.getElementById('mobileSheetHandle');
            if (mobileHandle) mobileHandle.classList.add('aurora-active');


            // Start the sequence
            runSteps().then(() => {
                // Once steps complete, or if stopped
                clearInterval(timerInterval);
                const finalTime = ((Date.now() - startTime) / 1000).toFixed(1);
                timerEl.textContent = `${finalTime}s`;
                const statusText = reasoningHeader.querySelector('.status-text');
                if (statusText) statusText.textContent = 'Thought for';

                // Set Summary
                let summaryText = "Analyzed your CRM inquiry and cross-referenced with your dealership records to provide the most relevant response.";
                if (logicKey === 'ryan_clarify') {
                    summaryText = "Found multiple 'Ryan' contacts in your system. I've narrowed it down to 5 active matches for your review.";
                } else if (logicKey === 'ryan_details') {
                    summaryText = "Located Ryan Carter's profile and identified 2 active deals. I've compiled the status and pricing for both vehicles.";
                }
                reasoningSummary.textContent = summaryText;

                // Step 1: Collapse steps first
                reasoningContainer.classList.remove('expanded');

                // Step 2: After collapse, show summary and start typing AI response
                setTimeout(async () => {
                    reasoningContainer.classList.add('finished');

                    // Small delay before starting the main response
                    setTimeout(async () => {
                        // Remove aurora effect when thinking completes
                        if (panel) panel.classList.remove('aurora-active');
                        if (mobileHandle) mobileHandle.classList.remove('aurora-active');

                        // If stopped during thinking phase
                        if (typingController.stopped) {
                            // Just stop here, maybe add a note
                            const stopNote = document.createElement('div');
                            stopNote.innerHTML = '<div style="color:var(--color-text-muted); font-style:italic; margin-top:8px;">Response stopped by you</div>';
                            textWrapper.appendChild(stopNote);

                            // Reset UI
                            typingController = null;
                            if (btnSendEl) {
                                btnSendEl.innerHTML = btnSendIcon;
                                btnSendEl.classList.remove('stop');
                            }
                            updateSendButton();
                            return;
                        }

                        // Remove 'thinking' class from avatar to stop blinking
                        thinkingAvatar.classList.remove('thinking');

                        const aiContent = document.createElement('div');
                        aiContent.className = 'ai-content';

                        // Calculate Sources (Attachments only)
                        let attachmentItems = [];
                        if (attachmentHTML) {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = attachmentHTML;
                            tempDiv.querySelectorAll('.attachment-pill span').forEach(span => {
                                attachmentItems.push(span.innerText);
                            });
                        }
                        const sourcesData = { count: attachmentItems.length, contextItems: [], attachmentItems: attachmentItems };

                        // Content Body for Typewriter
                        const contentBody = document.createElement('div');
                        aiContent.appendChild(contentBody);
                        textWrapper.appendChild(aiContent);

                        let responseHTML = "";
                        switch (logicKey) {
                            case 'ryan_clarify':
                                responseHTML = `<p>Please select the correct Ryan to proceed:</p>
                        <div class="compact-list-container">
                            <!-- Header -->
                            <div style="padding:12px 16px 0px 16px; font-weight:600; font-size:1rem; color:var(--color-text-heading);">
                                Contacts
                            </div>
                            <!-- Filters -->
                            <div style="padding:8px 16px 12px 16px; display:flex; align-items:center; justify-content:space-between; gap:16px; background:#fff;">
                                <div style="display:flex; gap:8px; overflow:hidden; white-space:nowrap; align-items:center; flex:1;">
                                    
                                    <div style="display:inline-flex; align-items:center; padding:4px 8px; border-radius:4px; font-size:0.75rem; background:var(--color-bg-surface); color:var(--color-text-subtle); border:1px solid #E0E0E0; font-weight:500; flex-shrink:0;">
                                        Contact = Ryan
                                    </div>
                                </div>
                                <div style="font-size:0.75rem; font-weight:600; color:var(--color-primary); cursor:pointer; flex-shrink:0;">
                                    Edit
                                </div>
                            </div>
                            <div class="compact-list-item" onclick="selectRyan(2)">
                                <div class="avatar-circle avatar-pink">RC</div>
                                <div class="item-main-info">
                                    <div class="item-name-row">
                                        <span class="item-name">Ryan Carter</span>
                                        <span class="item-id">#891</span>
                                    </div>
                                    <div class="item-sub-row">(512) 555-3421  r.carter@techstart.io</div>
                                </div>
                                <div class="item-meta-info">
                                    <span class="meta-date">12:30 PM</span>
                                    <span class="deal-badge badge-grey">2 Deals</span>
                                </div>
                            </div>
                            
                            <div class="compact-list-item" onclick="selectRyan(4)">
                                <div class="avatar-circle avatar-green">RW</div>
                                <div class="item-main-info">
                                    <div class="item-name-row">
                                        <span class="item-name">Ryan Washington</span>
                                        <span class="item-id">#554</span>
                                    </div>
                                    <div class="item-sub-row">(202) 555-7743  rwashington@state.gov</div>
                                </div>
                                <div class="item-meta-info">
                                    <span class="meta-date">Yesterday</span>
                                    <span class="deal-badge badge-grey">1 Deal</span>
                                </div>
                            </div>

                            <div class="compact-list-item" onclick="selectRyan(3)">
                                <div class="avatar-circle avatar-grey">RO</div>
                                <div class="item-main-info">
                                    <div class="item-name-row">
                                        <span class="item-name">Ryan O'Connell</span>
                                        <span class="item-id">#112</span>
                                    </div>
                                    <div class="item-sub-row">(617) 555-9982  ryan.oc@consulting.net</div>
                                </div>
                                <div class="item-meta-info">
                                    <span class="meta-date">Nov 12</span>
                                    <span class="deal-badge badge-grey">1 Deal</span>
                                </div>
                            </div>

                            <div class="compact-list-item" onclick="selectRyan(1)">
                                <div class="avatar-circle avatar-blue">RM</div>
                                <div class="item-main-info">
                                    <div class="item-name-row">
                                        <span class="item-name">Ryan Miller</span>
                                        <span class="item-id">#402</span>
                                    </div>
                                    <div class="item-sub-row">(312) 555-0192  ryan.miller@gmail.com</div>
                                </div>
                                <div class="item-meta-info">
                                    <span class="meta-date">Oct 24</span>
                                    <span class="deal-badge badge-grey">2 Deals</span>
                                </div>
                            </div>

                             <div class="compact-list-item" onclick="selectRyan(5)">
                                <div class="avatar-circle avatar-orange">RL</div>
                                <div class="item-main-info">
                                    <div class="item-name-row">
                                        <span class="item-name">Ryan Lee</span>
                                        <span class="item-id">#339</span>
                                    </div>
                                    <div class="item-sub-row">(415) 555-6621  ryan@leedesign.studio</div>
                                </div>
                                <div class="item-meta-info">
                                    <span class="meta-date">Sep 28</span>
                                    <span class="deal-badge badge-grey">3 Deals</span>
                                </div>
                            </div>
                        </div>`;
                                break;
                            case 'ryan_details':
                                // Show 2 Compact Deal Cards
                                responseHTML = `<p style="margin-bottom: 16px; font-size: 0.875rem; color: var(--color-text-main);">I've found 2 open deals for <strong>Ryan Carter</strong>:</p>
                        <div class="premium-deals-grid">
                            <!-- Card 1 -->
                            <div class="premium-deal-card" style="border: 1px solid var(--color-border-muted); border-radius: 4px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div style="padding: 12px;">
                                    <!-- Row 1: Vehicle Info -->
                                    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                                        <div style="width: 32px; height: 32px; border-radius: 8px; background: rgba(0, 191, 165, 0.08); color: var(--color-primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"></path><circle cx="7" cy="17" r="2"></circle><circle cx="17" cy="17" r="2"></circle><path d="M5 17h12"></path></svg>
                                        </div>
                                        <div>
                                            <div style="font-weight: 700; color: var(--color-text-heading); font-size: 0.85rem; line-height: 1.2; padding-bottom:4px;">#DEAL-4521</div>
                                            <div style="font-size: 0.75rem; color: var(--color-text-muted); font-weight: 500;">2024 Tesla Model Y</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Row 2: Salesperson, Type, Status -->
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); margin-bottom: 4px; padding: 8px 0; border-bottom: 1px solid #f1f3f4;">
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--color-text-muted); font-weight: 500;">Salesperson</div>
                                            <div style="font-size: 0.8rem; font-weight: 600; color: var(--color-text-main);">Sarah Jenkins</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--color-text-muted); font-weight: 500;">Type</div>
                                            <div style="font-size: 0.8rem; font-weight: 600; color: var(--color-text-main);">Finance</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--color-text-muted); font-weight: 500;">Status</div>
                                            <div style="font-size: 0.8rem; font-weight: 600; color: var(--color-text-main);">Quote</div>
                                        </div>
                                    </div>

                                    <!-- Row 3: Last Updated, View CTA -->
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--color-text-muted); font-weight: 500; padding-top:4px;">Last Updated</div>
                                            <div style="font-size: 0.8rem; font-weight: 600; color: var(--color-text-main);">Dec 21, 2025</div>
                                        </div>
                                        <button class="open-btn-compact" style="font-size: 14px; padding: 0 20px; border-radius: 2px; font-weight: 600; height: 32px;">View</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 2 -->
                            <div class="premium-deal-card" style="border: 1px solid var(--color-border-muted); border-radius: 4px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                <div style="padding: 12px;">
                                    <!-- Row 1: Vehicle Info -->
                                    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                                        <div style="width: 32px; height: 32px; border-radius: 8px; background: rgba(0, 0, 0, 0.04); color: #5f6368; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"></path><circle cx="7" cy="17" r="2"></circle><circle cx="17" cy="17" r="2"></circle><path d="M5 17h12"></path></svg>
                                        </div>
                                        <div>
                                            <div style="font-weight: 700; color: var(--color-text-heading); font-size: 0.85rem; line-height: 1.2; padding-bottom:4px;">#DEAL-9920</div>
                                            <div style="font-size: 0.75rem; color: var(--color-text-muted); font-weight: 500;">2021 Ford F-150</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Row 2: Salesperson, Type, Status -->
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); margin-bottom: 4px; padding: 8px 0; border-bottom: 1px solid #f1f3f4;">
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--color-text-muted); font-weight: 500;">Salesperson</div>
                                            <div style="font-size: 0.8rem; font-weight: 600; color: var(--color-text-main);">Mike Ross</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--color-text-muted); font-weight: 500;">Type</div>
                                            <div style="font-size: 0.8rem; font-weight: 600; color: var(--color-text-main);">Lease</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--color-text-muted); font-weight: 500;">Status</div>
                                            <div style="font-size: 0.8rem; font-weight: 600; color: var(--color-text-main);">Booked</div>
                                        </div>
                                    </div>

                                    <!-- Row 3: Last Updated, View CTA -->
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--color-text-muted); font-weight: 500; padding-top:4px;">Last Updated</div>
                                            <div style="font-size: 0.8rem; font-weight: 600; color: var(--color-text-main);">Dec 12, 2025</div>
                                        </div>
                                        <button class="open-btn-compact" style="font-size: 14px; padding: 0 20px; border-radius: 2px; font-weight: 600; height: 32px;">View</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;

                                break;
                            case 'Summarize recent hot leads':
                                responseHTML = `<p>Here is a summary of the active car leads from the current page view:</p><div class="ai-list-item"><span class="ai-list-number">1.</span><span><strong>John Doe:</strong> Interested in 2024 Honda CR-V. Financing pending.</span></div><div class="ai-list-item"><span class="ai-list-number">2.</span><span><strong>Sarah Smith:</strong> Requesting test drive for Ford Explorer. Trade-in valuation needed.</span></div><div class="ai-list-item"><span class="ai-list-number">3.</span><span><strong>Mike Johnson:</strong> Lease expiring soon. Looking at Toyota Camry options.</span></div>`;
                                break;
                            case 'Draft quote for Model X':
                                responseHTML = `<p><strong>Subject: Your Tesla Model X Quote</strong></p><p>Hi <strong>[Customer Name]</strong>,</p><p>Great choice on the <strong>Model X</strong>. Based on your configuration (Long Range, Black Interior), here is the preliminary quote attached. This includes the federal tax incentive deduction.</p>`;
                                break;
                            case 'List high-priority test drives':
                                responseHTML = `<p><strong>Today's High Priority Test Drives:</strong></p><div class="ai-list-item"><span class="ai-list-number">1.</span><span><strong>10:00 AM - BMW X5</strong> (Client: A. Miller)</span></div><div class="ai-list-item"><span class="ai-list-number">2.</span><span><strong>1:30 PM - Audi Q7</strong> (Client: B. Davis) - <em>Confirm trade-in arrival</em></span></div>`;
                                break;
                            case '/inventory-check':
                                responseHTML = `<strong>Stock Status:</strong><br>We have 3 units matching that description at the Main Lot, and 1 in transit (ETA: 5 days).`;
                                break;
                            case '/deal-probability':
                                responseHTML = `<strong>Deal Probability: 75%</strong><br>Customer has high intent. Credit score is solid (720+). Pending spouse approval on color.`;
                                break;
                            case '/credit-prequal':
                                responseHTML = `<strong>Soft Pull Result:</strong><br>Tier 1 Credit Qualified. Rate eligibility: 3.9% APR for 60 months.`;
                                break;
                            case '/trade-in-val':
                                responseHTML = `<strong>Estimated Value:</strong> $18,500 - $20,000<br>Based on 2018 model year with 45k miles and 'Good' condition.`;
                                break;
                            case '/schedule-drive':
                                responseHTML = `<strong>Slot Confirmed:</strong><br>Test drive scheduled for Saturday, Oct 24th at 11:00 AM. Confirmation SMS sent.`;
                                break;
                            case 'Summarize recent car leads':
                                responseHTML = `<p>Here is a summary of the active car leads from the current page view:</p><div class="ai-list-item"><span class="ai-list-number">1.</span><span><strong>John Doe:</strong> Interested in 2024 Honda CR-V. Financing pending.</span></div><div class="ai-list-item"><span class="ai-list-number">2.</span><span><strong>Sarah Smith:</strong> Requesting test drive for Ford Explorer. Trade-in valuation needed.</span></div><div class="ai-list-item"><span class="ai-list-number">3.</span><span><strong>Mike Johnson:</strong> Lease expiring soon. Looking at Toyota Camry options.</span></div>`;
                                break;
                            default:
                                responseHTML = "Analyzing CRM data...";
                        }

                        await typeWriter(contentBody, responseHTML, typingController, sourcesData);

                    }, 300); // Step 3: Response delay after summary appears
                }, 600); // Timing for step 2 (summary reveal) after step 1 (collapse) completes
            });
        };

        window.selectRyan = function (id) {
            const map = {
                1: "Ryan Miller (#402)",
                2: "Ryan Carter (#891)",
                3: "Ryan O'Connell (#112)",
                4: "Ryan Washington (#554)",
                5: "Ryan Lee (#339)"
            };
            const details = map[id] || "Ryan Carter (#891)";
            const text = "Show open deals for " + details;
            startChat(text, "ryan_details");
        };

        // --- FILTER POPOVER LOGIC ---
        window.toggleFilterPopover = function (event, element) {
            event.stopPropagation();

            // Remove existing popovers
            const existing = document.getElementById('activeFilterPopover');
            if (existing) existing.remove();

            // Create Popover
            const popover = document.createElement('div');
            popover.id = 'activeFilterPopover';
            popover.className = 'filter-popover visible';

            // Content
            popover.innerHTML = `
                <div style="font-weight:600; font-size:0.75rem; margin-bottom:8px; display:flex; align-items:center; gap:4px;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                    Applied Filters
                </div>
                <div class="popover-item">
                    <span class="popover-label">Status</span>
                    <span class="popover-value">Open</span>
                </div>
                <div class="popover-item">
                    <span class="popover-label">Customer ID</span>
                    <span class="popover-value">#891</span>
                </div>
            `;

            document.body.appendChild(popover);

            // Positioning
            // To ensure the popover moves with the scrolling content, we must append it 
            // inside the scrolling container or position it relative to the parent.
            // Since we can't easily change the DOM hierarchy of 'element' safely here,
            // we will use a trick: Calculate position relative to the scrollable 'chat-scroll-area'.
            // However, a simpler fix requested by the user is "tied to the element".
            // We will append the popover DIRECTLY to the badge element and set the badge to relative.

            // Remove from body first if we just added it (the line above was initial logic, replacing it now)
            popover.remove();

            element.style.position = 'relative';
            element.appendChild(popover);

            // Popover styling is absolute. 
            // We want it below the badge.
            popover.style.top = '100%';
            popover.style.left = 'auto';
            popover.style.right = '0';
            popover.style.marginTop = '4px';
            popover.style.position = 'absolute';

            // Close on outside click
            const closeHandler = function (e) {
                if (!popover.contains(e.target) && e.target !== element) {
                    popover.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            // Add slight delay so this click doesn't trigger it immediately if event bubbling hits
            setTimeout(() => {
                document.addEventListener('click', closeHandler);
            }, 0);
        };

        function resetChat() {
            // Clear all highlights
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.history-nav-item').forEach(el => {
                el.classList.remove('active');
                // Highlight "New Chat" Specifically
                if (el.innerText.trim() === "New Chat") el.classList.add('active');
            });

            openMainView('emptyState');
            activeChat.innerHTML = '';
            if (contextRow) contextRow.style.display = 'none';
            if (chatHeaderTitle) chatHeaderTitle.innerText = "New Chat";

            if (btnHeaderNewChat) btnHeaderNewChat.disabled = true;
            if (btnChatMenu) btnChatMenu.disabled = true;

            historyAdded = false;
            mainInput.innerHTML = '';
            updateSendButton();

            // STOP ANY STREAMING
            if (typingController) {
                typingController.stopped = true;
                if (typingController.timerId) clearTimeout(typingController.timerId);
                typingController = null;
            }
            btnSend.innerHTML = btnSendIcon;
            btnSend.classList.remove('stop');

            // Remove aurora glow
            if (panel) panel.classList.remove('aurora-active');
            const mobileHandle = document.getElementById('mobileSheetHandle');
            if (mobileHandle) mobileHandle.classList.remove('aurora-active');

            mainInput.focus();
        }

        // View Management
        window.openMainView = function (viewId) {
            const views = ['emptyState', 'activeChat', 'tasksView', 'insightsView', 'templatesView', 'settingsView'];
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            // Update Sidebar Highlights
            const navItems = document.querySelectorAll('.history-nav-item');
            navItems.forEach(item => {
                const text = item.innerText.trim();
                const viewMapping = {
                    "New Chat": "emptyState",
                    "Agent Tasks": "tasksView",
                    "Insights": "insightsView",
                    "Prompt Templates": "templatesView",
                    "Settings": "settingsView"
                };
                if (viewMapping[text] === viewId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // If navigating to a non-chat view, clear history item highlights
            if (viewId !== 'activeChat') {
                document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
            }

            const suggest = document.getElementById('suggestionsList');
            const footer = document.querySelector('.footer-container');
            const chatHeaderTitle = document.getElementById('chatHeaderTitle');
            const btnHeaderNewChat = document.getElementById('btnHeaderNewChat');
            const btnHeaderRefresh = document.getElementById('btnHeaderRefresh');
            const chatMenuContainer = document.getElementById('chatMenuContainer');
            const btnShowHistory = document.getElementById('btnShowHistory');

            const isDashView = ['tasksView', 'insightsView', 'templatesView', 'settingsView'].includes(viewId);

            // Default State
            if (btnHeaderNewChat) {
                btnHeaderNewChat.style.display = 'flex';
                btnHeaderNewChat.innerHTML = HEADER_NEW_CHAT_ICON;
            }
            if (chatMenuContainer) chatMenuContainer.style.display = 'flex';
            if (btnHeaderRefresh) btnHeaderRefresh.style.display = 'none';

            if (isDashView) {
                if (suggest) suggest.style.display = 'none';
                if (footer) footer.style.display = 'none';
                if (chatMenuContainer) chatMenuContainer.style.display = 'none';

                if (viewId === 'tasksView') {
                    if (chatHeaderTitle) chatHeaderTitle.innerText = "Agent Tasks";
                    if (btnHeaderNewChat) {
                        btnHeaderNewChat.style.display = 'flex';
                        btnHeaderNewChat.disabled = false;
                        btnHeaderNewChat.innerHTML = HEADER_ADD_ICON;
                    }
                } else if (viewId === 'insightsView') {
                    if (chatHeaderTitle) chatHeaderTitle.innerText = "Insights";
                    if (btnHeaderNewChat) btnHeaderNewChat.style.display = 'none';
                    if (btnHeaderRefresh) {
                        btnHeaderRefresh.style.display = 'flex';
                        btnHeaderRefresh.onclick = () => {
                            const target = document.getElementById('insightsView');
                            if (target) {
                                target.style.opacity = '0.5';
                                setTimeout(() => { target.style.opacity = '1'; }, 500);
                            }
                        };
                    }
                } else if (viewId === 'settingsView') {
                    if (chatHeaderTitle) chatHeaderTitle.innerText = "Settings";
                    if (btnHeaderNewChat) btnHeaderNewChat.style.display = 'none';
                } else if (viewId === 'templatesView') {
                    if (chatHeaderTitle) chatHeaderTitle.innerText = "Prompt Templates";
                    if (btnHeaderNewChat) {
                        btnHeaderNewChat.style.display = 'flex';
                        btnHeaderNewChat.disabled = false;
                        btnHeaderNewChat.innerHTML = HEADER_ADD_ICON;
                    }
                }

                // Update back button behavior to open history sidesheet and RETAIN current dashboard view
                if (btnShowHistory) {
                    btnShowHistory.onclick = () => {
                        toggleHistory(true);
                    };
                }
            } else {
                if (suggest) suggest.style.display = (viewId === 'emptyState') ? 'flex' : 'none';
                if (footer) footer.style.display = 'block';
                if (viewId === 'emptyState') {
                    if (chatHeaderTitle) chatHeaderTitle.innerText = "New Chat";
                    if (btnHeaderNewChat) btnHeaderNewChat.disabled = true;
                    if (btnChatMenu) btnChatMenu.disabled = true;
                }

                // Restore default back button behavior
                if (btnShowHistory) {
                    btnShowHistory.onclick = () => toggleHistory();
                }
            }

            const target = document.getElementById(viewId);
            if (target) {
                target.style.display = (viewId === 'activeChat' || viewId === 'emptyState') ? 'flex' : 'block';
            }

            toggleHistory(false);
        }

        // FAB Button for New Chat
        const historyNewChatBtn = document.getElementById('historyNewChatBtn');
        if (historyNewChatBtn) {
            historyNewChatBtn.onclick = () => {
                resetChat();
                historySheet.classList.remove('open');
                if (!panel.classList.contains('state-fullscreen')) {
                    historySheet.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        historySheet.style.transform = '';
                    }, 400);
                }
            };
        }

        // Tab Switching Function
        window.switchHistoryTab = function (tabName) {
            let mainViewId;
            switch (tabName) {
                case 'agent-tasks':
                    mainViewId = 'tasksView';
                    break;
                case 'pulse':
                case 'insights':
                    mainViewId = 'insightsView';
                    break;
                case 'prompt-templates':
                    mainViewId = 'templatesView';
                    break;
                case 'chats':
                    // Just close history for chats or show empty state if no active chat
                    mainViewId = 'emptyState';
                    break;
            }

            if (mainViewId) openMainView(mainViewId);
        };

        mainContent.onclick = () => {
            if (emptyState.style.display !== 'none') {
                if (contextRow) contextRow.style.display = 'none';
                suggestionsList.style.display = 'flex';
            }
        };

        // Window Controls
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btnMinimize').onclick = () => setState('minimized');
            document.getElementById('btnRestoreMin').onclick = () => setState('docked');
            document.getElementById('btnCloseMin').onclick = () => {
                // Disable transition for instant close from minimized state
                panel.style.transition = 'none';
                setState('closed');
                // Re-enable transition after a brief delay
                setTimeout(() => {
                    panel.style.transition = '';
                }, 50);
            };
            document.getElementById('btnFull').onclick = () => setState('fullscreen');
            document.getElementById('btnDock').onclick = () => setState('docked');
            document.getElementById('btnClose').onclick = () => setState('closed');
        });

        /* --- SOURCES POPOVER LOGIC --- */
        window.toggleSourcesPopover = function (event, element, data) {
            event.stopPropagation();

            // Remove existing popovers
            const existing = document.getElementById('activeSourcesPopover');
            if (existing) {
                const parent = existing.parentElement;
                existing.remove();
                if (parent === element) return; // Toggle off if clicking same element
            }

            // Create Popover
            const popover = document.createElement('div');
            popover.id = 'activeSourcesPopover';
            // Use same class as filter popover for consistency, assuming it provides basic styling
            popover.className = 'filter-popover visible';

            // Override or extra styling
            popover.style.width = '240px'; // Wider for filenames
            popover.style.zIndex = '100';
            popover.style.padding = '16px'; // More padding like reference

            // Build Content
            let html = `
                <div style="font-weight:600; font-size:1.1rem; margin-bottom:16px; display:flex; align-items:center; gap:4px; color:var(--color-text-heading);">
                    Sources
                </div>
            `;

            // Context Section
            if (data.contextItems && data.contextItems.length > 0) {
                html += `<div style="margin-bottom:12px;">`;
                html += `<div style="font-size:0.85rem; color:var(--color-text-muted); margin-bottom:8px;">Context</div>`;
                data.contextItems.forEach(name => {
                    html += `
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--color-text-main);"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <span style="font-size:0.95rem; color:var(--color-text-heading);">${name}</span>
                    </div>`;
                });
                html += `</div>`;
            }

            // Attachments Section
            if (data.attachmentItems && data.attachmentItems.length > 0) {
                html += `<div>`;
                html += `<div style="font-size:0.85rem; color:var(--color-text-muted); margin-bottom:8px;">Attachments</div>`;
                data.attachmentItems.forEach(name => {
                    html += `
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--color-text-main);"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                        <span style="font-size:0.95rem; color:var(--color-text-heading); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${name}</span>
                    </div>`;
                });
                html += `</div>`;
            }

            // Empty State (if needed, though count > 0 logic in main flow prevents this)
            if ((!data.contextItems || data.contextItems.length === 0) && (!data.attachmentItems || data.attachmentItems.length === 0)) {
                html += `<div style="color:var(--color-text-muted); font-size:0.9rem;">No sources found.</div>`;
            }

            popover.innerHTML = html;

            element.style.position = 'relative';
            element.appendChild(popover);

            // Position (Bottom Left aligned)
            popover.style.position = 'absolute';
            popover.style.top = 'calc(100% + 4px)';
            popover.style.left = '0';
            popover.style.right = 'auto';
            popover.style.marginTop = '0';

            // Close handler
            const closeHandler = function (e) {
                if (!popover.contains(e.target) && e.target !== element) {
                    popover.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            // Delay adding listener to prevent immediate closing
            setTimeout(() => {
                document.addEventListener('click', closeHandler);
            }, 0);
        };

        // Defined AFTER to override previous (due to edit conflicts)
        window.toggleSourcesPopover = function (event, element, data) {
            event.stopPropagation();

            // Remove existing popovers
            const existing = document.getElementById('activeSourcesPopover');
            if (existing) {
                const parent = existing.parentElement;
                existing.remove();
                if (parent === element) return; // Toggle off if clicking same element
            }

            // Create Popover
            const popover = document.createElement('div');
            popover.id = 'activeSourcesPopover';
            // Reuse filter-popover class
            popover.className = 'filter-popover visible';

            // Custom Styling
            popover.style.width = '240px';
            popover.style.zIndex = '1000'; // High z-index
            popover.style.padding = '12px 16px';
            popover.style.textAlign = 'left';

            // Build Content
            let html = `
                <div style="font-weight:600; font-size:0.8rem; margin-bottom:12px; display:flex; align-items:center; gap:6px; color:var(--color-text-heading);">
                    Sources
                </div>
            `;

            // Context Section
            if (data.contextItems && data.contextItems.length > 0) {
                html += `<div style="margin-bottom:12px;">`;
                html += `<div style="font-size:0.75rem; font-weight:500; color:var(--color-text-muted); margin-bottom:6px;">Context</div>`;
                data.contextItems.forEach(name => {
                    html += `
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--color-text-heading);"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <span style="font-size:0.85rem; color:var(--color-text-heading); font-weight:500;">${name}</span>
                    </div>`;
                });
                html += `</div>`;
            }

            // Attachments Section
            if (data.attachmentItems && data.attachmentItems.length > 0) {
                html += `<div>`;
                html += `<div style="font-size:0.75rem; font-weight:500; color:var(--color-text-muted); margin-bottom:6px;">Attachments</div>`;
                data.attachmentItems.forEach(name => {
                    html += `
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--color-text-heading);"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                        <span style="font-size:0.85rem; color:var(--color-text-heading); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${name}</span>
                    </div>`;
                });
                html += `</div>`;
            }

            if ((!data.contextItems || data.contextItems.length === 0) && (!data.attachmentItems || data.attachmentItems.length === 0)) {
                html += `<div style="color:var(--color-text-muted); font-size:0.8rem;">No sources found.</div>`;
            }

            popover.innerHTML = html;

            element.style.position = 'relative';
            element.appendChild(popover);

            // INTELLIGENT POSITIONING
            const rect = element.getBoundingClientRect();
            const spaceBelow = window.innerHeight - rect.bottom;

            popover.style.position = 'absolute';
            popover.style.left = '0';
            popover.style.right = 'auto'; // Default align left

            if (spaceBelow < 250) {
                // Not enough space below, pop UP
                popover.style.top = 'auto';
                popover.style.bottom = 'calc(100% + 8px)';
            } else {
                // Pop DOWN
                popover.style.bottom = 'auto';
                popover.style.top = 'calc(100% + 8px)';
            }

            // Check right edge collision
            const popRect = popover.getBoundingClientRect();
            if (popRect.right > window.innerWidth) {
                popover.style.left = 'auto';
                popover.style.right = '0';
            }


            // Close handler
            const closeHandler = function (e) {
                if (!popover.contains(e.target) && e.target !== element) {
                    popover.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeHandler);
            }, 0);
        };

        // Populate Dummy History
        function populateDummyHistory() {
            const list = document.getElementById('recentList');
            if (!list) return;
            list.innerHTML = ''; // Start Fresh
            const titles = [
                "Monthly Sales Review", "Tesla Fleet Inquiry", "Model 3 Pricing", "Product Specs - Model Y",
                "Sales Strategy Q4", "Customer Feedback Rev", "Inventory Check", "Service Appointment FAQ",
                "Warranty Terms Update", "Lease Options 2024", "Referral Program Details", "Insurance Partners",
                "Charging Station Map", "Mobile App Setup", "Test Drive Protocol", "Model S Comparison",
                "Q3 Earnings Analysis", "Staff Schedule Draft", "Holiday Promo Copy", "Email Campaign Iteration",
                "Client Meeting Notes", "Bug Report: Login", "Feature Request: Dark Mode", "API Documentation",
                "Deployment Checklist"
            ];

            titles.forEach((title, i) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                if (i < 2) {
                    item.classList.add('is-pinned');
                }

                let pinHtml = '';
                if (i < 2) {
                    pinHtml = `<div class="history-item-pin-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg></div>`;
                }

                item.innerHTML = `
                    <div class="history-item-left">
                        <span class="history-text">${title}</span>
                    </div>
                    <div class="history-item-actions">
                        ${pinHtml}
                        <button class="history-item-menu-btn" onclick="showItemMenu(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="1"></circle>
                                <circle cx="12" cy="5" r="1"></circle>
                                <circle cx="12" cy="19" r="1"></circle>
                            </svg>
                        </button>
                    </div>
                `;

                item.onclick = (e) => {
                    if (e.target.closest('.history-item-menu-btn')) return;
                    loadHistoryChat(title);
                    toggleHistory(false); // Close history when clicking on an item
                };
                list.appendChild(item);
            });
        }

        document.addEventListener('DOMContentLoaded', populateDummyHistory);
        // Global State Logic
        function setState(state) {
            if (panel) panel.classList.remove('state-docked', 'state-minimized', 'state-fullscreen', 'state-closed');
            if (mainContent) mainContent.classList.remove('pushed-by-dock', 'full-hidden');
            if (btnFull) btnFull.style.display = 'flex';
            if (btnDock) btnDock.style.display = 'none';

            // Ensure history overlay is gone if we change main state
            if (historySheet && historySheet.classList.contains('open')) {
                toggleHistory(false);
            }


            if (state === 'closed') {
                if (navAiToggle) navAiToggle.classList.remove('active');
                panel.classList.add('state-closed');
                panel.style.left = '';

                // Show FAB if on mobile
                if (window.innerWidth <= 768) {
                    mobileFab.classList.add('visible');
                }
            } else {
                if (navAiToggle) navAiToggle.classList.add('active');
                mobileFab.classList.remove('visible'); // Hide FAB when chat opens
            }

            if (state === 'docked') {
                panel.classList.add('state-docked');
                mainContent.classList.add('pushed-by-dock');
                panel.style.left = '';
                mainInput.focus();
            } else if (state === 'minimized') {
                panel.classList.add('state-minimized');
                if (!panel.style.left) panel.style.left = '100px';
            } else if (state === 'fullscreen') {
                panel.classList.add('state-fullscreen');
                mainContent.classList.add('full-hidden');
                btnFull.style.display = 'none';
                btnDock.style.display = 'flex';
                panel.style.left = '';
                mainInput.focus();
            }
        }

        if (navAiToggle) {
            navAiToggle.onclick = () => {
                if (panel.classList.contains('state-closed')) setState('docked');
                else setState('closed');
            };
        }

        // AI Logo toggle handlers
        const aiLogo1 = document.getElementById('aiLogo1');
        const aiLogo2 = document.getElementById('aiLogo2');

        if (aiLogo1) {
            aiLogo1.onclick = () => {
                if (panel.classList.contains('state-closed')) setState('docked');
                else setState('closed');
            };
        }

        if (aiLogo2) {
            aiLogo2.onclick = () => {
                if (panel.classList.contains('state-closed')) setState('docked');
                else setState('closed');
            };
        }

        // Mobile FAB Toggle Function
        window.toggleMobileChat = function () {
            setState('fullscreen'); // Open as full screen on mobile
        };

        const historyOverlay = document.getElementById('historyOverlay');

        function toggleHistory(forceOpen = null) {
            let isOpen;
            if (forceOpen === true) {
                historySheet.classList.add('open');
                isOpen = true;
            } else if (forceOpen === false) {
                historySheet.classList.remove('open');
                isOpen = false;
            } else {
                isOpen = historySheet.classList.toggle('open');
            }

            if (isOpen) {
                historyOverlay.classList.add('visible');
            } else {
                historyOverlay.classList.remove('visible');
            }
        }

        btnShowHistory.onclick = () => toggleHistory();
        if (historyOverlay) {
            historyOverlay.onclick = () => toggleHistory(false);
        }

        // Search UI Logic
        const historySearchBtn = document.getElementById('historySearchBtn');
        const historySearchWrapper = document.getElementById('historySearchWrapper');
        const historySearchInput = document.getElementById('historySearchInput');

        if (historySearchBtn && historySearchWrapper && historySearchInput) {
            historySearchBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (historySearchWrapper.classList.contains('active')) {
                    historySearchWrapper.classList.remove('active');
                    historySearchInput.value = '';
                    filterHistoryList('');
                } else {
                    historySearchWrapper.classList.add('active');
                    historySearchInput.focus();
                }
            });

            // New Chat Button in History
            if (window.historyNewChatBtn) {
                historyNewChatBtn.addEventListener('click', () => {
                    toggleHistory(false); // Close history/overlay
                    startNewChat(); // Trigger new chat logic
                });
            }

            historySearchInput.addEventListener('input', (e) => {
                filterHistoryList(e.target.value);
            });

            document.addEventListener('click', (e) => {
                if (historySearchWrapper.classList.contains('active') && !historySearchWrapper.contains(e.target)) {
                    historySearchWrapper.classList.remove('active');
                    historySearchInput.value = '';
                    filterHistoryList('');
                }
            });
        }

        // Rotating Placeholder Logic
        const placeholders = [
            "Ask  Find  Summarize",
            "Ask Anything...",
            "Find this customer...",
            "Summarize this page..."
        ];
        let placeholderIndex = 0;
        let phCurrent, phNext;
        let placeholderInterval;
        let isInputFocused = false;

        function rotatePlaceholder() {
            if (!mainInput) return;
            if (!phCurrent) {
                phCurrent = document.getElementById('phItem1');
                phNext = document.getElementById('phItem2');
            }

            // Check if chat is active (emptyState is hidden)
            const isChatActive = emptyState.style.display === 'none';

            if (isChatActive) {
                // Once initiated/active, show static placeholder
                phCurrent.innerText = "Ask  Find  Summarize";
                phCurrent.className = 'placeholder-item visible no-placeholder-transition';
                phNext.className = 'placeholder-item hidden-down no-placeholder-transition';
                return;
            }

            // Only animate if input is empty
            if (mainInput.textContent.trim() === "") {
                placeholderIndex = (placeholderIndex + 1) % placeholders.length;

                // 1. Move Next item to bottom instantly
                phNext.classList.add('no-placeholder-transition');
                phNext.innerText = placeholders[placeholderIndex];
                phNext.className = 'placeholder-item hidden-down no-placeholder-transition';

                // Force layout reflow
                phNext.offsetHeight;

                // 2. Perform synchronized scroll up
                phNext.classList.remove('no-placeholder-transition');

                // Current slides out to top
                phCurrent.className = 'placeholder-item hidden-up';
                // Next slides in from bottom to center
                phNext.className = 'placeholder-item visible';

                // 3. Swap roles for next rotation
                let temp = phCurrent;
                phCurrent = phNext;
                phNext = temp;
            }
        }

        function startPlaceholderRotation() {
            if (placeholderInterval) clearInterval(placeholderInterval);
            placeholderInterval = setInterval(rotatePlaceholder, 3000);
        }

        mainInput.addEventListener('focus', () => {
            isInputFocused = true;
        });

        mainInput.addEventListener('blur', () => {
            isInputFocused = false;
        });

        // Mobile Bottom Sheet Resize Logic
        const mobileSheetHandle = document.getElementById('mobileSheetHandle');
        let isResizingSheet = false;
        let startY, startHeight;

        mobileSheetHandle.addEventListener('mousedown', startResizing);
        mobileSheetHandle.addEventListener('touchstart', startResizing, { passive: false });

        function startResizing(e) {
            if (window.innerWidth > 768) return;
            isResizingSheet = true;
            startY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            startHeight = chatPanel.offsetHeight;
            chatPanel.classList.add('resizing');

            document.addEventListener('mousemove', handleResizing);
            document.addEventListener('touchmove', handleResizing, { passive: false });
            document.addEventListener('mouseup', stopResizing);
            document.addEventListener('touchend', stopResizing);

            if (e.cancelable) e.preventDefault();
        }

        function handleResizing(e) {
            if (!isResizingSheet) return;
            const currentY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            const dy = startY - currentY;
            const newHeight = startHeight + dy;

            // Min height 480px, Max 95vh
            if (newHeight >= 480 && newHeight <= window.innerHeight * 0.95) {
                chatPanel.style.height = newHeight + 'px';
            }

            if (e.cancelable) e.preventDefault();
        }

        function stopResizing() {
            isResizingSheet = false;
            chatPanel.classList.remove('resizing');
            document.removeEventListener('mousemove', handleResizing);
            document.removeEventListener('touchmove', handleResizing);
            document.removeEventListener('mouseup', stopResizing);
            document.removeEventListener('touchend', stopResizing);
        }

        // Defined here to ensure it overrides any previous definitions
        window.toggleSourcesPopover = function (event, element, data) {
            event.stopPropagation();

            // Remove existing popovers
            const existing = document.getElementById('activeSourcesPopover');
            if (existing) {
                const parent = existing.parentElement;
                existing.remove();
                if (parent === element) return; // Toggle off if clicking same element
            }

            // Create Popover
            const popover = document.createElement('div');
            popover.id = 'activeSourcesPopover';
            // Reuse filter-popover class
            popover.className = 'filter-popover visible';

            // Custom Styling - mimicking filter popover defaults + width for content
            popover.style.width = '220px';
            popover.style.zIndex = '1000';
            popover.style.textAlign = 'left';

            // Build Content
            // Match Filter Popover Header: font-weight:600; font-size:0.75rem; margin-bottom:8px;
            let html = `
                <div style="font-weight:600; font-size:0.75rem; margin-bottom:8px; display:flex; align-items:center; gap:4px; color:var(--color-text-heading);">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    Sources
                </div>
            `;

            // Context Section
            if (data.contextItems && data.contextItems.length > 0) {
                html += `<div style="margin-bottom:8px;">`;
                html += `<div style="font-size:0.7rem; font-weight:500; color:var(--color-text-muted); margin-bottom:4px;">Context</div>`;
                data.contextItems.forEach(name => {
                    html += `
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--color-text-heading);"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <span style="font-size:0.75rem; color:var(--color-text-heading); font-weight:500;">${name}</span>
                    </div>`;
                });
                html += `</div>`;
            }

            // Attachments Section
            if (data.attachmentItems && data.attachmentItems.length > 0) {
                html += `<div>`;
                html += `<div style="font-size:0.7rem; font-weight:500; color:var(--color-text-muted); margin-bottom:4px;">Attachments</div>`;
                data.attachmentItems.forEach(name => {
                    html += `
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--color-text-heading);"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                        <span style="font-size:0.75rem; color:var(--color-text-heading); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${name}</span>
                    </div>`;
                });
                html += `</div>`;
            }

            if ((!data.contextItems || data.contextItems.length === 0) && (!data.attachmentItems || data.attachmentItems.length === 0)) {
                html += `<div style="color:var(--color-text-muted); font-size:0.75rem;">No sources found.</div>`;
            }

            popover.innerHTML = html;

            element.style.position = 'relative';
            element.appendChild(popover);

            // INTELLIGENT POSITIONING
            const rect = element.getBoundingClientRect();
            const spaceBelow = window.innerHeight - rect.bottom;

            popover.style.position = 'absolute';
            popover.style.left = '0';
            popover.style.right = 'auto'; // Default align left

            if (spaceBelow < 250) {
                // Not enough space below, pop UP
                popover.style.top = 'auto';
                popover.style.bottom = 'calc(100% + 4px)';
            } else {
                // Pop DOWN
                popover.style.bottom = 'auto';
                popover.style.top = 'calc(100% + 4px)';
            }

            // Check right edge collision
            const popRect = popover.getBoundingClientRect();
            if (popRect.right > window.innerWidth) {
                popover.style.left = 'auto';
                popover.style.right = '0';
            }


            // Close handler
            const closeHandler = function (e) {
                if (!popover.contains(e.target) && e.target !== element) {
                    popover.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeHandler);
            }, 0);
        };

        // Defined here to ensure it overrides any previous definitions
        window.toggleSourcesPopover = function (event, element, data) {
            event.stopPropagation();

            // Remove existing popovers
            const existing = document.getElementById('activeSourcesPopover');
            if (existing) {
                const parent = existing.parentElement;
                existing.remove();
                if (existing.dataset.triggerId === element.id) return; // Toggle off if same
            }

            // Create Popover in BODY to avoid clipping
            const popover = document.createElement('div');
            popover.id = 'activeSourcesPopover';
            if (element.id) popover.dataset.triggerId = element.id;

            // Reuse filter-popover class
            popover.className = 'filter-popover visible';

            // Custom Styling
            popover.style.width = '220px';
            popover.style.zIndex = '9999'; // Very High z-index for fixed pos
            popover.style.textAlign = 'left';
            popover.style.position = 'fixed'; // Use fixed to ensure visibility over everything

            // Build Content Match Filter Popover Header
            let html = `
                <div style="font-weight:600; font-size:0.75rem; margin-bottom:8px; display:flex; align-items:center; gap:4px; color:var(--color-text-heading);">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    Sources
                </div>
            `;

            // Context Section
            if (data.contextItems && data.contextItems.length > 0) {
                html += `<div style="margin-bottom:8px;">`;
                html += `<div style="font-size:0.7rem; font-weight:500; color:var(--color-text-muted); margin-bottom:4px;">Context</div>`;
                data.contextItems.forEach(name => {
                    html += `
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--color-text-heading);"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <span style="font-size:0.75rem; color:var(--color-text-heading); font-weight:500;">${name}</span>
                    </div>`;
                });
                html += `</div>`;
            }

            // Attachments Section
            if (data.attachmentItems && data.attachmentItems.length > 0) {
                html += `<div>`;
                html += `<div style="font-size:0.7rem; font-weight:500; color:var(--color-text-muted); margin-bottom:4px;">Attachments</div>`;
                data.attachmentItems.forEach(name => {
                    html += `
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--color-text-heading);"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                        <span style="font-size:0.75rem; color:var(--color-text-heading); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${name}</span>
                    </div>`;
                });
                html += `</div>`;
            }


            if ((!data.contextItems || data.contextItems.length === 0) && (!data.attachmentItems || data.attachmentItems.length === 0)) {
                html += `<div style="color:var(--color-text-muted); font-size:0.75rem;">No sources found.</div>`;
            }

            popover.innerHTML = html;
            document.body.appendChild(popover);

            // Calculation for Fixed Position
            const rect = element.getBoundingClientRect();
            let top = rect.bottom + 6;
            let left = rect.left;

            // Check Bottom edge collision
            const estimatedHeight = 200;
            if (rect.bottom + estimatedHeight > window.innerHeight) {
                // Flip UP
                // For fixed position, bottom is easier if we want it anchored to bottom of screen? 
                // But let's stick to top/left coords for simplicity or use bottom property
                // popover relative to view:
                popover.style.top = 'auto';
                popover.style.bottom = (window.innerHeight - rect.top + 6) + 'px';
            } else {
                popover.style.top = top + 'px';
            }

            // Check Right edge collision
            if (left + 220 > window.innerWidth) {
                // Align Right Edge with Element Right Edge
                // left = rect.right - 220; 
                // Or force align to window right edge - 10px
                const diff = (left + 220) - window.innerWidth;
                left = left - diff - 10;
            }
            // Check Left edge
            if (left < 10) left = 10;

            popover.style.left = left + 'px';

            // Close handler + Scroll handler
            const cleanup = () => {
                if (popover && popover.parentNode) popover.remove();
                document.removeEventListener('click', closeHandler);
                window.removeEventListener('scroll', closeHandler, true);
                window.removeEventListener('resize', closeHandler);
            };

            const closeHandler = function (e) {
                // If scroll event, always close (simplest for fixed position)
                if (e.type === 'scroll' || e.type === 'resize') {
                    cleanup();
                    return;
                }
                // Click event
                if (!popover.contains(e.target) && e.target !== element) {
                    cleanup();
                }
            };

            setTimeout(() => {
                document.addEventListener('click', closeHandler);
                window.addEventListener('scroll', closeHandler, true);
                window.addEventListener('resize', closeHandler);
            }, 0);
        };

        // Defined here to ensure it overrides any previous definitions
        window.toggleSourcesPopover = function (event, element, data) {
            event.stopPropagation();

            // Remove existing popovers
            const existing = document.getElementById('activeSourcesPopover');
            if (existing) {
                const parent = existing.parentElement;
                existing.remove();
                if (existing.dataset.triggerId === element.id) return; // Toggle off if same
            }

            // Create Popover in BODY to avoid clipping
            const popover = document.createElement('div');
            popover.id = 'activeSourcesPopover';
            if (element.id) popover.dataset.triggerId = element.id;

            // Reuse filter-popover class
            popover.className = 'filter-popover visible';

            // Custom Styling
            popover.style.width = '220px';
            popover.style.zIndex = '9999'; // Very High z-index for fixed pos
            popover.style.textAlign = 'left';
            popover.style.position = 'fixed'; // Use fixed to ensure visibility over everything

            // Build Content Match Filter Popover Header
            // ICON REMOVED per request
            let html = `
                <div style="font-weight:600; font-size:0.75rem; margin-bottom:12px; display:flex; align-items:center; gap:4px; color:var(--color-text-heading);">
                    Sources
                </div>
            `;

            // Context Section
            if (data.contextItems && data.contextItems.length > 0) {
                html += `<div style="margin-bottom:8px;">`;
                // Font size increased to 0.75rem match items
                html += `<div style="font-size:0.75rem; font-weight:500; color:var(--color-text-muted); margin-bottom:8px;">Context</div>`;
                data.contextItems.forEach(name => {
                    html += `
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--color-text-heading);"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <span style="font-size:0.75rem; color:var(--color-text-heading); font-weight:500;">${name}</span>
                    </div>`;
                });
                html += `</div>`;
            }

            // Attachments Section
            if (data.attachmentItems && data.attachmentItems.length > 0) {
                html += `<div>`;
                html += `<div style="font-size:0.75rem; font-weight:500; color:var(--color-text-muted); margin-bottom:8px;">Attachments</div>`;
                data.attachmentItems.forEach(name => {
                    html += `
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--color-text-heading);"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                        <span style="font-size:0.75rem; color:var(--color-text-heading); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${name}</span>
                    </div>`;
                });
                html += `</div>`;
            }

            if ((!data.contextItems || data.contextItems.length === 0) && (!data.attachmentItems || data.attachmentItems.length === 0)) {
                html += `<div style="color:var(--color-text-muted); font-size:0.75rem;">No sources found.</div>`;
            }

            popover.innerHTML = html;
            document.body.appendChild(popover);

            // Calculation for Fixed Position
            const rect = element.getBoundingClientRect();
            let top = rect.bottom + 6;

            // Align Right Edge of Popover to Right Edge of Element
            let left = rect.right - 220;

            // Check Bottom edge collision
            const estimatedHeight = 200;
            if (rect.bottom + estimatedHeight > window.innerHeight) {
                // Flip UP
                popover.style.top = 'auto';
                popover.style.bottom = (window.innerHeight - rect.top + 6) + 'px';
            } else {
                popover.style.top = top + 'px';
            }

            // Boundary Checks
            if (left < 10) left = 10;
            if (left + 220 > window.innerWidth) {
                left = window.innerWidth - 230;
            }

            popover.style.left = left + 'px';

            // Close handler + Scroll handler
            const cleanup = () => {
                if (popover && popover.parentNode) popover.remove();
                document.removeEventListener('click', closeHandler);
                window.removeEventListener('scroll', closeHandler, true);
                window.removeEventListener('resize', closeHandler);
            };

            const closeHandler = function (e) {
                // If scroll event, always close (simplest for fixed position)
                if (e.type === 'scroll' || e.type === 'resize') {
                    cleanup();
                    return;
                }
                // Click event
                if (!popover.contains(e.target) && e.target !== element) {
                    cleanup();
                }
            };

            setTimeout(() => {
                document.addEventListener('click', closeHandler);
                window.addEventListener('scroll', closeHandler, true);
                window.addEventListener('resize', closeHandler);
            }, 0);
        };

        // Load directly into a new conversation
        window.onload = function () {
            resetChat();
            startPlaceholderRotation();
            // Ensure pinned items are at the top on page load
            sortHistoryList();
        };

    </script>
</body>

</html>
